
{% extends "base.html" %} {% load static %} {% block content %}
{% load stock_filters %} 
   <style>
  /* ========== Tablet override — paste at file end (after other table styles) ========== */
/* --- Tablet: freeze first 3 columns consistently with desktop --- */
@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {

*{
  font-size: 20px !important; /* Increase font size for better readability */
}

:root { --app-font-size: 20px; }

.rounded-circle{
  padding: 17px !important;
}

.model-image-tooltip{
  transform: translateX(-25%) !important;
  top: 45% !important;
  z-index: 500000 !important; /* high so it sits above table & scrollbar */

}


  /* Core layout blocks */
  .content-wrapper,
  .card, .card-body,
  .table-responsive,
  #order-listing,
  #trayScanModal_DayPlanning,
  .tray-scan-modal-DayPlanning,
  .pagination-wrapper {
    font-size: var(--app-font-size) !important;
    line-height: 1.35 !important;
  }

  /* Table headings / cells / icons */
  #order-listing th,
  #order-listing td,
  #order-listing thead th {
    font-size: var(--app-font-size) !important;
    vertical-align: middle !important;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  /* Ensure heading/title and date controls match */
  h4.text-left.mt-0.mb-3,
  .calendar-bar .date-input-group label,
  .calendar-bar .date-input-group input,
  #search-date-range-simple,
  #clear-date-filter-simple,
  .calendar-btn,
  #trayScanModal_DayPlanning input.form-control,#trayValidateBtn,
  #trayScanModal_DayPlanning table th, #trayScanModal_DayPlanning table td,
  #modalModelNo_DayPlanning
 {
    font-size: var(--app-font-size) !important;
  }  

  /* Reserve space for filter icons in header cells */
#order-listing th {
  position: relative;
  overflow: visible !important;
  white-space: normal !important; /* allow wrapping */
}

/* Ensure filter icons always stay to the right */
#order-listing th .fa-filter {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px !important;
  opacity: 0.8;
  cursor: pointer;
}

  /* Column 1 */
  #order-listing th:nth-child(1),
  #order-listing td:nth-child(1) {
    position: sticky;
    left: 0 !important;
    min-width: 90px !important;
    max-width: 90px !important;
    background: #f7fafd;
    z-index: 30;
  }

  /* Column 2 */
  #order-listing th:nth-child(2),
  #order-listing td:nth-child(2) {
    position: sticky;
    left: 90px !important;   /* = width of col1 */
    min-width: 125px !important;
    max-width: 125px !important;
    background: #f7fafd;
    z-index: 25;
  }

  /* Column 3 */
  #order-listing th:nth-child(3),
  #order-listing td:nth-child(3) {
    position: sticky;
    left: 215px !important;  /* 75 (col1) + 100 (col2 min) */
    min-width: 140px !important;
    max-width: 140px !important;
    background: #f7fafd;
    z-index: 20;
  }

  /* Sticky header */
  #order-listing thead th {
    position: sticky;
    top: 0;
    z-index: 40;
    background: #028084 !important;
    color: #e5fcff !important;
  }
}

@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {
  .table-container {
    overflow-x: auto;
  }

  /* Other columns (fit remaining space) */
  #order-listing th:nth-child(4)  { min-width: 135px !important; max-width: 135px !important; }
  #order-listing th:nth-child(5)  { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(6)  { min-width: 135px !important; max-width: 135px !important; }
  #order-listing th:nth-child(7)  { min-width: 135px !important; max-width: 140px !important; }
  #order-listing th:nth-child(8)  { min-width: 150px !important; max-width: 150px !important; }
  #order-listing th:nth-child(9)  { min-width: 150px !important; max-width: 150px !important; }
  #order-listing th:nth-child(10) { min-width: 130px !important; max-width: 150px !important; }
  #order-listing th:nth-child(11) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(12) { min-width: 130px !important; max-width: 140px !important; }
  #order-listing th:nth-child(13) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(14) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(15) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(16) { min-width: 120px !important; max-width: 130px !important; }
  #order-listing th:nth-child(17) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(18) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(19) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(20) { min-width: 130px !important; max-width: 130px !important; }


  /* Prevent overlap */
  #order-listing th:nth-child(-n+3),
  #order-listing td:nth-child(-n+3) {
    z-index: 45 !important;
  }

  /* Hide hidden columns */
  #order-listing th[hidden],
  #order-listing td[hidden] {
    display: none !important;
  }
}   
      /* Add to your CSS file for Excel-like grid lines */
.table-bordered th, .table-bordered td {
  border: 1px solid #d9dedf !important;
}
  /* Make the table header sticky */
thead th {
  position: sticky;
  top: 0;
  background-color: white; /* or your table header bg color */
  z-index: 5; /* ensure it stays above the table rows */
  
}

#order-listing thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important;
  color: #e5fcff !important;
  vertical-align: middle !important;
  border-bottom: 2.5px solid #bdbdbd !important; /* Thicker grey line below heading */
}
/* style for hol/unhold row - blurred bg */
#order-listing tr:last-child td {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
  /* background: #f4f3f3 !important; */
}
/* Gird line color combination */
#order-listing th,
#order-listing td {
  border-right: 1.5px solid #bababa !important; /* Vertical lines: blue */
  border-bottom: 1.5px solid #121413 !important; /* Horizontal lines: green */
}

  
/* Default: Desktop/Laptop (wider columns for larger font) - server */
/* #order-listing th:nth-child(1) {
  min-width: 90px;
  max-width: 90px;
} */ /* S.No */
/* #order-listing th:nth-child(2) {
  min-width: 90px;
  max-width: 100px;
} */ /* Last Updated */
/* #order-listing th:nth-child(3) {
  min-width: 90px;
  max-width: 120px;
} */ /* Plating */
#order-listing th:nth-child(4) {
  min-width: 110px;
  max-width: 120px;
} /* Polishing Stk No */
#order-listing th:nth-child(5) {
  min-width: 90px;
  max-width: 100px;
} /* Plating Color */
#order-listing th:nth-child(6) {
  min-width: 100px;
  max-width: 110px;
} /* Category */
#order-listing th:nth-child(7) {
  min-width: 95px;
  max-width: 95px;
} /* Polish Finish */
#order-listing th:nth-child(8) {
  min-width: 110px;
  max-width: 110px;
} /* Version */
#order-listing th:nth-child(9) {
  min-width: 105px;
  max-width: 105px;
} /* Tray Cate-Capacity */
#order-listing th:nth-child(10) {
  min-width: 90px;
  max-width: 100px;
} /* Source */
#order-listing th:nth-child(11) {
  min-width: 80px;
  max-width: 80px;
} /* No of Trays */
#order-listing th:nth-child(12) {
  min-width: 100px;
  max-width: 105px;
} /* Input Qty */
#order-listing th:nth-child(13) {
  min-width: 95px;
  max-width: 100px;
} /* Process Status */
#order-listing th:nth-child(14) {
  min-width: 100px;
  max-width: 100px;
} /*  Action */
#order-listing th:nth-child(15) {
  min-width: 90px;
  max-width: 100px;
} /* Lot Status */
#order-listing th:nth-child(16) {
  min-width: 110px;
  max-width: 110px;
} /* Current Stage */
#order-listing th:nth-child(17) {
  min-width: 110px;
  max-width: 100px;
} /* Remarks */
#order-listing th:nth-child(18) {
  min-width: 100px;
  max-width: 110px;
}

@media (min-width: 600px) and (max-width: 900px) {
  #order-listing {
    table-layout: auto !important; /* Let columns auto-fit content */
    width: 100% !important;
    min-width: unset !important;
    max-width: 100vw !important;
  }
  /* Adjust width for all headings (th) and cells (td) */
  #order-listing th,
  #order-listing td {
    min-width: 160px !important;
    max-width: 260px !important;
    width: 180px !important;
  }
  #order-listing th {
    position: relative;
    padding-right: 48px !important; /* More space for filter icon */
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: ellipsis;
  }
  #order-listing th .fa-filter {
    position: absolute;
    right: 18px !important;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    background: transparent;
    pointer-events: auto;
  }
}
/* Right-align filter icons */
#order-listing th .fa-filter {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.7;
  cursor: pointer;
  transition: opacity 0.2s;
}

#order-listing th .fa-filter:hover {
  opacity: 1;
}


  
#order-listing th:last-child,
#order-listing td:last-child {
  border-right: none;
  max-width: 95px;
  min-width: 100px;
}
/* Overall Table Shrink */
#order-listing tr,
#order-listing td,
#order-listing th {
  height: 20px !important;
  padding-top: 2px !important;
  padding-bottom: 2px !important;
  padding-left: 6px !important;
  padding-right: 6px !important;
}
/* Table heading font size */
/* Add this at the end of your <style> block in DP_PickTable.html */

/* Professional table header styling with proper text wrapping */
#order-listing th {
  position: relative;
  padding: 8px 12px 8px 16px !important;
  text-align: left !important;
  vertical-align: middle !important;
  white-space: normal !important;
  line-height: 1.3 !important;
  word-break: keep-all !important;
  hyphens: none !important;
  /* font-size: 13px; */
  /* font-weight: 600 !important; */
  background: #028084 !important;
  color: #e5fcff !important;
  border-bottom: 2.5px solid #bdbdbd !important;
  /* min-width: 80px;
  max-width: 140px; */
   overflow-wrap: break-word;
  word-wrap: break-word;
   z-index: 20 !important;
}

/* Make sure header cells for sticky columns are always above body cells */
/* Fix: Prevent shadow/rows from showing behind sticky columns while scrolling */
#order-listing th:nth-child(-n+3),
#order-listing td:nth-child(-n+3) {
  z-index: 30 !important; 
box-shadow: 2px 0 8px rgba(0,0,0,0.04);
}

/* Prevent sticky columns from overlapping sticky header */
#order-listing td:nth-child(-n+3) {
  z-index: 11 !important;
}
  /* Make the first column sticky and opaque */
#order-listing td:first-child,
#order-listing th:first-child {
  position: sticky;
  left: 0;
  background: #fff;      /* Or match your table background */
  z-index: 2;            /* Above blurred rows */
  box-shadow: 2px 0 4px rgba(0,0,0,0.03); /* Optional: subtle shadow */
}
/* Force specific table headers to wrap onto two lines */
#order-listing th:nth-child(4),   /* Polishing Stk No */
#order-listing th:nth-child(5),   /* Plating Color */
#order-listing th:nth-child(7),   /* Polish Finish */
#order-listing th:nth-child(9),   /* Tray Cate-Capacity */
#order-listing th:nth-child(11),  /* No of Tray */
#order-listing th:nth-child(12),  /* Input Qty */
#order-listing th:nth-child(13)   /* Process Status */ {
  white-space: normal !important;
  line-height: 1.2 !important;
  word-break: break-word !important;

  text-align: center;
  vertical-align: middle;
  padding-top: 5px !important;
  padding-bottom: 5px !important;
}
/* Freeze style for 1st - 3 columns */
/* --- Freeze first 3 columns and table header for #order-listing --- */
#order-listing {
  position: relative;
  border-collapse: separate !important;
  border-spacing: 0;
  background: #fff;
  /* Ensure enough left padding for sticky columns */
}

#order-listing th,
#order-listing td {
  background-clip: padding-box;
  /* Prevent overlap artifacts */
  z-index: 1;
}

/* Sticky header */
#order-listing thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #028084 !important;
  color: #e5fcff !important;
}

/* Freeze 1st column */
#order-listing th:nth-child(1),
#order-listing td:nth-child(1) {
  position: sticky;
  left: 0 !important;
  z-index: 12; /* Above header */
  background: #f7fafd;
  min-width: 75px;
  max-width: 75px;
}

/* Freeze 2nd column - Last Updated*/
#order-listing th:nth-child(2),
#order-listing td:nth-child(2) {
  position: sticky;
  left: 75px; /* Match min-width of 1st col */
  z-index: 12;
  background: #f7fafd;
  min-width: 100px; /* Increased width */
  max-width: 110px; /* Increased width */
}

/* Freeze 3rd column */
#order-listing th:nth-child(3),
#order-listing td:nth-child(3) {
  position: sticky;
  left: 175px; /* 100px (1st) + 90px (2nd) */
  z-index: 12;
  background: #f7fafd;
  min-width: 130px; /* Increased width 100 - old value*/
  max-width: 140px; /* Increased width  110 - old value*/
}

/* ...existing code... */

/* Prevent sticky columns from overlapping sticky header */
#order-listing th:nth-child(-n + 3) {
  z-index: 12;
}
#order-listing td:nth-child(-n + 3) {
  z-index: 11;
}

/* Ensure sticky columns and header work together */
#order-listing th,
#order-listing td {
  box-sizing: border-box;
  /* Prevent content shake */
  /* overflow: hidden; */
  text-overflow: ellipsis;
  white-space: nowrap;
}



    .blurred-heading, .blurred-cell {
    filter: blur(2px) grayscale(0.7) opacity(0.6);
    pointer-events: none !important;
    user-select: none;
    cursor: not-allowed;
    background: #f5f5f5 !important;
  }
    /* Show remark tooltip above the trigger instead of below */
  .remark-tooltip {
    top: auto !important;
    bottom: 110% !important;
  }
#trayScanDetails.table-grid {
  display: grid !important;
  grid-template-columns: 94px 175px 150px !important;
  gap: 0px !important;
  max-height: 300px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding-right: 10px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

#trayScanDetails.table-grid::-webkit-scrollbar {
  width: 8px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb:hover {
  background: #555;
}
 
 
.tray-scan-modal.open {
  width:500px !important;
}
/* For the 4-column layout (with validation status) */
#trayScanDetails.table-grid.four-column {
  grid-template-columns: 50px 1fr 100px 140px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
}
 
/* Styling individual grid cells, only inside trayScanDetails */
#trayScanDetails.table-grid > div {
  background: #f7f7f7;
  padding: 8px 12px;
  font-size: 12px;
  border: 1px solid #ddd;
  margin: 0; /* reset any margin from <p> or others */
}
 
/* S.no column specific styling */
#trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
  text-align: center;
  font-weight: 600;
  padding: 8px 4px; /* Reduced horizontal padding for S.no */
}
 
/* For mobile responsiveness */
@media (max-width: 768px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 45px 1fr 1fr !important; /* Even smaller S.no column on mobile */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 40px 1fr 80px 100px !important;
  }
  #trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
    padding: 6px 2px; /* Further reduced padding on mobile */
    font-size: 11px;
  }
}
 
/* For very small screens */
@media (max-width: 480px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 35px 1fr 80px !important; /* Minimal S.no column */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 30px 1fr 70px 90px !important;
  }
}
      /* Lot ID Colors for Tray Table */
.lot-color-1 { background-color: #e8f5e8 !important; } /* Light Green */
.lot-color-2 { background-color: #e3f2fd !important; } /* Light Blue */
.lot-color-3 { background-color: #fff3e0 !important; } /* Light Orange */
.lot-color-4 { background-color: #f3e5f5 !important; } /* Light Purple */
.lot-color-5 { background-color: #fff8e1 !important; } /* Light Yellow */
.lot-color-6 { background-color: #ffebee !important; } /* Light Red */

/* Color legend styling */
.lot-legend {
  margin-top: 10px; 
  font-size: 12px; 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap;
}

.lot-legend span {
  padding: 2px 8px; 
  border-radius: 4px; 
  border: 1px solid #ccc;
  font-weight: bold;
}
/* Modal Base Styles */
.right-slide-modal {
  position: fixed;
  top: 0;
  right: -100%;
  width: 100%;
  max-width: 650px;
  height: 100%;
  background: #ffffff;
  box-shadow: -4px 0 12px rgba(0, 0, 0, 0.15);
  transition: right 0.4s ease, opacity 0.3s ease;
  z-index: 10500;
  overflow-y: auto;
  font-family: 'Segoe UI', sans-serif;
  border-radius: 16px 0 0 16px;
}

.right-slide-modal.open {
  right: 0 !important;
  opacity: 1;
}

.right-slide-modal:not(.open) {
  opacity: 0;
}

.right-slide-modal.minimized {
  right: 0 !important;
  width: 350px !important;
  max-width: 350px !important;
  height: 60px !important;
  min-height: 60px !important;
  overflow: hidden;
  border-radius: 16px 0 0 0;
  transition: width 0.3s, height 0.3s;
  padding: 0 !important;
  display: flex;
  align-items: center;
  justify-content: center;
  position: fixed !important;
  top: 20px !important;
  z-index: 10500 !important;
}

.right-slide-modal.minimized .right-slide-content {
  width: 100%;
  height: 100%;
  padding: 8px 16px !important;
  display: flex;
  align-items: center;
  justify-content: center;
}

.right-slide-modal.minimized .modal-header {
  display: flex !important;
  align-items: center;
  justify-content: space-between !important;
  width: 100%;
  height: 100%;
  margin: 0;
  padding: 0;
}

.right-slide-modal.minimized .modal-header h3 {
  font-size: 14px !important;
  margin: 0;
  flex: 1;
  text-align: left !important;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.right-slide-modal.minimized .close-btn {
  display: block !important;
  font-size: 18px !important;
  margin-left: 10px;
  flex-shrink: 0;
}

.right-slide-modal.minimized .modal-actions,
.right-slide-modal.minimized .form-section,
.right-slide-modal.minimized .model-slider-wrapper,
.right-slide-modal.minimized h4 {
  display: none !important;
}

.right-slide-modal.minimized .tray-table,
.right-slide-modal.minimized .action-buttons,
.right-slide-modal.minimized #selectedItemsStatus {
  display: none !important;
}

/* Modal Content */
.right-slide-content {
  padding: 24px;
}

/* Modal Header */
.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-header h3 {
  font-size: 18px;
  margin: 0;
}

.highlight {
  color: #028084;
}

.close-btn {
  font-size: 26px;
  text-decoration: none;
  color: #666;
  cursor: pointer;
}

.close-btn:hover {
  color: red;
}

/* Modal Actions */
.modal-actions {
  display: flex;
  gap: 10px;
  align-items: center;
  margin: 20px 0;
  flex-wrap: wrap;
}

.btn-action {
  padding: 6px 14px;
  border: none;
  border-radius: 20px;
  font-size: 13px;
  color: white;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

.btn-action:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.btn-action.blue { 
  background-color: #0378bd; 
}

.btn-action.teal { 
  background-color: #02b4a8; 
}

.cycle-status {
  background: #e6f9fa;
  padding: 6px 14px;
  border-radius: 20px;
  color: #017d7a;
  font-size: 13px;
}

/* Form Section in Modal */
.form-section {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 10px !important;
  margin-bottom: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
  margin-bottom: 0.5rem !important;
}

.form-group label {
  font-size: 13px;
  margin-bottom: 4px;
  color: #555;
}

.form-group input {
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  background: #f9f9f9;
  font-size: 13px;
}

/* QR validation error styling */
.qr-validation-error {
  color: #dc3545;
  font-size: 12px;
  margin-top: 4px;
  font-weight: 500;
}

/* UPDATED: Tray Table in Modal - Changed to 2 columns */
.tray-table {
  display: grid;
  grid-template-columns: repeat(2, 1fr); /* Changed from 3 to 2 columns */
  gap: 6px;
  margin: 16px 0;
  border: 1px solid #ddd;
  border-radius: 6px;
  overflow: hidden;
}

.tray-table > div {
  background: #f0fdfc;
  border: 1px solid #d1d1d1;
  padding: 8px;
  font-size: 13px;
  text-align: center;
}

.tray-table > div:nth-child(-n+2) { /* Changed from -n+3 to -n+2 */
  background: #d1f2f3 !important;
  font-weight: bold;
  color: #028084;
}

/* Status indicator styling */
#selectedItemsStatus {
  animation: fadeIn 0.3s ease;
  margin: 15px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 6px;
  font-size: 14px;
  color: #666;
  display: none;
}

/* Action Buttons in Modal */
.action-buttons {
  display: flex;
  flex-wrap: nowrap;
  gap: 12px;
  margin-top: 20px;
}

.action-buttons button {
  flex: 1 1 calc(50% - 6px);
  padding: 10px;
  border: none;
  border-radius: 30px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
}

.btn-twitter { 
  background-color: #028084a8; 
  color: white; 
}

.btn-success { 
  background-color: #28a745; 
  color: white; 
}

.btn-warning { 
  background-color: #ffc107; 
  color: #000; 
}

.btn-danger { 
  background-color: #dc3545; 
  color: white; 
}

/* Animations for Modal */
@keyframes fadeIn {
  from { 
    opacity: 0; 
    transform: translateY(-10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

/* Toast animations */
@keyframes slideInToast {
  from { 
    opacity: 0; 
    transform: translateX(100%); 
  }
  to { 
    opacity: 1; 
    transform: translateX(0); 
  }
}

@keyframes slideOutToast {
  from { 
    opacity: 1; 
    transform: translateX(0); 
  }
  to { 
    opacity: 0; 
    transform: translateX(100%); 
  }
}

/* Modal message animations */
@keyframes slideInMessage {
  from { 
    opacity: 0; 
    transform: translateY(-10px); 
  }
  to { 
    opacity: 1; 
    transform: translateY(0); 
  }
}

@keyframes slideOutMessage {
  from { 
    opacity: 1; 
    transform: translateY(0); 
  }
  to { 
    opacity: 0; 
    transform: translateY(-10px); 
  }
}

/* Filter indicator animation */
@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

/* Model Slider in Modal */
.model-slider-wrapper {
  position: relative;
  margin-bottom: 20px;
}

.slider-btn {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.1);
  border: none;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  color: #666;
  z-index: 10;
  display: none;
}

.prev-btn {
  left: 4px;
}

.next-btn {
  right: 4px;
}

.model-slider-container {
  overflow: hidden;
  margin: 0 40px;
}

.model-slider {
  display: flex;
  transition: transform 0.3s ease;
  gap: 12px;
}

.model-loaded-item {
  min-width: 160px;
  flex: 0 0 auto;
  margin-right: 12px;
  display: flex;
  align-items: center;
  background: linear-gradient(135deg, #e8f5e8 0%, #fff5bd 100%);
  border: 2px solid #28a745;
  border-radius: 12px;
  padding: 12px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

/* Responsive Design for Modal */
@media (max-width: 600px) {
  .right-slide-content {
    padding: 16px;
  }
  
  .tray-table {
    grid-template-columns: 1fr;
  }
  
  .form-section {
    grid-template-columns: 1fr;
  }
  
  .action-buttons button {
    flex: 1 1 100%;
  }
}
</style>
<div class="content-wrapper">
   <div class="col-12 grid-margin stretch-card">
      <div class="card">
         <div class="card-body" style="padding-bottom:12px;">
            <h5 class="text-left mt-0 mb-4" style="font-weight:700;">Spider Spindle Completed Table</h5>
            <div class="table-responsive" style="overflow: scroll !important">
              <table id="order-listing" class="table">
                <thead>
                  <tr>
                    <th>
                      S.No <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Last<br>Updated
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                       Plating<br>Stk No
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Polishing Stk No
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Plating Color
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Polish Finish
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                   
                    <th>
                      Version <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Source - Location
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Tray Cate- <br> Capacity
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      No of <br> Trays <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Lot Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Jig Type <br> Capacity 
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      IP Info<i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Process Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Action <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Lot Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Current <br> Stage
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Remarks <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                  </tr>
                </thead>
              <tbody>
                {% for data in master_data %}
                <tr class="highlighted-tray-scan" data-batch-id="{{ data.batch_id }}">
                  <td>
                      <div style="display: flex; align-items: center; gap: 8px;">
                          <input type="checkbox" 
                                class="model-select-checkbox" 
                                data-model-no="{{ data.model_stock_no__model_no }}" 
                                data-stock-lot-id="{{ data.stock_lot_id }}"
                                data-img-url="{{ data.model_images.0|default:'/static/assets/images/imagePlaceholder.png' }}"
                                style="display: none;" />                       
                      </div>
                          <span class="sno-value">{{ page_obj.start_index|add:forloop.counter0 }}</span>

                  </span>

                  </td>
                  <td >
                    {{ data.jig_loaded_date_time|date:"d-M-y" }}<br>
                    <span style="display:inline-block; margin-top:4px;word-break: break-all;">{{ data.jig_loaded_date_time|date:"h:i A" }}</span>
                  </td>
                  <!-- Model/Stock No - Image hover -->  
                  <td >
                      <span class="model-hover-trigger" style="cursor: pointer; word-break: break-all;">
                        {{ data.plating_stk_no|highlight_plating_color|safe_html }}
                        <div class="model-image-tooltip" style="position: absolute; left: 80%; top: 110%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 12px 18px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; opacity: 0; pointer-events: none; transition: opacity 0.2s; min-width: 220px;">
                          
                          <!-- Header with Info and Close buttons -->
                          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <button class="info-btn" style="background: #007bff; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                               Info
                            </button>
                            <button class="close-btn" style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                               Close
                            </button>
                          </div>
                          <!-- Image gallery section -->
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <!-- Hide scroll buttons since only one image is shown -->
                            <div class="img-gallery" style="display: flex; gap: 6px; overflow: hidden; width: 180px;">
                              <img src="{{ data.model_images.0|default:'/static/assets/images/imagePlaceholder.png' }}" style="width: 55px; height: 55px; object-fit: cover; border-radius: 6px;" />
                            </div>
                          </div>
                        </div>
                      </span>
                    </td>
                  <td>{{ data.polishing_stk_no }}</td>
                  <td>{{ data.plating_color }}</td>
                  <td>{{ data.polish_finish }}</td>
                  <td>{{ data.version__version_internal }}</td>             
                  <td>{{ data.location__location_name }}</td>
                  <td>{{ data.tray_type }} {{ data.tray_capacity }}</td>
                  <td>{{ data.no_of_trays }}</td>
                  <td>
                    <input type="number"
                          class="edit-qty-input"
                          value="{{ data.display_qty|default:0 }}"
                          data-batch-id="{{ data.batch_id }}"
                          style="width: 60px; padding: 2px 6px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px;"
                          readonly />
                  </td>
                  <td>
                      {{data.jig_type}} - {{data.jig_capacity}}
                  </td>
                  <td>
                      <span class="mobile-cross-icon" title="Item removed" style="cursor: pointer; display: inline-flex; align-items: center;">
                          <i class="fa fa-mobile" aria-hidden="true" style="font-size:25px; color: #028084; font-weight: 900;" data-bs-toggle="tooltip" data-placement="right" data-bs-original-title="Jig"></i>
                      </span>
                  </td>
                  <td>
                    <div class="d-flex">
                      <div
                        title="Tray Scan"
                        class="d-flex align-items-center justify-content-center rounded-circle ms-1"
                        style="
                          width: 20px;
                          height: 20px;
                          color: white;
                          font-weight: bold;
                          line-height: 20px;
                          text-align: center;
                          padding-top: 1px;
                          padding-right: 1px;
                          {% if data.batch_status.status == 'Yet to Start' %}
                            background: #bdbdbd; /* gray */
                          {% elif data.batch_status.status == 'Draft' %}
                            background: linear-gradient(90deg, #0c8249 50%, #bdbdbd 50%); /* half green, half gray */
                          {% elif data.batch_status.status == 'Yet to Release' or data.batch_status.status == 'Released' %}
                            background: #0c8249; /* full green */
                          {% else %}
                            background: #bdbdbd; /* default gray */
                          {% endif %}
                        "
                      >
                        L
                      </div>
                    </div>
                  </td>
                  <!-- Action buttons cell -->
                  <td>

                    
                    <!-- Add Jig button section -->
                        <button
                            type="button"
                            class="btn btn-social-icon-text btn-twitter"
                            style="background-color: #028084a8; cursor: not-allowed;"
                            disabled
                        >
                            <i class="fa fa-check"></i>Added
                        </button>

                  </td>
                  <!-- Batch status cell -->
                    <td >
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; font-size: 13px; white-space: nowrap; padding: 5px;">
                          Released
                        </div>
                    </td>
                    <td >
                      <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #d1edf3; background-color: #d1edf3; color: #033b5d; font-size: 13px; white-space: nowrap; padding: 5px;">
                        {{ data.last_process_module|default:"N/A" }}
                      </div>
                    </td>
<!-- Remarks Column -->
<td>

  <!-- Audio Remark Icon -->
  {% if data.audio_remark %}
    <span class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: default;">
      <img src="{% static 'assets/icons/rec.png' %}" alt="Audio Remark" style="width: 20px; height: 20px;" />
      <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
        
        <span style="font-size: 12px; color: #333;">Audio remark available</span>
      </div>
    </span>
  {% else %}
    <span title="No audio remark" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; cursor: not-allowed;">
      <img src="{% static 'assets/icons/rec.png' %}" alt="Audio Remark Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
    </span>
  {% endif %}

  <!-- Text Remark Icon -->
  {% if data.spider_pick_remarks %}
    <span class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: default;">
      <img src="{% static 'assets/icons/chat_icon.png' %}" alt="Chat"
        style="width: 20px; height: 20px; filter: grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2); opacity: 1;" />
      <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
        
        <div style="font-size: 12px; color: #333;">{{ data.spider_pick_remarks }}</div>
      </div>
    </span>
  {% else %}
    <span title="No remarks" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; cursor: not-allowed;">
      <img src="{% static 'assets/icons/chat_icon.png' %}" alt="Chat Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
    </span>
  {% endif %}

</td>
                </tr>
              {% endfor %}
              </tbody>
              </table>


              <!-- Tray Scan Modal -->
                <div id="trayScanModal_DayPlanning" class="tray-scan-modal-DayPlanning"style="display:none"> 
                  <div class="tray-scan-modal-DayPlanning-content">
                    <span id="closeTrayScanModal_DayPlanning" class="tray-scan-close-readonly">&times;</span>
                    
                    <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
                      <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
                        <img src="/static/assets/images/imagePlaceholder.png" alt="User Profile" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
                        <!-- Model No and Lot Qty in same line -->
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                          <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <span style="font-weight: bold; color: #666;">Model No:</span>
                              <h6 id="modalModelNo_DayPlanning" style="margin: 0; color: #028084; font-weight: bold;">(Fetch Dynamically)</h6>
                            </div>
                          <h7 style="margin: 0; color: #666666; font-weight: bold;">
                              Lot Qty: <span id="modalLotQty_DayPlanning" style="font-weight:bold; color:#e67e22;"></span>
                          </h7>
                          </div>
                            
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                        Spider Spindle - Tray Scan 
                      </h5>
                      <button id="trayValidateBtn" type="button" style="display: flex; align-items: center; gap: 6px; background: #f5faff; border: 1px solid #023E4DCC; color: #023E4DCC; border-radius: 20px; padding: 4px 14px; font-size: 12px; font-weight: 500; cursor: pointer;">
                        
                        Tray Validate
                      </button>
                      <input id="trayValidateInput" type="text" placeholder="Enter validation info..." style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" />
                      <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="trayScanRedoBtn" style="width: 24px; height: 24px; cursor: pointer; margin-left: 8px;" title="Clear Tray IDs" />
                    </div>
                    <div id="trayErrorMessage" style="display: none; background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                      <span id="trayErrorText"></span>
                    </div>
                    <div id="trayScanDetails_DayPlanning" class="table-grid">
                      <!-- Headers and dynamic content will be injected here -->
                    </div>
                  </div>
                </div>           
            </div>
          </div>
            <!-- Pagination Section -->

            <div class="pagination-wrapper">
              <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end mb-0">
                  {# Previous button #}
                  {% if page_obj.has_previous %}
                    <li>
                      <a href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                    </li>
                  {% endif %}
                
                  {# Always show first page #}
                  {% if page_obj.number > 3 %}
                    <li><a href="?page=1">1</a></li>
                    {% if page_obj.number > 4 %}
                      <li class="disabled"><span>…</span></li>
                    {% endif %}
                  {% endif %}
                
                  {# Show pages around current page #}
                  {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                      {% if num == page_obj.number %}
                        <li class="active"><span>{{ num }}</span></li>
                      {% else %}
                        <li><a href="?page={{ num }}">{{ num }}</a></li>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                
                  {# Show ellipsis and last page if needed #}
                  {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                      <li class="disabled"><span>…</span></li>
                    {% endif %}
                    <li><a href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                  {% endif %}
                
                  {# Next button #}
                  {% if page_obj.has_next %}
                    <li>
                      <a href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
     </div>
   </div>
</div>
</div>

{% block script %}


  <!-- Script for Text Remarks (unchanged) -->
  <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var triggers = document.querySelectorAll(".remark-tooltip-trigger");
      triggers.forEach(function (trigger) {
        var tooltip = trigger.querySelector(".remark-tooltip");
        var sendButton = tooltip ? tooltip.querySelector("button") : null;
        function showTooltip() {
          tooltip.style.opacity = "1";
          tooltip.style.visibility = "visible";
          var rect = tooltip.getBoundingClientRect();
          if (rect.right > window.innerWidth) {
            tooltip.style.left = "auto";
            tooltip.style.right = "0";
            tooltip.style.transform = "none";
          }
          if (rect.left < 0) {
            tooltip.style.left = "0";
            tooltip.style.transform = "none";
          }
          var textarea = tooltip.querySelector("textarea");
          if (textarea) {
            textarea.focus();
          }
        }
        function hideTooltip() {
          tooltip.style.opacity = "0";
          tooltip.style.visibility = "hidden";
        }
        trigger.addEventListener("mouseenter", showTooltip);
        trigger.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        tooltip.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        trigger.addEventListener("click", function (e) {
          e.preventDefault();
        });
        if (sendButton) {
          sendButton.addEventListener("click", hideTooltip);
        }
      });
    });
  </script>
  
    <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var triggers = document.querySelectorAll(".remark-tooltip-trigger");
      triggers.forEach(function (trigger) {
        var tooltip = trigger.querySelector(".remark-tooltip");
        var sendButton = tooltip ? tooltip.querySelector("button") : null;
        function showTooltip() {
          tooltip.style.opacity = "1";
          tooltip.style.visibility = "visible";
          var rect = tooltip.getBoundingClientRect();
          if (rect.right > window.innerWidth) {
            tooltip.style.left = "auto";
            tooltip.style.right = "0";
            tooltip.style.transform = "none";
          }
          if (rect.left < 0) {
            tooltip.style.left = "0";
            tooltip.style.transform = "none";
          }
          var textarea = tooltip.querySelector("textarea");
          if (textarea) {
            textarea.focus();
          }
        }
        function hideTooltip() {
          tooltip.style.opacity = "0";
          tooltip.style.visibility = "hidden";
        }
        trigger.addEventListener("mouseenter", showTooltip);
        trigger.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        tooltip.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        trigger.addEventListener("click", function (e) {
          e.preventDefault();
        });
        if (sendButton) {
          sendButton.addEventListener("click", function (e) {
            e.preventDefault();
            // Find the textarea and get its value
            var textarea = tooltip.querySelector("textarea");
            var remark = textarea ? textarea.value.trim() : "";
            if (!remark) {
              Swal.fire('Error', 'Please enter a remark before sending.', 'error');
              return;
            }
            // Find the batch_id from the row (tr) data attribute or from a hidden field
            var row = trigger.closest("tr");
            var trayScanLink = row ? row.querySelector('.tray-scan-btn') : null;
            var batchId = row ? row.getAttribute('data-batch-id') : null;
            if (!batchId) {
              Swal.fire('Error', 'Batch ID not found.', 'error');
              return;
            }
            fetch('/spider_spindle_zone_two/Zone_jig_save_ip_pick_remark/', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
              },
              body: JSON.stringify({
                batch_id: batchId,
                remark: remark
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Remark saved!',
                  timer: 1200,
                  showConfirmButton: false
                }).then(() => {
                  // Make the textarea readonly
                  if (textarea) {
                    textarea.setAttribute("readonly", true);
                  }

                  // Replace send button with info message
                  if (sendButton && tooltip) {
                    const infoDiv = document.createElement("div");
                    infoDiv.style.marginTop = "40px";
                    infoDiv.style.color = "#31708f";
                    infoDiv.style.background = "#d9edf7";
                    infoDiv.style.border = "1px solid #bce8f1";
                    infoDiv.style.borderRadius = "4px";
                    infoDiv.style.padding = "8px 12px";
                    infoDiv.style.fontSize = "10px";
                    infoDiv.style.textAlign = "left";
                    infoDiv.innerHTML = `
                      <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                      Remark already saved and cannot be edited.
                    `;
                    sendButton.parentNode.replaceChild(infoDiv, sendButton);
                  }

                  hideTooltip(); // optional if you still want to hide the tooltip
                });

              } else {
                Swal.fire('Error', data.error || 'Failed to save remark', 'error');
              }
            })
            .catch(() => {
              Swal.fire('Error', 'Network error', 'error');
            });
          });
        }
      });
    });
  </script>

<!-- Plating Stk - Image hover - fixed position while hitting the Plating Stk No -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  let openTooltip = null;

  // Helper function to completely close a tooltip
  function closeTooltip(tooltip, trigger) {
    if (tooltip) {
      console.log('🔴 Closing tooltip completely');
      
      // Remove pinned class
      tooltip.classList.remove("pinned");
      
      // Hide the entire tooltip completely
      tooltip.style.opacity = "0";
      tooltip.style.pointerEvents = "none";
      tooltip.style.visibility = "hidden";
      tooltip.style.display = "none"; // ✅ ADDED: Force display none
      
      // Hide buttons
      const infoBtn = tooltip.querySelector('.info-btn');
      const closeBtn = tooltip.querySelector('.close-btn');
      if (infoBtn) infoBtn.style.display = 'none';
      if (closeBtn) closeBtn.style.display = 'none';
      
      // Remove visual indicator from trigger
      if (trigger) {
        trigger.style.backgroundColor = '';
        trigger.style.borderRadius = '';
      }
      
      // Clear global reference
      openTooltip = null;
      
      console.log('✅ Tooltip completely closed');
    }
  }

  // Tooltip show/hide logic
  document.querySelectorAll(".model-hover-trigger").forEach(function (trigger) {
    const tooltip = trigger.querySelector(".model-image-tooltip");

    trigger.addEventListener("mouseenter", function () {
      if (tooltip && !tooltip.classList.contains("pinned")) {
        tooltip.style.display = "flex"; // ✅ ADDED: Reset display
        tooltip.style.visibility = "visible"; // ✅ ADDED: Reset visibility
        tooltip.style.opacity = "1";
        tooltip.style.pointerEvents = "auto";
        
        // Show Info and Close buttons on hover
        const infoBtn = tooltip.querySelector('.info-btn');
        const closeBtn = tooltip.querySelector('.close-btn');
        if (infoBtn) infoBtn.style.display = 'block';
        if (closeBtn) closeBtn.style.display = 'block';
      }
    });

    trigger.addEventListener("mouseleave", function () {
      if (tooltip && !tooltip.classList.contains("pinned")) {
        tooltip.style.opacity = "0";
        tooltip.style.pointerEvents = "none";
        
        // Hide Info and Close buttons when not hovering and not pinned
        const infoBtn = tooltip.querySelector('.info-btn');
        const closeBtn = tooltip.querySelector('.close-btn');
        if (infoBtn) infoBtn.style.display = 'none';
        if (closeBtn) closeBtn.style.display = 'none';
      }
    });

    // Keep tooltip visible when hovering over it
    if (tooltip) {
      tooltip.addEventListener("mouseenter", function () {
        if (!tooltip.classList.contains("pinned")) {
          tooltip.style.display = "flex"; // ✅ ADDED: Reset display
          tooltip.style.visibility = "visible"; // ✅ ADDED: Reset visibility
        }
        tooltip.style.opacity = "1";
        tooltip.style.pointerEvents = "auto";
        
        // Keep buttons visible when hovering over tooltip
        const infoBtn = tooltip.querySelector('.info-btn');
        const closeBtn = tooltip.querySelector('.close-btn');
        if (infoBtn) infoBtn.style.display = 'block';
        if (closeBtn) closeBtn.style.display = 'block';
      });

      tooltip.addEventListener("mouseleave", function () {
        if (!tooltip.classList.contains("pinned")) {
          tooltip.style.opacity = "0";
          tooltip.style.pointerEvents = "none";
          
          // Hide buttons when leaving tooltip and not pinned
          const infoBtn = tooltip.querySelector('.info-btn');
          const closeBtn = tooltip.querySelector('.close-btn');
          if (infoBtn) infoBtn.style.display = 'none';
          if (closeBtn) closeBtn.style.display = 'none';
        }
      });
    }

    trigger.addEventListener("click", function (e) {
      e.stopPropagation();

      if (tooltip) {
        // Close any previously opened tooltip
        if (openTooltip && openTooltip !== tooltip) {
          const prevTrigger = openTooltip.closest('.model-hover-trigger');
          closeTooltip(openTooltip, prevTrigger);
        }

        tooltip.classList.add("pinned");
        tooltip.style.display = "flex"; // ✅ ADDED: Ensure display
        tooltip.style.visibility = "visible"; // ✅ ADDED: Ensure visibility
        tooltip.style.opacity = "1";
        tooltip.style.pointerEvents = "auto";
        openTooltip = tooltip;
        
        // Keep buttons visible when pinned
        const infoBtn = tooltip.querySelector('.info-btn');
        const closeBtn = tooltip.querySelector('.close-btn');
        if (infoBtn) infoBtn.style.display = 'block';
        if (closeBtn) closeBtn.style.display = 'block';

        // Add visual indicator that tooltip is pinned
        trigger.style.backgroundColor = '#e3f2fd';
        trigger.style.borderRadius = '4px';
      }
    });

    // ✅ Handle Info button click
    const infoBtn = tooltip?.querySelector('.info-btn');
    if (infoBtn) {
      // Initially hide the button
      infoBtn.style.display = 'none';
      
      infoBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        const modelNo = trigger.textContent.trim();
        
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            title: 'Model Information',
            html: `<strong>Plating Stk No:</strong> ${modelNo}`,
            icon: 'info',
            confirmButtonText: 'OK',
            confirmButtonColor: '#007bff'
          });
        } else {
          alert('Model Information:\nPlating Stk No: ' + modelNo);
        }
      });
    }

    // ✅ FIXED: Handle Close button click - Complete tooltip closure
    const closeBtn = tooltip?.querySelector('.close-btn');
    if (closeBtn) {
      // Initially hide the button
      closeBtn.style.display = 'none';
      
      closeBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        console.log('🔴 Close button clicked');
        
        // Use the helper function to completely close tooltip
        closeTooltip(tooltip, trigger);
        
        // Feedback animation for close button
        closeBtn.style.transform = 'scale(0.9)';
        setTimeout(() => {
          if (closeBtn.style) {
            closeBtn.style.transform = 'scale(1)';
          }
        }, 150);
      });
      
      // ✅ Add hover effect for close button
      closeBtn.addEventListener('mouseenter', function() {
        closeBtn.style.backgroundColor = '#c82333';
        closeBtn.style.transform = 'scale(1.05)';
      });
      
      closeBtn.addEventListener('mouseleave', function() {
        closeBtn.style.backgroundColor = '#dc3545';
        closeBtn.style.transform = 'scale(1)';
      });
    }
  });

  // ✅ ENHANCED: Close tooltip when clicking outside
  document.addEventListener("click", function (e) {
    if (openTooltip && !e.target.closest('.model-image-tooltip') && !e.target.closest('.model-hover-trigger')) {
      const openTrigger = openTooltip.closest('.model-hover-trigger');
      closeTooltip(openTooltip, openTrigger);
    }
  });

  // ✅ Close tooltip with ESC key
  document.addEventListener("keydown", function (e) {
    if (e.key === "Escape" && openTooltip) {
      const openTrigger = openTooltip.closest('.model-hover-trigger');
      closeTooltip(openTooltip, openTrigger);
      console.log('✅ Tooltip closed with ESC key');
    }
  });

  // Prevent tooltip from closing when clicking inside it
  document.querySelectorAll(".model-image-tooltip").forEach(function (tooltip) {
    tooltip.addEventListener("click", function (e) {
      e.stopPropagation();
    });
  });
});
</script>


<!-- Script for Model / Stock No - Image Mouse Hover -->
<script nonce="{{ csp_nonce }}">
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
      const tooltip = trigger.querySelector('.model-image-tooltip');
      let currentIndex = 0;
      let tooltipPinned = false;
      let hoverTimeout = null;
      const images = Array.from(tooltip.querySelectorAll('.img-gallery img'));

      function showImages(start) {
        images.forEach((img, i) => {
          img.style.display = (i >= start && i < start + 3) ? 'block' : 'none';
        });
      }
      showImages(currentIndex);

      // Show immediately on mouseenter
      trigger.addEventListener('mouseenter', function() {
        clearTimeout(hoverTimeout);
        tooltip.style.opacity = '1';
        tooltip.style.pointerEvents = 'auto';
      });

      // Hide when leaving trigger (unless pinned)
      trigger.addEventListener('mouseleave', function() {
        if (!tooltipPinned) {
          hoverTimeout = setTimeout(function() {
            if (!tooltip.matches(':hover')) {
              tooltip.style.opacity = '0';
              tooltip.style.pointerEvents = 'none';
            }
          }, 300);
        }
      });

      // Keep visible when hovering over tooltip
      tooltip.addEventListener('mouseenter', function() {
        clearTimeout(hoverTimeout);
        tooltip.style.opacity = '1';
        tooltip.style.pointerEvents = 'auto';
      });

      // Hide when leaving tooltip (unless pinned)
      tooltip.addEventListener('mouseleave', function() {
        if (!tooltipPinned) {
          hoverTimeout = setTimeout(function() {
            tooltip.style.opacity = '0';
            tooltip.style.pointerEvents = 'none';
          }, 300);
        }
      });

      // Pin tooltip on click (make it sticky)
      trigger.addEventListener('click', function(e) {
        e.preventDefault();
        tooltipPinned = true;
        tooltip.style.opacity = '1';
        tooltip.style.pointerEvents = 'auto';
        clearTimeout(hoverTimeout);
        
        // Add visual indicator that it's pinned
        trigger.style.backgroundColor = '#e3f2fd';
        trigger.style.borderRadius = '4px';
      });

      // Unpin tooltip if user clicks outside
      document.addEventListener('mousedown', function(e) {
        if (!trigger.contains(e.target) && !tooltip.contains(e.target)) {
          tooltipPinned = false;
          tooltip.style.opacity = '0';
          tooltip.style.pointerEvents = 'none';
          
          // Remove visual indicator
          trigger.style.backgroundColor = '';
          trigger.style.borderRadius = '';
        }
      });

      // Handle scroll buttons with error handling
      const leftBtn = tooltip.querySelector('.img-scroll-left');
      const rightBtn = tooltip.querySelector('.img-scroll-right');
      
      if (leftBtn) {
        leftBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (currentIndex > 0) {
            currentIndex--;
            showImages(currentIndex);
          }
        });
      }
      
      if (rightBtn) {
        rightBtn.addEventListener('click', function(e) {
          e.stopPropagation();
          if (currentIndex < images.length - 3) {
            currentIndex++;
            showImages(currentIndex);
          }
        });
      }

      // Add click event to images for modal slider
      images.forEach(function(img, idx) {
        img.style.cursor = 'pointer';
        img.addEventListener('click', function(e) {
          e.stopPropagation();
          openImageSlider(images.map(i => i.src), idx);
        });
      });
    });

    // Modal slider functions
    const modal = document.getElementById("imageSliderModal");
    const closeModal = document.getElementById("closeImageSliderModal");
    const slidesContainer = modal ? modal.querySelector(".slides") : null;
    let sliderImages = [];
    let currentSlide = 0;

    function openImageSlider(srcArray, startIdx) {
      if (!modal || !slidesContainer) return;
      
      sliderImages = srcArray;
      slidesContainer.innerHTML = '';
      sliderImages.forEach(src => {
        const slide = document.createElement('div');
        slide.className = 'slide';
        const img = document.createElement('img');
        img.src = src;
        slide.appendChild(img);
        slidesContainer.appendChild(slide);
      });
      currentSlide = startIdx;
      showSlide(currentSlide);
      modal.classList.add('open');
    }

    function showSlide(n) {
      const slides = slidesContainer ? slidesContainer.querySelectorAll('.slide') : [];
      if (!slides.length) return;
      currentSlide = (n + slides.length) % slides.length;
      slides.forEach((slide, idx) => {
        slide.classList.toggle('active', idx === currentSlide);
      });
    }

    if (modal) {
      const prevBtn = modal.querySelector("#prevBtn");
      const nextBtn = modal.querySelector("#nextBtn");
      
      if (prevBtn) {
        prevBtn.addEventListener("click", function(e) {
          e.stopPropagation();
          showSlide(currentSlide - 1);
        });
      }
      
      if (nextBtn) {
        nextBtn.addEventListener("click", function(e) {
          e.stopPropagation();
          showSlide(currentSlide + 1);
        });
      }
      
      if (closeModal) {
        closeModal.addEventListener("click", function() {
          modal.classList.remove("open");
        });
      }
      
      modal.addEventListener("click", function(e) {
        if (e.target === modal) modal.classList.remove("open");
      });
    }
  });
</script>
<!-- Enhanced Checkbox and Modal Handling Script -->

<!-- CSRF Token Helper -->
<script nonce="{{ csp_nonce }}">
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  function lockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button:not(#closeTrayScanModal_DayPlanning):not(#trayValidateBtn):not(#trayScanRedoBtn), .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.filter = 'grayscale(1)';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    document.querySelectorAll('a:not(.tray-scan-btn-Jig)').forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = 'none';
      menuPanel.style.cursor = 'not-allowed';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = 'auto';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = 'auto';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  function unlockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button, .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.filter = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });
    document.querySelectorAll('a').forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = '';
      menuPanel.style.cursor = '';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = '';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = '';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  var modal = document.getElementById("trayScanModal_DayPlanning");
  var closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");

  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link) {
    link.addEventListener('click', function() {
      setTimeout(lockParentActions, 100);
    });
  });

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      setTimeout(unlockParentActions, 200);
    });
  }
});
</script>

{% endblock %}
{% endblock content %}