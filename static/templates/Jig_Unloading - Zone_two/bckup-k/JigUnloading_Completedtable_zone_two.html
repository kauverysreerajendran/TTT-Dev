{% extends "base.html" %} 
{% load static %} 
{% load stock_filters %}
{% load custom_tags %}
{% block content %}
<style>
  /* ========== Tablet override â€” paste at file end (after other table styles) ========== */
/* --- Tablet: freeze first 3 columns consistently with desktop --- */
@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {

*{
  font-size: 20px !important; /* Increase font size for better readability */
}

:root { --app-font-size: 20px; }

.rounded-circle{
  padding: 17px !important;
}

.model-image-tooltip{
  transform: translateX(-25%) !important;
  top: 45% !important;
  z-index: 500000 !important; /* high so it sits above table & scrollbar */

}


  /* Core layout blocks */
  .content-wrapper,
  .card, .card-body,
  .table-responsive,
  #order-listing,
  #trayScanModal_DayPlanning,
  .tray-scan-modal-DayPlanning,
  .pagination-wrapper {
    font-size: var(--app-font-size) !important;
    line-height: 1.35 !important;
  }

  /* Table headings / cells / icons */
  #order-listing th,
  #order-listing td,
  #order-listing thead th {
    font-size: var(--app-font-size) !important;
    vertical-align: middle !important;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  /* Ensure heading/title and date controls match */
  h4.text-left.mt-0.mb-3,
  .calendar-bar .date-input-group label,
  .calendar-bar .date-input-group input,
  #search-date-range-simple,
  #clear-date-filter-simple,
  .calendar-btn,
  #trayScanModal_DayPlanning input.form-control,#trayValidateBtn,
  #trayScanModal_DayPlanning table th, #trayScanModal_DayPlanning table td,
  #modalModelNo_DayPlanning
 {
    font-size: var(--app-font-size) !important;
  }  

  /* Reserve space for filter icons in header cells */
#order-listing th {
  position: relative;
  overflow: visible !important;
  white-space: normal !important; /* allow wrapping */
}

/* Ensure filter icons always stay to the right */
#order-listing th .fa-filter {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px !important;
  opacity: 0.8;
  cursor: pointer;
}

  /* Column 1 */
  #order-listing th:nth-child(1),
  #order-listing td:nth-child(1) {
    position: sticky;
    left: 0 !important;
    min-width: 90px !important;
    max-width: 90px !important;
    background: #f7fafd;
    z-index: 30;
  }

  /* Column 2 */
  #order-listing th:nth-child(2),
  #order-listing td:nth-child(2) {
    position: sticky;
    left: 90px !important;   /* = width of col1 */
    min-width: 125px !important;
    max-width: 125px !important;
    background: #f7fafd;
    z-index: 25;
  }

  /* Column 3 */
  #order-listing th:nth-child(3),
  #order-listing td:nth-child(3) {
    position: sticky;
    left: 215px !important;  /* 75 (col1) + 100 (col2 min) */
    min-width: 140px !important;
    max-width: 140px !important;
    background: #f7fafd;
    z-index: 20;
  }

  /* Sticky header */
  #order-listing thead th {
    position: sticky;
    top: 0;
    z-index: 40;
    background: #028084 !important;
    color: #e5fcff !important;
  }
}

@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {
  .table-container {
    overflow-x: auto;
  }

  /* Other columns (fit remaining space) */
  #order-listing th:nth-child(4)  { min-width: 135px !important; max-width: 135px !important; }
  #order-listing th:nth-child(5)  { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(6)  { min-width: 135px !important; max-width: 135px !important; }
  #order-listing th:nth-child(7)  { min-width: 135px !important; max-width: 140px !important; }
  #order-listing th:nth-child(8)  { min-width: 120px !important; max-width: 130px !important; }
  #order-listing th:nth-child(9)  { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(10) { min-width: 150px !important; max-width: 150px !important; }
  #order-listing th:nth-child(11) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(12) { min-width: 130px !important; max-width: 140px !important; }
  #order-listing th:nth-child(13) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(14) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(15) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(16) { min-width: 120px !important; max-width: 130px !important; }
  #order-listing th:nth-child(17) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(18) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(19) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(20) { min-width: 130px !important; max-width: 130px !important; }


  /* Prevent overlap */
  #order-listing th:nth-child(-n+3),
  #order-listing td:nth-child(-n+3) {
    z-index: 45 !important;
  }

  /* Hide hidden columns */
  #order-listing th[hidden],
  #order-listing td[hidden] {
    display: none !important;
  }
}     
/* Add to your CSS file for Excel-like grid lines */
.table-bordered th, .table-bordered td {
  border: 1px solid #d9dedf !important;
}
  /* Make the table header sticky */
thead th {
  position: sticky;
  top: 0;
  background-color: white; /* or your table header bg color */
  z-index: 5; /* ensure it stays above the table rows */
  
}

#order-listing thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important;
  color: #e5fcff !important;
  vertical-align: middle !important;
  border-bottom: 2.5px solid #bdbdbd !important; /* Thicker grey line below heading */
}
/* style for hol/unhold row - blurred bg */
#order-listing tr:last-child td {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
  /* background: #f4f3f3 !important; */
}
/* Gird line color combination */
#order-listing th,
#order-listing td {
  border-right: 1.5px solid #bababa !important; /* Vertical lines: blue */
  border-bottom: 1.5px solid #121413 !important; /* Horizontal lines: green */
}

  
/* Default: Desktop/Laptop (wider columns for larger font) - server */
/* #order-listing th:nth-child(1) {
  min-width: 90px;
  max-width: 90px;
} */ /* S.No */
/* #order-listing th:nth-child(2) {
  min-width: 90px;
  max-width: 100px;
} */ /* Last Updated */
/* #order-listing th:nth-child(3) {
  min-width: 90px;
  max-width: 120px;
} */ /* Plating */
#order-listing th:nth-child(4) {
  min-width: 110px;
  max-width: 120px;
} /* Polishing Stk No */
#order-listing th:nth-child(5) {
  min-width: 105px;
  max-width: 105px;
} /* Plating Color */
#order-listing th:nth-child(6) {
  min-width: 100px;
  max-width: 110px;
} /* Category */
#order-listing th:nth-child(7) {
  min-width: 85px;
  max-width: 95px;
} /* Polish Finish */
#order-listing th:nth-child(8) {
  min-width: 110px;
  max-width: 110px;
} /* Version */
#order-listing th:nth-child(9) {
  min-width: 105px;
  max-width: 105px;
} /* Tray Cate-Capacity */
#order-listing th:nth-child(10) {
  min-width: 115px;
  max-width: 115px;
} /* Source */
#order-listing th:nth-child(11) {
  min-width: 80px;
  max-width: 80px;
} /* No of Trays */
#order-listing th:nth-child(12) {
  min-width: 100px;
  max-width: 105px;
} /* Input Qty */
#order-listing th:nth-child(13) {
  min-width: 95px;
  max-width: 100px;
} /* Process Status */
#order-listing th:nth-child(14) {
  min-width: 90px;
  max-width: 100px;
} /*  Action */
#order-listing th:nth-child(15) {
  min-width: 90px;
  max-width: 100px;
} /* Lot Status */
#order-listing th:nth-child(16) {
  min-width: 100px;
  max-width: 100px;
} /* Current Stage */
#order-listing th:nth-child(17) {
  min-width: 110px;
  max-width: 100px;
} /* Remarks */
#order-listing th:nth-child(18) {
  min-width: 100px;
  max-width: 110px;
}

@media (min-width: 600px) and (max-width: 900px) {
  #order-listing {
    table-layout: auto !important; /* Let columns auto-fit content */
    width: 100% !important;
    min-width: unset !important;
    max-width: 100vw !important;
  }
  /* Adjust width for all headings (th) and cells (td) */
  #order-listing th,
  #order-listing td {
    min-width: 160px !important;
    max-width: 260px !important;
    width: 180px !important;
  }
  #order-listing th {
    position: relative;
    padding-right: 48px !important; /* More space for filter icon */
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: ellipsis;
  }
  #order-listing th .fa-filter {
    position: absolute;
    right: 18px !important;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    background: transparent;
    pointer-events: auto;
  }
}
/* Right-align filter icons */
#order-listing th .fa-filter {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.7;
  cursor: pointer;
  transition: opacity 0.2s;
}

#order-listing th .fa-filter:hover {
  opacity: 1;
}


  
#order-listing th:last-child,
#order-listing td:last-child {
  border-right: none;
  max-width: 95px;
  min-width: 100px;
}
/* Overall Table Shrink */
#order-listing tr,
#order-listing td,
#order-listing th {
  height: 20px !important;
  padding-top: 2px !important;
  padding-bottom: 2px !important;
  padding-left: 6px !important;
  padding-right: 6px !important;
}
/* Table heading font size */
/* Add this at the end of your <style> block in DP_PickTable.html */

/* Professional table header styling with proper text wrapping */
#order-listing th {
  position: relative;
  padding: 8px 12px 8px 16px !important;
  text-align: left !important;
  vertical-align: middle !important;
  white-space: normal !important;
  line-height: 1.3 !important;
  word-break: keep-all !important;
  hyphens: none !important;
  /* font-size: 13px; */
  /* font-weight: 600 !important; */
  background: #028084 !important;
  color: #e5fcff !important;
  border-bottom: 2.5px solid #bdbdbd !important;
  /* min-width: 80px;
  max-width: 140px; */
   overflow-wrap: break-word;
  word-wrap: break-word;
   z-index: 20 !important;
}

/* Make sure header cells for sticky columns are always above body cells */
/* Fix: Prevent shadow/rows from showing behind sticky columns while scrolling */
#order-listing th:nth-child(-n+3),
#order-listing td:nth-child(-n+3) {
  z-index: 30 !important; 
box-shadow: 2px 0 8px rgba(0,0,0,0.04);
}

/* Prevent sticky columns from overlapping sticky header */
#order-listing td:nth-child(-n+3) {
  z-index: 11 !important;
}
  /* Make the first column sticky and opaque */
#order-listing td:first-child,
#order-listing th:first-child {
  position: sticky;
  left: 0;
  background: #fff;      /* Or match your table background */
  z-index: 2;            /* Above blurred rows */
  box-shadow: 2px 0 4px rgba(0,0,0,0.03); /* Optional: subtle shadow */
}
/* Force specific table headers to wrap onto two lines */
#order-listing th:nth-child(4),   /* Polishing Stk No */
#order-listing th:nth-child(5),   /* Plating Color */
#order-listing th:nth-child(7),   /* Polish Finish */
#order-listing th:nth-child(9),   /* Tray Cate-Capacity */
#order-listing th:nth-child(11),  /* No of Tray */
#order-listing th:nth-child(12),  /* Input Qty */
#order-listing th:nth-child(13)   /* Process Status */ {
  white-space: normal !important;
  line-height: 1.2 !important;
  word-break: break-word !important;

  text-align: center;
  vertical-align: middle;
  padding-top: 5px !important;
  padding-bottom: 5px !important;
}
/* Freeze style for 1st - 3 columns */
/* --- Freeze first 3 columns and table header for #order-listing --- */
#order-listing {
  position: relative;
  border-collapse: separate !important;
  border-spacing: 0;
  background: #fff;
  /* Ensure enough left padding for sticky columns */
}

#order-listing th,
#order-listing td {
  background-clip: padding-box;
  /* Prevent overlap artifacts */
  z-index: 1;
}

/* Sticky header */
#order-listing thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #028084 !important;
  color: #e5fcff !important;
}

/* Freeze 1st column */
#order-listing th:nth-child(1),
#order-listing td:nth-child(1) {
  position: sticky;
  left: 0 !important;
  z-index: 12; /* Above header */
  background: #f7fafd;
  min-width: 75px;
  max-width: 75px;
}

/* Freeze 2nd column - Last Updated*/
#order-listing th:nth-child(2),
#order-listing td:nth-child(2) {
  position: sticky;
  left: 75px; /* Match min-width of 1st col */
  z-index: 12;
  background: #f7fafd;
  min-width: 100px; /* Increased width */
  max-width: 110px; /* Increased width */
}

/* Freeze 3rd column */
#order-listing th:nth-child(3),
#order-listing td:nth-child(3) {
  position: sticky;
  left: 175px; /* 100px (1st) + 90px (2nd) */
  z-index: 12;
  background: #f7fafd;
  min-width: 130px; /* Increased width 100 - old value*/
  max-width: 140px; /* Increased width  110 - old value*/
}

/* Prevent sticky columns from overlapping sticky header */
#order-listing th:nth-child(-n + 3) {
  z-index: 12;
}
#order-listing td:nth-child(-n + 3) {
  z-index: 11;
}

/* Ensure sticky columns and header work together */
#order-listing th,
#order-listing td {
  box-sizing: border-box;
  /* Prevent content shake */
  /* overflow: hidden; */
  text-overflow: ellipsis;
  white-space: nowrap;
}



    .blurred-heading, .blurred-cell {
    filter: blur(2px) grayscale(0.7) opacity(0.6);
    pointer-events: none !important;
    user-select: none;
    cursor: not-allowed;
    background: #f5f5f5 !important;
  }
    /* Show remark tooltip above the trigger instead of below */
  .remark-tooltip {
    top: auto !important;
    bottom: 110% !important;
  }
#trayScanDetails.table-grid {
  display: grid !important;
  grid-template-columns: 94px 175px 150px !important;
  gap: 0px !important;
  max-height: 300px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding-right: 10px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

#trayScanDetails.table-grid::-webkit-scrollbar {
  width: 8px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb:hover {
  background: #555;
}
 
 
.tray-scan-modal.open {
  width:500px !important;
}
/* For the 4-column layout (with validation status) */
#trayScanDetails.table-grid.four-column {
  grid-template-columns: 50px 1fr 100px 140px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
}
 
/* Styling individual grid cells, only inside trayScanDetails */
#trayScanDetails.table-grid > div {
  background: #f7f7f7;
  padding: 8px 12px;
  font-size: 12px;
  border: 1px solid #ddd;
  margin: 0; /* reset any margin from <p> or others */
}
 
/* S.no column specific styling */
#trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
  text-align: center;
  font-weight: 600;
  padding: 8px 4px; /* Reduced horizontal padding for S.no */
}
 
/* For mobile responsiveness */
@media (max-width: 768px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 45px 1fr 1fr !important; /* Even smaller S.no column on mobile */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 40px 1fr 80px 100px !important;
  }
  #trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
    padding: 6px 2px; /* Further reduced padding on mobile */
    font-size: 11px;
  }
}
 
/* For very small screens */
@media (max-width: 480px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 35px 1fr 80px !important; /* Minimal S.no column */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 30px 1fr 70px 90px !important;
  }
}
.row-checkbox, #selectAllCheckbox {
  display: none;
}
body.add-model-mode .row-checkbox,
body.add-model-mode #selectAllCheckbox {
  display: inline-block;
}


        /* Model Image Gallery Styles */
        
        /* General model circle styling */
        .model-circle {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: -7px; /* Adjust this value for more/less space */
        }

        /* Compact and responsive modal for model/stock no */
        #modelRemarkModal {
            display: none;
            position: fixed;
            top: 6vh;
            right: 2vw;
            transform: none;
            z-index: 20000;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            min-width: 320px;
            max-width: 420px;
            min-height: 400px;
            max-height: 500px;
            padding: 18px 32px 12px 32px;
            overflow-y: auto;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            #modelRemarkModal {
                right: 0;
                max-width: 98vw;
                min-width: 0;
                width: 98vw;
                padding: 10px 4vw 10px 4vw;
                font-size: 11px;
            }
        }

        #modelRemarkModalContent {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #modelRemarkModal .close-btn,
        #closeModelRemarkModal {
            position: absolute;
            top: 6px;
            right: 12px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        #modelRemarkModal img {
            max-width: 54px;
            max-height: 54px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #fafafa;
        }

        #modelRemarkModal .model-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 2px;
        }

        #modelRemarkModal .model-circle {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 2px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        #modelRemarkModal .model-no {
            font-weight: 600;
            color: #023E4DCC;
            font-size: 0.98rem;
            margin-bottom: 2px;
        }

        #modelRemarkModal .remark-label {
            font-size: 11px;
            color: #222;
            margin-bottom: 1px;
        }

        #modelRemarkModal .remark-text {
            font-size: 11px;
            color: #444;
            background: #f7f7f7;
            border-radius: 5px;
            padding: 5px 8px;
            min-width: 80px;
            min-height: 18px;
            margin-bottom: 0;
        }

        @media (max-width: 600px) {
            #modelRemarkModal {
                left: 0;
                top: 0;
                width: 98vw;
                max-width: 98vw;
                min-width: 0;
                padding: 8px 4px 8px 4px;
                font-size: 11px;
                max-height: 60vh;
            }
            
            #modelRemarkModal img {
                max-width: 38px;
                max-height: 38px;
            }
            
            #modelRemarkModal .model-no {
                font-size: 0.92rem;
            }
            
            #modelRemarkModal .remark-label,
            #modelRemarkModal .remark-text {
                font-size: 10px;
            }
        }

        /* Tooltip for model images */
        .model-image-tooltip {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            padding: 10px;
            min-width: 220px;
            max-width: 350px;
            max-height: 220px;
            display: none;
            overflow: hidden;
        }

        .model-image-tooltip .image-slider {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-image-tooltip img {
            max-width: 180px;
            max-height: 180px;
            object-fit: contain;
            border-radius: 4px;
        }

        .model-image-tooltip .slider-btn {
            background: #eee;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            cursor: pointer;
        }

        .model-image-tooltip.static {
            display: block !important;
            position: fixed !important;
            top: 80px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 100000;
        }

        .model-image-tooltip .close-btn {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        /* Image slider modal */
        .image-slider-modal {
            display: none;
            position: fixed;
            top: 40px;
            right: 20px;
            width: 600px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 10000;
            transition: right 0.3s ease;
        }

        .image-slider-modal.open {
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .slider {
            position: relative;
            overflow: hidden;
            height: 350px;
        }

        .slides {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
        }

        .slide {
            flex: 0 0 100%;
            box-sizing: border-box;
            display: none;
        }

        .slide.active {
            display: block;
        }

        .slide img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            display: block;
        }

        .prev,
        .next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #fff;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            user-select: none;
        }

        .prev {
            left: 10px;
        }

        .next {
            right: 10px;
        }

        @media (max-width: 767px) {
            .image-slider-modal {
                width: 100%;
                right: 0;
                top: 0;
                border-radius: 0;
                padding: 10px;
            }
            
            .slider {
                height: 250px;
            }
            
            .slide img {
                height: 250px;
            }
        }

        /* Add Jig Remark Modal Styles */
        
        /* Modal backdrop styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1040;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        .modal-backdrop.fade {
            opacity: 0;
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }

        /* Modal base styles */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1050;
            display: none;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            outline: 0;
        }

        .modal.show {
            display: block !important;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Remarks modal specific styles */
        #remarksModal .modal-dialog {
            max-width: 500px;
            margin: 1.75rem auto;
        }

        #remarksModal .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #remarksModal .modal-header {
            border-bottom: none;
            padding: 0;
        }

        #remarksModal .modal-body {
            padding: 1rem 2rem 2rem 2rem;
        }

        #remarksModal .modal-title {
            color: #023E4DCC;
            font-weight: 700;
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Loading spinner styles */
        #remarksLoadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        #remarksLoadingSpinner .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.25em;
        }

        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .text-primary {
            color: #007bff !important;
        }

        /* Form styles for remarks modal */
        #remarksModalForm .form-control {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #remarksModalForm .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #remarksModalForm .form-check-input {
            width: 1em;
            height: 1em;
            margin-top: 0.25em;
            vertical-align: top;
            background-color: #fff;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            border: 1px solid rgba(0, 0, 0, 0.25);
            appearance: none;
            color-adjust: exact;
        }

        #remarksModalForm .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        #remarksModalForm .form-check-input[type="radio"] {
            border-radius: 50%;
        }

        #remarksModalForm .form-check-input[type="radio"]:checked {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e");
        }

        #remarksModalForm .btn {
            display: inline-block;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            border-radius: 0.375rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #remarksModalForm .btn-primary {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        #remarksModalForm .btn-primary:hover {
            color: #fff;
            background-color: #0056b3;
            border-color: #004085;
        }

        #remarksModalForm .btn-secondary {
            color: #fff;
            background-color: #6c757d;
            border-color: #6c757d;
        }

        #remarksModalForm .btn-secondary:hover {
            color: #fff;
            background-color: #545b62;
            border-color: #4e555b;
        }

        /* Character count styling */
        #remarksCharCount {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 0.75rem;
            pointer-events: none;
        }

        /* Position relative for character count container */
        .position-relative {
            position: relative !important;
        }

        /* Bootstrap utility classes used in the modal */
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin-top: calc(-0.5 * 0);
            margin-right: calc(-0.5 * 1.5rem);
            margin-left: calc(-0.5 * 1.5rem);
        }

        .col-5 {
            flex: 0 0 auto;
            width: 41.66666667%;
        }

        .col-7 {
            flex: 0 0 auto;
            width: 58.33333333%;
        }

        .col-12 {
            flex: 0 0 auto;
            width: 100%;
        }

        .d-flex {
            display: flex !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .justify-content-center {
            justify-content: center !important;
        }

        .gap-3 {
            gap: 1rem !important;
        }

        .text-end {
            text-align: right !important;
        }

        .fw-bold {
            font-weight: 700 !important;
        }

        .px-4 {
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
        }

        .me-2 {
            margin-right: 0.5rem !important;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            opacity: 0.5;
            background: transparent;
            border: 0;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.75;
        }

        .position-absolute {
            position: absolute !important;
        }

        .end-0 {
            right: 0 !important;
        }

        .top-0 {
            top: 0 !important;
        }

        .m-2 {
            margin: 0.5rem !important;
        }
</style>
<!-- Model/Stock No Modal Popup -->
<div id="modelRemarkModal">
  <span id="closeModelRemarkModal">&times;</span>
  <div style="font-weight:700; font-size:18px; color:#616161; margin-bottom:20px; margin-top:4px; text-align:center;">
    Model Image Gallery
  </div>
  <div id="modelRemarkModalContent"></div>
</div>

<div class="content-wrapper">
  <!-- <h5 class="text-left mt-0 mb-3">Day Planning Pick Table</h5> -->
  
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
          <div class="card-body">
            <h5 class="text-left mt-0 mb-4" style="font-weight:700;">Jig Unloading Completed Table Zone II</h5>
                      <!-- ðŸ”¥ NEW: Date Filter Section -->
          <div class="calendar-bar">
            <div class="date-input-group">
              <label for="from-date-simple" style="font-weight: 600; color: #028084; margin-right: 8px;">From Date:</label>
              <input type="date" id="from-date-simple" name="from_date" 
                     value="{{ from_date }}" 
                     max="{{ 'now'|date:'Y-m-d' }}"
                     style="border: 1.5px solid #028084; border-radius: 6px; padding: 6px 12px; font-size: 14px; color: #028084; font-weight: 600;">
            </div>
            
            <div class="date-input-group">
              <label for="to-date-simple" style="font-weight: 600; color: #028084; margin-right: 8px;">To Date:</label>
              <input type="date" id="to-date-simple" name="to_date" 
                     value="{{ to_date }}" 
                     max="{{ 'now'|date:'Y-m-d' }}"
                     style="border: 1.5px solid #028084; border-radius: 6px; padding: 6px 12px; font-size: 14px; color: #028084; font-weight: 600;">
            </div>
            
            <button id="search-date-range-simple" type="button" style="background: #028084; border: none; border-radius: 6px; cursor: pointer; padding: 8px 18px; color: #fff; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px;">
              <i class="fa fa-search"></i> Search
            </button>
            
            <button id="clear-date-filter-simple" type="button" style="background: #6c757d; border: none; border-radius: 6px; cursor: pointer; padding: 8px 18px; color: #fff; font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 6px; margin-left: 10px;">
              <i class="fa fa-times"></i> Clear Filter
            </button>
                                              <!-- Filter Active indicator - positioned above table -->
        <div id="filterActiveIndicator" style="display: none; margin: 10px 0;">
          <span style="font-size: 12px; color: #fff; font-weight: 600; background: #28a745; padding: 5px 12px; border-radius: 15px; border: 1px solid #1e7e34; display: inline-block;">Filter Active</span>
        </div>
          </div>

          <input type="hidden" id="from-date" value="{{ from_date }}" />
          <input type="hidden" id="to-date" value="{{ to_date }}" />
          <!-- ðŸ”¥ END: Date Filter Section -->

            <!-- Table Section -->
            <div class="table-responsive" style="overflow: scroll !important">
            <table id="order-listing" class="table">
                <thead>
                  <tr>
                    <th>S.No <i class="fa fa-filter" aria-hidden="true"></i>
                      <input type="checkbox" id="selectAllCheckbox" title="Select All" />
                    </th>
                    <th>JIG ID <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Last<br>Updated <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Plating<br>Stk No<i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Polishing<br>Stk No<i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Plating <br> Color <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Polish <br> Finish <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Version <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Source-Location <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Tray Cate - Capacity <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Lot Qty <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>No of Trays <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Process Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Action <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Batch Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Current Location <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Remarks <i class="fa fa-filter" aria-hidden="true"></i></th>
                  </tr>
                </thead>
                <tbody>
                  {% for jig_detail in completed_unloads %}
                    <tr class="highlighted-tray-scan" data-lot-id="{{ jig_detail.lot_id }}" data-lot-id-quantities='{{ jig_detail.lot_id_quantities|json_encode }}' data-lot-id-model-map='{{ jig_detail.lot_id_model_map|json_encode }}'>
                      <!-- S.No with checkbox -->
                      <td><span class="sno-value">{{ forloop.counter }}</span>
                      </td>
                      
                      <!-- JIG ID -->
                      <td>{{ jig_detail.jig_qr_id }}</td>
                      
                      <!-- Last Updated -->
                      <td>
                        {{ jig_detail.Un_loaded_date_time|date:"d-M-y" }}<br>
                        <span style="display:inline-block; margin-top:4px;word-break: break-all;">{{ jig_detail.Un_loaded_date_time|date:"h:i A" }}</span>
                      </td>

                      <td>{{ jig_detail.all_plating_stk_nos|join:", " }}</td>
                      <td>{{ jig_detail.all_polishing_stk_nos|join:", " }}</td>

                                            
                      <!-- Plating Color -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>
                        {{ jig_detail.plating_color|highlight_plating_color|safe|default:"N/A" }}
                      </td>                      
                      <!-- Polish Finish -->
                      <td>{{ jig_detail.polish_finish|default:"N/A" }}</td>

                      <!-- Version -->
                      <td>{{ jig_detail.all_versions|join:", "|default:"N/A" }}</td>

                      <!-- Source-Location -->
                      <td>
                        {% for location in jig_detail.unique_locations %}
                          {{ location }}{% if not forloop.last %}, {% endif %}
                        {% empty %}
                          {{ jig_detail.location|default:"N/A" }}
                        {% endfor %}
                      </td>
                      
                     <!-- Tray Cate - Capacity (now uses tray_type and tray_capacity) -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% if jig_detail.tray_type and jig_detail.tray_capacity %}
                          {% if jig_detail.tray_capacity == 20 %}
                            <div class="tray-capacity-badge normal-tray"
                                 style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; text-align: center; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                 title="Normal Tray - 20 Capacity (Custom for Jig Unloading Zone 2)">
                              Normal - 20                             </div>
                          {% elif jig_detail.tray_capacity == 12 %}
                            <div class="tray-capacity-badge jumbo-tray"
                                 style="background: #28a745; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; text-align: center; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                 title="Jumbo Tray - 12 Capacity (RED, DARK GREEN & LITE GREEN)">
                              Jumbo - 12
                            </div>
                          {% else %}
                            <div class="tray-capacity-badge other-tray"
                                 style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; text-align: center;"
                                 title="{{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }} Capacity">
                              {{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }}
                            </div>
                          {% endif %}
                        {% else %}
                          <span style="color: #6c757d; font-style: italic; font-size: 12px;">No Tray Info</span>
                        {% endif %}
                      </td>
                      <!-- Lot Qty -->
                      <td>
                        {% if jig_detail.lot_id_quantities %}
                          {{ jig_detail.lot_id_quantities.values|join:", "|default:"0" }}
                        {% else %}
                          {{ jig_detail.total_case_qty|default:"0" }}
                        {% endif %}
                      </td>
                      
                      <!-- No of Trays -->
                      <td>{{ jig_detail.calculated_no_of_trays|default:"0" }}</td>

                      <!-- Process Status -->
                      <td>
                        {% if jig_detail.jig_unload_draft %}
                          <!-- Half green filled circle for draft -->
                          <div title="Draft (Halfway Unloaded)" style="
                            background: linear-gradient(to right, #0c8249 0 50%, #ccc 50% 100%);
                            color: #fff;
                            border-radius: 50%;
                            width: 20px;
                            height: 20px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-weight: 500;
                            line-height: 20px;
                            text-align: center;
                            padding-top: 1px;
                            padding-right: 1px;
                            padding: 15px !important;
                          ">UL</div>
                        {% else %}
                          <div style="background:#0c8249;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;padding: 15px !important;" title="Completed">UL</div>
                        {% endif %}
                      </td>

                      <!-- Action -->
                      <td>
                        <span class="status-badge accepted" style="
                          background-color: #66bb6a; 
                          color: white; 
                          padding: 6px 12px; 
                          border-radius: 20px; 
                          font-size: 12px; 
                          font-weight: 600;
                          display: inline-flex;
                          align-items: center;
                          gap: 4px;
                        ">
                          <i class="fa fa-check-circle"></i>Unloaded
                        </span>
                        <a href="#" class="text-primary tray-scan-btn-Jig unload-modal-trigger" style="text-decoration: underline"
                          data-jig-id="{{ jig_detail.id }}"
                          data-lot-id="{{ jig_detail.lot_id }}"
                          data-lot-id-list='{{ jig_detail.lot_id_list|json_encode }}'
                          data-model-list='{{ jig_detail.no_of_model_cases|json_encode }}'
                          data-model-images='{{ jig_detail.model_images|json_encode }}'
                          data-lot-id-quantities='{% if jig_detail.lot_id_quantities %}{{ jig_detail.lot_id_quantities|json_encode }}{% else %}{}{% endif %}'
                          data-no-of-trays="{{ jig_detail.calculated_no_of_trays }}" 
                          data-tray-capacity="{{ jig_detail.jig_capacity }}"
                          data-plating-stk-no="{{ jig_detail.plating_stk_no }}"
                          data-model-no="{{ jig_detail.plating_stk_no }}"
                             data-total-case-qty="{{ jig_detail.total_case_qty|default:'0' }}">
                            <img src="{% static 'assets/icons/view.png' %}"
                                 alt="View"
                            style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;" />                        </a>
                      </td>
                      
                      <!-- Batch Status -->
                      <td>
                        {% if jig_detail.last_process_module == "Jig Unloading" %}
                          <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                            style="border: 2px solid #b3b3b3; background-color: #f5f5f5; color: #888; font-size: 12px; white-space: nowrap; padding: 6px;">
                            Yet to Release
                          </div>
                        {% else %}
                          <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                            style="border: 2px solid #007bff; background-color: #e3f2fd; color: #0d47a1; font-size: 12px; white-space: nowrap; padding: 6px;">
                            Released
                          </div>
                        {% endif %}
                      </td>
                      
                      <!-- Current Location -->
                      <td>
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="border: 1px solid #9adeed; background-color: #d1edf3; color: #033b5d; font-size: 12px; white-space: nowrap; padding: 6px;">
                            {{ jig_detail.last_process_module }}
                        </div>
                      </td>
                      
                      <td>

                        <!-- Audio Remark Icon -->
                        {% if data.audio_remark %}
                          <span class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: default;">
                            <img src="{% static 'assets/icons/rec.png' %}" alt="Audio Remark" style="width: 20px; height: 20px;" />
                            <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
                              
                              <span style="font-size: 12px; color: #333;">Audio remark available</span>
                            </div>
                          </span>
                        {% else %}
                          <span title="No audio remark" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; opacity: 0.5; cursor: not-allowed;">
                            <img src="{% static 'assets/icons/rec.png' %}" alt="Audio Remark Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                          </span>
                        {% endif %}

                        <!-- Text Remark Icon -->
                        {% if jig_detail.unloading_remarks %}
                          <span class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: default;">
                            <img src="{% static 'assets/icons/chat_icon.png' %}" alt="Chat"
                              style="width: 20px; height: 20px; filter: grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2); opacity: 1;" />
                            <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
                              
                              <div style="font-size: 12px; color: #333;">{{ jig_detail.unloading_remarks }}</div>
                            </div>
                          </span>
                        {% else %}
                          <span title="No remarks" style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; opacity: 0.5; cursor: not-allowed;">
                            <img src="{% static 'assets/icons/chat_icon.png' %}" alt="Chat Disabled" style="width: 20px; height: 20px; filter: grayscale(1) opacity(0.5);" />
                          </span>
                        {% endif %}

                      </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="17" style="text-align: center; padding: 20px; color: #888;">
                        No completed unloads found.
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>


              <!-- Tray Scan Modal -->
                <div id="trayScanModal_DayPlanning" class="tray-scan-modal-DayPlanning"style="display:none"> 
                  <div class="tray-scan-modal-DayPlanning-content">
                    <span id="closeTrayScanModal_DayPlanning" class="tray-scan-close-readonly">&times;</span>
                    
                    <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
                      <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
                        <div id="modalModelImages_DayPlanning" style="display: flex; gap: 6px;">
                            <!-- Model images will be injected here by JS -->
                            <img id="modalUserImg_DayPlanning" src="{% static 'assets/images/imagePlaceholder.png' %}" alt="Model Image" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
                          </div>                        
                          <!-- Model No and Lot Qty in same line -->
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                          <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <span style="font-weight: bold; color: #666;">Model No:</span>
                              <h6 id="modalModelNo_DayPlanning" style="margin: 0; color: #028084; font-weight: bold;">(Fetch Dynamically)</h6>
                            </div>
                          <h7 style="margin: 0; color: #666666; font-weight: bold;">
                              Lot Qty: <span id="modalLotQty_DayPlanning" style="font-weight:bold; color:#e67e22;"></span>
                          </h7>
                          </div>
                            
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                        Jig Unloading - Tray Scan 
                      </h5>
                      <button id="trayValidateBtn" type="button" style="display: flex; align-items: center; gap: 6px; background: #f5faff; border: 1px solid #023E4DCC; color: #023E4DCC; border-radius: 20px; padding: 4px 14px; font-size: 12px; font-weight: 500; cursor: pointer;">
                        
                        Tray Validate
                      </button>
                      <input id="trayValidateInput" type="text" placeholder="Enter validation info..." style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" />
                      <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="trayScanRedoBtn" style="width: 24px; height: 24px; cursor: pointer; margin-left: 8px;" title="Clear Tray IDs" />
                    </div>
                    <div id="trayErrorMessage" style="display: none; background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                      <span id="trayErrorText"></span>
                    </div>
                    <div id="trayScanDetails_DayPlanning" class="table-grid">
                      <!-- Headers and dynamic content will be injected here -->
                    </div>
                  </div>
                </div>  
               </div>
              
              <!-- Tray Scan (hyperlink) - Right side modal -->
              <div id="trayScanModal" class="tray-scan-modal active">
                <!-- Modal content will be populated by JavaScript -->
              </div>
            </div>
            
            <!-- Pagination Section -->
            <div class="pagination-wrapper">
              <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end mb-0">
                  {# Previous button #}
                  {% if page_obj.has_previous %}
                    <li>
                      <a href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                    </li>
                  {% endif %}
                
                  {# Always show first page #}
                  {% if page_obj.number > 3 %}
                    <li><a href="?page=1">1</a></li>
                    {% if page_obj.number > 4 %}
                      <li class="disabled"><span>â€¦</span></li>
                    {% endif %}
                  {% endif %}
                
                  {# Show pages around current page #}
                  {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                      {% if num == page_obj.number %}
                        <li class="active"><span>{{ num }}</span></li>
                      {% else %}
                        <li><a href="?page={{ num }}">{{ num }}</a></li>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                
                  {# Show ellipsis and last page if needed #}
                  {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                      <li class="disabled"><span>â€¦</span></li>
                    {% endif %}
                    <li><a href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                  {% endif %}
                
                  {# Next button #}
                  {% if page_obj.has_next %}
                    <li>
                      <a href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            </div>

            
        </div>
      </div>
    </div>
  </div>
</div>



{% block script %}



<!-- Script for table sorting functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const table = document.getElementById("order-listing");
  if (!table) {
    console.warn("Table with ID 'order-listing' not found.");
    return;
  }

  const headers = table.querySelectorAll("thead th");
  const tbody = table.querySelector("tbody");
  let sortDirection = {};

  headers.forEach((header, index) => {
    header.style.cursor = "pointer";

    header.addEventListener("click", function () {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const dir = sortDirection[index] === "asc" ? "desc" : "asc";
      sortDirection[index] = dir;

      rows.sort((a, b) => {
        const cellA = a.children[index].textContent.trim();
        const cellB = b.children[index].textContent.trim();
        const valA = isNaN(cellA) ? cellA : parseFloat(cellA);
        const valB = isNaN(cellB) ? cellB : parseFloat(cellB);

        if (valA < valB) return dir === "asc" ? -1 : 1;
        if (valA > valB) return dir === "asc" ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = "";
      rows.forEach((row) => tbody.appendChild(row));
    });
  });
});
</script>


 
<!-- Script for View Icon Tray validate -->
// Replace your existing tray validation scripts with these fixed versions

// Script 1: Redo Button Handler
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const redoBtn = document.getElementById("trayScanRedoBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (redoBtn && validateInput) {
    redoBtn.addEventListener("click", function () {
      validateInput.value = "";
      validateInput.blur();
      
      // Hide error message
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Reset button to normal state (original blue color)
      const validateBtn = document.getElementById("trayValidateBtn");
      if (validateBtn) {
        validateBtn.style.background = "#f5faff";
        validateBtn.style.borderColor = "#023E4DCC";
        validateBtn.style.color = "#023E4DCC";
      }
      
      // Remove the 4th column from the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table without validation column
        detailsDiv.innerHTML = modal.buildTableHTML(false);
      }
      
      redoBtn.focus();
    });
  }
});
</script>

// Script 2: Tray Validate Button Handler
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const validateBtn = document.getElementById("trayValidateBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (validateBtn && validateInput) {
    validateBtn.addEventListener("click", function () {
      validateInput.value = "";
      
      // Hide error message when starting new validation
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Change button to active state (green color)
      validateBtn.style.background = "#e8f5e8";
      validateBtn.style.borderColor = "#4caf50";
      validateBtn.style.color = "#2e7d32";
      
      // Add the 4th column to the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table with validation column
        detailsDiv.innerHTML = modal.buildTableHTML(true);
      }
      
      // Focus the hidden input so it can receive keystrokes
      validateInput.focus();
    });
  }
});
</script>

// Script 3: Updated Modal Script with buildTableHTML function
<script nonce="{{ csp_nonce }}">
// Enhanced JavaScript for modal popup with tray validation support
document.addEventListener("DOMContentLoaded", function () {
  console.log("ðŸš€ Modal script loaded");
  
  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link, index) {
    console.log(`ðŸ”Œ Found tray scan button ${index + 1}`);
    
    link.addEventListener('click', async function (e) {
      e.preventDefault();
      console.log("ðŸ”¥ View icon clicked!");

      // Get modal elements
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");

      // Get all data attributes with extensive logging
      const lotId = link.getAttribute('data-lot-id');
      const trayCapacity = link.getAttribute('data-tray-capacity');
      const platingStkNo = link.getAttribute('data-plating-stk-no');
      const modelNo = link.getAttribute('data-model-no');
      const modelImage = link.getAttribute('data-model-images');
      const lotIdQuantities = link.getAttribute('data-lot-id-quantities');

      // COMPREHENSIVE DEBUG LOGGING
      console.log("ðŸ” === MODAL DATA DEBUG ===");
      console.log("ðŸ“Š Raw Data Attributes:");
      console.log("  lotId:", lotId);
      console.log("  platingStkNo:", platingStkNo);
      console.log("  modelNo:", modelNo);
      console.log("  modelImage:", modelImage);
      console.log("  trayCapacity:", trayCapacity);
      console.log("  lotIdQuantities:", lotIdQuantities);
      console.log("ðŸ” ========================");

      // Set model number in modal with improved logic
      const modalModelNo = document.getElementById("modalModelNo_DayPlanning");
      if (modalModelNo) {
        let displayText = "Unknown Model";
        
        if (modelNo && modelNo !== 'N/A' && modelNo !== 'null' && modelNo !== 'undefined') {
          displayText = modelNo;
          console.log("âœ… Using modelNo:", modelNo);
        } else if (platingStkNo && platingStkNo !== 'N/A' && platingStkNo !== 'null' && platingStkNo !== 'undefined') {
          displayText = platingStkNo;
          console.log("âœ… Using platingStkNo as fallback:", platingStkNo);
        } else {
          console.log("âŒ No valid model data found");
        }
        
        modalModelNo.textContent = displayText;
        console.log("ðŸ·ï¸ Modal header set to:", displayText);
      }
      
      // Fetch model images using platingStkNo (extract model_no before 'X')
      let images = [];
      if (lotId && lotId !== 'N/A') {
        try {
          const resp = await fetch(`/JigUnloading_Zone2/JU_Zone_get_model_images/?lot_id=${encodeURIComponent(lotId)}`);
          const result = await resp.json();
          if (result.success && result.image) {
            images = [result.image]; // Use the single image from backend
          }
        } catch (err) {
          console.error('Error fetching model images:', err);
        }
      }
      
      // Show images in modal
      const imagesDiv = document.getElementById("modalModelImages_DayPlanning");
      if (imagesDiv) {
        imagesDiv.innerHTML = ""; // Clear previous images
        if (images.length > 0) {
          images.forEach((imgUrl, idx) => {
            imagesDiv.innerHTML += `<img src="${imgUrl}" alt="Model Image ${idx+1}" style="border-radius:50%;width:50px;height:50px;object-fit:cover;border:1px solid #eee;margin-right:2px;" />`;
          });
        } else {
          // Fallback to placeholder
          imagesDiv.innerHTML = `<img src="/static/assets/images/imagePlaceholder.png" alt="Model Image" style="border-radius:50%;width:50px;height:50px;object-fit:cover;" />`;
        }
      }

      // Set Lot Qty with improved error handling
      const totalCaseQty = link.getAttribute('data-total-case-qty');
      const modalLotQty = document.getElementById("modalLotQty_DayPlanning");
      if (modalLotQty) {
        modalLotQty.textContent = totalCaseQty || '0';
      }

      // Fetch tray data using lot_id
      console.log("ðŸ”„ Fetching tray data for lot_id:", lotId);
      let traysData = [];
      try {
        const params = new URLSearchParams({ lot_id: lotId });
        const resp = await fetch(`/JigUnloading_Zone2/JU_Zone_view_tray_list/?${params}`);
        const result = await resp.json();
        
        console.log("ðŸ“¡ Tray data API response:", result);
        
        if (result.success) {
          traysData = result.trays || [];
          console.log("âœ… Tray data loaded:", traysData.length, "trays");
        } else {
          console.error('âŒ API Error:', result.error || 'Unknown error');
        }
      } catch (e) {
        console.error('âŒ Fetch Error:', e);
      }

      // âœ… CREATE buildTableHTML FUNCTION AND STORE IN MODAL
      function buildTableHTML(showValidationColumn = false) {
        let html = `
          <table class="table table-bordered table-sm" style="width:100%; margin-bottom:0;">
            <thead>
              <tr>
                <th style="width:50px;">S.no</th>
                <th>Tray ID</th>
                <th>Tray Qty</th>
                ${showValidationColumn ? '<th>Tray Validation Status</th>' : ''}
              </tr>
            </thead>
            <tbody>
        `;
        
        if (traysData.length > 0) {
          traysData.forEach((tray, idx) => {
            html += `
              <tr>
                <td>${idx + 1}</td>
                <td>
                  <input type="text" class="form-control" value="${tray.tray_id || 'N/A'}" readonly style="width: 100%;" />
                </td>
                <td>
                  <input type="number" class="form-control" value="${tray.tray_quantity || '0'}" readonly style="width: 100%;" />
                </td>
                ${showValidationColumn ? `
                  <td>
                    <div class="validation-status">
                      <div class="status-icon fail">
                        <img src="/static/assets/icons/fail.png" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                      </div>
                      <div class="status-icon pass">
                        <img src="/static/assets/icons/pass.png" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                      </div>
                    </div>
                  </td>
                ` : ''}
              </tr>
            `;
          });
          console.log("âœ… Table built with", traysData.length, "rows");
        } else {
          html += `
            <tr>
              <td colspan="${showValidationColumn ? '4' : '3'}" style="text-align: center; color: #888; padding: 20px;">
                No tray data found for lot ID: ${lotId}
              </td>
            </tr>
          `;
          console.log("âš ï¸ No tray data found");
        }
        
        html += '</tbody></table>';
        return html;
      }

      // âœ… STORE THE FUNCTION AND DATA IN MODAL OBJECT
      modal.buildTableHTML = buildTableHTML;
      modal.traysData = traysData;
      
      // Build initial table without validation column
      detailsDiv.innerHTML = buildTableHTML(false);

      // Show the modal
      modal.style.display = "block";
      modal.classList.add("open");
      console.log("âœ… Modal displayed successfully");
    });
  });

  // Close handler
  const closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");
  if (closeBtn) {
    closeBtn.addEventListener("click", function () {
      const modal = document.getElementById("trayScanModal_DayPlanning");
      if (modal) {
        modal.classList.remove("open");
        modal.style.display = "none";
        console.log("ðŸ”’ Modal closed");
      }
          window.location.reload(); 

    });
  }
  
  console.log("âœ… Modal script setup complete");
});
</script>

// Script 4: Tray Validation Input Handler (Keep your existing one, it should work with the fixes above)
<script nonce="{{ csp_nonce }}">
// Updated Tray Validation Script with Stock Status Support and Enhanced Error Handling
document.addEventListener("DOMContentLoaded", function () {
  const validateInput = document.getElementById("trayValidateInput");
  const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
  const errorMessage = document.getElementById("trayErrorMessage");
  const errorText = document.getElementById("trayErrorText");

  console.log("ðŸ” Tray validation script loaded");

  function getCurrentLotId() {
    const modal = document.getElementById("trayScanModal_DayPlanning");
    if (modal && modal.dataset.lotId) return modal.dataset.lotId;
    const lastBtn = document.querySelector('.tray-scan-btn-Jig[data-lot-id]');
    return lastBtn ? lastBtn.getAttribute('data-lot-id') : '';
  }

  function showError(message) {
    console.log("ðŸš¨ Showing error:", message);
    if (errorMessage && errorText) {
      errorText.textContent = message;
      
      // Force display with important styles
      errorMessage.style.setProperty('display', 'block', 'important');
      errorMessage.style.setProperty('visibility', 'visible', 'important');
      errorMessage.style.setProperty('opacity', '1', 'important');
      errorMessage.style.setProperty('z-index', '99999', 'important');
      errorMessage.style.setProperty('position', 'relative', 'important');
      errorMessage.style.setProperty('background-color', '#ffebee', 'important');
      errorMessage.style.setProperty('border', '1px solid #f44336', 'important');
      errorMessage.style.setProperty('color', '#c62828', 'important');
      errorMessage.style.setProperty('padding', '8px 12px', 'important');
      errorMessage.style.setProperty('border-radius', '4px', 'important');
      errorMessage.style.setProperty('margin-bottom', '10px', 'important');
      errorMessage.style.setProperty('font-size', '12px', 'important');
      errorMessage.style.setProperty('text-align', 'center', 'important');
      errorMessage.style.setProperty('width', '100%', 'important');
      
      // Scroll to error message if it exists
      errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        errorMessage.style.display = "none";
      }, 8000);
    } else {
      // Fallback: show alert if error div not found
      alert(message);
    }
  }

  function hideError() {
    console.log("ðŸ«¥ Hiding error message");
    if (errorMessage) {
      errorMessage.style.display = "none";
    }
  }

  if (validateInput && detailsDiv) {
    console.log("ðŸŽ¯ Setting up tray validation event listener");
    
    validateInput.addEventListener("keydown", function (e) {
      console.log("ðŸ”‘ Key pressed:", e.key, "Value:", validateInput.value.trim());
      
      if (e.key === "Enter") {
        const trayId = validateInput.value.trim();
        console.log("ðŸŽ¯ Enter pressed with tray ID:", trayId);
        
        if (!trayId) {
          console.log("âš ï¸ Empty tray ID, returning");
          return;
        }
        
        const lotId = getCurrentLotId();
        console.log("ðŸ“¦ Current lot ID:", lotId);
        
        if (!lotId) {
          console.log("âŒ No lot ID found");
          showError("Lot ID not found. Please refresh and try again.");
          return;
        }

        // Hide any existing error message
        hideError();
        console.log("ðŸ”„ Making API call to validate tray...");

        fetch("/JigUnloading_Zone2/JU_Zone_after_tray_validate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
          },
          body: JSON.stringify({
            lot_id: lotId,
            tray_id: trayId
          })
        })
        .then(res => {
          console.log("ðŸ“¡ API Response status:", res.status);
          return res.json();
        })
        .then(data => {
          console.log("ðŸ“Š API Response data:", data);
          
          // Find the row in the table with this Tray ID
          const rows = detailsDiv.querySelectorAll("tbody tr");
          console.log("ðŸ“‹ Found", rows.length, "rows in modal table");
          
          let found = false;
          
          rows.forEach((row, index) => {
            const trayIdInput = row.querySelector('input[type="text"]');
            if (trayIdInput) {
              const rowTrayId = trayIdInput.value.trim();
              console.log(`ðŸ”Ž Row ${index + 1}: checking "${rowTrayId}" vs "${trayId}"`);
              
              if (rowTrayId === trayId) {
                found = true;
                console.log(`âœ… Found matching tray in row ${index + 1}`);
                
                const statusCell = row.querySelector("td:last-child");
                if (statusCell) {
                  if (data.success && data.exists) {
                    // Pass validation - show tick as active, cross as inactive
                    statusCell.innerHTML = `
                      <div class="validation-status">
                        <div class="status-icon fail inactive">
                          <img src="/static/assets/icons/fail.png" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                        </div>
                        <div class="status-icon pass active">
                          <img src="/static/assets/icons/pass.png" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                        </div>
                      </div>
                    `;
                    
                    // Add visual feedback for successful validation
                    row.style.backgroundColor = '#e8f5e8';
                    setTimeout(() => {
                      row.style.backgroundColor = '';
                    }, 2000);
                    
                    console.log("âœ… Updated status cell to PASS");
                    
                  } else {
                    // Fail validation - show cross as active, tick as inactive
                    statusCell.innerHTML = `
                      <div class="validation-status">
                        <div class="status-icon fail active">
                          <img src="/static/assets/icons/fail.png" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                        </div>
                        <div class="status-icon pass inactive">
                          <img src="/static/assets/icons/pass.png" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                        </div>
                      </div>
                    `;
                    
                    // Add visual feedback for failed validation
                    row.style.backgroundColor = '#ffebee';
                    setTimeout(() => {
                      row.style.backgroundColor = '';
                    }, 2000);
                    
                    console.log("âŒ Updated status cell to FAIL");
                  }
                }
              }
            }
          });
          
          if (!found) {
            console.log("âŒ Tray not found in table");
            showError(`Tray ID "${trayId}" not found in table.`);
          } else {
            console.log("ðŸŽ‰ Validation successful!");
          }
          
          // Always clear and focus input for next scan
          validateInput.value = "";
          validateInput.focus();
        })
        .catch(error => {
          console.error('âŒ Network error:', error);
          showError('Network error occurred while validating the tray ID.');
          validateInput.value = "";
          validateInput.focus();
        });
      }
    });
    
    // Also add focus event to ensure input is ready
    validateInput.addEventListener("focus", function() {
      console.log("ðŸŽ¯ Validate input focused and ready");
    });
    
  } else {
    console.log("âŒ Required elements not found:", {
      validateInput: !!validateInput,
      detailsDiv: !!detailsDiv
    });
  }
  
  // Helper for CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  console.log("ðŸŽ¯ Tray validation script setup complete");
});
</script>
<!--end of script view icon-->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  function lockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button:not(#closeTrayScanModal_DayPlanning):not(#trayValidateBtn):not(#trayScanRedoBtn), .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.filter = 'grayscale(1)';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    document.querySelectorAll('a:not(.tray-scan-btn-Jig)').forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = 'none';
      menuPanel.style.cursor = 'not-allowed';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = 'auto';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = 'auto';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  function unlockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button, .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.filter = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });
    document.querySelectorAll('a').forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = '';
      menuPanel.style.cursor = '';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = '';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = '';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  var modal = document.getElementById("trayScanModal_DayPlanning");
  var closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");

  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link) {
    link.addEventListener('click', function() {
      setTimeout(lockParentActions, 100);
    });
  });

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      setTimeout(unlockParentActions, 200);
    });
  }
});
</script>
<!-- Active row to be highlighted & Restores the highlighted row to its original position and removes the highlight bg when the tray scan modal is closed. -->
  <script nonce="{{ csp_nonce }}">
  // Append the following code block at the end of the file
  
  document.addEventListener("DOMContentLoaded", function() {
    let movedRowJig = null,
        placeholderRowJig = null,
        originalRowIndexJig = null;
  
    // Attach highlight behavior to "view.png" buttons via the .tray-scan-btn-Jig class
    document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link) {
      link.addEventListener('click', function(event) {
        // Remove existing highlight from all rows
        document.querySelectorAll('tbody tr').forEach(function(row) {
          row.classList.remove('dp-row-action-highlight');
        });
        // Get the closest table row of the clicked element
        var row = event.target.closest('tr');
        if (row && row.parentNode) {
          const tbody = row.parentNode;
          // Move row to the top if it is not already first
          if (tbody.firstElementChild !== row) {
            // Restore any previously moved row first
            if (movedRowJig && placeholderRowJig && placeholderRowJig.parentNode) {
              placeholderRowJig.parentNode.insertBefore(movedRowJig, placeholderRowJig);
              placeholderRowJig.parentNode.removeChild(placeholderRowJig);
              movedRowJig.classList.remove('dp-row-action-highlight');
              movedRowJig = null;
              placeholderRowJig = null;
              originalRowIndexJig = null;
            }
            originalRowIndexJig = Array.from(tbody.children).indexOf(row);
            movedRowJig = row;
            placeholderRowJig = document.createElement('tr');
            placeholderRowJig.style.display = 'none';
            tbody.insertBefore(placeholderRowJig, tbody.children[originalRowIndexJig]);
            tbody.insertBefore(row, tbody.firstElementChild);
          }
          // Add highlight class
          row.classList.add('dp-row-action-highlight');
        }
      });
    });
  
    // When the read-only modal is closed, restore the row to its original position
    var jigCloseBtn = document.getElementById('closeTrayScanModal_DayPlanning');
    if (jigCloseBtn) {
      jigCloseBtn.addEventListener('click', function() {
        if (movedRowJig && placeholderRowJig && placeholderRowJig.parentNode) {
          placeholderRowJig.parentNode.insertBefore(movedRowJig, placeholderRowJig);
          placeholderRowJig.parentNode.removeChild(placeholderRowJig);
          movedRowJig.classList.remove('dp-row-action-highlight');
          movedRowJig = null;
          placeholderRowJig = null;
          originalRowIndexJig = null;
        }
        document.querySelectorAll('tbody tr').forEach(function(row) {
          row.classList.remove('dp-row-action-highlight');
        });
      });
    }
  });
  </script>

{% endblock %}

<!-- ðŸ”¥ ENHANCED: Date Filter JavaScript with Future Date Validation -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
  console.log('ðŸ”„ Initializing enhanced date filtering with future date validation...');
  
  // âœ… Use specific IDs
  const fromInput = document.getElementById('from-date-simple');
  const toInput = document.getElementById('to-date-simple');
  const searchBtn = document.getElementById('search-date-range-simple');
  const clearBtn = document.getElementById('clear-date-filter-simple');
  const filterIndicatorSimple = document.getElementById('filterActiveIndicator');
  
  console.log('ðŸ“‹ Elements found:');
  console.log('- From input:', fromInput);
  console.log('- To input:', toInput);
  console.log('- Search button:', searchBtn);
  console.log('- Clear button:', clearBtn);
  console.log('- Filter indicator:', filterIndicatorSimple);
  
  // Get today's date in YYYY-MM-DD format
  const today = new Date();
  const todayString = today.getFullYear() + '-' + 
                      String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(today.getDate()).padStart(2, '0');
  
  console.log('ðŸ“… Today:', todayString);
  
  // âœ… Set max attribute to today's date for both inputs
  if (fromInput) {
    fromInput.max = todayString;
    console.log('ðŸ“… Set max date for from input:', fromInput.max);
  }
  if (toInput) {
    toInput.max = todayString;
    console.log('ðŸ“… Set max date for to input:', toInput.max);
  }
  
  // âœ… Enhanced validation function
  function validateDateInput(input, inputName) {
    const selectedDate = input.value;
    const selectedDateObj = new Date(selectedDate);
    const todayObj = new Date(todayString);
    
    console.log(`ðŸ” Validating ${inputName}:`, selectedDate);
    console.log(`ðŸ” Selected date object:`, selectedDateObj);
    console.log(`ðŸ” Today object:`, todayObj);
    
    // Reset styles first
    input.style.backgroundColor = '';
    input.style.borderColor = '';
    input.style.color = '';
    
    if (selectedDate && selectedDateObj > todayObj) {
      console.log(`âŒ ${inputName} is in the future!`);
      
      // Apply red styling
      input.style.backgroundColor = '#ffebee';
      input.style.borderColor = '#f44336';
      input.style.color = '#d32f2f';
      
      // Show notification
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Date Selection',
          text: `${inputName} cannot be a future date. Please select today or an earlier date.`,
          timer: 3000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });
      } else {
        // Fallback notification
        showNotification(`${inputName} cannot be a future date!`, 'error');
      }
      
      // Reset to today's date
      input.value = todayString;
      
      // Remove red styling after reset
      setTimeout(() => {
        input.style.backgroundColor = '';
        input.style.borderColor = '#028084';
        input.style.color = '#028084';
      }, 100);
      
      return false;
    }
    
    // Valid date - apply success styling
    if (selectedDate) {
      input.style.backgroundColor = '#e8f5e8';
      input.style.borderColor = '#28a745';
      input.style.color = '#155724';
      
      // Remove success styling after 2 seconds
      setTimeout(() => {
        input.style.backgroundColor = '';
        input.style.borderColor = '#028084';
        input.style.color = '#028084';
      }, 2000);
    }
    
    return true;
  }
  
  // âœ… Fallback notification function
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'error' ? '#f44336' : '#4caf50'};
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      z-index: 10000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.remove();
      style.remove();
    }, 3000);
  }
  
  // Check if we're in filter mode by looking at URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const hasFromDateParam = urlParams.has('from_date') && urlParams.get('from_date');
  const hasToDateParam = urlParams.has('to_date') && urlParams.get('to_date');
  const isFilterMode = hasFromDateParam && hasToDateParam;
  
  // Show "Filter Active" text ONLY if actual URL filter parameters exist
  if (isFilterMode && filterIndicatorSimple) {
    filterIndicatorSimple.style.display = 'block';
    console.log('Filter mode detected - showing indicator');
  } else {
    if (filterIndicatorSimple) {
      filterIndicatorSimple.style.display = 'none';
    }
    console.log('No filter mode - hiding indicator');
  }
  
  // âœ… Set dates based on URL parameters or defaults
  function setDatesFromUrlOrDefaults() {
    const twoDaysAgo = new Date();
    twoDaysAgo.setDate(today.getDate() - 1);
    
    const formatDate = (date) => {
      return date.getFullYear() + '-' + 
             String(date.getMonth() + 1).padStart(2, '0') + '-' + 
             String(date.getDate()).padStart(2, '0');
    };
    
    // If in filter mode, populate inputs with URL parameter values
    if (isFilterMode) {
      const fromDateParam = urlParams.get('from_date');
      const toDateParam = urlParams.get('to_date');
      
      if (fromInput && fromDateParam) {
        fromInput.value = fromDateParam;
        validateDateInput(fromInput, 'From Date');
        console.log('ðŸ“… Set from date from URL:', fromInput.value);
      }
      
      if (toInput && toDateParam) {
        toInput.value = toDateParam;
        validateDateInput(toInput, 'To Date');
        console.log('ðŸ“… Set to date from URL:', toInput.value);
      }
    } else {
      // Only set defaults if inputs are completely empty and we're not in filter mode
      if (fromInput && !fromInput.value) {
        fromInput.value = formatDate(twoDaysAgo);
        console.log('ðŸ“… Set default from date:', fromInput.value);
      }
      
      if (toInput && !toInput.value) {
        toInput.value = formatDate(today);
        console.log('ðŸ“… Set default to date:', toInput.value);
      }
    }
  }
  
  // Call the function to set dates
  setDatesFromUrlOrDefaults();
  
  // âœ… Enhanced date validation with future date checking
  if (fromInput && toInput) {
    fromInput.addEventListener('change', function() {
      console.log('ðŸ“… From date changed:', fromInput.value);
      
      if (validateDateInput(fromInput, 'From Date')) {
        if (toInput.value && fromInput.value > toInput.value) {
          toInput.value = fromInput.value;
        }
        toInput.min = fromInput.value;
      }
    });
    
    // Add blur event for additional validation
    fromInput.addEventListener('blur', function() {
      validateDateInput(fromInput, 'From Date');
    });
    
    toInput.addEventListener('change', function() {
      console.log('ðŸ“… To date changed:', toInput.value);
      
      if (validateDateInput(toInput, 'To Date')) {
        if (fromInput.value && toInput.value < fromInput.value) {
          fromInput.value = toInput.value;
        }
        fromInput.max = toInput.value;
      }
    });
    
    // Add blur event for additional validation
    toInput.addEventListener('blur', function() {
      validateDateInput(toInput, 'To Date');
    });
  }
  
  // âœ… Enhanced search functionality with validation
  if (searchBtn) {
    searchBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      const fromDate = fromInput ? fromInput.value : '';
      const toDate = toInput ? toInput.value : '';
      
      console.log('ðŸ” Search clicked - From:', fromDate, 'To:', toDate);
      
      if (!fromDate || !toDate) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'warning',
            title: 'Date Selection Required',
            text: 'Please select both start and end dates.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          showNotification('Please select both start and end dates.', 'error');
        }
        return;
      }
      
      // Validate dates are not in the future
      const fromDateObj = new Date(fromDate);
      const toDateObj = new Date(toDate);
      const todayObj = new Date(todayString);
      
      if (fromDateObj > todayObj || toDateObj > todayObj) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'Selected dates cannot be in the future. Please select today or earlier dates.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          showNotification('Selected dates cannot be in the future!', 'error');
        }
        return;
      }
      
      if (new Date(fromDate) > new Date(toDate)) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'Start date must be before or equal to end date.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          showNotification('Start date must be before or equal to end date.', 'error');
        }
        return;
      }
      
      // Construct URL
      const currentUrl = window.location.href.split('?')[0];
      const newUrl = `${currentUrl}?from_date=${fromDate}&to_date=${toDate}`;
      console.log('ðŸ”„ Redirecting to:', newUrl);
      window.location.href = newUrl;
    });
  } else {
    console.error('âŒ Search button not found with ID: search-date-range-simple');
  }
  
  // âœ… Clear functionality (prevents cache/flickering issues)
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Reset input styles
      if (fromInput) {
        fromInput.style.backgroundColor = '';
        fromInput.style.borderColor = '';
        fromInput.style.color = '';
      }
      if (toInput) {
        toInput.style.backgroundColor = '';
        toInput.style.borderColor = '';
        toInput.style.color = '';
      }
      
      // Immediately redirect to clean URL without date parameters
      const currentUrl = window.location.href.split('?')[0];
      console.log('ðŸ”„ Redirecting to:', currentUrl);
      window.location.href = currentUrl;
    });
  } else {
    console.error('âŒ Clear button not found with ID: clear-date-filter-simple');
  }
  
  console.log('âœ… Enhanced date filtering initialization complete');
});
</script>

<!-- ðŸ”¥ ENHANCED: Date Filter JavaScript with Future Date Validation -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
  console.log('ðŸ”„ Initializing enhanced date filtering with future date validation...');
  
  // âœ… Use specific IDs
  const fromInput = document.getElementById('from-date-simple');
  const toInput = document.getElementById('to-date-simple');
  const searchBtn = document.getElementById('search-date-range-simple');
  const clearBtn = document.getElementById('clear-date-filter-simple');
  const filterIndicatorSimple = document.getElementById('filterActiveIndicator');
  
  console.log('ðŸ“‹ Elements found:');
  console.log('- From input:', fromInput);
  console.log('- To input:', toInput);
  console.log('- Search button:', searchBtn);
  console.log('- Clear button:', clearBtn);
  console.log('- Filter indicator:', filterIndicatorSimple);
  
  // Get today's date in YYYY-MM-DD format
  const today = new Date();
  const todayString = today.getFullYear() + '-' + 
                      String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                      String(today.getDate()).padStart(2, '0');
  
  console.log('ðŸ“… Today:', todayString);
  
  // âœ… Set max attribute to today's date for both inputs
  if (fromInput) {
    fromInput.max = todayString;
    console.log('ðŸ“… Set max date for from input:', fromInput.max);
  }
  if (toInput) {
    toInput.max = todayString;
    console.log('ðŸ“… Set max date for to input:', toInput.max);
  }
  
  // âœ… Enhanced validation function
  function validateDateInput(input, inputName) {
    const selectedDate = input.value;
    const selectedDateObj = new Date(selectedDate);
    const todayObj = new Date(todayString);
    
    console.log(`ðŸ” Validating ${inputName}:`, selectedDate);
    console.log(`ðŸ” Selected date object:`, selectedDateObj);
    console.log(`ðŸ” Today object:`, todayObj);
    
    // Reset styles first
    input.style.backgroundColor = '';
    input.style.borderColor = '';
    input.style.color = '';
    
    if (selectedDate && selectedDateObj > todayObj) {
      console.log(`âŒ ${inputName} is in the future!`);
      
      // Apply red styling
      input.style.backgroundColor = '#ffebee';
      input.style.borderColor = '#f44336';
      input.style.color = '#d32f2f';
      
      // Show notification
      if (typeof Swal !== 'undefined') {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Date Selection',
          text: `${inputName} cannot be a future date. Please select today or an earlier date.`,
          timer: 3000,
          showConfirmButton: false,
          toast: true,
          position: 'top-end'
        });
      } else {
        // Fallback notification
        showNotification(`${inputName} cannot be a future date!`, 'error');
      }
      
      // Reset to today's date
      input.value = todayString;
      
      // Remove red styling after reset
      setTimeout(() => {
        input.style.backgroundColor = '';
        input.style.borderColor = '#028084';
        input.style.color = '#028084';
      }, 100);
      
      return false;
    }
    
    // Valid date - apply success styling
    if (selectedDate) {
      input.style.backgroundColor = '#e8f5e8';
      input.style.borderColor = '#28a745';
      input.style.color = '#155724';
      
      // Remove success styling after 2 seconds
      setTimeout(() => {
        input.style.backgroundColor = '';
        input.style.borderColor = '#028084';
        input.style.color = '#028084';
      }, 2000);
    }
    
    return true;
  }
  
  // âœ… Fallback notification function
  function showNotification(message, type) {
    // Create notification element
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: ${type === 'error' ? '#f44336' : '#4caf50'};
      color: white;
      padding: 12px 20px;
      border-radius: 6px;
      z-index: 10000;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // Add animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
    `;
    document.head.appendChild(style);
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
      notification.remove();
      style.remove();
    }, 3000);
  }
  
  // Check if we're in filter mode by looking at URL parameters
  const urlParams = new URLSearchParams(window.location.search);
  const hasFromDateParam = urlParams.has('from_date') && urlParams.get('from_date');
  const hasToDateParam = urlParams.has('to_date') && urlParams.get('to_date');
  const isFilterMode = hasFromDateParam && hasToDateParam;
  
  // Show "Filter Active" text ONLY if actual URL filter parameters exist
  if (isFilterMode && filterIndicatorSimple) {
    filterIndicatorSimple.style.display = 'block';
    console.log('Filter mode detected - showing indicator');
  } else {
    if (filterIndicatorSimple) {
      filterIndicatorSimple.style.display = 'none';
    }
    console.log('No filter mode - hiding indicator');
  }
  
  // âœ… Set dates based on URL parameters or defaults
  function setDatesFromUrlOrDefaults() {
    const twoDaysAgo = new Date();
    twoDaysAgo.setDate(today.getDate() - 1);
    
    const formatDate = (date) => {
      return date.getFullYear() + '-' + 
             String(date.getMonth() + 1).padStart(2, '0') + '-' + 
             String(date.getDate()).padStart(2, '0');
    };
    
    // If in filter mode, populate inputs with URL parameter values
    if (isFilterMode) {
      const fromDateParam = urlParams.get('from_date');
      const toDateParam = urlParams.get('to_date');
      
      if (fromInput && fromDateParam) {
        fromInput.value = fromDateParam;
        validateDateInput(fromInput, 'From Date');
        console.log('ðŸ“… Set from date from URL:', fromInput.value);
      }
      
      if (toInput && toDateParam) {
        toInput.value = toDateParam;
        validateDateInput(toInput, 'To Date');
        console.log('ðŸ“… Set to date from URL:', toInput.value);
      }
    } else {
      // Only set defaults if inputs are completely empty and we're not in filter mode
      if (fromInput && !fromInput.value) {
        fromInput.value = formatDate(twoDaysAgo);
        console.log('ðŸ“… Set default from date:', fromInput.value);
      }
      
      if (toInput && !toInput.value) {
        toInput.value = formatDate(today);
        console.log('ðŸ“… Set default to date:', toInput.value);
      }
    }
  }
  
  // Call the function to set dates
  setDatesFromUrlOrDefaults();
  
  // âœ… Enhanced date validation with future date checking
  if (fromInput && toInput) {
    fromInput.addEventListener('change', function() {
      console.log('ðŸ“… From date changed:', fromInput.value);
      
      if (validateDateInput(fromInput, 'From Date')) {
        if (toInput.value && fromInput.value > toInput.value) {
          toInput.value = fromInput.value;
        }
        toInput.min = fromInput.value;
      }
    });
    
    // Add blur event for additional validation
    fromInput.addEventListener('blur', function() {
      validateDateInput(fromInput, 'From Date');
    });
    
    toInput.addEventListener('change', function() {
      console.log('ðŸ“… To date changed:', toInput.value);
      
      if (validateDateInput(toInput, 'To Date')) {
        if (fromInput.value && toInput.value < fromInput.value) {
          fromInput.value = toInput.value;
        }
        fromInput.max = toInput.value;
      }
    });
    
    // Add blur event for additional validation
    toInput.addEventListener('blur', function() {
      validateDateInput(toInput, 'To Date');
    });
  }
  
  // âœ… Enhanced search functionality with validation
  if (searchBtn) {
    searchBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      const fromDate = fromInput ? fromInput.value : '';
      const toDate = toInput ? toInput.value : '';
      
      console.log('ðŸ” Search clicked - From:', fromDate, 'To:', toDate);
      
      if (!fromDate || !toDate) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'warning',
            title: 'Date Selection Required',
            text: 'Please select both start and end dates.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          showNotification('Please select both start and end dates.', 'error');
        }
        return;
      }
      
      // Validate dates are not in the future
      const fromDateObj = new Date(fromDate);
      const toDateObj = new Date(toDate);
      const todayObj = new Date(todayString);
      
      if (fromDateObj > todayObj || toDateObj > todayObj) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'Selected dates cannot be in the future. Please select today or earlier dates.',
            timer: 3000,
            showConfirmButton: false
          });
        } else {
          showNotification('Selected dates cannot be in the future!', 'error');
        }
        return;
      }
      
      if (new Date(fromDate) > new Date(toDate)) {
        if (typeof Swal !== 'undefined') {
          Swal.fire({
            icon: 'error',
            title: 'Invalid Date Range',
            text: 'Start date must be before or equal to end date.',
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          showNotification('Start date must be before or equal to end date.', 'error');
        }
        return;
      }
      
      // Construct URL
      const currentUrl = window.location.href.split('?')[0];
      const newUrl = `${currentUrl}?from_date=${fromDate}&to_date=${toDate}`;
      console.log('ðŸ”„ Redirecting to:', newUrl);
      window.location.href = newUrl;
    });
  } else {
    console.error('âŒ Search button not found with ID: search-date-range-simple');
  }
  
  // âœ… Clear functionality (prevents cache/flickering issues)
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Reset input styles
      if (fromInput) {
        fromInput.style.backgroundColor = '';
        fromInput.style.borderColor = '';
        fromInput.style.color = '';
      }
      if (toInput) {
        toInput.style.backgroundColor = '';
        toInput.style.borderColor = '';
        toInput.style.color = '';
      }
      
      // Immediately redirect to clean URL without date parameters
      const currentUrl = window.location.href.split('?')[0];
      console.log('ðŸ”„ Redirecting to:', currentUrl);
      window.location.href = currentUrl;
    });
  } else {
    console.error('âŒ Clear button not found with ID: clear-date-filter-simple');
  }
  
  console.log('âœ… Enhanced date filtering initialization complete');
});
</script>
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  // Get all table rows
  document.querySelectorAll("#order-listing tbody tr").forEach(function (row) {
    // For Jig Unloading Zone 2, plating color is in the 6th column (index 5)
    // Column structure: S.No(0), JIG ID(1), Last Updated(2), Model Presents(3), Polishing Stk No(4), Plating Color(5)
    var cell = row.children[5]; // Plating Color column
    
    if (!cell) return;

    var colorText = (cell.textContent || "")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
    console.log("Normalized colorText:", colorText);

    if (!colorText || colorText === "n/a") return;

    var colorMap = {
      black: {
        bg: "linear-gradient(135deg, #222 60%, #555 100%)",
        border: "#888",
      },
      ips: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #bdbdbd 100%)",
        border: "#757575",
      },
      ipg: {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffe066 100%)",
        border: "#bfa600",
      },
      "ip-gun": {
        bg: "linear-gradient(135deg, #4b4b4b 60%, #a6a6a6 100%)",
        border: "#333",
      },
      "ip-brown": {
        bg: "linear-gradient(135deg, #b97a56 60%, #ffe066 100%)",
        border: "#8d5524",
      },
      rg: {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      ipsipg: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-blue m": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ipsipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "rg-bi": {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      "ipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "ipsipg-hn": {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-corn.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-titanium": {
        bg: "linear-gradient(135deg, #8a8a8a 60%, #bdbdbd 100%)",
        border: "#666",
      },
      "ipg-half.n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      anodising: {
        bg: "linear-gradient(135deg, #ff7f50 60%, #ff4500 100%)",
        border: "#cc3700",
      },
      "ip-blue inh": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-br anti": {
        bg: "linear-gradient(135deg, #b97a56 60%, #8d5524 100%)",
        border: "#8d5524",
      },
      "ip-bronze": {
        bg: "linear-gradient(135deg, #cd7f32 60%, #d2b48c 100%)",
        border: "#8b4513",
      },
      "ip-ch.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-sil anti": {
        bg: "linear-gradient(135deg, #c0c0c0 60%, #f5f5f5 100%)",
        border: "#888",
      },
      "ip-lcr": {
        bg: "linear-gradient(135deg, #ff4500 60%, #ff6347 100%)",
        border: "#cc3700",
      },
      "ip-ogr": {
        bg: "linear-gradient(135deg, #228b22 60%, #32cd32 100%)",
        border: "#006400",
      },
      "ip-ice blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-plum": {
        bg: "linear-gradient(135deg, #dda0dd 60%, #ee82ee 100%)",
        border: "#800080",
      },
      "ip-titanium blue": {
        bg: "linear-gradient(135deg, #4682b4 60%, #5f9ea0 100%)",
        border: "#2c5d72",
      },
    };

    var match = Object.keys(colorMap).find(function (key) {
      return colorText === key || colorText.includes(key);
    });
    console.log("Matched key:", match);

    var oldCircle = cell.querySelector(".plating-color-indicator");
    if (oldCircle) oldCircle.remove();

    if (match) {
      console.log("Creating indicator for:", match);
      var style = colorMap[match];
      var circle = document.createElement("span");
      circle.className = "plating-color-indicator";
      circle.style.display = "inline-block";
      circle.style.width = "16px";
      circle.style.height = "16px";
      circle.style.borderRadius = "50%";
      circle.style.marginRight = "6px";
      circle.style.verticalAlign = "middle";
      if (style.bg.startsWith("linear-gradient")) {
        circle.style.background = "";
        circle.style.backgroundImage = style.bg;
      } else {
        circle.style.background = style.bg;
      }
      circle.style.border = "1px solid " + style.border;
      cell.insertBefore(circle, cell.firstChild);
    }
  });
});
</script>
<!-- Professional Color Verification and Auto-Focus Script -->
<script nonce="{{ csp_nonce }}">
// ðŸŽ¨ Professional Color Verification UI Update Function
function updateColorVerificationUI(platingColor, trayIdColor, trayIdPrefix, modelNumber, platingStkNo, multipleModels) {
  const colorIndicator = document.getElementById('platingColorIndicator');
  const colorText = document.getElementById('platingColorText');
  const statusBadge = document.getElementById('colorStatusBadge');
  const trayRouting = document.getElementById('trayRouting');

  if (!colorIndicator || !colorText || !statusBadge || !trayRouting) {
    console.log('âš ï¸ Color verification UI elements not found');
    return;
  }
  
  // Create status text with plating stock number and model type
  const modelType = multipleModels ? 'Multiple Models' : 'Single Model';
  const displayText = platingStkNo && platingStkNo !== 'No Plating Stock No' ? 
    `${platingStkNo} - ${modelType}` : 
    modelNumber ? `${modelNumber} - ${modelType}` : modelType;
  
  // Default values if no plating color provided
  if (!platingColor || platingColor === 'Unknown') {
    colorIndicator.style.background = '#6c757d';
    colorText.textContent = 'Unknown Color';
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#6c757d';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone Detection...';
    return;
  }
  
  // Set indicator color and text based on plating color
  colorText.textContent = platingColor;
  
  if (platingColor === 'IPS') {
    colorIndicator.style.background = '#dc3545'; // Red
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#dc3545';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone 1 (Red Tray)';
    trayRouting.style.color = '#dc3545';
  } else if (platingColor && (platingColor.includes('Bi') || platingColor.includes('bi'))) {
    colorIndicator.style.background = '#90EE90'; // Light Green
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#90EE90';
    statusBadge.style.color = '#333';
    trayRouting.textContent = 'Light Green Tray';
    trayRouting.style.color = '#90EE90';
  } else {
    colorIndicator.style.background = '#28a745'; // Dark Green
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#28a745';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone 2 (Dark Green Tray)';
    trayRouting.style.color = '#28a745';
  }
  
  console.log('ðŸŽ¨ Color verification UI updated:', {
    platingColor,
    trayIdColor,
    trayIdPrefix,
    modelNumber,
    platingStkNo,
    multipleModels,
    displayText
  });
}

// Enhanced auto-focus function for tray ID inputs (Zone 2)
function enableTrayIdAutoFocus() {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) {
    console.log('âš ï¸ Upload modal not found for auto-focus');
    return;
  }

  // Wait for modal to be fully visible and populated
  setTimeout(() => {
    // Look for the first tray ID input (typically the top tray)
    const firstTrayIdInput = uploadModal.querySelector('.jig-loading-table input[type="text"]:not([readonly]):not([disabled])');
    
    if (firstTrayIdInput) {
      // Clear any existing content and focus
      firstTrayIdInput.value = '';
      firstTrayIdInput.focus();
      firstTrayIdInput.select();
      
      // Add visual indicator
      firstTrayIdInput.style.boxShadow = '0 0 8px rgba(0, 123, 255, 0.5)';
      firstTrayIdInput.style.borderColor = '#007bff';
      
      console.log('ðŸŽ¯ Zone 2 - Auto-focused on first tray input:', firstTrayIdInput);
      
      // Remove visual indicator after 2 seconds
      setTimeout(() => {
        if (firstTrayIdInput.style.boxShadow === '0 0 8px rgba(0, 123, 255, 0.5)') {
          firstTrayIdInput.style.boxShadow = '';
          firstTrayIdInput.style.borderColor = '';
        }
      }, 2000);
    } else {
      console.log('âš ï¸ Zone 2 - No tray ID input found for auto-focus');
    }
  }, 400); // Increased delay to ensure modal is fully rendered
}

// Add event listener to call auto-focus when modal is shown
document.addEventListener('DOMContentLoaded', function() {
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        const uploadModal = document.getElementById('uploadChildModal');
        if (uploadModal && uploadModal.style.display === 'flex') {
          enableTrayIdAutoFocus();
        }
      }
    });
  });
  
  // Start observing when DOM is ready
  setTimeout(() => {
    const uploadModal = document.getElementById('uploadChildModal');
    if (uploadModal) {
      observer.observe(uploadModal, { attributes: true });
    }
  }, 1000);

  // --- CLIENT HELPERS: tray prefix validation and modal-scoped scanned set (Zone 2) ---
  (function(){
    try {
      const uploadModal = document.getElementById('uploadChildModal');
      if (uploadModal && !uploadModal._scannedTrays) uploadModal._scannedTrays = new Set();

      function allowedPrefixesFor(platingColor, trayType) {
        const color = String(platingColor || '').toUpperCase();
        const type = String(trayType || '').toLowerCase();
        if (color === 'IPS') return type === 'jumbo' ? ['JR'] : ['NR'];
        if (color.includes('BI') || color.includes('BIC') || color.includes('BI-')) return type === 'jumbo' ? ['JL'] : ['NL'];
        return type === 'jumbo' ? ['JD'] : ['ND'];
      }

      window.validateTrayPrefixLocalZone2 = function(trayId, platingColor, trayType) {
        if (!trayId) return { valid: false, reason: 'Empty tray id' };
        const prefix = String(trayId || '').split('-')[0] || '';
        const allowed = allowedPrefixesFor(platingColor, trayType);
        const candidate = prefix.toUpperCase().slice(0,2);
        if (allowed.includes(candidate)) return { valid: true };
        return { valid: false, reason: `Invalid prefix '${candidate}'. Expected: ${allowed.join(', ')}` };
      };

      window.maybeValidateTrayIdZone2 = function(trayInputEl) {
        try {
          const trayId = trayInputEl && trayInputEl.value && trayInputEl.value.trim();
          const uploadModal = document.getElementById('uploadChildModal');
          const platingColor = uploadModal ? uploadModal.getAttribute('data-plating-color') : '';
          const trayType = uploadModal ? uploadModal.getAttribute('data-tray-type') : '';
          const prefRes = window.validateTrayPrefixLocalZone2(trayId, platingColor, trayType);
          if (!prefRes.valid) {
            if (typeof showTrayValidationMessage === 'function') showTrayValidationMessage(trayInputEl, 'error', prefRes.reason);
            return Promise.resolve({ success: false, error: prefRes.reason });
          }
          if (uploadModal && uploadModal._scannedTrays && uploadModal._scannedTrays.has(trayId.toLowerCase())) {
            if (typeof showTrayValidationMessage === 'function') showTrayValidationMessage(trayInputEl, 'info', `${trayId} already validated`);
            return Promise.resolve({ success: true, duplicate: true });
          }
          if (typeof validateTrayIdZone2 === 'function') {
            return validateTrayIdZone2(trayInputEl).then(resp => {
              if (resp && resp.success && uploadModal && uploadModal._scannedTrays) uploadModal._scannedTrays.add(trayId.toLowerCase());
              return resp;
            });
          }
          return Promise.resolve({ success: true });
        } catch (e) {
          console.error('maybeValidateTrayIdZone2 error', e);
          return Promise.resolve({ success: false, error: String(e) });
        }
      };
    } catch (e) {
      console.warn('Zone2 Tray helper init failed', e);
    }
  })();
});
</script>
{% endblock content %}