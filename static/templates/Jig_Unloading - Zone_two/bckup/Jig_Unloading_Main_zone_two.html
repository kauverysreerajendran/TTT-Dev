{% extends "base.html" %} 
{% load static %} 
{% load stock_filters %}
{% load custom_tags %}
{% block content %}
<style>
 /* ========== Tablet override â€” paste at file end (after other table styles) ========== */
/* --- Tablet: freeze first 3 columns consistently with desktop --- */
@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {

*{
  font-size: 20px !important; /* Increase font size for better readability */
}

:root { --app-font-size: 20px; }
.rounded-circle{
  padding: 17px !important;
}
.model-image-tooltip{
  transform: translateX(-25%) !important;
  top: 45% !important;
  z-index: 500000 !important; /* high so it sits above table & scrollbar */

}


  /* Core layout blocks */
  .content-wrapper,
  .card, .card-body,
  .table-responsive,
  #order-listing,
  #trayScanModal_DayPlanning,
  .tray-scan-modal-DayPlanning,
  .pagination-wrapper {
    font-size: var(--app-font-size) !important;
    line-height: 1.35 !important;
  }

  /* Table headings / cells / icons */
  #order-listing th,
  #order-listing td,
  #order-listing thead th {
    font-size: var(--app-font-size) !important;
    vertical-align: middle !important;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
  }

  /* Ensure heading/title and date controls match */
  h4.text-left.mt-0.mb-3,
  .calendar-bar .date-input-group label,
  .calendar-bar .date-input-group input,
  #search-date-range-simple,
  #clear-date-filter-simple,
  .calendar-btn,
  #trayScanModal_DayPlanning input.form-control,#trayValidateBtn,
  #trayScanModal_DayPlanning table th, #trayScanModal_DayPlanning table td,
  #modalModelNo_DayPlanning
 {
    font-size: var(--app-font-size) !important;
  }  

  /* Reserve space for filter icons in header cells */
#order-listing th {
  position: relative;
  overflow: visible !important;
  white-space: normal !important; /* allow wrapping */
}

/* Ensure filter icons always stay to the right */
#order-listing th .fa-filter {
  position: absolute;
  right: 10px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 10px !important;
  opacity: 0.8;
  cursor: pointer;
}

  /* Column 1 */
  #order-listing th:nth-child(1),
  #order-listing td:nth-child(1) {
    position: sticky;
    left: 0 !important;
    min-width: 90px !important;
    max-width: 90px !important;
    background: #f7fafd;
    z-index: 30;
  }

  /* Column 2 */
  #order-listing th:nth-child(2),
  #order-listing td:nth-child(2) {
    position: sticky;
    left: 90px !important;   /* = width of col1 */
    min-width: 125px !important;
    max-width: 125px !important;
    background: #f7fafd;
    z-index: 25;
  }

  /* Column 3 */
  #order-listing th:nth-child(3),
  #order-listing td:nth-child(3) {
    position: sticky;
    left: 215px !important;  /* 75 (col1) + 100 (col2 min) */
    min-width: 140px !important;
    max-width: 140px !important;
    background: #f7fafd;
    z-index: 20;
  }

  /* Sticky header */
  #order-listing thead th {
    position: sticky;
    top: 0;
    z-index: 40;
    background: #028084 !important;
    color: #e5fcff !important;
  }
}

@media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {
  .table-container {
    overflow-x: auto;
  }

  /* Other columns (fit remaining space) */
  #order-listing th:nth-child(4)  { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(5)  { min-width: 120px !important; max-width: 120px !important; }
  #order-listing th:nth-child(6)  { min-width: 135px !important; max-width: 135px !important; }
  #order-listing th:nth-child(7)  { min-width: 115px !important; max-width: 125px !important; }
  #order-listing th:nth-child(8)  { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(9)  { min-width: 140px !important; max-width: 145px !important; }
  #order-listing th:nth-child(10) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(11) { min-width: 120px !important; max-width: 130px !important; }
  #order-listing th:nth-child(12) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(13) { min-width: 120px !important; max-width: 130px !important; }
  #order-listing th:nth-child(14) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(15) { min-width: 115px !important; max-width: 115px !important; }
  #order-listing th:nth-child(16) { min-width: 130px !important; max-width: 150px !important; }
  #order-listing th:nth-child(17) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(18) { min-width: 130px !important; max-width: 130px !important; }
  #order-listing th:nth-child(19) { min-width: 140px !important; max-width: 140px !important; }
  #order-listing th:nth-child(20) { min-width: 130px !important; max-width: 130px !important; }


  /* Prevent overlap */
  #order-listing th:nth-child(-n+3),
  #order-listing td:nth-child(-n+3) {
    z-index: 45 !important;
  }

  /* Hide hidden columns */
  #order-listing th[hidden],
  #order-listing td[hidden] {
    display: none !important;
  }
}
      /* Add to your CSS file for Excel-like grid lines */
.table-bordered th, .table-bordered td {
  border: 1px solid #d9dedf !important;
}
  /* Make the table header sticky */
thead th {
  position: sticky;
  top: 0;
  background-color: white; /* or your table header bg color */
  z-index: 5; /* ensure it stays above the table rows */
  
}

#order-listing thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important;
  color: #e5fcff !important;
  vertical-align: middle !important;
  border-bottom: 2.5px solid #bdbdbd !important; /* Thicker grey line below heading */
}
/* style for hol/unhold row - blurred bg */
#order-listing tr:last-child td {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
  /* background: #f4f3f3 !important; */
}
/* Gird line color combination */
#order-listing th,
#order-listing td {
  border-right: 1.5px solid #bababa !important; /* Vertical lines: blue */
  border-bottom: 1.5px solid #121413 !important; /* Horizontal lines: green */
}

/* Model circle styles */

.model-stock-no-cell {
  position: relative;
}

.model-stock-no-text {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 2px;
}

  
/* Default: Desktop/Laptop (wider columns for larger font) - server */
/* #order-listing th:nth-child(1) {
  min-width: 90px;
  max-width: 90px;
} */ /* S.No */
/* #order-listing th:nth-child(2) {
  min-width: 90px;
  max-width: 100px;
} */ /* Last Updated */
/* #order-listing th:nth-child(3) {
  min-width: 90px;
  max-width: 120px;
} */ /* Plating */
#order-listing th:nth-child(4) {
  min-width: 100px;
  max-width: 120px;
} /* Polishing Stk No */

 /* Plating Color */
#order-listing th:nth-child(5) {
  min-width: 100px;
  max-width: 110px;
} /* Category */
#order-listing th:nth-child(6) {
  min-width: 110px;
  max-width: 110px;
} /* Polish Finish */
#order-listing th:nth-child(7) {
  min-width: 100px;
  max-width: 110px;
} /* Version */
#order-listing th:nth-child(8) {
  min-width: 105px;
  max-width: 105px;
} /* Tray Cate-Capacity */
#order-listing th:nth-child(9) {
  min-width: 115px;
  max-width: 115px;
} /* Source */
#order-listing th:nth-child(10) {
  min-width: 115px;
  max-width: 120px;
} /* Input Qty */
#order-listing th:nth-child(11) {
  min-width: 95px;
  max-width: 100px;
} /* Process Status */
#order-listing th:nth-child(12) {
  min-width: 100px;
  max-width: 100px;
} /*  Action */
#order-listing th:nth-child(13) {
  min-width: 100px;
  max-width: 100px;
} /* Lot Status */
#order-listing th:nth-child(14) {
  min-width: 100px;
  max-width: 100px;
} /* Current Stage */
#order-listing th:nth-child(15) {
  min-width: 110px;
  max-width: 100px;
} /* Remarks */
#order-listing th:nth-child(16) {
  min-width: 135px;
  max-width: 140px;
}
#order-listing th:nth-child(17) {
  min-width: 115px;
  max-width: 140px;
}
@media (min-width: 600px) and (max-width: 900px) {
  #order-listing {
    table-layout: auto !important; /* Let columns auto-fit content */
    width: 100% !important;
    min-width: unset !important;
    max-width: 100vw !important;
  }
  /* Adjust width for all headings (th) and cells (td) */
  #order-listing th,
  #order-listing td {
    min-width: 160px !important;
    max-width: 260px !important;
    width: 180px !important;
  }
  #order-listing th {
    position: relative;
    padding-right: 48px !important; /* More space for filter icon */
    white-space: normal !important;
    overflow: visible !important;
    text-overflow: ellipsis;
  }
  #order-listing th .fa-filter {
    position: absolute;
    right: 18px !important;
    top: 50%;
    transform: translateY(-50%);
    z-index: 2;
    background: transparent;
    pointer-events: auto;
  }
}
/* Right-align filter icons */
#order-listing th .fa-filter {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.7;
  cursor: pointer;
  transition: opacity 0.2s;
}

#order-listing th .fa-filter:hover {
  opacity: 1;
}


  
#order-listing th:last-child,
#order-listing td:last-child {
  border-right: none;
  max-width: 95px;
  min-width: 100px;
}
/* Overall Table Shrink */
#order-listing tr,
#order-listing td,
#order-listing th {
  height: 20px !important;
  padding-top: 2px !important;
  padding-bottom: 2px !important;
  padding-left: 6px !important;
  padding-right: 6px !important;
}
/* Table heading font size */
/* Add this at the end of your <style> block in DP_PickTable.html */

/* Professional table header styling with proper text wrapping */
#order-listing th {
  position: relative;
  padding: 8px 12px 8px 16px !important;
  text-align: left !important;
  vertical-align: middle !important;
  white-space: normal !important;
  line-height: 1.3 !important;
  word-break: keep-all !important;
  hyphens: none !important;
  /* font-size: 13px; */
  /* font-weight: 600 !important; */
  background: #028084 !important;
  color: #e5fcff !important;
  border-bottom: 2.5px solid #bdbdbd !important;
  /* min-width: 80px;
  max-width: 140px; */
   overflow-wrap: break-word;
  word-wrap: break-word;
   z-index: 16 !important;
}

/* Make sure header cells for sticky columns are always above body cells */
/* Fix: Prevent shadow/rows from showing behind sticky columns while scrolling */
#order-listing th:nth-child(-n+3),
#order-listing td:nth-child(-n+3) {
  z-index: 30 !important; 
box-shadow: 2px 0 8px rgba(0,0,0,0.04);
}

/* Prevent sticky columns from overlapping sticky header */
#order-listing td:nth-child(-n+3) {
  z-index: 11 !important;
}
  /* Make the first column sticky and opaque */
#order-listing td:first-child,
#order-listing th:first-child {
  position: sticky;
  left: 0;
  background: #fff;      /* Or match your table background */
  z-index: 2;            /* Above blurred rows */
  box-shadow: 2px 0 4px rgba(0,0,0,0.03); /* Optional: subtle shadow */
}
/* Force specific table headers to wrap onto two lines */
#order-listing th:nth-child(4),   /* Polishing Stk No */
#order-listing th:nth-child(5),   /* Plating Color */
#order-listing th:nth-child(7),   /* Polish Finish */
#order-listing th:nth-child(9),   /* Tray Cate-Capacity */
#order-listing th:nth-child(11),  /* No of Tray */
#order-listing th:nth-child(12),  /* Input Qty */
#order-listing th:nth-child(13)   /* Process Status */ {
  white-space: normal !important;
  line-height: 1.2 !important;
  word-break: break-word !important;

  text-align: center;
  vertical-align: middle;
  padding-top: 5px !important;
  padding-bottom: 5px !important;
}
/* Freeze style for 1st - 3 columns */
/* --- Freeze first 3 columns and table header for #order-listing --- */
#order-listing {
  position: relative;
  border-collapse: separate !important;
  border-spacing: 0;
  background: #fff;
  /* Ensure enough left padding for sticky columns */
}

#order-listing th,
#order-listing td {
  background-clip: padding-box;
  /* Prevent overlap artifacts */
  z-index: 1;
}

/* Sticky header */
#order-listing thead th {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #028084 !important;
  color: #e5fcff !important;
}

/* Freeze 1st column */
#order-listing th:nth-child(1),
#order-listing td:nth-child(1) {
  position: sticky;
  left: 0 !important;
  z-index: 12; /* Above header */
  background: #f7fafd;
  min-width: 75px;
  max-width: 75px;
}

/* Freeze 2nd column - Last Updated*/
#order-listing th:nth-child(2),
#order-listing td:nth-child(2) {
  position: sticky;
  left: 75px; /* Match min-width of 1st col */
  z-index: 12;
  background: #f7fafd;
  min-width: 180px; /* Increased width */
  max-width: 180px; /* Increased width */
}

/* Freeze 3rd column */
#order-listing th:nth-child(3),
#order-listing td:nth-child(3) {
  position: sticky;
  left: 255px; /* 100px (1st) + 90px (2nd) */
  z-index: 12;
  background: #f7fafd;
  min-width: 100px; /* Increased width 100 - old value*/
  max-width: 100px; /* Increased width  110 - old value*/
}

/* Prevent sticky columns from overlapping sticky header */
#order-listing th:nth-child(-n + 3) {
  z-index: 12;
}
#order-listing td:nth-child(-n + 3) {
  z-index: 11;
}

/* Ensure sticky columns and header work together */
#order-listing th,
#order-listing td {
  box-sizing: border-box;
  /* Prevent content shake */
  /* overflow: hidden; */
  text-overflow: ellipsis;
  white-space: nowrap;
}



    .blurred-heading, .blurred-cell {
    filter: blur(2px) grayscale(0.7) opacity(0.6);
    pointer-events: none !important;
    user-select: none;
    cursor: not-allowed;
    background: #f5f5f5 !important;
  }
    /* Show remark tooltip above the trigger instead of below */
  .remark-tooltip {
    top: auto !important;
    bottom: 110% !important;
  }
#trayScanDetails.table-grid {
  display: grid !important;
  grid-template-columns: 94px 175px 150px !important;
  gap: 0px !important;
  max-height: 300px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
  padding-right: 10px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

#trayScanDetails.table-grid::-webkit-scrollbar {
  width: 8px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb {
  background: #888;
  border-radius: 4px;
}
 
#trayScanDetails.table-grid::-webkit-scrollbar-thumb:hover {
  background: #555;
}
 
 
.tray-scan-modal.open {
  width:500px !important;
}
/* For the 4-column layout (with validation status) */
#trayScanDetails.table-grid.four-column {
  grid-template-columns: 50px 1fr 100px 140px !important;
  overflow-y: auto !important;
  overflow-x: hidden !important;
}
 
/* Styling individual grid cells, only inside trayScanDetails */
#trayScanDetails.table-grid > div {
  background: #f7f7f7;
  padding: 8px 12px;
  font-size: 12px;
  border: 1px solid #ddd;
  margin: 0; /* reset any margin from <p> or others */
}
 
/* S.no column specific styling */
#trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
  text-align: center;
  font-weight: 600;
  padding: 8px 4px; /* Reduced horizontal padding for S.no */
}
 
/* For mobile responsiveness */
@media (max-width: 768px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 45px 1fr 1fr !important; /* Even smaller S.no column on mobile */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 40px 1fr 80px 100px !important;
  }
  #trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
    padding: 6px 2px; /* Further reduced padding on mobile */
    font-size: 11px;
  }
}
 
/* For very small screens */
@media (max-width: 480px) {
  #trayScanDetails.table-grid {
    grid-template-columns: 35px 1fr 80px !important; /* Minimal S.no column */
  }
  #trayScanDetails.table-grid.four-column {
    grid-template-columns: 30px 1fr 70px 90px !important;
  }
}
.row-checkbox, #selectAllCheckbox {
  display: none;
}
body.add-model-mode .row-checkbox,
body.add-model-mode #selectAllCheckbox {
  display: inline-block;
}


        /* Model Image Gallery Styles */
        
        /* General model circle styling */
        .model-circle {
            cursor: pointer;
            position: relative;
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            vertical-align: middle;
            margin-right: -4px; /* Adjust this value for more/less space */
        }

        /* Compact and responsive modal for model/stock no */
        #modelRemarkModal {
            display: none;
            position: fixed;
            top: 6vh;
            right: 2vw;
            transform: none;
            z-index: 20000;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            min-width: 320px;
            max-width: 420px;
            min-height: 400px;
            max-height: 500px;
            padding: 18px 32px 12px 32px;
            overflow-y: auto;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            #modelRemarkModal {
                right: 0;
                max-width: 98vw;
                min-width: 0;
                width: 98vw;
                padding: 10px 4vw 10px 4vw;
                font-size: 11px;
            }
        }

        #modelRemarkModalContent {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #modelRemarkModal .close-btn,
        #closeModelRemarkModal {
            position: absolute;
            top: 6px;
            right: 12px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        #modelRemarkModal img {
            max-width: 54px;
            max-height: 54px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #fafafa;
        }

        #modelRemarkModal .model-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 2px;
        }

        #modelRemarkModal .model-circle {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 2px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        #modelRemarkModal .model-no {
            font-weight: 600;
            color: #023E4DCC;
            font-size: 0.98rem;
            margin-bottom: 2px;
        }

        #modelRemarkModal .remark-label {
            font-size: 11px;
            color: #222;
            margin-bottom: 1px;
        }

        #modelRemarkModal .remark-text {
            font-size: 11px;
            color: #444;
            background: #f7f7f7;
            border-radius: 5px;
            padding: 5px 8px;
            min-width: 80px;
            min-height: 18px;
            margin-bottom: 0;
        }

        @media (max-width: 600px) {
            #modelRemarkModal {
                left: 0;
                top: 0;
                width: 98vw;
                max-width: 98vw;
                min-width: 0;
                padding: 8px 4px 8px 4px;
                font-size: 11px;
                max-height: 60vh;
            }
            
            #modelRemarkModal img {
                max-width: 38px;
                max-height: 38px;
            }
            
            #modelRemarkModal .model-no {
                font-size: 0.92rem;
            }
            
            #modelRemarkModal .remark-label,
            #modelRemarkModal .remark-text {
                font-size: 10px;
            }
        }

        /* Tooltip for model images */
        .model-image-tooltip {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            padding: 10px;
            min-width: 220px;
            max-width: 350px;
            max-height: 220px;
            display: none;
            overflow: hidden;
        }

        .model-image-tooltip .image-slider {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-image-tooltip img {
            max-width: 180px;
            max-height: 180px;
            object-fit: contain;
            border-radius: 4px;
        }

        .model-image-tooltip .slider-btn {
            background: #eee;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            cursor: pointer;
        }

        .model-image-tooltip.static {
            display: block !important;
            position: fixed !important;
            top: 80px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 100000;
        }

        .model-image-tooltip .close-btn {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        /* Image slider modal */
        .image-slider-modal {
            display: none;
            position: fixed;
            top: 40px;
            right: 20px;
            width: 600px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 10000;
            transition: right 0.3s ease;
        }

        .image-slider-modal.open {
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .slider {
            position: relative;
            overflow: hidden;
            height: 350px;
        }

        .slides {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
        }

        .slide {
            flex: 0 0 100%;
            box-sizing: border-box;
            display: none;
        }

        .slide.active {
            display: block;
        }

        .slide img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            display: block;
        }

        .prev,
        .next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #fff;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            user-select: none;
        }

        .prev {
            left: 10px;
        }

        .next {
            right: 10px;
        }

        @media (max-width: 767px) {
            .image-slider-modal {
                width: 100%;
                right: 0;
                top: 0;
                border-radius: 0;
                padding: 10px;
            }
            
            .slider {
                height: 250px;
            }
            
            .slide img {
                height: 250px;
            }
        }

        /* Add Jig Remark Modal Styles */
        
        /* Modal backdrop styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1040;
            width: 100vw;
            height: 100vh;
            background-color: #000;
        }

        .modal-backdrop.fade {
            opacity: 0;
        }

        .modal-backdrop.show {
            opacity: 0.5;
        }

        /* Modal base styles */
        .modal.fade .modal-dialog {
            transition: transform 0.3s ease-out;
            transform: translate(0, -50px);
        }

        .modal.show .modal-dialog {
            transform: none;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1050;
            display: none;
            width: 100%;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
            outline: 0;
        }

        .modal.show {
            display: block !important;
        }

        body.modal-open {
            overflow: hidden;
        }

        /* Remarks modal specific styles */
        #remarksModal .modal-dialog {
            max-width: 500px;
            margin: 1.75rem auto;
        }

        #remarksModal .modal-content {
            border: none;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        #remarksModal .modal-header {
            border-bottom: none;
            padding: 0;
        }

        #remarksModal .modal-body {
            padding: 1rem 2rem 2rem 2rem;
        }

        #remarksModal .modal-title {
            color: #023E4DCC;
            font-weight: 700;
            font-size: 1.25rem;
            text-align: center;
            margin-bottom: 1rem;
        }

        /* Loading spinner styles */
        #remarksLoadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
        }

        #remarksLoadingSpinner .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: 0.25em;
        }

        .spinner-border {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            vertical-align: text-bottom;
            border: 0.25em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }

        @keyframes spinner-border {
            to {
                transform: rotate(360deg);
            }
        }

        .text-primary {
            color: #007bff !important;
        }

        /* Form styles for remarks modal */
        #remarksModalForm .form-control {
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            line-height: 1.5;
            color: #495057;
            background-color: #fff;
            background-clip: padding-box;
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #remarksModalForm .form-control:focus {
            color: #495057;
            background-color: #fff;
            border-color: #80bdff;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        #remarksModalForm .form-check-input {
            width: 1em;
            height: 1em;
            margin-top: 0.25em;
            vertical-align: top;
            background-color: #fff;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            border: 1px solid rgba(0, 0, 0, 0.25);
            appearance: none;
            color-adjust: exact;
        }

        #remarksModalForm .form-check-input:checked {
            background-color: #007bff;
            border-color: #007bff;
        }

        #remarksModalForm .form-check-input[type="radio"] {
            border-radius: 50%;
        }

        #remarksModalForm .form-check-input[type="radio"]:checked {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e");
        }

        #remarksModalForm .btn {
            display: inline-block;
            font-weight: 400;
            line-height: 1.5;
            color: #212529;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            background-color: transparent;
            border: 1px solid transparent;
            padding: 0.375rem 0.75rem;
            font-size: 1rem;
            border-radius: 0.375rem;
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }

        #remarksModalForm .btn-primary {
            color: #fff;
            background-color: #007bff;
            border-color: #007bff;
        }

        #remarksModalForm .btn-primary:hover {
            color: #fff;
            background-color: #0056b3;
            border-color: #004085;
        }

        #remarksModalForm .btn-secondary {
            color: #fff;
            background-color: #6c757d;
            border-color: #6c757d;
        }

        #remarksModalForm .btn-secondary:hover {
            color: #fff;
            background-color: #545b62;
            border-color: #4e555b;
        }

        /* Character count styling */
        #remarksCharCount {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
            font-size: 0.75rem;
            pointer-events: none;
        }

        /* Position relative for character count container */
        .position-relative {
            position: relative !important;
        }

        /* Bootstrap utility classes used in the modal */
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin-top: calc(-0.5 * 0);
          if (!existingLotIdList.includes(newLotId)) {
              existingLotIdList.push(newLotId);
              uploadModal.setAttribute('data-existing-lot-id-list', JSON.stringify(existingLotIdList));
          }
            margin-right: calc(-0.5 * 1.5rem);
            margin-left: calc(-0.5 * 1.5rem);
        }

        .col-5 {
            flex: 0 0 auto;
            width: 41.66666667%;
        }

        .col-7 {
            flex: 0 0 auto;
            width: 58.33333333%;
        }

        .col-12 {
            flex: 0 0 auto;
            width: 100%;
        }

        .d-flex {
            display: flex !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .justify-content-center {
            justify-content: center !important;
        }

        .gap-3 {
            gap: 1rem !important;
        }

        .text-end {
            text-align: right !important;
        }

        .fw-bold {
            font-weight: 700 !important;
        }

        .px-4 {
            padding-left: 1.5rem !important;
            padding-right: 1.5rem !important;
        }

        .me-2 {
            margin-right: 0.5rem !important;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            font-weight: 700;
            line-height: 1;
            color: #000;
            text-shadow: 0 1px 0 #fff;
            opacity: 0.5;
            background: transparent;
            border: 0;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.75;
        }

        .position-absolute {
            position: absolute !important;
        }

        .end-0 {
            right: 0 !important;
        }

        .top-0 {
            top: 0 !important;
        }

        .m-2 {
            margin: 0.5rem !important;
        }

        /* Enhanced model circle with animation */
        .model-circle {
            transition: all 0.2s ease;
        }
        
        .model-row:hover .model-circle {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        /* Compact and responsive modal for model/stock no */
        #modelRemarkModal {
            display: none;
            position: fixed;
            top: 6vh;
            right: 2vw;
            transform: none;
            z-index: 20000;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            min-width: 320px;
            max-width: 420px;
            min-height: 400px;
            max-height: 500px;
            padding: 18px 32px 12px 32px;
            overflow-y: auto;
            font-size: 12px;
        }

        @media (max-width: 900px) {
            #modelRemarkModal {
                right: 0;
                max-width: 98vw;
                min-width: 0;
                width: 98vw;
                padding: 10px 4vw 10px 4vw;
                font-size: 11px;
            }
        }

        #modelRemarkModalContent {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        #modelRemarkModal .close-btn,
        #closeModelRemarkModal {
            position: absolute;
            top: 6px;
            right: 12px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        #modelRemarkModal img {
            max-width: 54px;
            max-height: 54px;
            border-radius: 6px;
            border: 1px solid #eee;
            background: #fafafa;
        }

        #modelRemarkModal .model-row {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 2px;
        }

        #modelRemarkModal .model-circle {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 2px;
            vertical-align: middle;
            flex-shrink: 0;
        }

        #modelRemarkModal .model-no {
            font-weight: 600;
            color: #023E4DCC;
            font-size: 0.98rem;
            margin-bottom: 2px;
        }

        #modelRemarkModal .remark-label {
            font-size: 11px;
            color: #222;
            margin-bottom: 1px;
        }

        #modelRemarkModal .remark-text {
            font-size: 11px;
            color: #444;
            background: #f7f7f7;
            border-radius: 5px;
            padding: 5px 8px;
            min-width: 80px;
            min-height: 18px;
            margin-bottom: 0;
        }

        @media (max-width: 600px) {
            #modelRemarkModal {
                left: 0;
                top: 0;
                width: 98vw;
                max-width: 98vw;
                min-width: 0;
                padding: 8px 4px 8px 4px;
                font-size: 11px;
                max-height: 60vh;
            }

            #modelRemarkModal img {
                max-width: 38px;
                max-height: 38px;
            }

            #modelRemarkModal .model-no {
                font-size: 0.92rem;
            }

            #modelRemarkModal .remark-label,
            #modelRemarkModal .remark-text {
                font-size: 10px;
            }
        }

        /* Tooltip for model images */
        .model-image-tooltip {
            position: absolute;
            z-index: 99999;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
            padding: 10px;
            min-width: 220px;
            max-width: 350px;
            max-height: 220px;
            display: none;
            overflow: hidden;
        }

        .model-image-tooltip .image-slider {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .model-image-tooltip img {
            max-width: 180px;
            max-height: 180px;
            object-fit: contain;
            border-radius: 4px;
        }

        .model-image-tooltip .slider-btn {
            background: #eee;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            font-size: 18px;
            cursor: pointer;
        }

        .model-image-tooltip.static {
            display: block !important;
            position: fixed !important;
            top: 80px !important;
            left: 50% !important;
            transform: translateX(-50%) !important;
            z-index: 100000;
        }

        .model-image-tooltip .close-btn {
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 18px;
            color: #888;
            cursor: pointer;
        }

        /* Image slider modal */
        .image-slider-modal {
            display: none;
            position: fixed;
            top: 40px;
            right: 20px;
            width: 600px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 20px;
            z-index: 10000;
            transition: right 0.3s ease;
        }

        .image-slider-modal.open {
            display: block;
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .slider {
            position: relative;
            overflow: hidden;
            height: 350px;
        }

        .slides {
            display: flex;
            transition: transform 0.5s ease;
            width: 100%;
        }

        .slide {
            flex: 0 0 100%;
            box-sizing: border-box;
            display: none;
        }

        .slide.active {
            display: block;
        }

        .slide img {
            width: 100%;
            height: 350px;
            object-fit: cover;
            display: block;
        }

        .prev,
        .next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            border: none;
            color: #fff;
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            user-select: none;
        }

        .prev {
            left: 10px;
        }

        .next {
            right: 10px;
        }

        @media (max-width: 767px) {
            .image-slider-modal {
                width: 100%;
                right: 0;
                top: 0;
                border-radius: 0;
                padding: 10px;
            }

            .slider {
                height: 250px;
            }

            .slide img {
                height: 250px;
            }
        }
        
        /* ======= Tray Edit Functionality Styling - Zone 2 ======= */
        
        /* Disabled tray quantity input styling */
        .jig-loading-table input[type="number"]:disabled {
            background-color: #f9f9f9;
            border-color: #ddd;
            color: #666;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Enabled (editing) tray quantity input styling */
        .jig-loading-table input[type="number"]:not(:disabled) {
            background-color: #fff;
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            color: #333;
        }
        
        /* Edit button hover effects */
        .jig-loading-table img[alt="Edit"] {
            transition: all 0.2s ease;
            border-radius: 3px;
            padding: 2px;
        }
        
        .jig-loading-table img[alt="Edit"]:hover {
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(1.1);
        }
        
        /* Save button (when in edit mode) styling */
        .jig-loading-table img[title="Save Changes"] {
            filter: hue-rotate(120deg) brightness(1.1);
            background-color: rgba(40, 167, 69, 0.1);
        }
        
        /* Tray quantity change animation */
        .jig-loading-table input[type="number"].qty-updated {
            background-color: #e8f5e8;
            transition: background-color 0.3s ease;
        }
        
        /* Lot quantity update animation */
        #jigQrId.lot-qty-updated {
            background-color: #e8f5e8;
            border-color: #28a745;
            transition: all 0.5s ease;
        }
        
        /* Zone 2 Tray Edit Functionality CSS */
        .tray-qty-input-zone2:disabled {
            background-color: #f9f9f9 !important;
            border-color: #ccc !important;
            color: #666 !important;
            cursor: not-allowed;
        }
        
        .tray-qty-input-zone2:not(:disabled) {
            background-color: #fff !important;
            border-color: #007bff !important;
            color: #333 !important;
            cursor: text;
        }
        
        .tray-edit-btn-zone2 {
            cursor: pointer !important;
            transition: filter 0.2s ease;
        }
        
        .tray-edit-btn-zone2:hover {
            filter: brightness(0.8) !important;
        }
        
        .tray-edit-btn-zone2:active {
            transform: scale(0.95);
        }
    </style>
<!-- Model/Stock No Modal Popup -->
<div id="modelRemarkModal">
  <span id="closeModelRemarkModal">&times;</span>
  <div style="font-weight:700; font-size:18px; color:#616161; margin-bottom:20px; margin-top:4px; text-align:center;">
    Model Image Gallery
  </div>
  <div id="modelRemarkModalContent"></div>
</div>

<div class="content-wrapper">
  <!-- <h5 class="text-left mt-0 mb-3">Day Planning Pick Table</h5> -->
  
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
          <div class="card-body">
            <h5 class="text-left mt-0 mb-4" style="font-weight:700;">Jig Unloading Main Table Zone II</h5>

            <!-- Table Section -->
            <div class="table-responsive" style="overflow: scroll !important">
<table id="order-listing" class="table">
                <thead>
                  <tr>
                    <th>S.No <i class="fa fa-filter" aria-hidden="true"></i>
                      <input type="checkbox" id="selectAllCheckbox" title="Select All" />
                    </th>
                    <th>Lot ID <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>JIG ID <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Last<br>Updated <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Model Presents <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <!--<th>Plating<br>Stk No<i class="fa fa-filter" aria-hidden="true"></i></th>-->
                    <th>Polishing<br>Stk No<i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Plating Color <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Polish Finish <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th style="display: none;">Version <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <!--<th>Source-Location <i class="fa fa-filter" aria-hidden="true"></i></th>-->
                    <th>Tray Cate - Capacity <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Lot Qty <i class="fa fa-filter" aria-hidden="true"></i></th>
                      <!--<th>No of Trays <i class="fa fa-filter" aria-hidden="true"></i></th>-->
                    <th>Bath No <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Process Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Action <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Lot Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Current Stage <i class="fa fa-filter" aria-hidden="true"></i></th>
                    <th>Remarks <i class="fa fa-filter" aria-hidden="true"></i></th>
                  </tr>
                </thead>
                <tbody>
                  {% for jig_detail in jig_unload %}
                  <tr class="highlighted-tray-scan" 
                      data-jig-lot-id="{{ jig_detail.jig_lot_id }}" 
                      data-jig-qr-id="{{ jig_detail.jig_qr_id }}"
                      data-lot-id="{{ jig_detail.lot_id }}" 
                      data-lot-id-quantities='{{ jig_detail.lot_id_quantities|json_encode }}' 
                      data-lot-id-model-map='{{ jig_detail.lot_id_model_map|json_encode }}'>                    
                                      
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>                  
                        <span style="display:flex; align-items:center; gap:3px;">
                    {% if is_admin %}
                      <!-- Admin users: Show toggle switch -->
                      <label class="hold-toggle-switch" style="margin-bottom:0;">
                        {% if not jig_detail.unload_hold_lot %}
                          <input type="checkbox" class="hold-toggle-btn" checked />
                          <span class="hold-slider"></span>
                        {% else %}
                          <input type="checkbox" class="hold-toggle-btn" />
                          <span class="hold-slider"></span>
                        {% endif %}
                      </label>
                      <!-- Hold remark icon -->
                      <span class="hold-remark-icon" 
                            style="display:{% if jig_detail.unload_hold_lot or jig_detail.unload_release_lot or jig_detail.unload_holding_reason or data.unload_release_reason %}inline-block{% else %}none{% endif %}; cursor:pointer;" 
                            title="{% if jig_detail.unload_holding_reason %}Holding Reason: {{ jig_detail.unload_holding_reason }}{% endif %}{% if jig_detail.unload_holding_reason and jig_detail.unload_release_reason %}&#10;{% endif %}{% if jig_detail.unload_release_reason %}Release Reason: {{ jig_detail.unload_release_reason }}{% endif %}">
                        {% if jig_detail.unload_hold_lot or jig_detail.unload_release_lot or jig_detail.unload_holding_reason or jig_detail.unload_release_reason %}
                          <img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:12px; height:12px;" />
                        {% endif %}
                      </span>
                    {% else %}
                      <!-- Non-admin: Only show view icon if there's a holding/release reason -->
                      {% if jig_detail.unload_hold_lot or jig_detail.unload_release_lot or jig_detail.unload_holding_reason or jig_detail.unload_release_reason %}
                        <span class="hold-remark-icon" 
                              style="display:inline-block; cursor:pointer;" 
                              title="{% if jig_detail.unload_holding_reason %}Holding Reason: {{ jig_detail.unload_holding_reason }}{% endif %}{% if jig_detail.unload_holding_reason and jig_detail.unload_release_reason %}&#10;{% endif %}{% if jig_detail.unload_release_reason %}Release Reason: {{ jig_detail.unload_release_reason }}{% endif %}">
                          <img src="{% static 'assets/icons/view2.png' %}" alt="View Reason" style="width:18px; height:18px;" />
                        </span>
                      {% endif %}
                    {% endif %}
                    <span class="sno-value">{{ forloop.counter}}</span>
                      <input type="checkbox" class="row-checkbox" style="vertical-align:middle; margin-left:4px;" />

                  </span>

                      </td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %} style="padding: 8px 4px; text-align: center; font-weight: 500; color: #2c3e50; font-size: 0.9em;">{{ jig_detail.lot_id }}</td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>{{ jig_detail.jig_qr_id }}</td>
                    <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                    {{ jig_detail.IP_loaded_date_time|date:"d-M-y" }}<br>
                    <span style="display:inline-block; margin-top:4px;word-break: break-all;">{{ jig_detail.IP_loaded_date_time|date:"h:i A" }}</span>
                    </td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %} class="model-stock-no-cell" 
                          data-images='{{ jig_detail.model_images|json_encode }}'
                          data-model-colors='{{ jig_detail.model_colors|json_encode }}'
                          data-model-list='{{ jig_detail.no_of_model_cases|json_encode }}'>
                          <span class="model-stock-no-text" style="cursor:pointer;">
                              {% for model_no in jig_detail.no_of_model_cases %}
                                  {% with color=jig_detail.model_colors|get_item:model_no %}
                                      {% if color and color != 'NOT_FOUND' and color != '#cccccc' %}
                                          <span class="model-circle" 
                                                style="background-color: {{ color }}; 
                                                       border: 2px solid {{ color }};
                                                       color: white;
                                                       font-weight: bold;
                                                       text-align: center;
                                                       line-height: 12px;" 
                                                title="Model: {{ model_no }} (Color: {{ color }})"
                                                data-model="{{ model_no }}"
                                                data-color="{{ color }}">
                                          </span>
                                      {% else %}
                                          <span class="model-circle" 
                                                style="background-color: #6c757d; 
                                                       border: 2px solid #6c757d;
                                                       color: white;
                                                       font-size: 8px;
                                                       font-weight: bold;
                                                       text-align: center;
                                                       line-height: 12px;" 
                                                title="Model: {{ model_no }} (No color assigned)"
                                                data-model="{{ model_no }}"
                                                data-color="default">
                                              {{ model_no|slice:":2" }}
                                          </span>
                                      {% endif %}
                                  {% endwith %}
                              {% endfor %}
                              
                              <!-- Expand menu icon -->
                              <span class="expand-model-remark" 
                                    style="display:inline-block;
                                           width:18px;
                                           height:18px;
                                           vertical-align:middle;
                                           cursor:pointer;
                                           margin-left: 5px;" 
                                    title="Expand">
                                  <svg width="18" height="18" viewBox="0 0 18 18">
                                      <circle cx="9" cy="9" r="8" fill="#bbb"/>
                                      <polygon points="6,7 12,7 9,12" fill="#fff"/>
                                  </svg>
                              </span>
                          </span>
                      </td>
                      <!--<td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>{{ jig_detail.all_plating_stk_nos|join:", " }}</td>-->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>{{ jig_detail.all_polishing_stk_nos|join:", " }}</td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>{{ jig_detail.plating_color|highlight_plating_color|safe|default:"N/A" }}</td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur"  {% endif %}>{{ jig_detail.polish_finish_name|default:"N/A" }}</td>

                    <!-- Version display -->
                    <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %} style="display: none;">
                      {{ jig_detail.all_versions|join:", " }}
                    </td>
                    <!--
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% for location in jig_detail.unique_locations %}
                          {{ location }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      </td>-->
                      <!-- Tray Cate - Capacity (now uses tray_type and tray_capacity) -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% if jig_detail.tray_type and jig_detail.tray_capacity %}
                          {% if jig_detail.tray_capacity == 20 %}
                            <div class="tray-capacity-badge normal-tray"
                                 style="background: #dc3545; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; text-align: center; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                 title="Normal Tray - 20 Capacity (Custom for Jig Unloading Zone 2)">
                              Normal - 20                             </div>
                          {% elif jig_detail.tray_capacity == 12 %}
                            <div class="tray-capacity-badge jumbo-tray"
                                 style="background: #28a745; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 700; text-align: center; border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 2px 4px rgba(0,0,0,0.2); text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                 title="Jumbo Tray - 12 Capacity (RED, DARK GREEN & LITE GREEN)">
                              Jumbo - 12
                            </div>
                          {% else %}
                            <div class="tray-capacity-badge other-tray"
                                 style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 15px; font-size: 12px; font-weight: 600; text-align: center;"
                                 title="{{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }} Capacity">
                              {{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }}
                            </div>
                          {% endif %}
                        {% else %}
                          <span style="color: #6c757d; font-style: italic; font-size: 12px;">No Tray Info</span>
                        {% endif %}
                      </td>
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                          {{jig_detail.lot_id_quantities.values|join:", "|default:"0"}}
                      </td>
                      <!-- No of Trays -->
                        <!--<td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.calculated_no_of_trays|default:"0" }}</td>-->

                      
                      <!-- Bath No -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.bath_numbers.bath_number|default:"N/A" }}</td>

                      <!-- Process Status column -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                      {% if jig_detail.jig_unload_draft %}
                        <!-- Half green filled circle for draft -->
                        <div title="Draft (Halfway Unloaded)" style="
                          background: linear-gradient(to right, #0c8249 0 50%, #ccc 50% 100%);
                          color: #fff;
                          border-radius: 50%;
                          width: 20px;
                          height: 20px;
                          display: flex;
                          align-items: center;
                          justify-content: center;
                          font-weight: 500;
                          line-height: 20px;
                          text-align: center;
                          padding-top: 1px;
                          padding-right: 1px;
                          padding: 15px !important;
                        ">UL</div>

                      {% else %}
                        <div style="background:#ccc;color:#fff;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:12px;padding:0;">UL</div>                      {% endif %}
                      </td>

                      <!-- Action -->
                      <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>

                        <a href="#" title="Delete" class="delete-jig-btn" data-lot-id="{{ jig_detail.lot_id }}">
                          <img src="{% static 'assets/icons/bin.png' %}" alt="Delete" style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;"/>
                        </a>
                        
                        <a href="#" class="text-primary tray-scan-btn unload-modal-trigger" style="text-decoration: underline"
                           data-jig-id="{{ jig_detail.id }}"
                           data-lot-id="{{ jig_detail.lot_id }}"
                           data-lot-id-list='{{ jig_detail.lot_id_list|json_encode }}'
                           data-model-list='{{ jig_detail.no_of_model_cases|json_encode }}'
                           data-model-images='{{ jig_detail.model_images|json_encode }}'
                           data-lot-id-quantities='{% if jig_detail.lot_id_quantities %}{{ jig_detail.lot_id_quantities|json_encode }}{% else %}{}{% endif %}'
                           data-no-of-trays="{{ jig_detail.calculated_no_of_trays }}" 
                           data-tray-capacity="{{ jig_detail.primary_tray_capacity }}">
                           <span class="unload-btn-label">Unload</span>
                          </a>
         
 
                      </td>
                      <!-- Lot Status -->
                    <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>
                      {% if jig_detail.jig_unload_draft %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="border: 2px solid #4997ac; background-color: #d1f2f3; color: #03425d; font-size: 12px; white-space: nowrap; padding: 6px;">
                          Draft
                        </div>
                      {% elif not jig_detail.remarks and not jig_detail.bath_numbers %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="border: 2px solid #b3b3b3; background-color: #f5f5f5; color: #888; font-size: 12px; white-space: nowrap; padding: 6px;">
                          Pending
                        </div>
                      {% elif jig_detail.unload_hold_lot %}
                        <div
                          class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="border: 1px solid #dc3545; background-color: #f8d7da; color: #721c24; font-size: 12px; white-space: nowrap; padding: 5px;">
                          On Hold
                        </div>
                        {% elif jig_detail.batch_status == "Completed" %}
                      <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                        style="border: 2px solid #007bff; background-color: #e3f2fd; color: #0d47a1; font-size: 12px; white-space: nowrap; padding: 6px;">
                        Released
                      </div>
                      {% else %}
                          <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #f9a825; background-color: #fff8e1; color: #b26a00; font-size: 13px; white-space: nowrap; padding: 6px;">
                            Yet To Start
                          </div>
                      {% endif %}
                    </td>
                      <!-- Current Stage -->
                      <td>
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="border: 1px solid #9adeed; background-color: #d1edf3; color: #033b5d; font-size: 12px; white-space: nowrap; padding: 6px;">
                          {% if jig_detail.electroplating_only %}Electroplating{% else %}Jig Unloading{% endif %}
                        </div>
                      </td>
                    <td {% if jig_detail.unload_hold_lot %} class="row-inactive-blur" {% endif %}>

                      <!-- VoiceRec with tooltip (audio remark) -->
                          <a href="#" title="Add Audio Remark" class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: pointer;">
                            <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec" style="width: 20px; height: 20px"/>
                            <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 265px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 10px; z-index: 1000;">
                              <!-- Audio recording UI placeholder -->
                              <div style="display: flex; align-items: center; gap: 10px;">
                                <button type="button" style="background: #28a745; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center;">
                                  <i class="fa fa-microphone"></i>
                                </button>
                                <span style="font-size: 14px; color: #333;">Hold to record audio</span>
                                  <div style="text-align: right; margin-top: 10px;">
                                <button type="button" style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                  <i class="fa fa-send"></i>
                                </button>
                              </div>
                              </div>
                            
                            </div>
                          </a>
                          <a
                              href="#"
                              title="Add Remark"
                              class="remark-tooltip-trigger"
                              data-jig-lot-id="{{ jig_detail.jig_lot_id }}"
                              style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: pointer;"
                            >
                              <img
                                src="{% static 'assets/icons/chat_icon.png' %}"
                                alt="Chat"
                                style="width: 20px; height: 20px; {% if jig_detail.unloading_remarks %}filter: grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2); opacity: 1;{% endif %}"
                              />
                              <div
                                class="remark-tooltip"
                                style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;"
                              >
                                <textarea
                                  placeholder="Type your remark..."
                                  style="width: 85%; height: 40px; resize: vertical; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px;"
                                  {% if jig_detail.unloading_remarks %}readonly{% endif %}
                                >{{ jig_detail.unloading_remarks|default_if_none:"" }}</textarea>
                                <div style="text-align: right; margin-top: -35px">
                                  {% if not jig_detail.unloading_remarks %}
                                  <button
                                    type="button"
                                    style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;"
                                  >
                                    <i class="fa fa-send"></i>
                                  </button>
                                  {% else %}
                                  <div style="margin-top: 40px; color: #31708f; background: #d9edf7; border: 1px solid #bce8f1; border-radius: 4px; padding: 8px 12px; font-size: 10px; text-align: left;">
                                    <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                                    Remark already saved and cannot be edited.
                                  </div>
                                  {% endif %}
                                </div>
                              </div>
                          </a>
                 
                    </td>
                    </tr>
                  {% empty %}
                    <tr>
                      <td colspan="19" style="text-align: center; padding: 20px; color: #888;">
                        No jig details found for unloading.
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>


              <!-- Tray Scan Modal -->
                <div id="trayScanModal_DayPlanning" class="tray-scan-modal-DayPlanning"style="display:none"> 
                  <div class="tray-scan-modal-DayPlanning-content">
                    <span id="closeTrayScanModal_DayPlanning" class="tray-scan-close-readonly">&times;</span>
                    
                    <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
                      <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
                        <img src="/static/assets/images/imagePlaceholder.png" alt="User Profile" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
                        <!-- Model No and Lot Qty in same line -->
                        <div style="display: flex; flex-direction: column; gap: 2px;">
                          <div style="display: flex; align-items: center; gap: 15px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                              <span style="font-weight: bold; color: #666;">Model No:</span>
                              <h6 id="modalModelNo_DayPlanning" style="margin: 0; color: #028084; font-weight: bold;">(Fetch Dynamically)</h6>
                            </div>
                          <h7 style="margin: 0; color: #666666; font-weight: bold;">
                              Lot Qty: <span id="modalLotQty_DayPlanning" style="font-weight:bold; color:#e67e22;"></span>
                          </h7>
                          </div>
                            
                        </div>
                      </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                      <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                        Jig loading - Tray Scan 
                      </h5>
                      <button id="trayValidateBtn" type="button" style="display: flex; align-items: center; gap: 6px; background: #f5faff; border: 1px solid #023E4DCC; color: #023E4DCC; border-radius: 20px; padding: 4px 14px; font-size: 12px; font-weight: 500; cursor: pointer;">
                        
                        Tray Validate
                      </button>
                      <input id="trayValidateInput" type="text" placeholder="Enter validation info..." style="position: absolute; left: -9999px; opacity: 0; pointer-events: none;" />
                      <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="trayScanRedoBtn" style="width: 24px; height: 24px; cursor: pointer; margin-left: 8px;" title="Clear Tray IDs" />
                    </div>
                    <div id="trayErrorMessage" style="display: none; background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 12px; text-align: center;">
                      <span id="trayErrorText"></span>
                    </div>
                    <div id="trayScanDetails_DayPlanning" class="table-grid">
                      <!-- Headers and dynamic content will be injected here -->
                    </div>
                  </div>
                </div>  
               </div>
              
              <!-- Tray Scan (hyperlink) - Right side modal -->
              <div id="trayScanModal" class="tray-scan-modal active">
                <!-- Modal content will be populated by JavaScript -->
              </div>
            </div>
            
            <!-- Pagination Section -->
            <div class="pagination-wrapper">
              <nav aria-label="Page navigation">
                                <ul class="pagination justify-content-end mb-0">
                  {# Previous button #}
                  {% if page_obj.has_previous %}
                    <li>
                      <a href="?page={{ page_obj.previous_page_number }}" aria-label="Previous">
                        <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-left"></i></span>
                    </li>
                  {% endif %}
                
                  {# Always show first page #}
                  {% if page_obj.number > 3 %}
                    <li><a href="?page=1">1</a></li>
                    {% if page_obj.number > 4 %}
                      <li class="disabled"><span>â€¦</span></li>
                    {% endif %}
                  {% endif %}
                
                  {# Show pages around current page #}
                  {% for num in page_obj.paginator.page_range %}
                    {% if num >= page_obj.number|add:'-2' and num <= page_obj.number|add:'2' %}
                      {% if num == page_obj.number %}
                        <li class="active"><span>{{ num }}</span></li>
                      {% else %}
                        <li><a href="?page={{ num }}">{{ num }}</a></li>
                      {% endif %}
                    {% endif %}
                  {% endfor %}
                
                  {# Show ellipsis and last page if needed #}
                  {% if page_obj.number < page_obj.paginator.num_pages|add:'-2' %}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:'-3' %}
                      <li class="disabled"><span>â€¦</span></li>
                    {% endif %}
                    <li><a href="?page={{ page_obj.paginator.num_pages }}">{{ page_obj.paginator.num_pages }}</a></li>
                  {% endif %}
                
                  {# Next button #}
                  {% if page_obj.has_next %}
                    <li>
                      <a href="?page={{ page_obj.next_page_number }}" aria-label="Next">
                        <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                      </a>
                    </li>
                  {% else %}
                    <li class="disabled">
                      <span aria-hidden="true"><i class="fa fa-chevron-right"></i></span>
                    </li>
                  {% endif %}
                </ul>
              </nav>
            </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Hold Remark Modal -->
<div id="holdRemarkModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:20000; align-items:center; justify-content:center;">
   <div style="background:#fff; border-radius:10px; padding:28px 32px 18px 32px; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.18); position:relative;">
      <span id="closeHoldRemarkModal" style="position:absolute; top:8px; right:16px; font-size:22px; font-weight:bold; color:#d9534f; cursor:pointer;">&times;</span>
      <h5 style="margin-bottom:16px; color:#028084;">Row Hold Remark</h5>
      <textarea id="holdRemarkInput" maxlength="50" style="width:100%; height:60px; border:1px solid #ccc; border-radius:6px; padding:8px; font-size:15px; resize:none;" placeholder="Enter remark (max 50 chars)"></textarea>
      <div style="text-align:right; margin-top:10px;">
         <button id="saveHoldRemarkBtn" style="background:#007bff; color:#fff; border:none; border-radius:20px; padding:6px 18px; font-size:15px; cursor:pointer;">Save</button>
      </div>
      <div id="holdRemarkError" style="color:red; font-size:13px; min-height:18px; margin-top:6px;"></div>
   </div>
</div>

{% block script %}

<!--HOld save-->
<script nonce="{{ csp_nonce }}">
   // âœ… FIXED: Store state globally so it persists across table refreshes
   window.holdToggleState = {
     currentHoldCell: null,
     intendedState: null,
     currentBatchId: null,
     currentLotId: null
   };
   
   function attachHoldToggleListeners() {
     console.log('Attaching hold toggle listeners...');
   
     // Attach batch_id to each row for easy access
     document.querySelectorAll("tbody tr").forEach(function (row) {
       const trayScanBtn = row.querySelector('.tray-scan-btn, .tray-scan-btn-Jig');
       if (trayScanBtn) {
         row.setAttribute('data-batch-id', trayScanBtn.getAttribute('data-batch-id'));
       }
     });
   
     // Remove existing listeners and attach new ones
     document.querySelectorAll('.hold-toggle-btn').forEach(function (btn) {
       // Remove any existing click listeners
       const newBtn = btn.cloneNode(true);
       btn.parentNode.replaceChild(newBtn, btn);
       
       // Add new event listener
       newBtn.addEventListener('click', function (e) {
         e.preventDefault();
         
         const holdCell = newBtn.closest('td');
        const row = holdCell.closest('tr');
        let lotId = row.getAttribute('data-jig-lot-id');
        if (!lotId) {
          // Try to get from checkbox in the row
          const checkbox = row.querySelector('.model-select-checkbox');
          if (checkbox) {
            lotId = checkbox.getAttribute('data-jig-lot-id');
          }
        }
        window.holdToggleState = {
          currentHoldCell: holdCell,
          intendedState: newBtn.checked,
          currentLotId: lotId,
          rowIdentifier: lotId
        };
         console.log('Hold toggle clicked, state:', window.holdToggleState);
         
         document.getElementById('holdRemarkModal').querySelector('h5').textContent = 
           window.holdToggleState.intendedState ? 'Unholding Reason' : 'Holding Reason';
         document.getElementById('holdRemarkInput').value = '';
         document.getElementById('holdRemarkError').textContent = '';
         document.getElementById('holdRemarkModal').style.display = 'flex';
         document.getElementById('holdRemarkInput').focus();
       });
     });
   
     // âœ… Attach save button handler (only once globally)
     const saveBtn = document.getElementById('saveHoldRemarkBtn');
     if (saveBtn && !window.holdSaveHandlerAttached) {
       window.holdSaveHandlerAttached = true;
       
       saveBtn.onclick = function () {
         console.log('Save button clicked, current state:', window.holdToggleState);
         
         const remark = document.getElementById('holdRemarkInput').value.trim();
         if (!remark) {
           document.getElementById('holdRemarkError').textContent = 'Remark required!';
           return;
         }
         
         // âœ… Use stored state instead of current variables
         if (!window.holdToggleState.currentLotId) {
           document.getElementById('holdRemarkError').textContent = 'Lot ID not found!';
           return;
         }
       
         const action = window.holdToggleState.intendedState ? 'unhold' : 'hold';
         
         console.log('Sending request:', {
           lot_id: window.holdToggleState.currentLotId,
           remark: remark,
           action: action
         });
       
         fetch('/JigUnloading_Zone2/JU_Zone_unload_save_hold_unhold_reason/', {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify({
             jig_lot_id: window.holdToggleState.currentLotId,
             remark: remark,
             action: action
           })
         })
         .then(res => res.json())
         .then(data => {
           console.log('Server response:', data);
           
           if (data.success) {
             // âœ… Close modal first
             document.getElementById('holdRemarkModal').style.display = 'none';
             
             // âœ… Update UI immediately before refresh
             const currentRow = document.querySelector(`tr[data-jig-lot-id="${window.holdToggleState.currentLotId}"]`);
             if (currentRow) {
               const toggle = currentRow.querySelector('.hold-toggle-btn');
               const icon = currentRow.querySelector('.hold-remark-icon');
               
               if (action === 'hold') {
                 if (toggle) toggle.checked = false;
                 currentRow.classList.add('row-inactive');
                 currentRow.querySelectorAll('td').forEach((td, idx) => {
                   if (idx > 0) {
                     td.classList.add('row-inactive-blur');
                   } else {
                     td.classList.remove('row-inactive-blur');
                   }
                 });
                 if (icon) {
                   icon.style.display = 'inline-block';
                   icon.innerHTML = `<img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:18px; height:18px;" />`;
                   icon.setAttribute('title', 'Holding Reason: ' + remark);
                 }
               } else {
                 if (toggle) toggle.checked = true;
                 currentRow.classList.remove('row-inactive');
                 currentRow.querySelectorAll('td').forEach(td => {
                   td.classList.remove('row-inactive-blur');
                 });
                 if (icon) {
                   icon.style.display = 'none';
                 }
               }
             }
             
             // âœ… Then refresh the table data
             setTimeout(() => {
               if (typeof refreshTableData === 'function') {
                 location.reload();
               } else {
                 location.reload();
               }
             }, 500);
             
           } else {
             document.getElementById('holdRemarkError').textContent = data.error || 'Failed to save reason!';
           }
         })
         .catch((error) => {
           console.error('Request failed:', error);
           document.getElementById('holdRemarkError').textContent = 'Network error!';
         });
       };
     }
   
     // âœ… Attach close button handler (only once globally)
     const closeBtn = document.getElementById('closeHoldRemarkModal');
     if (closeBtn && !window.holdCloseHandlerAttached) {
       window.holdCloseHandlerAttached = true;
       closeBtn.onclick = function () {
         document.getElementById('holdRemarkModal').style.display = 'none';
         // Clear the state when modal is closed
         window.holdToggleState = {
           currentHoldCell: null,
           intendedState: null,
           currentBatchId: null,
           currentLotId: null
         };
       };
     }
   
     // Helper for CSRF
     function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
         const cookies = document.cookie.split(';');
         for (let i = 0; i < cookies.length; i++) {
           const cookie = cookies[i].trim();
           if (cookie.substring(0, name.length + 1) === (name + '=')) {
             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
             break;
           }
         }
       }
       return cookieValue;
     }
   }
   
   // âœ… Call on page load
   document.addEventListener("DOMContentLoaded", function () {
     attachHoldToggleListeners();
   });
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  // Setup tray edit event listeners for Zone 2 with retry mechanism
  console.log('ðŸš€ Zone 2 DOM loaded, setting up edit listeners...');
  
  // Initial setup
  if (typeof window.setupTrayEditEventListenersZone2 === 'function') {
    window.setupTrayEditEventListenersZone2();
  } else {
    console.warn('âš ï¸ setupTrayEditEventListenersZone2 function not found');
  }
  
  // Also set up listeners after a short delay to catch any dynamically created elements
  setTimeout(() => {
    if (typeof window.setupTrayEditEventListenersZone2 === 'function') {
      window.setupTrayEditEventListenersZone2();
    }
  }, 1000);
  
  // Collect all jig_lot_ids for unload status check
  const rows = document.querySelectorAll("#order-listing tbody tr[data-jig-lot-id]");
  const jigLotIds = [];
  
  // Build a map of jig_lot_id to lot_ids for each row
  const jigToLotIdsMap = new Map();
  
  rows.forEach(row => {
    const jigLotId = row.getAttribute("data-jig-lot-id");
    const lotIdQuantitiesStr = row.getAttribute("data-lot-id-quantities");
    
    if (jigLotId && jigLotId.trim()) {
      jigLotIds.push(jigLotId.trim());
      
      // Extract lot_ids from this jig
      if (lotIdQuantitiesStr) {
        try {
          const lotIdQuantities = JSON.parse(lotIdQuantitiesStr);
          const lotIds = Object.keys(lotIdQuantities);
          jigToLotIdsMap.set(jigLotId, lotIds);
          console.log(`ðŸ” Jig ${jigLotId} has lot_ids:`, lotIds);
        } catch (e) {
          console.warn(`Failed to parse lot_id_quantities for jig ${jigLotId}:`, e);
        }
      }
    }
  });

  console.log("Found jig_lot_ids:", jigLotIds);
  console.log("Jig to Lot IDs mapping:", jigToLotIdsMap);

  // Call the backend to check which lot_ids are unloaded for each jig
  if (jigLotIds.length > 0) {
    // Check each jig individually to get accurate results
    const checkPromises = Array.from(jigToLotIdsMap.entries()).map(([jigLotId, lotIds]) => {
      console.log(`ðŸ” Checking unload status for jig ${jigLotId} with lot_ids:`, lotIds);
      
      return fetch('/JigUnloading_Zone2/JU_Zone_check_unload_status/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ 
          lot_ids: lotIds,
          jig_lot_id: jigLotId  // ðŸ”§ NEW: Include jig_lot_id for context
        })
      })
      .then(res => res.json())
      .then(data => ({
        jigLotId: jigLotId,
        lotIds: lotIds,
        unloadedLotIds: data.success ? (data.unloaded_lot_ids || []) : [],
        success: data.success
      }))
      .catch(error => {
        console.error(`Error checking unload status for jig ${jigLotId}:`, error);
        return {
          jigLotId: jigLotId,
          lotIds: lotIds,
          unloadedLotIds: [],
          success: false
        };
      });
    });

    Promise.all(checkPromises).then(results => {
      console.log("ðŸ” All unload status checks completed:", results);
      
      // Process results for each jig
      results.forEach(result => {
        const { jigLotId, lotIds, unloadedLotIds, success } = result;
        
        if (success) {
          console.log(`ðŸ” Jig ${jigLotId}: ${unloadedLotIds.length} of ${lotIds.length} lot_ids are unloaded`);
          console.log(`    Unloaded lot_ids:`, unloadedLotIds);
          
          // Find the row for this jig and update its unload button
          const row = document.querySelector(`tr[data-jig-lot-id="${jigLotId}"]`);
          if (row) {
            const unloadLink = row.querySelector('.unload-modal-trigger');
            if (unloadLink) {
              const unloadLabel = unloadLink.querySelector('.unload-btn-label');
              const viewIcon = unloadLink.querySelector('.view-btn-icon');
              
              // Check if ALL lot_ids for this jig are unloaded
              const allLotIdsUnloaded = lotIds.length > 0 && lotIds.every(lotId => unloadedLotIds.includes(lotId));
              
              console.log(`ðŸ” Jig ${jigLotId}: All lot_ids unloaded? ${allLotIdsUnloaded}`);
              
              if (allLotIdsUnloaded) {
                // All lot_ids are unloaded: hide Unload, show View
                if (unloadLabel) unloadLabel.style.display = 'none';
                if (viewIcon) viewIcon.style.display = '';
                unloadLink.classList.add('view-only');
                console.log(`âœ… Jig ${jigLotId}: Switched to View mode (all unloaded)`);
              } else {
                // Some or no lot_ids are unloaded: show Unload, hide View
                if (unloadLabel) unloadLabel.style.display = '';
                if (viewIcon) viewIcon.style.display = 'none';
                unloadLink.classList.remove('view-only');
                console.log(`âœ… Jig ${jigLotId}: Kept in Unload mode (${unloadedLotIds.length}/${lotIds.length} unloaded)`);
              }
            }
          }
        } else {
          console.error(`âŒ Failed to check unload status for jig ${jigLotId}`);
        }
      });
    });
  }
});
</script>
<script nonce="{{ csp_nonce }}">

// Tray ID validation script for Zone 2
document.addEventListener("DOMContentLoaded", function () {
  // âœ… ENHANCED: Add dynamic validation with debouncing for Zone 2
  let validationTimeoutZone2;
  
  // Enhanced blur event listener with comprehensive validation
  document.body.addEventListener('blur', function (e) {
    if (
      e.target.tagName === 'INPUT' &&
      e.target.type === 'text' &&
      e.target.closest('.jig-loading-table')
    ) {
      validateTrayIdZone2(e);
    }
  }, true);

  // Enhanced keydown event listener for Enter key
  document.body.addEventListener('keydown', function (e) {
    if (
      e.target.tagName === 'INPUT' &&
      e.target.type === 'text' &&
      e.target.closest('.jig-loading-table') &&
      e.key === 'Enter'
    ) {
      validateTrayIdZone2({ target: e.target, keyEvent: e });
    }
  });

  // âœ… NEW: Dynamic validation as user types (debounced) for Zone 2
  document.body.addEventListener('input', function (e) {
    if (
      e.target.tagName === 'INPUT' &&
      e.target.type === 'text' &&
      e.target.closest('.jig-loading-table')
    ) {
      // Clear existing timeout
      if (validationTimeoutZone2) {
        clearTimeout(validationTimeoutZone2);
      }
      
      // Set new timeout for validation (1500ms delay to allow full tray ID typing)
      try {
        const inputEl = e.target;
        const uploadModal = document.getElementById('uploadChildModal');
        if (uploadModal && inputEl && inputEl.dataset && inputEl.dataset.prevValue) {
          const prev = inputEl.dataset.prevValue.trim().toLowerCase();
          const current = (inputEl.value || '').trim().toLowerCase();
          if (prev && prev !== current && uploadModal._scannedTrays instanceof Set) {
            uploadModal._scannedTrays.delete(prev);
            delete inputEl.dataset.prevValue;
          }
        }
      } catch (err) { console.error('Zone2 cleaning prev tray error:', err); }

      validationTimeoutZone2 = setTimeout(() => {
        validateTrayIdZone2({ target: e.target });
      }, 1500);
    }
  });

  function validateTrayIdZone2(e) {
    const input = e.target;
    const trayId = input.value.trim();

    // Remove any previous validation messages
    clearTrayValidationMessagesZone2(input);
    
    if (!trayId) {
      // Reset styling when input is empty
      input.style.borderColor = '#ccc';
      input.style.backgroundColor = '';
      return;
    }

    // âœ… ENHANCED: Get plating color from modal context
    const uploadModal = document.getElementById('uploadChildModal');
    const lot_id = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
    const plating_color = uploadModal ? uploadModal.getAttribute('data-plating-color') : 'OTHER';

    // Prevent duplicate validations: if the same tray is already present in
    // another input inside this modal/table, skip server validation.
    try {
      const tbody = input.closest('tbody');
      if (tbody) {
        const otherInputs = Array.from(tbody.querySelectorAll('input[type="text"]'));
        const duplicate = otherInputs.some(inp => inp !== input && inp.value.trim().toLowerCase() === trayId.toLowerCase());
        if (duplicate) {
          showTrayValidationMessageZone2(input, 'Tray already scanned in another slot', 'warning');
          input.style.borderColor = '#ffc107';
          input.style.backgroundColor = '#fff8e1';
          return;
        }
      }
    } catch (e) {
      console.error('Zone2 duplicate detection error:', e);
    }

    console.log('[Zone 2 Validation] Tray:', trayId, 'Lot:', lot_id, 'Color:', plating_color);

    // Show loading state
    showTrayValidationLoadingZone2(input);
    
    console.log('[Zone 2 Tray Validation] Calling dynamic API for:', trayId, 'with lot_id:', lot_id);

    // âœ… NEW: Use dynamic validation API for real-time feedback
    fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id_dynamic/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ 
        tray_id: trayId,
        lot_id: lot_id,
        plating_color: plating_color
      })
    })
    .then(res => res.json())
    .then(data => {
      clearTrayValidationMessagesZone2(input);
      
      if (data.success) {
        // âœ… SUCCESS: Tray is valid
        input.style.borderColor = '#4caf50';
        input.style.backgroundColor = '#f1f8e9';
        showTrayValidationMessageZone2(input, data.message || 'âœ… Valid for unloading', 'success');
        try {
          const uploadModal = document.getElementById('uploadChildModal');
          if (uploadModal) {
            if (!uploadModal._scannedTrays) uploadModal._scannedTrays = new Set();
            uploadModal._scannedTrays.add(trayId.toLowerCase());
            input.dataset.prevValue = trayId;
          }
        } catch (err) { console.error('Zone2 record scanned tray error:', err); }
        try {
          const uploadModal = document.getElementById('uploadChildModal');
          if (uploadModal) {
            if (!uploadModal._scannedTrays) uploadModal._scannedTrays = new Set();
            uploadModal._scannedTrays.add(input.value.trim().toLowerCase());
            input.dataset.prevValue = input.value.trim();
          }
        } catch (err) { console.error('Zone2 attach handler record error:', err); }
        
        // Auto-move to next input on Enter
        if (e.keyEvent && e.keyEvent.key === 'Enter') {
          moveToNextTrayInputZone2(input);
        }
      } else {
        // âŒ ERROR: Tray validation failed
        input.style.borderColor = '#d32f2f';
        input.style.backgroundColor = '#ffebee';
        
        // Use the professional message from API response
        const errorMessage = data.message || 'âŒ Tray validation failed';
        showTrayValidationMessageZone2(input, errorMessage, 'error');
        
        // Keep focus on invalid input
        input.focus();
        input.select();
      }
    })
    .catch(error => {
      console.error('Zone 2 Tray validation error:', error);
      clearTrayValidationMessagesZone2(input);
      input.style.borderColor = '#ff5722';
      input.style.backgroundColor = '#fff3e0';
      showTrayValidationMessageZone2(input, 'âš ï¸ Validation error - please try again', 'warning');
    });
  }

  // Helper function to clear all validation messages
  function clearTrayValidationMessagesZone2(input) {
    const trayIdCell = input.closest('td');
    const existingMessages = trayIdCell.querySelectorAll('.tray-validation-message');
    existingMessages.forEach(msg => msg.remove());
    
    // Also remove old error rows
    let errorRow = input.closest('tr').nextElementSibling;
    if (errorRow && errorRow.classList.contains('tray-id-error-row')) {
      errorRow.remove();
    }
  }

  // Helper function to show loading state
  function showTrayValidationLoadingZone2(input) {
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'tray-validation-message tray-loading';
    loadingDiv.style.cssText = `
      color: #6c757d;
      font-size: 11px;
      font-weight: 500;
      margin-top: 4px;
      padding: 2px 6px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 4px;
    `;
    loadingDiv.innerHTML = 'ðŸ”„ Validating...';
    input.parentNode.appendChild(loadingDiv);
  }

  // Helper function to show validation messages
  function showTrayValidationMessageZone2(input, message, type) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `tray-validation-message tray-${type}`;
    
    let styles = {
      'font-size': '11px',
      'font-weight': 'bold',
      'padding': '4px 6px',
      'border-radius': '4px',
      'margin-top': '4px',
      'display': 'block'
    };
    
    if (type === 'success') {
      styles.color = '#2e7d32';
      styles['background-color'] = '#f1f8e9';
      styles.border = '1px solid #c8e6c9';
    } else if (type === 'error') {
      styles.color = '#d32f2f';
      styles['background-color'] = '#ffebee';
      styles.border = '1px solid #f5c6cb';
    } else if (type === 'warning') {
      styles.color = '#f57c00';
      styles['background-color'] = '#fff3e0';
      styles.border = '1px solid #ffcc80';
    }
    
    // Apply styles
    Object.keys(styles).forEach(key => {
      messageDiv.style.setProperty(key, styles[key]);
    });
    
    messageDiv.textContent = message;
    input.parentNode.appendChild(messageDiv);
    
    // Auto-remove success messages after 2 seconds
    if (type === 'success') {
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 2000);
    }
  }

  // Helper function to move to next tray input
  function moveToNextTrayInputZone2(currentInput) {
    const allTrayInputs = Array.from(document.querySelectorAll('.jig-loading-table input[type="text"]:not([readonly])'));
    const currentIndex = allTrayInputs.indexOf(currentInput);
    
    if (currentIndex >= 0 && currentIndex < allTrayInputs.length - 1) {
      const nextInput = allTrayInputs[currentIndex + 1];
      setTimeout(() => {
        nextInput.focus();
        nextInput.select();
      }, 100);
    }
  }
});
</script>



<!-- Helper function for CSRF token -->
<script nonce="{{ csp_nonce }}">
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- Script for Delete functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.delete-jig-btn').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const lotId = this.getAttribute('data-lot-id');
      if (!lotId) {
        Swal.fire('Error', 'Lot ID not found.', 'error');
        return;
      }
      Swal.fire({
        title: 'Are you sure?',
        text: "Do you really want to delete this record?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Delete',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch('/JigUnloading_Zone2/delete_jig_details/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ lot_id: lotId })
          })
          .then(res => res.json())
          .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Record deleted successfully.',
                  showConfirmButton: false,
                  timer: 1200
                }).then(() => window.location.reload());
              } else {
                Swal.fire('Error', data.message || 'Failed to delete record.', 'error');
              }
          })
          .catch(() => {
            Swal.fire('Error', 'Network error.', 'error');
          });
        }
      });
    });
  });
});
</script>

<!-- Enhanced Script for dynamic model image gallery view with navigation -->
<script nonce="{{ csp_nonce }}">
   // Global color palette and model-to-color mapping (use shared window vars)
   window.GLOBAL_COLOR_PALETTE = window.GLOBAL_COLOR_PALETTE || [
     "#e74c3c", "#f1c40f", "#2ecc71", "#3498db", "#9b59b6",
     "#e67e22", "#1abc9c", "#34495e", "#f39c12", "#d35400",
     "#c0392b", "#8e44ad", "#2980b9", "#27ae60", "#16a085",
     "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7",
     "#dda0dd", "#98d8c8", "#f7dc6f", "#bb8fce", "#85c1e9"
   ];

   // Global mapping to ensure consistent colors across all rows
   window.globalModelColors = window.globalModelColors || {};
   window._globalColorIndex = typeof window._globalColorIndex === 'number' ? window._globalColorIndex : 0;

   // Function to get consistent color for a model
   function getGlobalModelColor(modelNo) {
     if (!window.globalModelColors[modelNo]) {
       const idx = window._globalColorIndex || 0;
       window.globalModelColors[modelNo] = window.GLOBAL_COLOR_PALETTE[idx % window.GLOBAL_COLOR_PALETTE.length];
       window._globalColorIndex = idx + 1;
     }
     return window.globalModelColors[modelNo];
   }
   
   // Initialize global colors on page load by scanning all model data
   function initializeGlobalModelColors() {
     console.log('ðŸŽ¨ Zone 2: Initializing global model colors...');
     
     // Collect all unique models from all rows
     const allModels = new Set();
     
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         modelList.forEach(model => allModels.add(model));
       } catch (e) {
         console.warn('Zone 2: Error parsing model list:', e);
       }
     });
     
     // Assign colors to all models consistently
     const sortedModels = Array.from(allModels).sort(); // Sort for consistency
     sortedModels.forEach(function(modelNo) {
       getGlobalModelColor(modelNo); // This will assign colors in order
     });
     
     console.log('ðŸŽ¨ Zone 2: Global model colors initialized:', window.globalModelColors);
     
     // Update all existing model circles with consistent colors
     updateAllModelCircles();
   }
   
   // Function to update all model circles with consistent colors
   function updateAllModelCircles() {
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         const circles = cell.querySelectorAll('.model-circle');
         
         circles.forEach(function(circle, index) {
           if (modelList[index]) {
             const color = getGlobalModelColor(modelList[index]);
             circle.style.backgroundColor = color;
           }
         });
       } catch (e) {
         console.warn('Zone 2: Error updating model circles:', e);
       }
     });
   }

document.addEventListener("DOMContentLoaded", function () {
  // Initialize global colors first
  initializeGlobalModelColors();
  
  const modal = document.getElementById('modelRemarkModal');
  const closeBtn = document.getElementById('closeModelRemarkModal');
  const modalContent = document.getElementById('modelRemarkModalContent');
     closeBtn.addEventListener("click", function () {
    //add this below line
    window.location.reload(); 
   });

  document.querySelectorAll('.expand-model-remark').forEach(function(expandBtn) {
    expandBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      const cell = expandBtn.closest('.model-stock-no-cell');
      if (!cell) return;

      try {
        const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
        const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
        const modelColors = JSON.parse(cell.getAttribute('data-model-colors') || '{}');
        
        console.log('ðŸ” Zone 2 Modal Debug Info:');
        console.log('   modelList:', modelList);
        console.log('   modelImages:', modelImages);
        console.log('   modelColors:', modelColors);
        
        // Clear previous content
        modalContent.innerHTML = '';
        
        if (modelList.length === 0) {
          modalContent.innerHTML = '<p style="text-align:center; color:#666;">No models available</p>';
        } else {
          modelList.forEach(function(modelNo, index) {
            const color = getGlobalModelColor(modelNo);
            
            // FIXED: Get images using the correct data structure
            let images = [];
            let firstImage = '/static/assets/images/imagePlaceholder.png';
            
            // Check multiple possible data structures for images
            if (modelImages[modelNo]) {
              if (Array.isArray(modelImages[modelNo])) {
                // Direct array of image URLs
                images = modelImages[modelNo];
                firstImage = images[0] || firstImage;
              } else if (modelImages[modelNo].images && Array.isArray(modelImages[modelNo].images)) {
                // Object with 'images' property
                images = modelImages[modelNo].images;
                firstImage = images[0] || firstImage;
              } else if (modelImages[modelNo].first_image) {
                // Object with 'first_image' property
                firstImage = modelImages[modelNo].first_image;
                images = modelImages[modelNo].images || [firstImage];
              } else if (typeof modelImages[modelNo] === 'string') {
                // Single image URL as string
                images = [modelImages[modelNo]];
                firstImage = modelImages[modelNo];
              }
            }
            
            console.log(`ðŸ“¸ Zone 2 Model ${modelNo} images:`, images);
            console.log(`ðŸ“¸ Zone 2 Model ${modelNo} firstImage:`, firstImage);
            
            // Create model row container
            const modelRow = document.createElement('div');
            modelRow.className = 'model-row';
            modelRow.style.cssText = `
              display: flex;
              align-items: flex-start;
              gap: 12px;
              margin-bottom: 16px;
              padding: 12px;
              border: 1px solid #e5e5e5;
              border-radius: 8px;
              background: #fafafa;
              transition: all 0.2s ease;
              cursor: pointer;
            `;
            
            // Add hover effect
            modelRow.addEventListener('mouseenter', function() {
              this.style.background = '#f0f8ff';
              this.style.borderColor = '#007bff';
              this.style.transform = 'translateY(-1px)';
              this.style.boxShadow = '0 4px 12px rgba(0,123,255,0.15)';
            });
            
            modelRow.addEventListener('mouseleave', function() {
              this.style.background = '#fafafa';
              this.style.borderColor = '#e5e5e5';
              this.style.transform = 'translateY(0)';
              this.style.boxShadow = 'none';
            });
            
            // Add navigation on click with correct model_no extraction
            modelRow.addEventListener('click', function() {
              const cleanModelNo = extractModelNumber(modelNo);
              const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
              console.log(`ðŸ”— Zone 2 Navigating to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
              console.log(`ðŸ”— Zone 2 URL: ${visualAidUrl}`);
              window.open(visualAidUrl, '_blank');
            });
            
            // Model circle
            const circle = document.createElement('span');
            circle.className = 'model-circle';
            circle.style.cssText = `
              display: inline-block;
              width: 20px;
              height: 20px;
              border-radius: 50%;
              background-color: ${color};
              border: 2px solid #fff;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              flex-shrink: 0;
              margin-top: 2px;
            `;
            
            // Content container
            const contentContainer = document.createElement('div');
            contentContainer.style.cssText = `
              flex: 1;
              min-width: 0;
            `;
            
            // Model number
            const modelNoElement = document.createElement('div');
            modelNoElement.className = 'model-no';
            modelNoElement.textContent = modelNo;
            modelNoElement.style.cssText = `
              font-weight: 700;
              color: #023E4DCC;
              font-size: 16px;
              margin-bottom: 8px;
              word-break: break-word;
            `;
            
            // Images container
            const imagesContainer = document.createElement('div');
            imagesContainer.style.cssText = `
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
              margin-top: 8px;
            `;
            
            if (images.length > 0) {
              console.log(`ðŸ“¸ Zone 2 Displaying ${images.length} images for model ${modelNo}`);
              
              images.slice(0, 3).forEach(function(imageUrl, imgIndex) {
                const img = document.createElement('img');
                img.src = imageUrl;
                img.alt = `${modelNo} - Image ${imgIndex + 1}`;
                img.style.cssText = `
                  width: 200px;
                  height: 200px;
                  object-fit: cover;
                  border-radius: 6px;
                  border: 1px solid #ddd;
                  background: #fff;
                  transition: transform 0.2s ease;
                  cursor: pointer;
                `;
                
                // Add click handler to show full image viewer
                img.addEventListener('click', function(e) {
                  e.stopPropagation(); // Prevent row click
                  showModelImages(modelNo, JSON.stringify(images));
                });
                
                img.addEventListener('mouseenter', function() {
                  this.style.transform = 'scale(1.1)';
                });
                
                img.addEventListener('mouseleave', function() {
                  this.style.transform = 'scale(1)';
                });
                
                // Handle image load errors
                img.addEventListener('error', function() {
                  this.src = '/static/assets/images/imagePlaceholder.png';
                  this.style.opacity = '0.5';
                });
                
                imagesContainer.appendChild(img);
              });
              
              if (images.length > 3) {
                const moreIndicator = document.createElement('div');
                moreIndicator.textContent = `+${images.length - 3} more`;
                moreIndicator.style.cssText = `
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  width: 50px;
                  height: 50px;
                  background: #f8f9fa;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  font-size: 10px;
                  color: #666;
                  font-weight: 600;
                  cursor: pointer;
                `;
                
                moreIndicator.addEventListener('click', function(e) {
                  e.stopPropagation();
                  showModelImages(modelNo, JSON.stringify(images));
                });
                
                imagesContainer.appendChild(moreIndicator);
              }
            } else {
              console.log(`âŒ Zone 2 No images found for model ${modelNo}`);
              const noImageIndicator = document.createElement('div');
              noImageIndicator.textContent = 'No Images';
              noImageIndicator.style.cssText = `
                width: 50px;
                height: 50px;
                background: #f8f9fa;
                border: 1px solid #ddd;
                border-radius: 6px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                color: #999;
              `;
              imagesContainer.appendChild(noImageIndicator);
            }
            
            // Click to view indicator
            const clickIndicator = document.createElement('div');
            clickIndicator.innerHTML = 'ðŸ”— Click to view in Visual Aid';
            clickIndicator.style.cssText = `
              font-size: 11px;
              color: #007bff;
              margin-top: 6px;
              font-style: italic;
            `;
            
            // Assemble the row
            contentContainer.appendChild(modelNoElement);
            contentContainer.appendChild(imagesContainer);
            contentContainer.appendChild(clickIndicator);
            
            modelRow.appendChild(circle);
            modelRow.appendChild(contentContainer);
            
            modalContent.appendChild(modelRow);
          });
        }
        
        modal.style.display = 'block';
      } catch (error) {
        console.error('Zone 2 Error showing model gallery:', error);
        modalContent.innerHTML = '<p style="text-align:center; color:#dc3545;">Error loading model data</p>';
        modal.style.display = 'block';
      }
    });
  });

  closeBtn.addEventListener('click', function() {
    modal.style.display = 'none';
  });
  
  window.addEventListener('click', function(e) {
    if (modal.style.display === 'block' && !modal.contains(e.target) && !e.target.classList.contains('expand-model-remark')) {
      modal.style.display = 'none';
    }
  });
});

// Function to extract clean model number from complex model strings
function extractModelNumber(modelString) {
  console.log(`ðŸ” Zone 2 Extracting model number from: "${modelString}"`);
  
  if (!modelString || typeof modelString !== 'string') {
    console.log('âŒ Zone 2 Invalid model string, returning as-is');
    return modelString;
  }
  
  // Pattern 1: Extract leading digits (e.g., "1805NAD02" -> "1805")
  const leadingDigitsMatch = modelString.match(/^(\d+)/);
  if (leadingDigitsMatch) {
    const extracted = leadingDigitsMatch[1];
    console.log(`âœ… Zone 2 Extracted using leading digits pattern: "${extracted}"`);
    return extracted;
  }
  
  // Pattern 2: Extract model before first letter (e.g., "2617ABC" -> "2617")
  const beforeLetterMatch = modelString.match(/^(\d+)(?=[A-Za-z])/);
  if (beforeLetterMatch) {
    const extracted = beforeLetterMatch[1];
    console.log(`âœ… Zone 2 Extracted using before-letter pattern: "${extracted}"`);
    return extracted;
  }
  
  // Pattern 3: Extract digits before any special characters
  const beforeSpecialMatch = modelString.match(/^(\d+)(?=\W)/);
  if (beforeSpecialMatch) {
    const extracted = beforeSpecialMatch[1];
    console.log(`âœ… Zone 2 Extracted using before-special pattern: "${extracted}"`);
    return extracted;
  }
  
  // If no pattern matches, return the original string
  console.log(`âš ï¸ Zone 2 No extraction pattern matched, returning original: "${modelString}"`);
  return modelString;
}

// Enhanced function to show model images in a larger view with navigation
function showModelImages(modelNo, imagesJson) {
  try {
    const images = JSON.parse(imagesJson);
    if (images.length === 0) {
      // If no images, directly navigate to visual aid with cleaned model number
      const cleanModelNo = extractModelNumber(modelNo);
      const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
      console.log(`ðŸ”— Zone 2 No images found, navigating directly to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
      window.open(visualAidUrl, '_blank');
      return;
    }
    
    // Get the consistent global color for this model
    const modelColor = getGlobalModelColor(modelNo);
    
    // Create image viewer modal
    let imageModal = document.getElementById('modelImageViewer');
    if (!imageModal) {
      imageModal = document.createElement('div');
      imageModal.id = 'modelImageViewer';
      imageModal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0,0,0,0.9); z-index: 100000; display: none;
        justify-content: center; align-items: center;
      `;
      document.body.appendChild(imageModal);
    }
    
    let currentIndex = 0;
    
    function updateImage() {
      const cleanModelNo = extractModelNumber(modelNo);
      
      imageModal.innerHTML = `
        <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 12px; padding: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <span class="model-circle" style="background:${modelColor};width:20px;height:20px;display:inline-block;border-radius:50%;"></span>
              <h3 style="margin: 0; color: ${modelColor};">Zone 2 Model: ${modelNo} (${currentIndex + 1}/${images.length})</h3>
            </div>
            <div style="display: flex; gap: 10px;">
              <button onclick="window.open('/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}', '_blank')" 
                      style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                ðŸ”— Open Visual Aid
              </button>
              <button onclick="document.getElementById('modelImageViewer').style.display='none'" 
                      style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 18px;">
                âœ•
              </button>
            </div>
          </div>
          <div style="position: relative;">
            <img src="${images[currentIndex]}" alt="Model ${modelNo}" 
                 style="max-width: 100%; max-height: 70vh; object-fit: contain; display: block; margin: 0 auto;"
                 onerror="this.src='/static/assets/images/imagePlaceholder.png'; this.style.opacity='0.5';">
            ${images.length > 1 ? `
              <button onclick="prevImage()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€¹</button>
              <button onclick="nextImage()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€º</button>
            ` : ''}
          </div>
          <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
            Click "Open Visual Aid" to view detailed information about this model
          </div>
        </div>
      `;
    }
    
    window.prevImage = function() {
      if (currentIndex > 0) {
        currentIndex--;
        updateImage();
      }
    };
    
    window.nextImage = function() {
      if (currentIndex < images.length - 1) {
        currentIndex++;
        updateImage();
      }
    };
    
    updateImage();
    imageModal.style.display = 'flex';
    
  } catch (error) {
    console.error('Zone 2 Error showing images:', error);
    // Fallback: navigate to visual aid with cleaned model number
    const cleanModelNo = extractModelNumber(modelNo);
    const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
    window.open(visualAidUrl, '_blank');
  }
}
</script>

<!-- Script for Text Remarks functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  var triggers = document.querySelectorAll(".remark-tooltip-trigger");
  triggers.forEach(function (trigger) {
    var tooltip = trigger.querySelector(".remark-tooltip");
    var sendButton = tooltip ? tooltip.querySelector("button") : null;
    
    function showTooltip() {
      tooltip.style.opacity = "1";
      tooltip.style.visibility = "visible";
      var rect = tooltip.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        tooltip.style.left = "auto";
        tooltip.style.right = "0";
        tooltip.style.transform = "none";
      }
      if (rect.left < 0) {
        tooltip.style.left = "0";
        tooltip.style.transform = "none";
      }
      var textarea = tooltip.querySelector("textarea");
      if (textarea) {
        textarea.focus();
      }
    }
    
    function hideTooltip() {
      tooltip.style.opacity = "0";
      tooltip.style.visibility = "hidden";
    }
    
    trigger.addEventListener("mouseenter", showTooltip);
    trigger.addEventListener("mouseleave", function () {
      setTimeout(function () {
        if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
          hideTooltip();
        }
      }, 100);
    });
    tooltip.addEventListener("mouseleave", function () {
      setTimeout(function () {
        if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
          hideTooltip();
        }
      }, 100);
    });
    trigger.addEventListener("click", function (e) {
      e.preventDefault();
    });
    
    if (sendButton) {
      sendButton.addEventListener("click", function (e) {
        e.preventDefault();
        var textarea = tooltip.querySelector("textarea");
        var unloadingRemark = textarea ? textarea.value.trim() : "";
        if (!unloadingRemark) {
          Swal.fire('Error', 'Please enter a remark before sending.', 'error');
          return;
        }

        var jigLotId = trigger.getAttribute('data-jig-lot-id');
        if (!jigLotId) {
          Swal.fire('Error', 'JIG Lot ID not found.', 'error');
          return;
        }
        
        fetch('/JigUnloading_Zone2/JU_Zone_save_jig_pick_remark/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
            jig_lot_id: jigLotId,
            unloading_remarks: unloadingRemark
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Remark saved!',
              timer: 1200,
              showConfirmButton: false
            }).then(() => {
              if (textarea) {
                textarea.setAttribute("readonly", true);
              }
        
              if (sendButton && tooltip) {
                const infoDiv = document.createElement("div");
                infoDiv.style.marginTop = "40px";
                infoDiv.style.color = "#31708f";
                infoDiv.style.background = "#d9edf7";
                infoDiv.style.border = "1px solid #bce8f1";
                infoDiv.style.borderRadius = "4px";
                infoDiv.style.padding = "8px 12px";
                infoDiv.style.fontSize = "10px";
                infoDiv.style.textAlign = "left";
                infoDiv.innerHTML = `
                  <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                  Remark already saved and cannot be edited.
                `;
                sendButton.parentNode.replaceChild(infoDiv, sendButton);
              }
        
              // ðŸ‘‰ Immediately update chat icon color
              const chatIcon = trigger.querySelector('img[alt="Chat"]');
              if (chatIcon) {
                chatIcon.style.filter = "grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2)";
                chatIcon.style.opacity = "1";
              }
        
              hideTooltip();
            });
          } else {
            Swal.fire('Error', data.error || 'Failed to save remark', 'error');
          }
        })
        .catch(() => {
          Swal.fire('Error', 'Network error', 'error');
        });
      });
    }
  });
});
</script>

<!-- Script for Play/Pause Audio Toggle -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.toggle-play-pause').forEach(function(img) {
    img.addEventListener('click', function(e) {
      e.preventDefault();
      const isPlay = img.src.includes('play1.png');
      img.src = isPlay
        ? "{% static 'assets/icons/pause.png' %}"
        : "{% static 'assets/icons/play1.png' %}";
    });
  });
});
</script>

<script nonce="{{ csp_nonce }}">
// Smart Dynamic Quantity Update Function
function setupDynamicQuantityUpdate() {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  // Function to calculate total quantity from all trays
  function calculateTotalQuantity() {
    const trayRows = uploadModal.querySelectorAll('.jig-loading-table tbody tr');
    let totalQty = 0;
    
    trayRows.forEach(row => {
      const qtyInput = row.querySelector('input[type="number"]');
      const qtySpan = row.querySelector('td:last-child span');
      
      let qty = 0;
      if (qtyInput) {
        qty = parseInt(qtyInput.value) || 0;
      } else if (qtySpan) {
        qty = parseInt(qtySpan.textContent.trim()) || 0;
      }
      
      totalQty += qty;
    });
    
    return totalQty;
  }

  // Function to update the main quantity display
  function updateMainQuantity(newTotal) {
    const qtyInput = uploadModal.querySelector('#jigQrId');
    if (qtyInput) {
      qtyInput.value = newTotal;
      console.log(`âœ… Updated main quantity to: ${newTotal}`);
    }
    
    // Update modal title if it contains quantity info
    const headerElement = uploadModal.querySelector('h5');
    if (headerElement && headerElement.textContent.includes('Single Model')) {
      const modelNumber = headerElement.textContent.split(' - ')[0];
      headerElement.textContent = `${modelNumber} - Single Model (${newTotal} pieces)`;
    }
  }

  // Attach event listeners to tray quantity inputs
  function attachQuantityListeners() {
    const trayQtyInputs = uploadModal.querySelectorAll('input[type="number"]');
    
    trayQtyInputs.forEach(input => {
      // Remove existing listeners to avoid duplicates
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      // Add input event for real-time updates
      newInput.addEventListener('input', function() {
        const newTotal = calculateTotalQuantity();
        updateMainQuantity(newTotal);
      });
      
      // Add change event for when user finishes editing
      newInput.addEventListener('change', function() {
        const newTotal = calculateTotalQuantity();
        updateMainQuantity(newTotal);
        
        // Show brief confirmation
        this.style.backgroundColor = '#e8f5e8';
        setTimeout(() => {
          this.style.backgroundColor = '';
        }, 1000);
      });
    });
  }

  // Initialize listeners when modal content changes
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'childList' || mutation.type === 'subtree') {
        // Re-attach listeners when table content changes
        setTimeout(attachQuantityListeners, 100);
      }
    });
  });

  // Start observing the modal for changes
  const tableWrapper = uploadModal.querySelector('.jig-loading-table-wrapper');
  if (tableWrapper) {
    observer.observe(tableWrapper, {
      childList: true,
      subtree: true
    });
  }

  // Initial setup
  attachQuantityListeners();
}

// Initialize when DOM is loaded
document.addEventListener("DOMContentLoaded", function() {
  setupDynamicQuantityUpdate();
});

// Also initialize when modal is opened
document.addEventListener('click', function(e) {
  if (e.target.classList.contains('unload-modal-trigger')) {
    setTimeout(setupDynamicQuantityUpdate, 500);
  }
});
</script>

<!-- Combined and Improved Script for Unload Modal functionality -->
<script nonce="{{ csp_nonce }}">
// Combined Script for Unload Modal functionality - ENHANCED VERSION WITH STATUS CHECK
document.addEventListener("DOMContentLoaded", function () {
  // Modal HTML (only add once)
  if (!document.getElementById('unloadModal')) {
    const modal = document.createElement('div');
    modal.id = 'unloadModal';
    modal.style = `
      display:none; position:fixed; top:0; right:0; height:100vh; z-index:20000;
      background:rgba(0,0,0,0.10); align-items:flex-start; justify-content:flex-end;
      width:100vw; max-width:100vw;
    `;
    modal.innerHTML = `
      <div style="
        background:#fff; border-radius:12px; max-width:420px; width:96vw; max-height:96vh; padding:24px 18px 18px 18px;
        box-shadow:0 8px 32px rgba(0,0,0,0.18); position:relative; display:flex; flex-direction:column; margin:24px 12px 24px 0;
        overflow-y:auto;
      ">
        <span id="unloadModalClose" style="position:absolute;top:10px;right:18px;font-size:22px;cursor:pointer;color:#888;">&times;</span>
        <h5 style="margin:0 0 16px 0; text-align:center; font-weight:700;">Unload Models</h5>
        <div style="overflow-y:auto; max-height:60vh;">
          <table style="width:100%; border-collapse:collapse; min-width:320px;">
            <thead>
              <tr style="background:#f7f7f7;">
                <th style="padding:8px 6px; border-bottom:1px solid #ddd;">Image</th>
                <th style="padding:8px 6px; border-bottom:1px solid #ddd;">Model Number</th>
                <th style="padding:8px 6px; border-bottom:1px solid #ddd;">Qty</th>
                <th style="padding:8px 6px; border-bottom:1px solid #ddd;">Operation</th>
              </tr>
            </thead>
            <tbody id="unloadModalTableBody">
              <!-- Rows will be injected here -->
            </tbody>
          </table>
        </div>
      </div>
    `;
    document.body.appendChild(modal);

    // Responsive: full width on small screens
    const style = document.createElement('style');
    style.innerHTML = `
      @media (max-width: 600px) {
        #unloadModal > div {
          max-width: 99vw !important;
          width: 99vw !important;
          margin: 10px 0 0 0 !important;
          border-radius: 0 !important;
        }
      }
    `;
    document.head.appendChild(style);
  }


  // Fixed function to properly map lot_ids to models

function showUnloadModal(modelList, modelImages, lotIdQuantities, lotId, lotIdList, modelColors = {}, preloadedUnloadedLotIds = []) {
  const modal = document.getElementById('unloadModal');
  const tbody = document.getElementById('unloadModalTableBody');
  if (!modal || !tbody) return;

  console.log('=== ENHANCED MODAL DEBUG WITH JIG CONTEXT ===');
  console.log('modelList:', modelList);
  console.log('lotIdQuantities:', lotIdQuantities);
  console.log('lotIdList:', lotIdList);

  tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#666;"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr>';
  modal.style.display = 'flex';

  if (!modelList || modelList.length === 0) {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;padding:20px;color:#888;">No models available</td></tr>';
    return;
  }

  const modelData = [];
  const lotIdsToCheck = [];
  let jigLotId = ''; // ðŸ”§ NEW: Get jig context

  // ðŸ”§ NEW: Get jig_lot_id from the triggering button for context
  const triggerButton = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
  if (triggerButton) {
    const row = triggerButton.closest('tr');
    jigLotId = row ? row.getAttribute('data-jig-lot-id') : '';
    console.log('ðŸ” Modal jig context:', jigLotId);
    
    try {
      const lotIdModelMap = JSON.parse(triggerButton.getAttribute('data-lot-id-model-map') || '{}');
      
      if (lotIdQuantities && Object.keys(lotIdQuantities).length > 0) {
        Object.entries(lotIdQuantities).forEach(([currentLotId, quantity]) => {
          const modelNo = lotIdModelMap[currentLotId] || modelList[0] || 'Unknown';
          const modelImageData = modelImages[modelNo] || {};
          const firstImage = modelImageData.first_image || '/static/assets/images/imagePlaceholder.png';

          modelData.push({
            modelNo: modelNo,
            modelLotId: currentLotId,
            quantity: parseInt(quantity) || 1,
            firstImage: firstImage
          });

          lotIdsToCheck.push(currentLotId);
          console.log(`Mapped: ${currentLotId} -> ${modelNo} (qty: ${quantity})`);
        });
      }
    } catch (e) {
      console.error('Error parsing model data:', e);
    }
  }

  console.log('Final modelData:', modelData);
  console.log('lotIdsToCheck:', lotIdsToCheck);
  console.log('jigLotId context:', jigLotId);

  // ðŸ”§ NEW: Check unload status with jig context
  if (lotIdsToCheck.length > 0) {
    fetch('/JigUnloading_Zone2/JU_Zone_check_unload_status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ 
        lot_ids: lotIdsToCheck,
        jig_lot_id: jigLotId // ðŸ”§ NEW: Include jig context
      })
    })
    .then(response => response.json())
    .then(data => {
      const unloadedLotIds = data.unloaded_lot_ids || [];
      console.log('Unloaded lot_ids from backend (with jig context):', unloadedLotIds);
      populateUnloadTable(modelData, unloadedLotIds, modelColors);
    })
    .catch(error => {
      console.error('Error checking unload status:', error);
      populateUnloadTable(modelData, preloadedUnloadedLotIds || [], modelColors);
    });
  } else {
    populateUnloadTable(modelData, preloadedUnloadedLotIds || [], modelColors);
  }
}

// Function to populate the unload table with status
function populateUnloadTable(modelData, unloadedLotIds, modelColors = {}) {
  const tbody = document.getElementById('unloadModalTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  modelData.forEach(data => {
    const { modelNo, modelLotId, quantity, firstImage } = data;
    const isUnloaded = unloadedLotIds.includes(modelLotId);

    console.log(`Model ${modelNo}, Lot ID: ${modelLotId}, IsUnloaded: ${isUnloaded}`);

    // Get color for this model
    const modelColor = modelColors[modelNo];
    let modelNumberStyle = 'padding:6px 4px; text-align:center; font-weight:600;';
    
    if (modelColor && modelColor !== 'NOT_FOUND' && modelColor !== '#cccccc') {
      // Use the same color as Model Presents
      modelNumberStyle += ` background-color: ${modelColor}; border: 2px solid ${modelColor}; color: white; border-radius: 4px;`;
    } else {
      // Default styling similar to Model Presents default
      modelNumberStyle += ' color: #023E4DCC;';
    }

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="padding:6px 4px; text-align:center;">
        <img src="${firstImage}" alt="Model" style="width:38px; height:38px; object-fit:contain; border-radius:6px; border:1px solid #eee;"/>
      </td>
      <td style="${modelNumberStyle}">${modelNo}</td>
      <td style="display:none;">${modelLotId || 'N/A'}</td>  
      <td style="padding:6px 4px; text-align:center;">
        <input type="number" min="1" value="${quantity}" style="width:60px; text-align:center; border-radius:4px; border:1px solid #ccc;" ${isUnloaded ? 'disabled' : ''}/>
      </td>
      <td style="padding:6px 4px; text-align:center;">
        ${isUnloaded ? 
          `<span style="
            display: inline-flex; align-items: center; justify-content: center;
            background: #28a745; color: white; border: none; border-radius: 15px; 
            padding: 4px 12px; font-size: 12px; font-weight: 500;
            cursor: default;
          ">âœ“ Unloaded</span>` :
          `<button class="unload-row-btn" style="background:#023E4DCC; color:#fff; border:none; border-radius:5px; padding:5px 14px; font-size:13px; cursor:pointer;">Unload</button>`
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

  // Close modal handlers
  document.getElementById('unloadModalClose').onclick = function() {
    window.location.reload();
  };

  document.getElementById('unloadModal').onclick = function(e) {
    if (e.target === this) this.style.display = 'none';
  };

  // Attach click handler to all "Unload" links/buttons with enhanced data support
  document.querySelectorAll('.unload-modal-trigger').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.preventDefault();

      // Remove previous markers
      document.querySelectorAll('.unload-modal-trigger').forEach(b => 
        b.removeAttribute('data-last-triggered')
      );
      
      // Mark this button as last triggered
      this.setAttribute('data-last-triggered', 'true');

      try {
        const modelList = JSON.parse(this.getAttribute('data-model-list') || '[]');
        const modelImages = JSON.parse(this.getAttribute('data-model-images') || '{}');
        const lotIdQuantities = JSON.parse(this.getAttribute('data-lot-id-quantities') || '{}');
        const lotId = this.getAttribute('data-lot-id');
        const lotIdList = JSON.parse(this.getAttribute('data-lot-id-list') || '[]');
        
        // Get model colors from the row data
        const row = this.closest('tr');
        const modelStockNoCell = row ? row.querySelector('.model-stock-no-cell') : null;
        const modelColors = modelStockNoCell ? JSON.parse(modelStockNoCell.getAttribute('data-model-colors') || '{}') : {};
        
        // Get preloaded unload status if available
        const preloadedUnloadedLotIds = this.hasAttribute('data-unloaded-lot-ids') 
          ? JSON.parse(this.getAttribute('data-unloaded-lot-ids') || '[]') 
          : [];
        
        showUnloadModal(modelList, modelImages, lotIdQuantities, lotId, lotIdList, modelColors, preloadedUnloadedLotIds);
      } catch (error) {
        console.error('Error parsing model data:', error);
        showUnloadModal([], {}, {}, null, [], {}, []);
      }
    });
  });

  // Handle Unload button in table (only for non-unloaded items)
  document.body.addEventListener('click', function(e) {
    if (
      e.target.tagName === 'BUTTON' &&
      e.target.textContent.trim().toLowerCase() === 'unload' &&
      e.target.closest('#unloadModal tbody')
    ) {
      e.preventDefault();

      const row = e.target.closest('tr');
      const lotIdCell = row.children[2];
      const lotId = lotIdCell ? lotIdCell.textContent.trim() : 'N/A';
      const modelCell = row.children[1];
      const modelNumber = modelCell ? modelCell.textContent.trim() : 'Unknown Model';
      const qtyCell = row.children[3];
      const qtyInput = qtyCell ? qtyCell.querySelector('input[type="number"]') : null;
      const quantity = qtyInput ? parseInt(qtyInput.value) || 1 : 1;

      fetchModelDetails(modelNumber, lotId, quantity);
    }
  });

   function fetchModelDetails(modelNumber, lotId, quantity) {
    const uploadModal = document.getElementById('uploadChildModal');
    if (uploadModal) {
      const headerElement = uploadModal.querySelector('h5');
      if (headerElement) {
        headerElement.textContent = `Loading... ${modelNumber} - ${lotId}`;
      }
      uploadModal.style.display = 'flex';
    }

    fetch('/JigUnloading_Zone2/JU_Zone_get_model_details/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        // Send the full model string (e.g. '1805SAD02') so backend can search plating_stk_no
        model_number: modelNumber,
        lot_id: lotId
      })
    })
    .then(response => response.json())
    .then(data => {
      console.log('ðŸ” Zone 2 - API Response Structure:', data);
      
      if (data.success) {
        // API response has data at root level, not nested under data.data
        const modelData = data.data || data;  // Handle both structures
        
        console.log('ðŸ“‹ Model Data for Modal:', modelData);
        console.log('ðŸŽ¯ Tray Info:', { 
          trayType: modelData.tray_type, 
          capacity: modelData.tray_capacity 
        });
        
        populateUploadChildModal(
          modelData.model_number, 
          modelData.lot_id, 
          quantity, 
          modelData.tray_type, 
          modelData.tray_capacity,
          modelData.plating_color,
          modelData.tray_id_color,
          modelData.tray_id_prefix,
          modelData.plating_stk_no,
          modelData.multiple_models || false
        );
      } else {
        // If API returns failure, try to use values from the triggering row or modal attributes
        const triggerRow = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]')?.closest('tr');
        const fallbackTrayType = triggerRow ? (triggerRow.getAttribute('data-tray-type') || 'Normal') : 'Normal';
        const fallbackTrayCapacity = triggerRow ? parseInt(triggerRow.getAttribute('data-tray-capacity')) || 20 : 20;
        const fallbackPrefix = triggerRow ? (triggerRow.getAttribute('data-tray-prefix') || 'NR') : 'NR';
  populateUploadChildModal(modelNumber, lotId, quantity, fallbackTrayType, fallbackTrayCapacity, "Unknown", "#6c757d", fallbackPrefix, modelNumber, false);
        Swal.fire({
          icon: 'warning',
          title: 'Model Details',
          text: `Could not fetch model details. Using default values. Error: ${data.error}`,
          timer: 3000,
          showConfirmButton: false
        });
      }
    })
    .catch(error => {
      // On fetch error, prefer using values from the triggering row if present (avoid hardcoding Normal-20)
      const triggerRow = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]')?.closest('tr');
      const fallbackTrayType = triggerRow ? (triggerRow.getAttribute('data-tray-type') || 'Normal') : 'Normal';
      const fallbackTrayCapacity = triggerRow ? parseInt(triggerRow.getAttribute('data-tray-capacity')) || 20 : 20;
      const fallbackPrefix = triggerRow ? (triggerRow.getAttribute('data-tray-prefix') || 'NR') : 'NR';
  populateUploadChildModal(modelNumber, lotId, quantity, fallbackTrayType, fallbackTrayCapacity, "Unknown", "#6c757d", fallbackPrefix, modelNumber, false);
      Swal.fire({
        icon: 'warning',
        title: 'Connection Error',
        text: 'Could not fetch model details. Using default values.',
        timer: 3000,
        showConfirmButton: false
      });
    });
  
  }

// 3. Updated populateUploadChildModal with simplified header and professional color verification
function populateUploadChildModal(modelNumber, lotId, quantity, trayType, trayCapacity, platingColor, trayIdColor, trayIdPrefix, platingStkNo, multipleModels) {
  // Update modal header with proper title
  const modalTitle = document.querySelector('#uploadChildModal .modal-title, #uploadChildModal h4');
  if (modalTitle) {
    modalTitle.textContent = 'Unloading Tray Scan';
  }
  
  // Set Tray Cate - Capacity value and color based on resolved trayType/trayCapacity
  const trayInput = document.getElementById('trayTypeCapacity');
  const trayCircle = trayInput ? trayInput.previousElementSibling : null;

  // Resolve final values: prefer API params, otherwise read trigger row attributes
  let finalTrayType = trayType;
  let finalCapacity = parseInt(trayCapacity, 10) || 20;
  if (!finalTrayType || finalTrayType.trim() === '' || isNaN(finalCapacity)) {
    const triggerBtn = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
    if (triggerBtn) {
      const triggerRow = triggerBtn.closest('tr');
      if (triggerRow) {
        const dt = triggerRow.getAttribute('data-tray-type');
        const dc = triggerRow.getAttribute('data-tray-capacity');
        if (dt) finalTrayType = dt;
        if (dc && !isNaN(parseInt(dc))) finalCapacity = parseInt(dc);
      }
    }
  }

  trayInput.value = `${finalTrayType} - ${finalCapacity}`;
  if (trayCircle) {
    if (finalTrayType === 'Jumbo' && finalCapacity === 12) trayCircle.style.background = '#006400';
    else if (finalTrayType === 'Normal' && finalCapacity === 20) trayCircle.style.background = '#dc3545';
    else trayCircle.style.background = '#6c757d';
  }
  
  // ï¿½ DYNAMIC PLATING COLOR DETECTION WITH ZONE ROUTING
  // If platingStkNo is missing, try a lightweight fallback fetch to obtain plating_stk_no and related metadata
  if (!platingStkNo || platingStkNo === '' || platingStkNo === modelNumber) {
    // attempt to re-fetch model details (safe fallback) and then update UI
    fetch('/JigUnloading_Zone2/JU_Zone_get_model_details/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ model_number: modelNumber, lot_id: lotId })
    })
    .then(r => r.json())
    .then(d => {
      const resolvedPlatingStk = d.plating_stk_no || platingStkNo || modelNumber;
      const resolvedPlatingColor = d.plating_color || platingColor;
      const resolvedTrayIdColor = d.tray_id_color || trayIdColor;
      const resolvedTrayIdPrefix = d.tray_id_prefix || trayIdPrefix;
      fetchPlatingColorAndUpdateUI(modelNumber, lotId, resolvedPlatingColor, resolvedTrayIdColor, resolvedTrayIdPrefix, resolvedPlatingStk, multipleModels);
    })
    .catch(err => {
      console.warn('Fallback fetch for plating_stk_no failed:', err);
      fetchPlatingColorAndUpdateUI(modelNumber, lotId, platingColor, trayIdColor, trayIdPrefix, platingStkNo, multipleModels);
    });
  } else {
    fetchPlatingColorAndUpdateUI(modelNumber, lotId, platingColor, trayIdColor, trayIdPrefix, platingStkNo, multipleModels);
  }
  
  // ï¿½ðŸŽ¨ Professional Color Verification UI Update (fallback)
  updateColorVerificationUI(platingColor, trayIdColor, trayIdPrefix, modelNumber, platingStkNo, multipleModels);
  
  // Update tray ID color indicator based on plating color if provided
  if (trayIdColor) {
    // Find tray ID input or container to update color
    const trayIdInputs = document.querySelectorAll('input[id^="trayId_"]');
    const trayIdContainer = document.getElementById('trayScanDetails');
    
    if (trayIdContainer) {
      trayIdContainer.setAttribute('data-tray-color', trayIdColor);
      trayIdContainer.setAttribute('data-tray-prefix', trayIdPrefix || 'NR');
      trayIdContainer.setAttribute('data-plating-color', platingColor || '');
      
      console.log('ðŸŽ¨ Tray color data set:', {
        color: trayIdColor,
        prefix: trayIdPrefix,
        platingColor: platingColor
      });
    }
  }
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  // Get jig_qr_id and jig_lot_id from the triggering row
  const triggerButton = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
  let jigLotId = '';
  let jigQrId = '';
  
  if (triggerButton) {
    const row = triggerButton.closest('tr');
    jigLotId = row ? row.getAttribute('data-jig-lot-id') : '';
    jigQrId = row ? row.getAttribute('data-jig-qr-id') : '';
    console.log('ðŸŽ¯ Retrieved jig_lot_id from triggering row:', jigLotId);
    console.log('ðŸŽ¯ Retrieved jig_qr_id from triggering row:', jigQrId);
  }

  console.log('ðŸ“‹ Setting up modal with simplified header:');
  console.log('  Model Number:', modelNumber);
  console.log('  Lot ID:', lotId);
  console.log('  Jig Lot ID:', jigLotId);
  console.log('  Quantity:', quantity);

  // ðŸŽ¯ DYNAMIC FETCH: Don't set header immediately, let fetchPlatingColorAndUpdateUI handle it
  const headerElement = uploadModal.querySelector('h5');
  if (headerElement) {
    // Set temporary header while loading
    headerElement.textContent = 'Loading...';
    
    // Store lotId in a hidden span for scripts (keep lot_id as hidden data)
    let hiddenLotId = uploadModal.querySelector('.hidden-lot-id');
    if (!hiddenLotId) {
      hiddenLotId = document.createElement('span');
      hiddenLotId.className = 'hidden-lot-id';
      hiddenLotId.style.display = 'none';
      headerElement.parentNode.insertBefore(hiddenLotId, headerElement.nextSibling);
    }
    hiddenLotId.textContent = lotId; // Store as hidden value
    console.log('ðŸ”’ Hidden Lot ID stored:', lotId);
  }

  // Set all required attributes (lot_id kept as hidden data)
  uploadModal.setAttribute('data-current-lot-id', lotId);
  uploadModal.setAttribute('data-current-model', modelNumber);
  uploadModal.setAttribute('data-current-quantity', quantity);
  uploadModal.setAttribute('data-tray-capacity', trayCapacity);
  uploadModal.setAttribute('data-jig-lot-id', jigLotId);
  uploadModal.setAttribute('data-plating-color', platingColor || 'Others'); // âœ… NEW: Store plating color for validation (default to Others for Zone 2)
  
  // ðŸ”§ NEW: Initialize jig-aware sources for single model
  const initialJigAwareSource = `${jigLotId}:${lotId}`;
  uploadModal.setAttribute('data-jig-aware-sources', JSON.stringify([initialJigAwareSource]));
  uploadModal.setAttribute('data-source-count', '1');

  console.log('âœ… Modal attributes set with hidden lot_id data:', {
    'data-current-lot-id': lotId,
    'data-current-model': modelNumber,
    'data-current-quantity': quantity,
    'data-tray-capacity': trayCapacity,
    'data-jig-lot-id': jigLotId,
    'data-jig-aware-sources': [initialJigAwareSource]
  });

  const qtyInput = uploadModal.querySelector('#jigQrId');
  if (qtyInput) {
    qtyInput.value = quantity;
    qtyInput.setAttribute('data-original-qty', quantity);
  }

  const trayTypeInput = uploadModal.querySelector('#trayTypeCapacity');
  if (trayTypeInput) {
    trayTypeInput.value = `${trayType} - ${trayCapacity}`;
  }

  // Set Jig ID field using actual JIG QR ID
  const jigIdInput = uploadModal.querySelector('#jigId');
  if (jigIdInput) {
    jigIdInput.value = jigQrId || 'Not Available';
  }

  populateTrayTable(quantity, trayCapacity, [], lotId);
  // Seed modal-level scanned set from any prefilled validated messages/values
  try {
    const scannedSet = new Set();
    const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
    if (tableBody) {
      tableBody.querySelectorAll('input[type="text"]').forEach(inp => {
        const val = (inp.value || '').trim();
        if (val) scannedSet.add(val.toLowerCase());
      });
    }
    uploadModal._scannedTrays = scannedSet;
  } catch (err) {
    console.error('Zone2 error seeding scanned trays:', err);
  }

  uploadModal.style.display = 'flex';
  
  // ðŸ–¼ï¸ Fetch and display model images
  setTimeout(() => {
    fetchAndDisplayModelImages(lotId, modelNumber);
  }, 100); // Small delay to ensure modal is fully rendered
}

// ðŸŽ¯ DYNAMIC PLATING COLOR AND PLATING STOCK NO DETECTION FUNCTION FOR ZONE ROUTING
function fetchPlatingColorAndUpdateUI(modelNumber, lotId, platingColor, trayIdColor, trayIdPrefix, platingStkNo, multipleModels) {
  console.log('ðŸ” Zone 2 - Fetching plating color and stock no for:', { modelNumber, lotId, platingColor, platingStkNo });
  
  // Always make API call to get fresh data including platingStkNo
  fetch('/JigUnloading_Zone2/JU_Zone_get_model_details/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({
      model_number: modelNumber,
      lot_id: lotId
    })
  })
  .then(response => {
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    }
    return response.json();
  })
  .then(data => {
    console.log('ðŸ” Zone 2 - API Response:', data);
    
    let detectedColor = 'Unknown Color';
    let detectedZone = 'Zone Detection...';
    let dynamicPlatingStkNo = data.plating_stk_no || platingStkNo || 'No Plating Stock No';
    
    if (data.success && data.plating_color) {
      detectedColor = data.plating_color;
      


      
      // Zone Detection Logic for Zone 2 (All except IPS)
      if (detectedColor === 'IPS') {
        detectedZone = 'âš ï¸ Zone 1 (IPS Only)';
        console.log('âš ï¸ Zone 2 - Detected IPS color, should route to Zone 1');
      } else {
        detectedZone = 'âœ… Zone 2 (Current Zone)';
        console.log('âœ… Zone 2 - Detected non-IPS color, correctly in Zone 2');
      }
    } else {
      console.log('âš ï¸ Zone 2 - Could not detect plating color, showing Unknown');
      detectedZone = 'â“ Unknown - Manual Check Required';
    }
    
    // Update modal header with dynamic plating stock no
    updateModalHeaderWithPlatingStkNo(dynamicPlatingStkNo, multipleModels);
    
    updateColorVerificationUIWithZoneDetection(
      detectedColor,
      trayIdColor || data.tray_id_color,
      trayIdPrefix || data.tray_id_prefix,
      modelNumber,
      dynamicPlatingStkNo,
      multipleModels,
      detectedZone
    );
  })
  .catch(error => {
    console.error('âŒ Zone 2 - Error fetching plating color:', error);
    // Update modal header even on error
    updateModalHeaderWithPlatingStkNo(platingStkNo || 'No Plating Stock No', multipleModels);
    
    updateColorVerificationUIWithZoneDetection(
      'Unknown Color',
      trayIdColor,
      trayIdPrefix,
      modelNumber,
      platingStkNo || 'No Plating Stock No',
      multipleModels,
      'âŒ Detection Failed'
    );
  });
}

// ðŸŽ¯ NEW FUNCTION: Update Modal Header with Dynamic Plating Stock No
function updateModalHeaderWithPlatingStkNo(platingStkNo, multipleModels) {
  const uploadModal = document.getElementById('uploadChildModal');
  const headerElement = uploadModal ? uploadModal.querySelector('h5') : null;
  
  if (headerElement) {
    const modelType = 'Unloading Tray Scan';
    let headerText = '';
    
    if (platingStkNo && platingStkNo !== 'No Plating Stock No') {
      headerText = `${modelType}`;
    } else {
      headerText = `No Plating Stock - ${modelType}`;
    }
    
    headerElement.textContent = headerText;
    console.log('ðŸŽ¯ Zone 2 - Dynamic Header Updated:', headerText);
  }
}

// ðŸŽ¨ ENHANCED COLOR VERIFICATION UI WITH ZONE DETECTION
function updateColorVerificationUIWithZoneDetection(platingColor, trayIdColor, trayIdPrefix, modelNumber, platingStkNo, multipleModels, zoneInfo) {
  console.log('ðŸŽ¨ Zone 2 - Updating UI with:', { platingColor, zoneInfo });
  
  
  
  // Update plating color text with professional styling
  const platingColorText = document.getElementById('platingColorText');
  if (platingColorText) {
    platingColorText.textContent = platingColor || 'Unknown Color';
    platingColorText.style.fontWeight = '600';
  }
  
  // Update zone routing text with enhanced professional styling
  const trayRouting = document.getElementById('trayRouting');
  if (trayRouting) {
    // Enhanced zone routing display for Zone 2
    if (zoneInfo && zoneInfo.includes('âœ… Zone 2')) {
      trayRouting.innerHTML = `<span style="color: #28a745; font-weight: 700;">âœ…</span> <span style="color: #2d5016; font-weight: 600;">Zone 2 (Dark Green Tray)</span>`;
    } else if (zoneInfo && zoneInfo.includes('âš ï¸ Zone 1')) {
      trayRouting.innerHTML = `<span style="color: #fd7e14; font-weight: 700;">âš ï¸</span> <span style="color: #856404; font-weight: 600;">Zone 1 (IPS Only)</span>`;
    } else if (zoneInfo && (zoneInfo.includes('âŒ') || zoneInfo.includes('â“'))) {
      trayRouting.innerHTML = `<span style="color: #dc3545; font-weight: 700;">âŒ</span> <span style="color: #721c24; font-weight: 600;">Detection Failed - Manual Check</span>`;
    } else {
      trayRouting.textContent = zoneInfo || 'Zone Detection...';
      trayRouting.style.color = '#6c757d';
      trayRouting.style.fontWeight = '500';
    }
  }
  
  // Update color indicator circle with enhanced styling
  const colorIndicator = document.getElementById('platingColorIndicator');
  if (colorIndicator) {
    const colorMap = {
      'IPS': '#ffd700',      // Gold for IPS
      '3N': '#c0c0c0',       // Silver for 3N
      '2N': '#daa520',       // Golden rod for 2N
      'RG': '#ff6347',       // Tomato for RG
      'CHG': '#32cd32',      // Lime green for CHG
      'CN': '#4169e1',       // Royal blue for CN
      'J-BLUE': '#0000ff',   // Blue for J-BLUE
      'BR': '#8b4513',       // Saddle brown for BR
      'BRN': '#a52a2a',      // Brown for BRN
      'GUN': '#708090',      // Slate gray for GUN
      'BLU': '#4169e1',      // Royal blue for BLU
      'PLUM': '#dda0dd',     // Plum color
      'BIC': '#ff69b4',      // Hot pink for BIC
      'Unknown': '#6c757d'   // Gray for unknown
    };
    
    const selectedColor = colorMap[platingColor] || '#6c757d';
    colorIndicator.style.background = selectedColor;
    colorIndicator.style.border = `3px solid ${selectedColor === '#6c757d' ? '#dee2e6' : 'rgba(255,255,255,0.8)'}`;
    colorIndicator.style.boxShadow = `0 3px 8px rgba(0,0,0,0.15), 0 0 0 1px ${selectedColor}`;
    colorIndicator.style.transform = 'scale(1.1)';
    colorIndicator.style.transition = 'all 0.3s ease';
  }
  
  // Update status badge with enhanced professional styling
  const statusBadge = document.getElementById('colorStatusBadge');
  if (statusBadge) {
    if (platingColor && platingColor !== 'Unknown Color') {
      statusBadge.textContent = 'DETECTED';
      statusBadge.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
      statusBadge.style.boxShadow = '0 2px 6px rgba(40, 167, 69, 0.3)';
      statusBadge.style.animation = 'none'; // Remove any loading animation
    } else {
      statusBadge.textContent = 'UNKNOWN';
      statusBadge.style.background = 'linear-gradient(135deg, #dc3545, #e74c3c)';
      statusBadge.style.boxShadow = '0 2px 6px rgba(220, 53, 69, 0.3)';
    }
    statusBadge.style.color = 'white';
    statusBadge.style.fontWeight = '700';
    statusBadge.style.letterSpacing = '0.5px';
    statusBadge.style.border = 'none';
    statusBadge.style.transition = 'all 0.3s ease';
  }
  
  // Call original function for compatibility
  if (typeof updateColorVerificationUI === 'function') {
    updateColorVerificationUI(platingColor, trayIdColor, trayIdPrefix, modelNumber, platingStkNo, multipleModels);
  }
}

  // Helper function to toggle edit mode for tray quantity - Zone 2
  window.toggleTrayQtyEditZone2 = function(editButton) {
    console.log('ðŸ”§ Zone 2 - toggleTrayQtyEditZone2 called', editButton);
    
    const trayQtyInput = editButton.previousElementSibling;
    if (!trayQtyInput) {
      console.error('âŒ Zone 2 - No tray quantity input found next to edit button');
      return;
    }
    
    console.log('ðŸ“ Zone 2 - Tray input found:', trayQtyInput, 'Disabled:', trayQtyInput.disabled);
    const isCurrentlyDisabled = trayQtyInput.disabled;
    
    if (isCurrentlyDisabled) {
      // Enable editing
      console.log('ðŸ”“ Zone 2 - Enabling edit mode');
      trayQtyInput.disabled = false;
      trayQtyInput.style.borderColor = '#007bff';
      trayQtyInput.style.backgroundColor = '#fff';
      trayQtyInput.focus();
      trayQtyInput.select();
      
      // Change button appearance
      editButton.src = '/static/assets/icons/check.png';
      editButton.title = 'Save Changes';
      editButton.style.filter = 'hue-rotate(120deg)';
    } else {
      // Save changes and disable editing
      console.log('ðŸ”’ Zone 2 - Saving and disabling edit mode');
      trayQtyInput.disabled = true;
      trayQtyInput.style.borderColor = '#ccc';
      trayQtyInput.style.backgroundColor = '#f9f9f9';
      
      // Change button back
      editButton.src = '/static/assets/icons/edit1.png';
      editButton.title = 'Edit';
      editButton.style.filter = '';
      
      // Recalculate total quantity
      recalculateLotQuantityZone2();
    }
  };
  
  // Helper function to recalculate and update Lot Qty when tray quantities change - Zone 2
  window.recalculateLotQuantityZone2 = function() {
    const uploadModal = document.getElementById('uploadChildModal');
    if (!uploadModal) return;
    
    const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
    if (!tableBody) return;
    
    const trayRows = tableBody.querySelectorAll('tr');
    let totalQuantity = 0;
    const validTrays = [];
    
    // Get original quantity for missing qty calculation
    const originalQtyInput = uploadModal.querySelector('#jigQrId');
    const originalQuantity = originalQtyInput ? parseInt(originalQtyInput.getAttribute('data-original-qty')) || 0 : 0;
    
    // First pass: collect all non-zero quantities and remove zero quantity rows
    trayRows.forEach((row, index) => {
      const qtyInput = row.querySelector('input[type="number"]');
      const qtySpan = row.querySelector('td:last-child span');
      
      let qty = 0;
      if (qtyInput) {
        qty = parseInt(qtyInput.value) || 0;
      } else if (qtySpan) {
        qty = parseInt(qtySpan.textContent) || 0;
      }
      
      if (qty > 0) {
        validTrays.push({ row, quantity: qty });
        totalQuantity += qty;
      } else {
        // Mark row for removal if quantity is 0
        row.style.opacity = '0.3';
        setTimeout(() => {
          if (row.parentNode) {
            row.remove();
            // After removing, renumber the remaining trays
            renumberTraysZone2();
          }
        }, 500);
      }
    });
    
    // Function to renumber trays after removal - Zone 2
    function renumberTraysZone2() {
      const remainingRows = tableBody.querySelectorAll('tr');
      remainingRows.forEach((row, index) => {
        const snoCell = row.querySelector('td:first-child');
        if (snoCell) {
          const isTopTray = index === 0;
          snoCell.innerHTML = isTopTray 
            ? `${index + 1} <span style="color:#28a745; font-weight:600;">(Top Tray)</span>` 
            : `${index + 1}`;
          
          // Update edit button functionality for new top tray
          const editBtn = row.querySelector('.tray-edit-btn-zone2');
          const qtyInput = row.querySelector('input[type="number"]');
          if (isTopTray && editBtn && qtyInput) {
            qtyInput.disabled = false;
            qtyInput.style.backgroundColor = '#fff';
            qtyInput.style.borderColor = '#007bff';
          }
        }
      });
    }
    
    // Calculate missing quantity
    const missingQuantity = Math.max(0, originalQuantity - totalQuantity);
    
    // Update the Lot Qty display in modal
    const lotQtyInput = uploadModal.querySelector('#jigQrId');
    if (lotQtyInput) {
      const oldQty = parseInt(lotQtyInput.value) || 0;
      lotQtyInput.value = totalQuantity;
      
      console.log(`ðŸ”¢ Zone 2 - Lot Qty updated: ${oldQty} â†’ ${totalQuantity}`);
      console.log(`âŒ Zone 2 - Missing Qty calculated: ${missingQuantity}`);
      
      // Show visual feedback
      if (totalQuantity !== oldQty) {
        lotQtyInput.style.backgroundColor = '#e8f5e8';
        setTimeout(() => {
          lotQtyInput.style.backgroundColor = '';
        }, 1000);
      }
    }
    
    // Update the Missing Qty display
    const missingQtyInput = uploadModal.querySelector('#missingQty');
    if (missingQtyInput) {
      missingQtyInput.value = missingQuantity;
      
      // Show visual feedback if there's missing quantity
      if (missingQuantity > 0) {
        missingQtyInput.style.backgroundColor = '#ffebee';
        missingQtyInput.style.borderColor = '#f44336';
        missingQtyInput.style.color = '#d32f2f';
        missingQtyInput.style.fontWeight = '700';
      } else {
        missingQtyInput.style.backgroundColor = '#f1f8e9';
        missingQtyInput.style.borderColor = '#4caf50';
        missingQtyInput.style.color = '#2e7d32';
        missingQtyInput.style.fontWeight = '600';
      }
    }
    
    return { totalQuantity, missingQuantity };
  };
  
  // Helper function to validate tray quantity input - Zone 2
  window.validateTrayQtyInputZone2 = function(input, originalQty) {
    const newQty = parseInt(input.value) || 0;
    const maxQty = parseInt(input.getAttribute('data-original-qty')) || originalQty;
    
    if (newQty > maxQty) {
      input.value = maxQty;
      
      // Show warning
      Swal.fire({
        icon: 'warning',
        title: 'Invalid Quantity',
        text: `Tray quantity cannot exceed ${maxQty}`,
        timer: 2000,
        showConfirmButton: false
      });
    } else if (newQty < 0) {
      input.value = 0;
    }
    
    // Auto-recalculate if not disabled (this will handle renumbering if qty is 0)
    if (!input.disabled) {
      recalculateLotQuantityZone2();
    }
    
    // Special handling for when top tray becomes 0
    if (newQty === 0) {
      const row = input.closest('tr');
      const snoCell = row?.querySelector('td:first-child');
      if (snoCell && snoCell.textContent.includes('Top Tray')) {
        console.log('ðŸ”„ Zone 2 - Top tray set to 0, renumbering will occur after recalculation');
        
        // Show user feedback
        Swal.fire({
          icon: 'info',
          title: 'Top Tray Updated - Zone 2',
          text: 'Top tray quantity set to 0. The next tray will become the new top tray.',
          timer: 2500,
          showConfirmButton: false
        });
      }
    }
  };

  // Add event listeners for tray edit buttons - Zone 2
  window.setupTrayEditEventListenersZone2 = function() {
    // Check if listeners are already setup to avoid duplicates
    if (window.zone2EditListenersSetup) {
      console.log('ðŸ”„ Zone 2 edit listeners already setup, skipping...');
      return;
    }
    
    console.log('ðŸŽ¯ Setting up Zone 2 tray edit event listeners...');
    
    // Use event delegation to handle dynamically created edit buttons
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('tray-edit-btn-zone2')) {
        e.preventDefault();
        console.log('ðŸ–±ï¸ Zone 2 edit button clicked');
        toggleTrayQtyEditZone2(e.target);
      }
    });
    
    // Add hover effects via event listeners
    document.addEventListener('mouseover', function(e) {
      if (e.target.classList.contains('tray-edit-btn-zone2')) {
        e.target.style.filter = 'brightness(0.8)';
      }
    });
    
    document.addEventListener('mouseout', function(e) {
      if (e.target.classList.contains('tray-edit-btn-zone2')) {
        e.target.style.filter = '';
      }
    });
    
    // Add event listener for tray quantity inputs
    document.addEventListener('input', function(e) {
      if (e.target.classList.contains('tray-qty-input-zone2')) {
        const originalQty = parseInt(e.target.getAttribute('data-original-qty')) || 0;
        validateTrayQtyInputZone2(e.target, originalQty);
      }
    });
    
    document.addEventListener('change', function(e) {
      if (e.target.classList.contains('tray-qty-input-zone2')) {
        const originalQty = parseInt(e.target.getAttribute('data-original-qty')) || 0;
        validateTrayQtyInputZone2(e.target, originalQty);
      }
    });
    
    document.addEventListener('keydown', function(e) {
      if (e.target.classList.contains('tray-qty-input-zone2') && e.key === 'ArrowUp') {
        e.preventDefault();
      }
    });
    
    // Mark as setup to avoid duplicates
    window.zone2EditListenersSetup = true;
    console.log('âœ… Zone 2 tray edit listeners setup complete');
  };

  // Test function to verify Zone 2 edit functionality
  window.testZone2EditFunctionality = function() {
    console.log('ðŸ§ª Testing Zone 2 Edit Functionality...');
    
    // Check if functions exist
    const functions = [
      'setupTrayEditEventListenersZone2',
      'toggleTrayQtyEditZone2', 
      'validateTrayQtyInputZone2',
      'recalculateLotQuantityZone2'
    ];
    
    functions.forEach(funcName => {
      if (typeof window[funcName] === 'function') {
        console.log(`âœ… ${funcName} - Function exists`);
      } else {
        console.error(`âŒ ${funcName} - Function missing`);
      }
    });
    
    // Check for edit buttons in DOM
    const editButtons = document.querySelectorAll('.tray-edit-btn-zone2');
    console.log(`ðŸ”˜ Found ${editButtons.length} Zone 2 edit buttons`);
    
    // Check for input fields
    const inputFields = document.querySelectorAll('.tray-qty-input-zone2');
    console.log(`ðŸ“ Found ${inputFields.length} Zone 2 tray quantity inputs`);
    
    // Check event listener setup flag
    if (window.zone2EditListenersSetup) {
      console.log('âœ… Zone 2 event listeners setup flag is true');
    } else {
      console.warn('âš ï¸ Zone 2 event listeners setup flag is false');
    }
    
    return {
      functionsExist: functions.every(f => typeof window[f] === 'function'),
      editButtonsFound: editButtons.length > 0,
      inputFieldsFound: inputFields.length > 0,
      listenersSetup: !!window.zone2EditListenersSetup
    };
  };

  // âœ… UPDATED: populateTrayTable function with optimal quantity distribution and Edit functionality - Zone 2
  // EXPECTED BEHAVIOR: With total qty 80 and tray capacity 12
  // CALCULATION: 80 Ã· 12 = 6 full trays (72) + 1 partial tray (8)
  // OUTPUT: 1(Top Tray)-8, 2-12, 3-12, 4-12, 5-12, 6-12, 7-12
  window.populateTrayTable = function(quantity, trayCapacity, lotIdList = [], mainLotId = '') {
    const uploadModal = document.getElementById('uploadChildModal');
    if (!uploadModal) return;

    const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    console.log('ðŸ” OPTIMAL TRAY DISTRIBUTION CALCULATION:');
    console.log('   Total Quantity:', quantity);
    console.log('   Tray Capacity:', trayCapacity);
    console.log('   LotIdList:', lotIdList);
    console.log('   Main Lot ID:', mainLotId);

    // If no lotIdList provided, fill with mainLotId
    if (!lotIdList || lotIdList.length === 0) {
      lotIdList = Array(quantity).fill(mainLotId);
    }

    // Ensure lotIdList has exactly 'quantity' elements
    while (lotIdList.length < quantity) {
      lotIdList.push(mainLotId);
    }
    if (lotIdList.length > quantity) {
      lotIdList = lotIdList.slice(0, quantity);
    }

    // âœ… OPTIMAL DISTRIBUTION: Calculate best tray distribution
    const fullTrays = Math.floor(quantity / trayCapacity);
    const remainingQty = quantity % trayCapacity;
    const totalTrays = remainingQty > 0 ? fullTrays + 1 : fullTrays;

    console.log('   ðŸ“Š OPTIMAL CALCULATION:');
    console.log(`     Full trays (${trayCapacity} each):`, fullTrays);
    console.log(`     Remaining quantity:`, remainingQty);
    console.log(`     Total trays needed:`, totalTrays);

    // âœ… CREATE OPTIMAL TRAY DISTRIBUTION
    const optimalTrays = [];
    
    // Add partial tray first (if exists) - this will be the smallest
    if (remainingQty > 0) {
      optimalTrays.push({
        trayNumber: 1,
        quantity: remainingQty,
        isTopTray: true // Smallest tray is top tray
      });
    }
    
    // Add full trays
    for (let i = 0; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: optimalTrays.length + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }

    // âœ… DISTRIBUTE LOT_IDS ACROSS OPTIMAL TRAYS
    let lotIdIndex = 0;
    optimalTrays.forEach(tray => {
      // Assign lot_id to this tray (cycling through available lot_ids)
      if (lotIdIndex < lotIdList.length) {
        tray.lotId = lotIdList[lotIdIndex];
        // Move index forward by tray quantity to get next lot_id
        lotIdIndex += tray.quantity;
        if (lotIdIndex >= lotIdList.length) {
          // If we exceed the list, use the last lot_id or main lot_id
          tray.lotId = lotIdList[lotIdList.length - 1] || mainLotId;
        }
      } else {
        tray.lotId = mainLotId;
      }
    });

    console.log('   ðŸŽ¯ OPTIMAL TRAYS CREATED:');
    optimalTrays.forEach(tray => {
      console.log(`     Tray ${tray.trayNumber}: ${tray.quantity} pieces (${tray.lotId})${tray.isTopTray ? ' [TOP TRAY]' : ''}`);
    });

    // âœ… Render the optimal trays in the table
    optimalTrays.forEach((tray, index) => {
      const row = document.createElement('tr');
      row.setAttribute('data-lot-id', tray.lotId);

      row.innerHTML = `
        <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
          ${tray.trayNumber}${tray.isTopTray ? ' (Top Tray)' : ''}
        </td>
        <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
          <input type="text" placeholder="Scan tray" 
                 data-lot-id="${tray.lotId}"
                 style="width:100%; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px;" />
        </td>

        <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">
          ${tray.isTopTray
            ? `<input type="number" value="${tray.quantity}" min="1" max="${tray.quantity}" 
                       data-original-qty="${tray.quantity}"
                       style="width:60px; text-align:center; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px; background-color:#f9f9f9;"
                       class="tray-qty-input-zone2"
                       disabled />
               <img src="/static/assets/icons/edit1.png" alt="Edit" title="Edit" 
                    style="width:16px; height:16px; margin-left:6px; vertical-align:middle; cursor:pointer;" 
                    class="tray-edit-btn-zone2" data-action="edit" />`
            : `<span style="font-weight:500; color:#333;">${tray.quantity}</span>`
          }
        </td>
      `;

      tableBody.appendChild(row);
    });
      // Store original total quantity and tray capacity on the modal so validation logic
      // and quantity re-distribution can reference the canonical totals later.
      try {
        uploadModal.setAttribute('data-original-quantity', quantity);
        uploadModal.setAttribute('data-tray-capacity', trayCapacity);
      } catch (e) {
        // ignore if uploadModal not present for some reason
      }
    
    console.log('ðŸ” FINAL OPTIMAL TRAY VERIFICATION:');
    const finalQuantities = [];
    let totalVerification = 0;
    document.querySelectorAll('.jig-loading-table tbody tr').forEach((row, idx) => {
      const lotId = row.getAttribute('data-lot-id');
      const qty = parseInt(row.querySelector('input[type="number"], span')?.value || row.querySelector('span')?.textContent || 0);
      finalQuantities.push(qty);
      totalVerification += qty;
      console.log(`   Row ${idx + 1}: lot_id="${lotId}", qty="${qty}"`);
    });
    console.log('   ðŸ“Š Final optimal sequence:', finalQuantities.join(', '));
    console.log('   âœ… Total verification:', totalVerification, '(expected:', quantity, ')');
    console.log('   âœ… Matches expected total?', totalVerification === quantity);
  }


    function attachTrayQuantityValidationHandlers() {
  const trayRows = document.querySelectorAll('.jig-loading-table tbody tr');
  trayRows.forEach(row => {
    const trayIdInput = row.querySelector('input[type="text"]');
    const trayQtyInput = row.querySelector('input[type="number"]');
    if (trayIdInput) {
      trayIdInput.addEventListener('input', function () {
        const trayId = trayIdInput.value.trim();
        if (!trayId) {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdRequiredError(trayIdInput);
          return;
        }

        // Prevent duplicate scans: if the same tray id already exists in another
        // input cell in this modal, skip server validation and show a small message.
        const tbody = trayIdInput.closest('tbody');
        if (tbody) {
          const otherInputs = Array.from(tbody.querySelectorAll('input[type="text"]'));
          const duplicateFound = otherInputs.some(inp => inp !== trayIdInput && inp.value.trim().toLowerCase() === trayId.toLowerCase());
          if (duplicateFound) {
            showTrayValidationMessage(trayIdInput, 'Tray already scanned in another slot', false);
            trayIdInput.style.borderColor = '#ffc107';
            trayIdInput.style.backgroundColor = '#fff8e1';
            return; // do not call server
          }
        }
        // âœ… FIX: Get lot_id from modal or row
        const uploadModal = document.getElementById('uploadChildModal');
        const lot_id = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
        
        console.log('[Tray Validation] Calling /JigUnloading_Zone2/JU_Zone_validate_tray_id/ for:', trayId, 'with lot_id:', lot_id);

        fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            tray_id: trayId,
            lot_id: lot_id  // âœ… FIX: Include lot_id
          })
        })
        .then(res => res.json())
        .then(data => {
          removeTrayIdError(trayIdInput);
          if (data.success) {
            trayIdInput.style.borderColor = '#28a745';
            trayIdInput.style.backgroundColor = '#f5fff5';
            showTrayValidationMessage(trayIdInput, "Available", true);
          } else {
            trayIdInput.style.borderColor = '#dc3545';
            trayIdInput.style.backgroundColor = '#fff5f5';
            showTrayValidationMessage(trayIdInput, data.error || 'Tray ID is invalid', false);
          }
        })
        .catch(() => {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdValidationError(trayIdInput, 'Network error during validation');
        });
      });
    }
    
    // Existing quantity validation with same fix
    if (trayQtyInput && trayIdInput) {
      trayQtyInput.addEventListener('change', function () {
        const trayId = trayIdInput.value.trim();
        if (!trayId) {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdRequiredError(trayIdInput);
          return;
        }

        // âœ… FIX: Get lot_id from modal or row
        const uploadModal = document.getElementById('uploadChildModal');
        const lot_id = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
        
        console.log('[Tray Validation] Calling /JigUnloading_Zone2/JU_Zone_validate_tray_id/ for:', trayId, 'with lot_id:', lot_id);

        fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            tray_id: trayId,
            lot_id: lot_id  // âœ… FIX: Include lot_id
          })
        })
        .then(res => res.json())
        .then(data => {
          removeTrayIdError(trayIdInput);
          if (data.success) {
            trayIdInput.style.borderColor = '#28a745';
            trayIdInput.style.backgroundColor = '#f5fff5';
            showTrayValidationMessage(trayIdInput, "Available", true);
          } else {
            trayIdInput.style.borderColor = '#dc3545';
            trayIdInput.style.backgroundColor = '#fff5f5';
            showTrayValidationMessage(trayIdInput, data.error || 'Tray ID is invalid', false);
          }
        })
        .catch(() => {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdValidationError(trayIdInput, 'Network error during validation');
        });
      });
    }
  });
}
    function showTrayValidationMessage(input, message, isSuccess) {
  removeTrayIdError(input);
  const msg = document.createElement('div');
  msg.className = 'tray-validation-msg';
  msg.style.cssText = `
    margin-top: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    color: ${isSuccess ? '#28a745' : '#856404'};
    background: ${isSuccess ? '#e8f5e9' : '#fff3cd'};
    border: 1px solid ${isSuccess ? '#c3e6cb' : '#ffeeba'};
    border-radius: 6px;
    padding: 6px 14px;
    min-width: 180px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    position: absolute;
    left: 0;
    top: 38px;
    z-index: 1001;
  `;
  msg.innerHTML = isSuccess
    ? `<span style="font-size:18px;">&#x2714;</span> <span>${message}</span>`
    : `<span style="font-size:18px;">&#9888;</span> <span>${message}</span>`;
  const inputCell = input.closest('td');
  if (inputCell) {
    inputCell.style.position = 'relative';
    inputCell.appendChild(msg);
    setTimeout(() => {
      if (msg.parentNode) msg.remove();
      input.style.borderColor = '#ccc';
      input.style.backgroundColor = '#fff';
    }, 5000);
  }
}
    // Helper to show required error
  function showTrayIdRequiredError(input) {
    removeTrayIdError(input);
    const errorElement = document.createElement('div');
    errorElement.className = 'tray-validation-error';
    errorElement.style.cssText = `
      color: #dc3545; font-size: 12px; margin-top: 4px; 
      padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
      border-radius: 4px; position: absolute; z-index: 1000; 
      min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    errorElement.textContent = 'Tray ID is required';
    const inputCell = input.closest('td');
    if (inputCell) {
      inputCell.style.position = 'relative';
      inputCell.appendChild(errorElement);
      setTimeout(() => {
        if (errorElement.parentNode) {
          errorElement.remove();
          input.style.borderColor = '#ccc';
          input.style.backgroundColor = '#fff';
        }
      }, 5000);
    }
  }
  
  // Helper to show validation error
  function showTrayIdValidationError(input, message) {
    removeTrayIdError(input);
    const errorElement = document.createElement('div');
    errorElement.className = 'tray-validation-error';
    errorElement.style.cssText = `
      color: #dc3545; font-size: 12px; margin-top: 4px; 
      padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
      border-radius: 4px; position: absolute; z-index: 1000; 
      min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    `;
    errorElement.textContent = message;
    const inputCell = input.closest('td');
    if (inputCell) {
      inputCell.style.position = 'relative';
      inputCell.appendChild(errorElement);
      setTimeout(() => {
        if (errorElement.parentNode) {
          errorElement.remove();
          input.style.borderColor = '#ccc';
          input.style.backgroundColor = '#fff';
        }
      }, 5000);
    }
  }
  
  // Helper to remove previous error
  function removeTrayIdError(input) {
    const inputCell = input.closest('td');
    if (inputCell) {
      const error = inputCell.querySelector('.tray-validation-error');
      if (error) error.remove();
    }
  }
  
  // Call this after rendering the tray table
  attachTrayQuantityValidationHandlers();
  // âœ… ENHANCED: Also update the validation function to handle the new structure
  window.validateTrayQuantity = function(input, trayCapacity) {
    const value = parseInt(input.value);

    if (value > trayCapacity) {
      input.value = trayCapacity;
      Swal.fire({
        icon: 'warning',
        title: 'Quantity Limit Exceeded',
        text: `Maximum quantity per tray is ${trayCapacity}. Value reset to ${trayCapacity}.`,
        timer: 2500,
        showConfirmButton: false
      });
    } else if (value < 1) {
      input.value = 1;
      Swal.fire({
        icon: 'warning',
        title: 'Invalid Quantity',
        text: 'Minimum quantity per tray is 1.',
        timer: 2000,
        showConfirmButton: false
      });
    }

    if (value >= 1 && value <= trayCapacity) {
      input.style.borderColor = '#28a745';
      setTimeout(() => {
        input.style.borderColor = '#ccc';
      }, 1000);
    } else {
      input.style.borderColor = '#dc3545';
    }
  };

  // Enhanced function to refresh the unload modal with updated status
  function refreshUnloadModal() {
    const unloadModal = document.getElementById('unloadModal');
    if (unloadModal && unloadModal.style.display === 'flex') {
        // Find the last triggered unload button to get the data
        const lastTriggeredBtn = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
        
        if (lastTriggeredBtn) {
            try {
                const modelList = JSON.parse(lastTriggeredBtn.getAttribute('data-model-list') || '[]');
                const modelImages = JSON.parse(lastTriggeredBtn.getAttribute('data-model-images') || '{}');
                const lotIdQuantities = JSON.parse(lastTriggeredBtn.getAttribute('data-lot-id-quantities') || '{}');
                const lotId = lastTriggeredBtn.getAttribute('data-lot-id');
                const lotIdList = JSON.parse(lastTriggeredBtn.getAttribute('data-lot-id-list') || '[]');
                
                // Get model colors from the row data
                const row = lastTriggeredBtn.closest('tr');
                const modelStockNoCell = row ? row.querySelector('.model-stock-no-cell') : null;
                const modelColors = modelStockNoCell ? JSON.parse(modelStockNoCell.getAttribute('data-model-colors') || '{}') : {};
                
                const preloadedUnloadedLotIds = lastTriggeredBtn.hasAttribute('data-unloaded-lot-ids') 
                  ? JSON.parse(lastTriggeredBtn.getAttribute('data-unloaded-lot-ids') || '[]') 
                  : [];
                
                // Refresh the modal with updated data
                showUnloadModal(modelList, modelImages, lotIdQuantities, lotId, lotIdList, modelColors, preloadedUnloadedLotIds);
            } catch (error) {
                console.error('Error refreshing unload modal:', error);
                // Just close the modal if refresh fails
                unloadModal.style.display = 'none';
            }
        } else {
            // Close the modal if we can't refresh
            unloadModal.style.display = 'none';
        }
    }
  }

  // Make refreshUnloadModal available globally
  window.refreshUnloadModal = refreshUnloadModal;

  // Additional utility functions for better integration
  
  // Function to manually trigger unload status check for specific lot IDs
  window.checkUnloadStatusManually = function(lotIds) {
    return fetch('/JigUnloading_Zone2/JU_Zone_check_unload_status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ lot_ids: Array.isArray(lotIds) ? lotIds : [lotIds] })
    })
    .then(response => response.json())
    .catch(error => {
      console.error('Error checking unload status manually:', error);
      return { success: false, unloaded_lot_ids: [] };
    });
  };

  // Function to update a specific row's unload status
  window.updateRowUnloadStatus = function(lotId, isUnloaded) {
    const rows = document.querySelectorAll('#unloadModalTableBody tr');
    rows.forEach(row => {
      const lotIdCell = row.children[2];
      if (lotIdCell && lotIdCell.textContent.trim() === lotId) {
        const operationCell = row.children[4];
        if (operationCell) {
          if (isUnloaded) {
            operationCell.innerHTML = `
              <span style="
                display: inline-flex; align-items: center; justify-content: center;
                background: #28a745; color: white; border: none; border-radius: 15px; 
                padding: 4px 12px; font-size: 12px; font-weight: 500;
                cursor: default;
              ">âœ“ Unloaded</span>
            `;
            
            // Also disable quantity input
            const qtyInput = row.children[3].querySelector('input[type="number"]');
            if (qtyInput) {
              qtyInput.disabled = true;
            }
          } else {
            operationCell.innerHTML = `
              <button class="unload-row-btn" style="background:#023E4DCC; color:#fff; border:none; border-radius:5px; padding:5px 14px; font-size:13px; cursor:pointer;">Unload</button>
            `;
            
            // Enable quantity input
            const qtyInput = row.children[3].querySelector('input[type="number"]');
            if (qtyInput) {
              qtyInput.disabled = false;
            }
          }
        }
      }
    });
  };

  // âœ… FIXED: populateTrayTableEnhanced function with optimal quantity distribution
  // EXPECTED BEHAVIOR: With total qty 80 and combined lot_ids
  // CALCULATION: 80 Ã· 12 = 6 full trays (72) + 1 partial tray (8)
  // OUTPUT: 1(Top Tray)-8, 2-12, 3-12, 4-12, 5-12, 6-12, 7-12
  window.populateTrayTableEnhanced = function(quantity, trayCapacity, lotIdList = [], mainLotId = '', allCombinedLotIds = []) {
    const uploadModal = document.getElementById('uploadChildModal');
    if (!uploadModal) return;

    const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
    if (!tableBody) return;

    tableBody.innerHTML = '';

    console.log('ðŸ” ENHANCED OPTIMAL TRAY DISTRIBUTION:');
    console.log('   Total Quantity:', quantity);
    console.log('   Tray Capacity:', trayCapacity);
    console.log('   LotIdList:', lotIdList);
    console.log('   All Combined Lot IDs:', allCombinedLotIds);
    console.log('   Main Lot ID:', mainLotId);

    // âœ… OPTIMAL DISTRIBUTION: Calculate best tray distribution
    const fullTrays = Math.floor(quantity / trayCapacity);
    const remainingQty = quantity % trayCapacity;
    const totalTrays = remainingQty > 0 ? fullTrays + 1 : fullTrays;

    console.log('   ðŸ“Š ENHANCED OPTIMAL CALCULATION:');
    console.log(`     Full trays (${trayCapacity} each):`, fullTrays);
    console.log(`     Remaining quantity:`, remainingQty);
    console.log(`     Total trays needed:`, totalTrays);

    // âœ… CREATE OPTIMAL TRAY DISTRIBUTION
    const optimalTrays = [];
    
    // Add partial tray first (if exists) - this will be the smallest
    if (remainingQty > 0) {
      optimalTrays.push({
        trayNumber: 1,
        quantity: remainingQty,
        isTopTray: true // Smallest tray is top tray
      });
    }
    
    // Add full trays
    for (let i = 0; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: optimalTrays.length + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }

    // âœ… ENHANCED LOT_ID DISTRIBUTION across optimal trays
    // Strategy: Distribute lot_ids proportionally across trays
    const lotIdCounts = {};
    lotIdList.forEach(lotId => {
      lotIdCounts[lotId] = (lotIdCounts[lotId] || 0) + 1;
    });

    console.log('   ðŸ“‹ Lot ID distribution in input:', lotIdCounts);

    // Assign lot_ids to trays based on proportional distribution
    let currentLotIdIndex = 0;
    
    optimalTrays.forEach((tray, trayIndex) => {
      // For simplicity, we'll cycle through the lotIdList
      if (currentLotIdIndex < lotIdList.length) {
        tray.lotId = lotIdList[currentLotIdIndex];
        // Advance by the tray quantity to get variety across trays
        currentLotIdIndex = (currentLotIdIndex + tray.quantity) % lotIdList.length;
      } else if (allCombinedLotIds.length > 0) {
        // Fallback to combined lot IDs
        tray.lotId = allCombinedLotIds[trayIndex % allCombinedLotIds.length];
      } else {
        // Final fallback to main lot ID
        tray.lotId = mainLotId;
      }
    });

    console.log('   ðŸŽ¯ ENHANCED OPTIMAL TRAYS CREATED:');
    optimalTrays.forEach(tray => {
      console.log(`     Tray ${tray.trayNumber}: ${tray.quantity} pieces (${tray.lotId})${tray.isTopTray ? ' [TOP TRAY]' : ''}`);
    });

    // âœ… Render the optimal trays in the table
    optimalTrays.forEach((tray, index) => {
      const row = document.createElement('tr');
      row.setAttribute('data-lot-id', tray.lotId);

      row.innerHTML = `
        <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
          ${tray.trayNumber}${tray.isTopTray ? ' (Top Tray)' : ''}
        </td>
        <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
          <input type="text" placeholder="Scan tray" 
                 data-lot-id="${tray.lotId}"
                 style="width:100%; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px;" />
        </td>

        <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">
          ${tray.isTopTray
            ? `<input type="number" value="${tray.quantity}" min="1" max="${tray.quantity}" 
                       data-original-qty="${tray.quantity}"
                       style="width:60px; text-align:center; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px; background-color:#f9f9f9;"
                       class="tray-qty-input-zone2"
                       disabled />
               <img src="/static/assets/icons/edit1.png" alt="Edit" title="Edit" 
                    style="width:16px; height:16px; margin-left:6px; vertical-align:middle; cursor:pointer;" 
                    class="tray-edit-btn-zone2" data-action="edit" />`
            : `<span style="font-weight:500; color:#333;">${tray.quantity}</span>`
          }
        </td>
      `;

      tableBody.appendChild(row);
    });
    
    console.log('ðŸ” FINAL ENHANCED OPTIMAL VERIFICATION:');
    const finalQuantities = [];
    let totalVerification = 0;
    document.querySelectorAll('.jig-loading-table tbody tr').forEach((row, idx) => {
      const lotId = row.getAttribute('data-lot-id');
      const qty = parseInt(row.querySelector('input[type="number"], span')?.value || row.querySelector('span')?.textContent || 0);
      finalQuantities.push(qty);
      totalVerification += qty;
      console.log(`   Row ${idx + 1}: lot_id="${lotId}", qty="${qty}"`);
    });
    console.log('   ðŸ“Š Final enhanced optimal sequence:', finalQuantities.join(', '));
    console.log('   âœ… Total verification:', totalVerification, '(expected:', quantity, ')');
    console.log('   âœ… Matches expected total?', totalVerification === quantity);
    
    // âœ… Final lot_id verification
    const finalTrayLotIds = [...new Set(Array.from(document.querySelectorAll('.jig-loading-table tbody tr')).map(row => row.getAttribute('data-lot-id')))];
    console.log('   ðŸ“‹ Unique lot_ids in final trays:', finalTrayLotIds.length);
    console.log('   ðŸ“‹ Expected combined lot_ids:', allCombinedLotIds.length);
  }
});
</script>

<!-- Script for Upload Child Modal - UPDATED WITH OPTIMAL TRAY DISTRIBUTION -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  
  // Global variables to store current modal context
  let currentModelNumber = null;
  let currentLotId = null;
  let currentQuantity = 0;
  let currentTrayType = null;
  let currentTrayCapacity = 0;
  
// ðŸ”§ FIXED: enterAddModelMode to capture jig context
function enterAddModelMode(modelNumber, lotId, quantity, trayType, trayCapacity) {
  // Store current modal context
  currentModelNumber = modelNumber;
  currentLotId = lotId;
  currentTrayType = trayType;
  currentTrayCapacity = parseInt(trayCapacity) || 8;
  
  // ðŸ”§ NEW: Get and store current jig_lot_id context
  const triggerButton = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
  if (triggerButton) {
    const row = triggerButton.closest('tr');
    currentJigLotId = row ? row.getAttribute('data-jig-lot-id') : '';
    console.log('ðŸŽ¯ Current Jig Context for Add Model:', currentJigLotId);
  } else {
    currentJigLotId = '';
    console.warn('âš ï¸ No jig context found');
  }
  
  // âœ… FIXED: Get current quantity from modal input instead of parameter
  const uploadModal = document.getElementById('uploadChildModal');
  const qtyInput = uploadModal ? uploadModal.querySelector('#jigQrId') : null;
  
  if (qtyInput && qtyInput.value) {
    currentQuantity = parseInt(qtyInput.value) || 0;
    console.log('   Using quantity from modal input:', currentQuantity);
  } else {
    currentQuantity = parseInt(quantity) || 0;
    console.log('   Using quantity from parameter:', currentQuantity);
  }
  
  console.log('ðŸš€ ENTERING ADD MODEL MODE:');
  console.log('   Model Number:', currentModelNumber);
  console.log('   Lot ID:', currentLotId);
  console.log('   Current Jig Lot ID:', currentJigLotId);
  console.log('   Current Quantity (from modal):', currentQuantity);
  console.log('   Tray Type:', currentTrayType);
  console.log('   Tray Capacity:', currentTrayCapacity);
  
  // âœ… FIXED: Load jig-aware previously combined rows from modal data
  let existingSourceCount = 1;
  
  if (uploadModal) {
    const existingSourceData = uploadModal.getAttribute('data-source-count');
    if (existingSourceData) {
      existingSourceCount = parseInt(existingSourceData) || 1;
      console.log('   Existing Source Count Found:', existingSourceCount);
    } else {
      uploadModal.setAttribute('data-source-count', '1');
      console.log('   Fresh Start - Source Count Initialized to 1');
    }
    
    // ðŸ”§ NEW: Load jig-aware previously combined rows
    if (uploadModal.getAttribute('data-combined-lot-ids')) {
      try {
        const combinedLotIds = JSON.parse(uploadModal.getAttribute('data-combined-lot-ids') || '[]');
        previouslyCombinedRows = new Set();
        
        // Convert to jig-aware format: "jig_lot_id:lot_id"
        combinedLotIds.forEach(lotId => {
          const jigAwareKey = `${currentJigLotId}:${lotId}`;
          previouslyCombinedRows.add(jigAwareKey);
        });
        
        console.log('ðŸ”§ Loaded jig-aware previously combined rows:', Array.from(previouslyCombinedRows));
      } catch (e) {
        console.warn('Failed to load previously combined rows:', e);
      }
    }
  }
  // Close both modals
  const unloadModal = document.getElementById('unloadModal');
  
  if (unloadModal) {
    unloadModal.style.display = 'none';
  }
  if (uploadModal) {
    uploadModal.style.display = 'none';
  }
  
  // Add class to show checkboxes and visual indicators
  document.body.classList.add('add-model-mode');
  
  // Show loading indicator
  showAddModelLoadingIndicator();
  
  // Filter and highlight only compatible rows (with unload status check)
  filterAndHighlightCompatibleRowsWithUnloadCheck(modelNumber, lotId);
  
  // Create and show Exit button
  createExitAddModelButton();
  
  console.log('âœ… Add Model Mode Activated');
}


// ðŸ”§ FIXED: Auto-check previously combined rows with proper jig-awareness
function autoCheckPreviouslyCombinedRows() {
  if (previouslyCombinedRows.size === 0) {
    console.log('No previously combined rows to auto-check');
    return;
  }
  
  console.log('ðŸ”§ Auto-checking jig-aware previously combined rows:', Array.from(previouslyCombinedRows));
  console.log('ðŸŽ¯ Current jig context:', currentJigLotId);
  
  const tableRows = document.querySelectorAll('#order-listing tbody tr');
  let autoCheckedCount = 0;
  
  // ðŸ”§ NEW: Get jig-aware sources from modal if available
  const uploadModal = document.getElementById('uploadChildModal');
  let jigAwareSources = new Set();
  
  if (uploadModal && uploadModal.getAttribute('data-jig-aware-sources')) {
    try {
      const sources = JSON.parse(uploadModal.getAttribute('data-jig-aware-sources'));
      jigAwareSources = new Set(sources);
      console.log('ðŸ“‹ Found existing jig-aware sources:', Array.from(jigAwareSources));
    } catch (e) {
      console.warn('Failed to parse jig-aware sources:', e);
    }
  }
  
  tableRows.forEach(row => {
    const rowLotId = row.getAttribute('data-lot-id');
    const rowJigLotId = row.getAttribute('data-jig-lot-id');
    const checkbox = row.querySelector('.row-checkbox');
    
    if (rowLotId && rowJigLotId && checkbox && !checkbox.disabled) {
      // ðŸ”§ NEW: Create jig-aware key for comparison
      const jigAwareKey = `${rowJigLotId}:${rowLotId}`;
      
      // âœ… FIXED: Check if this specific jig-lot combination was previously combined
      if (jigAwareSources.has(jigAwareKey) || previouslyCombinedRows.has(jigAwareKey)) {
        checkbox.checked = true;
        autoCheckedCount++;
        
        // Add visual indication that this was auto-checked
        row.style.backgroundColor = '#e8f5e8';
        row.style.border = '2px solid #28a745';
        
        // Add a small indicator
        if (!row.querySelector('.auto-checked-indicator')) {
          const indicator = document.createElement('span');
          indicator.className = 'auto-checked-indicator';
          indicator.innerHTML = 'âœ“';
          indicator.style.cssText = `
            position: absolute; top: 5px; right: 5px; z-index: 10;
            background: #28a745; color: white; border-radius: 50%;
            width: 16px; height: 16px; font-size: 10px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
          `;
          indicator.title = `Previously combined: ${jigAwareKey}`;
          row.style.position = 'relative';
          row.appendChild(indicator);
        }
        
        console.log(`âœ… Auto-checked: ${jigAwareKey}`);
      } else {
        console.log(`â­ï¸ Skipped: ${jigAwareKey} (not in previous combinations)`);
      }
    }
  });
  
  if (autoCheckedCount > 0) {
    // Update counters
    updateSelectedCount();
    
    // Show notification
    setTimeout(() => {
      Swal.fire({
        icon: 'info',
        title: 'Previously Combined Rows',
        text: `${autoCheckedCount} previously combined jig-lot combinations have been automatically selected`,
        timer: 2000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end'
      });
    }, 500);
  } else {
    console.log('â„¹ï¸ No previously combined jig-lot combinations found');
  }
}

// NEW: Show loading indicator while checking unload status
function showAddModelLoadingIndicator() {
  let loadingIndicator = document.getElementById('addModelLoadingIndicator');
  if (!loadingIndicator) {
    loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'addModelLoadingIndicator';
    loadingIndicator.style.cssText = `
      position: fixed; top: 120px; right: 20px; z-index: 10000;
      background: #007bff; color: white; padding: 12px 20px;
      border-radius: 25px; font-weight: 600; font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    `;
    document.body.appendChild(loadingIndicator);
  }
  
  loadingIndicator.innerHTML = 'ðŸ”„ Checking compatible rows...';
  loadingIndicator.style.display = 'block';
}

// NEW: Hide loading indicator
function hideAddModelLoadingIndicator() {
  const loadingIndicator = document.getElementById('addModelLoadingIndicator');
  if (loadingIndicator) {
    loadingIndicator.style.display = 'none';
  }
}

// UPDATED: filterAndHighlightCompatibleRowsWithUnloadCheck to include auto-checking
// ðŸŽ¯ FIXED: Now filters by plating stock number instead of model list
function filterAndHighlightCompatibleRowsWithUnloadCheck(modelNumber, currentLotId) {
  const tableRows = document.querySelectorAll('#order-listing tbody tr');
  let potentialCompatibleRows = [];
  let allLotIdsToCheck = [];
  let jigLotIdToLotIdsMap = new Map(); // ðŸ”§ NEW: Track which lot_ids belong to which jig
  
  console.log(`ðŸŽ¯ ADD MODEL FILTER: Looking for rows with plating stock no: ${modelNumber}`);
  
  // First pass: identify potentially compatible rows and collect lot_ids with their jig context
  tableRows.forEach((row, index) => {
    const rowLotId = row.getAttribute('data-lot-id');
    const jigLotId = row.getAttribute('data-jig-lot-id'); // ðŸ”§ NEW: Get jig context
    const modelCell = row.querySelector('.model-stock-no-cell');
    
    if (!modelCell || !rowLotId) {
      row.style.display = 'none';
      const checkbox = row.querySelector('.row-checkbox');
      if (checkbox) checkbox.disabled = true;
      return;
    }
    
    try {
      const modelList = JSON.parse(modelCell.getAttribute('data-model-list') || '[]');
      const lotIdQuantities = JSON.parse(row.getAttribute('data-lot-id-quantities') || '{}');
      const lotIdModelMap = JSON.parse(row.getAttribute('data-lot-id-model-map') || '{}');
      
      // ðŸŽ¯ FIX: Check if any lot_id in this row has the same plating stock number (modelNumber is actually plating_stk_no)
      const hasTargetModel = Object.values(lotIdModelMap).includes(modelNumber);
      
      console.log(`Row ${index + 1} Check:`, {
        rowLotId,
        jigLotId, // ðŸ”§ NEW: Log jig context
        hasTargetModel,
        lotIdQuantities,
        lotIdModelMap, // ðŸŽ¯ NEW: Log model mapping for debugging
        targetPlatingStockNo: modelNumber, // ðŸŽ¯ NEW: Clarify this is plating stock number
        isCurrentRowLotId: rowLotId === currentLotId
      });
      
      if (hasTargetModel) {
        const hasUnusedLotIds = checkForUnusedLotIds(lotIdQuantities, currentLotId, modelNumber);
        
        if (hasUnusedLotIds) {
          potentialCompatibleRows.push({
            row: row,
            index: index,
            rowLotId: rowLotId,
            jigLotId: jigLotId, // ðŸ”§ NEW: Include jig context
            lotIdQuantities: lotIdQuantities,
            isCurrentRow: (jigLotId === currentJigLotId && rowLotId === currentLotId) // ðŸŽ¯ FIXED: Compare both jig and lot
          });
          
          const lotIds = Object.keys(lotIdQuantities);
          allLotIdsToCheck.push(...lotIds);
          
          // ðŸ”§ NEW: Map lot_ids to their jig for context-aware checking
          if (jigLotId) {
            if (!jigLotIdToLotIdsMap.has(jigLotId)) {
              jigLotIdToLotIdsMap.set(jigLotId, new Set());
            }
            lotIds.forEach(lotId => jigLotIdToLotIdsMap.get(jigLotId).add(lotId));
          }
        } else {
          row.style.display = 'none';
          row.classList.remove('compatible-row');
          const checkbox = row.querySelector('.row-checkbox');
          if (checkbox) checkbox.disabled = true;
        }
      } else {
        row.style.display = 'none';
        row.classList.remove('compatible-row');
        const checkbox = row.querySelector('.row-checkbox');
        if (checkbox) checkbox.disabled = true;
      }
    } catch (error) {
      console.error('Error parsing model data for row:', error);
      row.style.display = 'none';
      const checkbox = row.querySelector('.row-checkbox');
      if (checkbox) checkbox.disabled = true;
    }
  });
  
  if (potentialCompatibleRows.length === 0) {
    hideAddModelLoadingIndicator();
    Swal.fire({
      icon: 'warning',
      title: 'No Compatible Rows',
      text: `No available rows found with unused quantities for plating stock no: ${modelNumber}.`,
      timer: 4000,
      showConfirmButton: false
    });
    return;
  }
  
  // ðŸ”§ NEW: Check unload status for each jig separately
  console.log('ðŸ” Checking unload status for jigs:', Array.from(jigLotIdToLotIdsMap.keys()));
  
  const checkPromises = Array.from(jigLotIdToLotIdsMap.entries()).map(([jigLotId, lotIdsSet]) => {
    const lotIds = Array.from(lotIdsSet);
    
    return fetch('/JigUnloading_Zone2/JU_Zone_check_unload_status/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ 
        lot_ids: lotIds,
        jig_lot_id: jigLotId // ðŸ”§ NEW: Include jig context
      })
    })
    .then(response => response.json())
    .then(data => ({
      jigLotId: jigLotId,
      lotIds: lotIds,
      unloadedLotIds: data.success ? new Set(data.unloaded_lot_ids || []) : new Set(),
      success: data.success
    }))
    .catch(error => {
      console.error(`Error checking unload status for jig ${jigLotId}:`, error);
      return {
        jigLotId: jigLotId,
        lotIds: lotIds,
        unloadedLotIds: new Set(),
        success: false
      };
    });
  });
  
  Promise.all(checkPromises).then(results => {
    hideAddModelLoadingIndicator();
    
    // Build a master unloaded lot_ids set from all results
    const allUnloadedLotIds = new Set();
    results.forEach(result => {
      if (result.success) {
        result.unloadedLotIds.forEach(lotId => allUnloadedLotIds.add(lotId));
        console.log(`ðŸ” Jig ${result.jigLotId}: Unloaded lot_ids:`, Array.from(result.unloadedLotIds));
      }
    });
    
    console.log('ðŸ” All unloaded lot_ids across jigs:', Array.from(allUnloadedLotIds));
    
    // Second pass: filter out rows with fully unloaded quantities for the target model
    let finalCompatibleRows = [];
    
    potentialCompatibleRows.forEach(rowData => {
      const { row, lotIdQuantities, isCurrentRow, jigLotId } = rowData;
      
      let hasAvailableQuantity = false;
      const lotIdModelMap = JSON.parse(row.getAttribute('data-lot-id-model-map') || '{}');
      
      Object.keys(lotIdQuantities).forEach(lotId => {
        const modelForLotId = lotIdModelMap[lotId];
        const isTargetModel = String(modelForLotId).trim() === String(modelNumber).trim();
        const isNotUnloaded = !allUnloadedLotIds.has(lotId);
        // ðŸŽ¯ FIXED: Only exclude the exact triggering row (same jig AND lot_id)
        const isNotCurrentlyBeingUsed = isCurrentRow ? false : true; // Exclude only the exact current row
        
        if (isTargetModel && isNotUnloaded && isNotCurrentlyBeingUsed) {
          hasAvailableQuantity = true;
          console.log(`âœ… Jig ${jigLotId}, Lot ID ${lotId}: Available for model ${modelNumber}`);
        } else {
          const reasons = [];
          if (!isTargetModel) reasons.push('wrong model');
          if (!isNotUnloaded) reasons.push('unloaded');
          if (!isNotCurrentlyBeingUsed) reasons.push('current row');
          console.log(`âŒ Jig ${jigLotId}, Lot ID ${lotId}: Unavailable - ${reasons.join(', ')}`);
        }
      });
      
      if (hasAvailableQuantity) {
        row.style.display = '';
        row.classList.add('compatible-row');
        const checkbox = row.querySelector('.row-checkbox');
        if (checkbox) {
          checkbox.disabled = false;
          const extraInfo = isCurrentRow ? ' (from same row)' : '';
          checkbox.title = `Add model ${modelNumber} from this row${extraInfo}`;
        }
        finalCompatibleRows.push(rowData);
      } else {
        row.style.display = 'none';
        row.classList.remove('compatible-row');
        const checkbox = row.querySelector('.row-checkbox');
        if (checkbox) checkbox.disabled = true;
      }
    });
    
    if (finalCompatibleRows.length === 0) {
      Swal.fire({
        icon: 'info',
        title: 'No Available Quantities',
        text: `All ${modelNumber} quantities have already been used or unloaded.`,
        timer: 3000,
        showConfirmButton: false
      });
    }
    
    console.log(`Found ${finalCompatibleRows.length} compatible rows with available quantities for model ${modelNumber}`);
    
    // AUTO-CHECK PREVIOUSLY COMBINED ROWS
    setTimeout(() => {
      autoCheckPreviouslyCombinedRows();
    }, 200);
    
    // Show summary
    setTimeout(() => {
      showCompatibleRowsSummary(modelNumber, finalCompatibleRows.length);
      updateCompatibleRowsCounter(document.querySelectorAll('.row-checkbox:checked').length, finalCompatibleRows.length);
    }, 300);
    
  }).catch(error => {
    hideAddModelLoadingIndicator();
    console.error('Error checking unload status:', error);
    showCompatibleRowsWithoutUnloadCheck(potentialCompatibleRows, modelNumber);
  });
}


// NEW: Helper function to check for unused lot_ids in a row
function checkForUnusedLotIds(lotIdQuantities, currentLotId, targetModelNumber) {
  const lotIds = Object.keys(lotIdQuantities);
  
  // ðŸŽ¯ FIXED: Allow adding models from other jigs with same plating stock number
  // This includes both:
  // 1. Other lot_ids in the same jig (lotId !== currentLotId)
  // 2. Same lot_id from different jigs (which will be filtered later)
  return lotIds.length > 0; // Any lot_ids mean potential compatibility
}

// FALLBACK: Show compatible rows without unload check (if API fails)
function showCompatibleRowsWithoutUnloadCheck(potentialCompatibleRows, modelNumber) {
  let compatibleRowsCount = 0;
  
  potentialCompatibleRows.forEach(rowData => {
    const { row } = rowData;
    row.style.display = '';
    row.classList.add('compatible-row');
    const checkbox = row.querySelector('.row-checkbox');
    if (checkbox) {
      checkbox.disabled = false;
      checkbox.title = `Add model ${modelNumber} from this row (unload status unknown)`;
    }
    compatibleRowsCount++;
  });
  
  console.log(`Fallback: Found ${compatibleRowsCount} potentially compatible rows for model ${modelNumber}`);
  
  // Show summary with warning
  setTimeout(() => {
    showCompatibleRowsSummaryWithWarning(modelNumber, compatibleRowsCount);
    updateCompatibleRowsCounter(0, compatibleRowsCount);
  }, 100);
}

// NEW: Show summary with warning when unload check fails
function showCompatibleRowsSummaryWithWarning(modelNumber, compatibleCount) {
  let summary = document.getElementById('compatibleSummary');
  if (!summary) {
    summary = document.createElement('div');
    summary.id = 'compatibleSummary';
    summary.style.cssText = `
      position: fixed; top: 180px; right: 20px; z-index: 9998;
      background: #ffc107; color: #212529; padding: 10px 15px;
      border-radius: 10px; font-size: 13px; font-weight: 500;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
      max-width: 220px; text-align: center;
    `;
    document.body.appendChild(summary);
  }
  
  summary.innerHTML = `
    <div style="margin-bottom: 5px;">âš ï¸ <strong>Model: ${modelNumber}</strong></div>
    <div style="font-size: 11px; opacity: 0.9;">
      ${compatibleCount > 0 ? `${compatibleCount} rows found` : 'No compatible rows found'}
      <br><small>(Unload status check failed)</small>
    </div>
  `;
  
  setTimeout(() => {
    if (summary && summary.parentNode) summary.remove();
  }, 7000);
}

// FIXED: Enhanced quantity calculation that excludes previously combined lot_ids
function getModelQuantityFromRowEnhanced(row, targetModelNumber, currentLotId, unloadedLotIds = new Set()) {
  try {
    const lotIdQuantities = JSON.parse(row.getAttribute('data-lot-id-quantities') || '{}');
    const lotIdModelMap = JSON.parse(row.getAttribute('data-lot-id-model-map') || '{}');
    const rowLotId = row.getAttribute('data-lot-id');
    const rowJigLotId = row.getAttribute('data-jig-lot-id');
    
    // âœ… GET PREVIOUSLY COMBINED LOT_IDS FROM MODAL
    const uploadModal = document.getElementById('uploadChildModal');
    let previouslyCombinedLotIds = new Set();
    if (uploadModal && uploadModal.getAttribute('data-combined-lot-ids')) {
      try {
        const combinedLotIds = JSON.parse(uploadModal.getAttribute('data-combined-lot-ids') || '[]');
        previouslyCombinedLotIds = new Set(combinedLotIds);
        console.log('   Previously Combined Lot IDs:', Array.from(previouslyCombinedLotIds));
      } catch (e) {
        console.warn('Failed to parse previously combined lot IDs:', e);
      }
    }
    
    let totalQty = 0;
    let lotIdBreakdown = [];
    const targetModelStr = String(targetModelNumber).trim();
    let debugArr = [];
    
    console.log('ðŸ” ENHANCED QUANTITY CALCULATION DEBUG:');
    console.log('   Target Model:', targetModelStr);
    console.log('   Current Lot ID (being used):', currentLotId);
    console.log('   Current Jig Lot ID:', currentJigLotId);
    console.log('   Row Lot ID:', rowLotId);
    console.log('   Row Jig Lot ID:', rowJigLotId);
    console.log('   Previously Combined Lot IDs:', Array.from(previouslyCombinedLotIds));
    console.log('   Lot ID Quantities:', lotIdQuantities);
    console.log('   Lot ID Model Map:', lotIdModelMap);
    console.log('   Unloaded Lot IDs:', Array.from(unloadedLotIds));
    
    // FIXED: More precise filtering logic with jig-aware current row exclusion
    Object.entries(lotIdQuantities).forEach(([lotId, qty]) => {
      const modelNo = lotIdModelMap[lotId] ? String(lotIdModelMap[lotId]).trim() : '';
      const parsedQty = parseInt(qty) || 0;
      
      // ðŸŽ¯ FIXED: Only exclude if it's the exact same jig+lot_id combination as current row
      const isTargetModel = modelNo === targetModelStr;
      const isNotCurrentlyBeingUsed = !(rowJigLotId === currentJigLotId && lotId === currentLotId); // ðŸŽ¯ FIXED: Compare jig+lot
      const isNotUnloaded = !unloadedLotIds.has(lotId); // âœ… EXCLUDE already unloaded
      const isNotPreviouslyCombined = !previouslyCombinedLotIds.has(lotId); // âœ… NEW: EXCLUDE previously combined
      const hasValidQuantity = parsedQty > 0; // âœ… ONLY positive quantities
      
      const shouldInclude = isTargetModel && isNotCurrentlyBeingUsed && isNotUnloaded && isNotPreviouslyCombined && hasValidQuantity;
      
      debugArr.push({ 
        lotId, 
        qty: parsedQty, 
        modelNo, 
        targetModelStr,
        isTargetModel,
        isNotCurrentlyBeingUsed,
        isNotUnloaded,
        isNotPreviouslyCombined, // âœ… NEW DEBUG FIELD
        hasValidQuantity,
        shouldInclude 
      });
      
      if (shouldInclude) {
        totalQty += parsedQty;
        lotIdBreakdown.push({
          lotId: lotId,
          qty: parsedQty
        });
        console.log(`   âœ… ADDED: Lot ID ${lotId} with qty ${parsedQty} (from jig: ${rowJigLotId})`);
      } else {
        const reasons = [];
        if (!isTargetModel) reasons.push('wrong model');
        if (!isNotCurrentlyBeingUsed) reasons.push('currently being used');
        if (!isNotUnloaded) reasons.push('already unloaded');
        if (!isNotPreviouslyCombined) reasons.push('already combined'); // âœ… NEW REASON
        if (!hasValidQuantity) reasons.push('invalid quantity');
        
        console.log(`   âŒ EXCLUDED: Lot ID ${lotId} with qty ${parsedQty} (from jig: ${rowJigLotId}) - Reasons: ${reasons.join(', ')}`);
      }
    });
    
    console.log('   ðŸ“Š FINAL CALCULATION:');
    console.log('   Total Quantity Added:', totalQty);
    console.log('   Lot ID Breakdown:', lotIdBreakdown);
    console.log('   Debug Array:', debugArr);
    
    return { totalQty, lotIdBreakdown };
  } catch (error) {
    console.error('âŒ Error in enhanced quantity calculation:', error);
    return { totalQty: 0, lotIdBreakdown: [] };
  }
}



// ðŸ”§ FIXED: exitAddModelMode with jig context cleanup
function exitAddModelMode() {
  document.body.classList.remove('add-model-mode');
  
  // Remove buttons and counters
  const exitBtn = document.getElementById('exitAddModelBtn');
  const counter = document.getElementById('compatibleRowsCounter');
  const summary = document.getElementById('compatibleSummary');
  const loadingIndicator = document.getElementById('addModelLoadingIndicator');
  
  if (exitBtn) exitBtn.remove();
  if (counter) counter.remove();
  if (summary) summary.remove();
  if (loadingIndicator) loadingIndicator.remove();
  
  // Reset all rows to normal state
  const tableRows = document.querySelectorAll('#order-listing tbody tr');
  tableRows.forEach(row => {
    row.style.display = '';
    row.style.backgroundColor = '';
    row.style.border = '';
    row.classList.remove('compatible-row');
    
    // Remove auto-check indicators
    const indicator = row.querySelector('.auto-checked-indicator');
    if (indicator) indicator.remove();
    
    const checkbox = row.querySelector('.row-checkbox');
    if (checkbox) {
      checkbox.checked = false;
      checkbox.disabled = false;
      checkbox.title = '';
    }
  });
  
  // Reset select all checkbox
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  if (selectAllCheckbox) {
    selectAllCheckbox.checked = false;
    selectAllCheckbox.indeterminate = false;
  }
  
  // ðŸ”§ NEW: Reset jig-aware global variables
  currentModelNumber = null;
  currentLotId = null;
  currentQuantity = 0;
  currentTrayType = null;
  currentTrayCapacity = 0;
  currentJigLotId = '';  // Clear jig context
  
  Swal.fire({
    icon: 'success',
    title: 'Exited Add Model Mode',
    timer: 500,
    showConfirmButton: false
    
  });
}


// UPDATED: handleSelectedRows with unload status awareness - DIRECT COMBINE
function handleSelectedRowsEnhanced() {
  const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
  if (selectedCheckboxes.length === 0) {
    Swal.fire({
      icon: 'warning',
      title: 'No Selection',
      text: 'Please select at least one row to add models.',
      timer: 2000,
      showConfirmButton: false
    });
    return;
  }

  // First, collect all lot_ids to check their unload status
  let allLotIdsToCheck = [];
  const selectedRowsData = [];

  selectedCheckboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const rowLotId = row.getAttribute('data-lot-id');
    const jigQrId = row.children[1]?.textContent.trim() || 'Unknown';
    const lotIdQuantities = JSON.parse(row.getAttribute('data-lot-id-quantities') || '{}');
    
    selectedRowsData.push({
      row: row,
      rowLotId: rowLotId,
      jigQrId: jigQrId,
      lotIdQuantities: lotIdQuantities
    });
    
    // Collect lot_ids for unload status check
    allLotIdsToCheck.push(...Object.keys(lotIdQuantities));
  });

  // Remove duplicates
  const uniqueLotIds = [...new Set(allLotIdsToCheck)];

  // Show loading while processing
  Swal.fire({
    title: 'Combining Models...',
    text: 'Processing selected rows',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });

  // Check unload status
  fetch('/JigUnloading_Zone2/JU_Zone_check_unload_status/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify({ lot_ids: uniqueLotIds })
  })
  .then(response => response.json())
  .then(data => {
    const unloadedLotIds = new Set(data.unloaded_lot_ids || []);
    
    // Process each selected row with unload status
    let totalAddedQuantity = 0;
    const selectedRowsInfo = [];

    selectedRowsData.forEach(rowData => {
      const { row, rowLotId, jigQrId } = rowData;
      
      // Use enhanced function that respects unload status
      const { totalQty, lotIdBreakdown } = getModelQuantityFromRowEnhanced(
        row, currentModelNumber, currentLotId, unloadedLotIds
      );

      if (totalQty > 0) { // Only include rows with available quantities
        totalAddedQuantity += totalQty;
        selectedRowsInfo.push({
          rowLotId: rowLotId,
          jigQrId: jigQrId,
          quantity: totalQty,
          lotIdBreakdown: lotIdBreakdown
        });
      }
    });

    Swal.close(); // Close loading

    if (selectedRowsInfo.length === 0) {
      Swal.fire({
        icon: 'warning',
        title: 'No Available Quantities',
        text: 'All selected rows have already been fully unloaded for this model.',
        timer: 3000,
        showConfirmButton: false
      });
      return;
    }

    const newTotalQuantity = currentQuantity + totalAddedQuantity;

    // DIRECT COMBINE - Skip confirmation popup and directly call combine function
    combineModelsAndUpdateModal(newTotalQuantity, selectedRowsInfo);
    exitAddModelMode();
    
  })
  .catch(error => {
    Swal.close(); // Close loading
    console.error('Error checking unload status:', error);
    // Fallback to original behavior without unload check
    handleSelectedRowsOriginalDirect();
  });
}

// FALLBACK: Original handleSelectedRows function (without unload check) - DIRECT COMBINE
function handleSelectedRowsOriginalDirect() {
  const selectedCheckboxes = document.querySelectorAll('.row-checkbox:checked');
  let totalAddedQuantity = 0;
  const selectedRowsInfo = [];

  selectedCheckboxes.forEach(checkbox => {
    const row = checkbox.closest('tr');
    const rowLotId = row.getAttribute('data-lot-id');
    const jigQrId = row.children[1]?.textContent.trim() || 'Unknown';

    const { totalQty, lotIdBreakdown } = getModelQuantityFromRow(row, currentModelNumber, currentLotId);

    totalAddedQuantity += totalQty;
    selectedRowsInfo.push({
      rowLotId: rowLotId,
      jigQrId: jigQrId,
      quantity: totalQty,
      lotIdBreakdown: lotIdBreakdown
    });
  });

  const newTotalQuantity = currentQuantity + totalAddedQuantity;

  // Show brief processing message
  Swal.fire({
    title: 'Combining Models...',
    text: 'Processing selection',
    timer: 500,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  }).then(() => {
    // DIRECT COMBINE - Skip confirmation and directly combine
    combineModelsAndUpdateModal(newTotalQuantity, selectedRowsInfo);
    exitAddModelMode();
  });
}

// UPDATED: createExitAddModelButton - Remove click handler since auto-combine happens on checkbox change
function createExitAddModelButton() {
  const existingBtn = document.getElementById('exitAddModelBtn');
  if (existingBtn) existingBtn.remove();
  
  const exitBtn = document.createElement('button');
  exitBtn.id = 'exitAddModelBtn';
  exitBtn.innerHTML = 'âŒ Exit Add Model Mode';
  exitBtn.style.cssText = `
    position: fixed; top: 80px; right: 20px; z-index: 10000;
    background: #dc3545; color: white; border: none;
    padding: 10px 20px; border-radius: 25px; font-weight: 600;
    cursor: pointer; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);
    transition: all 0.3s ease;
  `;
  
  // UPDATED: Only exit on click, no combining since it happens automatically
  exitBtn.onclick = function() {
    exitAddModelMode();
  };
  
  document.body.appendChild(exitBtn);
}
// FIXED: Basic quantity calculation with jig-aware current row exclusion
function getModelQuantityFromRow(row, targetModelNumber, currentLotId) {
  try {
    const lotIdQuantities = JSON.parse(row.getAttribute('data-lot-id-quantities') || '{}');
    const lotIdModelMap = JSON.parse(row.getAttribute('data-lot-id-model-map') || '{}');
    const rowLotId = row.getAttribute('data-lot-id');
    const rowJigLotId = row.getAttribute('data-jig-lot-id');
    
    // âœ… GET PREVIOUSLY COMBINED LOT_IDS FROM MODAL
    const uploadModal = document.getElementById('uploadChildModal');
    let previouslyCombinedLotIds = new Set();
    if (uploadModal && uploadModal.getAttribute('data-combined-lot-ids')) {
      try {
        const combinedLotIds = JSON.parse(uploadModal.getAttribute('data-combined-lot-ids') || '[]');
        previouslyCombinedLotIds = new Set(combinedLotIds);
        console.log('   Previously Combined Lot IDs:', Array.from(previouslyCombinedLotIds));
      } catch (e) {
        console.warn('Failed to parse previously combined lot IDs:', e);
      }
    }
    
    let totalQty = 0;
    let lotIdBreakdown = [];
    const targetModelStr = String(targetModelNumber).trim();
    let debugArr = [];
    
    console.log('ðŸ” BASIC QUANTITY CALCULATION DEBUG:');
    console.log('   Target Model:', targetModelStr);
    console.log('   Current Lot ID (being used):', currentLotId);
    console.log('   Current Jig Lot ID:', currentJigLotId);
    console.log('   Row Lot ID:', rowLotId);
    console.log('   Row Jig Lot ID:', rowJigLotId);
    console.log('   Previously Combined Lot IDs:', Array.from(previouslyCombinedLotIds));
    console.log('   Lot ID Quantities:', lotIdQuantities);
    console.log('   Lot ID Model Map:', lotIdModelMap);
    
    Object.entries(lotIdQuantities).forEach(([lotId, qty]) => {
      const modelNo = lotIdModelMap[lotId] ? String(lotIdModelMap[lotId]).trim() : '';
      const parsedQty = parseInt(qty) || 0;
      
      // ðŸŽ¯ FIXED: Only exclude if it's the exact same jig+lot_id combination as current row
      const isTargetModel = modelNo === targetModelStr;
      const isNotCurrentLot = !(rowJigLotId === currentJigLotId && lotId === currentLotId); // ðŸŽ¯ FIXED: Compare jig+lot
      const isNotPreviouslyCombined = !previouslyCombinedLotIds.has(lotId); // âœ… NEW: Don't include previously combined
      const hasValidQuantity = parsedQty > 0;
      
      const shouldInclude = isTargetModel && isNotCurrentLot && isNotPreviouslyCombined && hasValidQuantity;
      
      debugArr.push({ 
        lotId, 
        qty: parsedQty, 
        modelNo, 
        targetModelStr, 
        isTargetModel,
        isNotCurrentLot,
        isNotPreviouslyCombined, // âœ… NEW DEBUG FIELD
        hasValidQuantity,
        shouldInclude 
      });
      
      if (shouldInclude) {
        totalQty += parsedQty;
        lotIdBreakdown.push({
          lotId: lotId,
          qty: parsedQty
        });
        console.log(`   âœ… ADDED: Lot ID ${lotId} with qty ${parsedQty} (from jig: ${rowJigLotId})`);
      } else {
        const reasons = [];
        if (!isTargetModel) reasons.push('wrong model');
        if (!isNotCurrentLot) reasons.push('currently being used');
        if (!isNotPreviouslyCombined) reasons.push('already combined'); // âœ… NEW REASON
        if (!hasValidQuantity) reasons.push('invalid quantity');
        
        console.log(`   âŒ EXCLUDED: Lot ID ${lotId} with qty ${parsedQty} (from jig: ${rowJigLotId}) - Reasons: ${reasons.join(', ')}`);
      }
    });
    
    console.log('   ðŸ“Š FINAL CALCULATION:');
    console.log('   Total Quantity Added:', totalQty);
    console.log('   Lot ID Breakdown:', lotIdBreakdown);
    console.log('   Debug Array:', debugArr);
    
    return { totalQty, lotIdBreakdown };
  } catch (error) {
    console.error('âŒ Error in basic quantity calculation:', error);
    return { totalQty: 0, lotIdBreakdown: [] };
  }
}

let previouslyCombinedRows = new Set(); // Store lot_ids of previously combined rows
let currentJigLotId = '';

// 1. Updated combineModelsAndUpdateModal with simplified header + preserved backend data
function combineModelsAndUpdateModal(newTotalQuantity, selectedRowsInfo) {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  console.log('ðŸš€ FIXED COMBINE MODELS WITH SIMPLIFIED DISPLAY:');
  console.log('   Current Model:', currentModelNumber);
  console.log('   Current Lot ID:', currentLotId);
  console.log('   Current Jig Lot ID:', currentJigLotId);
  console.log('   Selected Rows Info:', selectedRowsInfo);

  // Get existing data
  let existingCombinedLotIds = [];
  let existingSourceCount = 1;
  let existingLotIdList = [];
  let existingJigAwareSources = new Set();
  
  try {
    const existingData = uploadModal.getAttribute('data-combined-lot-ids');
    if (existingData) {
      existingCombinedLotIds = JSON.parse(existingData);
    }
    
    const existingSourceData = uploadModal.getAttribute('data-source-count');
    if (existingSourceData) {
      existingSourceCount = parseInt(existingSourceData) || 1;
    }

    const existingLotIdListData = uploadModal.getAttribute('data-existing-lot-id-list');
    if (existingLotIdListData) {
      existingLotIdList = JSON.parse(existingLotIdListData);
    }
    
    // Get existing jig-aware sources
    const existingJigAwareData = uploadModal.getAttribute('data-jig-aware-sources');
    if (existingJigAwareData) {
      const sources = JSON.parse(existingJigAwareData);
      existingJigAwareSources = new Set(sources);
    }
  } catch (e) {
    console.warn('Failed to parse existing data:', e);
  }

  // Build jig-aware sources and unique lot_ids
  const existingJigLotId = uploadModal.getAttribute('data-jig-lot-id') || currentJigLotId;
  
  // Add current source to jig-aware sources
  const currentJigAwareSource = `${existingJigLotId}:${currentLotId}`;
  existingJigAwareSources.add(currentJigAwareSource);
  
  let lotIdList = [...existingLotIdList];
  let allCombinedLotIds = [...existingCombinedLotIds];
  
  // Add current lot_id to combined list if not already present
  if (!allCombinedLotIds.includes(currentLotId)) {
    allCombinedLotIds.push(currentLotId);
  }
  
  // Process new selected rows
  selectedRowsInfo.forEach((info, infoIndex) => {
    console.log(`   Processing row ${infoIndex + 1}: ${info.rowLotId}`);
    
    // Get jig context from the selected row
    const selectedRows = document.querySelectorAll('.row-checkbox:checked');
    let rowJigLotId = currentJigLotId; // Default fallback
    
    selectedRows.forEach(checkbox => {
      const row = checkbox.closest('tr');
      const checkboxRowLotId = row.getAttribute('data-lot-id');
      const checkboxRowJigLotId = row.getAttribute('data-jig-lot-id');
      
      if (checkboxRowLotId === info.rowLotId && checkboxRowJigLotId) {
        rowJigLotId = checkboxRowJigLotId;
      }
    });
    
    // Create jig-aware source
    const jigAwareSource = `${rowJigLotId}:${info.rowLotId}`;
    existingJigAwareSources.add(jigAwareSource);
    
    // Only add to combined list if not already present (avoid duplicates)
    if (!allCombinedLotIds.includes(info.rowLotId)) {
      allCombinedLotIds.push(info.rowLotId);
      console.log(`   âœ… Added unique lot_id: ${info.rowLotId}`);
    } else {
      console.log(`   â„¹ï¸ Lot_id already exists: ${info.rowLotId}`);
    }
    
    // Process lot breakdown
    if (info.lotIdBreakdown && Array.isArray(info.lotIdBreakdown)) {
      info.lotIdBreakdown.forEach((lotIdInfo) => {
        const { lotId, qty } = lotIdInfo;
        for (let i = 0; i < qty; i++) {
          lotIdList.push(lotId);
        }
        
        const jigAwareLotSource = `${rowJigLotId}:${lotId}`;
        existingJigAwareSources.add(jigAwareLotSource);
        
        if (!allCombinedLotIds.includes(lotId)) {
          allCombinedLotIds.push(lotId);
        }
      });
    } else {
      for (let i = 0; i < info.quantity; i++) {
        lotIdList.push(info.rowLotId);
      }
    }
  });

  const newSourceCount = existingSourceCount + selectedRowsInfo.length;
  allCombinedLotIds = [...new Set(allCombinedLotIds.filter(id => id && id.trim()))];
  const allJigAwareSourcesArray = Array.from(existingJigAwareSources);
  
  // Count unique JLOTs for accurate source count
  const uniqueJigLotIds = new Set();
  allJigAwareSourcesArray.forEach(source => {
    if (source.includes(':')) {
      const jigLotId = source.split(':')[0];
      uniqueJigLotIds.add(jigLotId);
    }
  });
  const actualSourceCount = uniqueJigLotIds.size;
  
  console.log('ðŸ”§ FIXED: Accurate source counting:');
  console.log('   All Jig-Aware Sources:', allJigAwareSourcesArray);
  console.log('   Unique Jig Lot IDs:', Array.from(uniqueJigLotIds));
  console.log('   Actual Source Count:', actualSourceCount);
  
  // Update modal with combined data
  uploadModal.setAttribute('data-combined-lot-ids', JSON.stringify(allCombinedLotIds));
  uploadModal.setAttribute('data-source-count', actualSourceCount);
  uploadModal.setAttribute('data-existing-lot-id-list', JSON.stringify(lotIdList));
  uploadModal.setAttribute('data-current-lot-id', allCombinedLotIds.join(', '));
  uploadModal.setAttribute('data-current-model', currentModelNumber);
  uploadModal.setAttribute('data-current-quantity', newTotalQuantity);
  uploadModal.setAttribute('data-tray-capacity', currentTrayCapacity);
  uploadModal.setAttribute('data-jig-aware-sources', JSON.stringify(allJigAwareSourcesArray)); // ðŸ”§ CRITICAL: For backend
  
  if (existingJigLotId) {
    uploadModal.setAttribute('data-jig-lot-id', existingJigLotId);
  }

  console.log('âœ… FIXED: Modal attributes set with preserved mappings:', {
    'unique-lot-ids': allCombinedLotIds.length,
    'jig-aware-sources': allJigAwareSourcesArray.length,
    'actual-source-count': actualSourceCount
  });

  // ðŸ”§ FIXED: Update header with SIMPLIFIED format (no detailed source information)
  const headerElement = uploadModal.querySelector('h5');
  if (headerElement) {
    if (actualSourceCount > 1) {
      // âœ… SIMPLIFIED: Only show source count, not the detailed source list
      headerElement.textContent = `${currentModelNumber} - Combined Models (${actualSourceCount} sources)`;
    } else {
      headerElement.textContent = `${currentModelNumber} - Single Model`;
    }
    
    console.log('ðŸŽ¯ SIMPLIFIED HEADER SET TO:', headerElement.textContent);
  }

  // Update previouslyCombinedRows for future auto-checks
  previouslyCombinedRows = new Set(allJigAwareSourcesArray);

  // Update input values
  const qtyInput = uploadModal.querySelector('#jigQrId');
  if (qtyInput) {
    qtyInput.value = newTotalQuantity;
    qtyInput.setAttribute('data-original-qty', newTotalQuantity);
  }

  const trayTypeInput = uploadModal.querySelector('#trayTypeCapacity');
  if (trayTypeInput) {
    trayTypeInput.value = `${currentTrayType} - ${currentTrayCapacity}`;
  }

  // Set Jig ID field for combined models - collect actual JIG QR IDs from table rows
  const jigIdInput = uploadModal.querySelector('#jigId');
  if (jigIdInput) {
    // For combined models, collect actual JIG QR IDs from the table rows
    const uniqueJigQrIds = new Set();
    
    // Extract jig_lot_ids from allJigAwareSourcesArray to find corresponding rows
    allJigAwareSourcesArray.forEach(source => {
      if (source.includes(':')) {
        const jigLotId = source.split(':')[0];
        // Find the table row with this jig_lot_id and get its jig_qr_id
        const tableRow = document.querySelector(`tr[data-jig-lot-id="${jigLotId}"]`);
        if (tableRow) {
          const jigQrId = tableRow.getAttribute('data-jig-qr-id');
          if (jigQrId) {
            uniqueJigQrIds.add(jigQrId);
          }
        }
      }
    });
    
    const jigQrIdsArray = Array.from(uniqueJigQrIds);
    const jigIdsDisplay = jigQrIdsArray.length > 3 
      ? `${jigQrIdsArray.slice(0, 3).join(', ')} +${jigQrIdsArray.length - 3} more`
      : jigQrIdsArray.join(', ');
    jigIdInput.value = jigIdsDisplay || 'Multiple Jigs';
  }

  // Call enhanced populateTrayTable
  populateTrayTableEnhanced(newTotalQuantity, currentTrayCapacity, lotIdList, currentLotId, allCombinedLotIds);

  // Show modal
  uploadModal.style.display = 'flex';

  // ðŸ”§ FIXED: Success notification with simplified display
  setTimeout(() => {
    Swal.fire({
      icon: 'success',
      title: 'Models Combined!',
      html: `<strong>Total:</strong> ${newTotalQuantity} pieces from ${actualSourceCount} sources<br>
             <strong>Unique Lot IDs:</strong> ${allCombinedLotIds.length}<br>
             <small style="color: #666; font-size: 11px;">
               Jig mappings preserved for backend processing
             </small>`,
      timer: 3000,
      showConfirmButton: false,
      toast: true,
      position: 'top-end'
    });
  }, 100);
}

// ðŸ”§ ALSO UPDATE: The populateUploadChildModal function to use simplified header
function populateUploadChildModalFixed(modelNumber, lotId, quantity, trayType, trayCapacity) {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  // Get jig_qr_id and jig_lot_id from the triggering row
  const triggerButton = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]');
  let jigLotId = '';
  let jigQrId = '';
  
  if (triggerButton) {
    const row = triggerButton.closest('tr');
    jigLotId = row ? row.getAttribute('data-jig-lot-id') : '';
    jigQrId = row ? row.getAttribute('data-jig-qr-id') : '';
    console.log('ðŸŽ¯ Retrieved jig_lot_id from triggering row:', jigLotId);
    console.log('ðŸŽ¯ Retrieved jig_qr_id from triggering row:', jigQrId);
  }

  console.log('ðŸ“‹ Setting up modal with simplified header:');
  console.log('  Model Number:', modelNumber);
  console.log('  Lot ID:', lotId);
  console.log('  Jig Lot ID:', jigLotId);
  console.log('  Jig QR ID:', jigQrId);
  console.log('  Quantity:', quantity);

  // ðŸ”§ FIXED: Update header with SIMPLIFIED format
  const headerElement = uploadModal.querySelector('h5');
  if (headerElement) {
    // âœ… ALWAYS USE SIMPLIFIED FORMAT - no detailed source information in display
    headerElement.textContent = `${modelNumber} - Single Model`;
    
    // Store lotId in a hidden span for scripts (keep lot_id as hidden data)
    let hiddenLotId = uploadModal.querySelector('.hidden-lot-id');
    if (!hiddenLotId) {
      hiddenLotId = document.createElement('span');
      hiddenLotId.className = 'hidden-lot-id';
      hiddenLotId.style.display = 'none';
      headerElement.parentNode.insertBefore(hiddenLotId, headerElement.nextSibling);
    }
    hiddenLotId.textContent = lotId; // Store as hidden value
    
    console.log('ðŸŽ¯ SIMPLIFIED HEADER SET TO:', headerElement.textContent);
    console.log('ðŸ”’ Hidden Lot ID stored:', lotId);
  }

  // Set all required attributes (lot_id kept as hidden data)
  uploadModal.setAttribute('data-current-lot-id', lotId);
  uploadModal.setAttribute('data-current-model', modelNumber);
  uploadModal.setAttribute('data-current-quantity', quantity);
  uploadModal.setAttribute('data-tray-capacity', trayCapacity);
  uploadModal.setAttribute('data-jig-lot-id', jigLotId);
  
  // ðŸ”§ NEW: Store detailed source information as hidden data
  uploadModal.setAttribute('data-detailed-sources', JSON.stringify([`${jigLotId}:${lotId}`]));

  console.log('âœ… Modal attributes set with hidden lot_id data:', {
    'data-current-lot-id': lotId,
    'data-current-model': modelNumber,
    'data-current-quantity': quantity,
    'data-tray-capacity': trayCapacity,
    'data-jig-lot-id': jigLotId
  });

  const qtyInput = uploadModal.querySelector('#jigQrId');
  if (qtyInput) {
    qtyInput.value = quantity;
    qtyInput.setAttribute('data-original-qty', quantity);
  }

  const trayTypeInput = uploadModal.querySelector('#trayTypeCapacity');
  if (trayTypeInput) {
    trayTypeInput.value = `${trayType} - ${trayCapacity}`;
  }

  // Set Jig ID field using actual JIG QR ID
  const jigIdInput = uploadModal.querySelector('#jigId');
  if (jigIdInput) {
    jigIdInput.value = jigQrId || 'Not Available';
  }

  populateTrayTable(quantity, trayCapacity, [], lotId);
  uploadModal.style.display = 'flex';
}

// âœ… UPDATED: populateTrayTableEnhanced function with optimal quantity distribution
function populateTrayTableEnhanced(quantity, trayCapacity, lotIdList = [], mainLotId = '', allCombinedLotIds = []) {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  console.log('ðŸ”§ FIXED OPTIMAL TRAY DISTRIBUTION:');
  console.log('   Total Quantity:', quantity);
  console.log('   Tray Capacity:', trayCapacity);
  console.log('   LotIdList:', lotIdList);
  console.log('   All Combined Lot IDs:', allCombinedLotIds);
  console.log('   Main Lot ID:', mainLotId);

  // âœ… FIXED DISTRIBUTION: Calculate best tray distribution
  const fullTrays = Math.floor(quantity / trayCapacity);
  const remainingQty = quantity % trayCapacity;
  const totalTrays = remainingQty > 0 ? fullTrays + 1 : fullTrays;

  console.log('   ðŸ“Š FIXED OPTIMAL CALCULATION:');
  console.log(`     Full trays (${trayCapacity} each):`, fullTrays);
  console.log(`     Remaining quantity:`, remainingQty);
  console.log(`     Total trays needed:`, totalTrays);

  // âœ… FIXED: ALWAYS MAKE FIRST TRAY THE TOP TRAY (EDITABLE) - ENHANCED VERSION
  const optimalTrays = [];
  
  // ALWAYS create first tray as Top Tray (editable)
  if (remainingQty > 0) {
    // Case 1: There's a remainder - put remainder in first tray (Top Tray)
    optimalTrays.push({
      trayNumber: 1,
      quantity: remainingQty,
      isTopTray: true // First tray is always Top Tray
    });
    
    // Add remaining full trays (non-editable)
    for (let i = 0; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: optimalTrays.length + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }
  } else {
    // Case 2: No remainder - first tray is still Top Tray with full capacity
    optimalTrays.push({
      trayNumber: 1,
      quantity: trayCapacity,
      isTopTray: true // First tray is always Top Tray
    });
    
    // Add remaining full trays (non-editable)
    for (let i = 1; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: i + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }
  }

  // âœ… ENHANCED LOT_ID DISTRIBUTION across optimal trays
  let currentLotIdIndex = 0;
  
  optimalTrays.forEach((tray, trayIndex) => {
    // For simplicity, we'll cycle through the lotIdList
    if (currentLotIdIndex < lotIdList.length) {
      tray.lotId = lotIdList[currentLotIdIndex];
      // Advance by the tray quantity to get variety across trays
      currentLotIdIndex = (currentLotIdIndex + tray.quantity) % lotIdList.length;
    } else if (allCombinedLotIds.length > 0) {
      // Fallback to combined lot IDs
      tray.lotId = allCombinedLotIds[trayIndex % allCombinedLotIds.length];
    } else {
      // Final fallback to main lot ID
      tray.lotId = mainLotId;
    }
  });

  console.log('   ðŸŽ¯ FIXED OPTIMAL TRAYS CREATED:');
  optimalTrays.forEach(tray => {
    console.log(`     Tray ${tray.trayNumber}: ${tray.quantity} pieces (${tray.lotId})${tray.isTopTray ? ' [TOP TRAY - EDITABLE]' : ''}`);
  });

  // âœ… Render the optimal trays in the table
  optimalTrays.forEach((tray, index) => {
    const row = document.createElement('tr');
    row.setAttribute('data-lot-id', tray.lotId);

    row.innerHTML = `
      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
        ${tray.trayNumber}${tray.isTopTray ? ' (Top Tray)' : ''}
      </td>
      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
        <input type="text" placeholder="Scan New Tray" 
               data-lot-id="${tray.lotId}"
               style="width:100%; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px;" />
      </td>
      
      <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">
        ${tray.isTopTray
          ? `<input type="number" value="${tray.quantity}" min="1" max="${tray.quantity}" 
                     style="width:60px; text-align:center; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px;"
                     oninput="validateTrayQuantity(this, ${tray.quantity})" 
                     onchange="validateTrayQuantity(this, ${tray.quantity})"
                     onkeydown="if(event.key==='ArrowUp'){event.preventDefault();}" />
             <img src="/static/assets/icons/edit1.png" alt="Edit" title="Edit" 
                  class="tray-edit-btn-zone2" data-action="edit"
                  style="width:16px; height:16px; margin-left:6px; vertical-align:middle; cursor:pointer;" />`
          : `<span style="font-weight:500; color:#333;">${tray.quantity}</span>`
        }
      </td>
    `;

    tableBody.appendChild(row);
  });
  
  console.log('ðŸ”§ FINAL FIXED OPTIMAL VERIFICATION:');
  const finalQuantities = [];
  let totalVerification = 0;
  document.querySelectorAll('.jig-loading-table tbody tr').forEach((row, idx) => {
    const lotId = row.getAttribute('data-lot-id');
    const qty = parseInt(row.querySelector('input[type="number"], span')?.value || row.querySelector('span')?.textContent || 0);
    finalQuantities.push(qty);
    totalVerification += qty;
    console.log(`   Row ${idx + 1}: lot_id="${lotId}", qty="${qty}"${row.querySelector('input[type="number"]') ? ' [EDITABLE]' : ''}`);
  });
  console.log('   ðŸ“Š Final fixed optimal sequence:', finalQuantities.join(', '));
  console.log('   âœ… Total verification:', totalVerification, '(expected:', quantity, ')');
  console.log('   âœ… Matches expected total?', totalVerification === quantity);
  console.log('   âœ… Has editable top tray?', document.querySelector('.jig-loading-table input[type="number"]') ? 'YES' : 'NO');
}



function attachTrayQuantityValidationHandlers() {
  const trayRows = document.querySelectorAll('.jig-loading-table tbody tr');
  trayRows.forEach(row => {
    const trayIdInput = row.querySelector('input[type="text"]');
    const trayQtyInput = row.querySelector('input[type="number"]');
    if (trayIdInput) {
      trayIdInput.addEventListener('input', function () {
        const trayId = trayIdInput.value.trim();
        if (!trayId) {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdRequiredError(trayIdInput);
          return;
        }

        // âœ… FIX: Get lot_id from modal or row
        const uploadModal = document.getElementById('uploadChildModal');
        const lot_id = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
        
        console.log('[Tray Validation] Calling /JigUnloading_Zone2/JU_Zone_validate_tray_id/ for:', trayId, 'with lot_id:', lot_id);

        fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            tray_id: trayId,
            lot_id: lot_id  // âœ… FIX: Include lot_id
          })
        })
        .then(res => res.json())
        .then(data => {
          removeTrayIdError(trayIdInput);
          if (data.success) {
            trayIdInput.style.borderColor = '#28a745';
            trayIdInput.style.backgroundColor = '#f5fff5';
            showTrayValidationMessage(trayIdInput, "Available", true);
          } else {
            trayIdInput.style.borderColor = '#dc3545';
            trayIdInput.style.backgroundColor = '#fff5f5';
            showTrayValidationMessage(trayIdInput, data.error || 'Tray ID is invalid', false);
          }
        })
        .catch(() => {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdValidationError(trayIdInput, 'Network error during validation');
        });
      });
    }
    
    // Existing quantity validation with same fix
    if (trayQtyInput && trayIdInput) {
      trayQtyInput.addEventListener('change', function () {
        const trayId = trayIdInput.value.trim();
        if (!trayId) {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdRequiredError(trayIdInput);
          return;
        }

        // âœ… FIX: Get lot_id from modal or row
        const uploadModal = document.getElementById('uploadChildModal');
        const lot_id = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
        
        console.log('[Tray Validation] Calling /JigUnloading_Zone2/JU_Zone_validate_tray_id/ for:', trayId, 'with lot_id:', lot_id);

        fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({ 
            tray_id: trayId,
            lot_id: lot_id  // âœ… FIX: Include lot_id
          })
        })
        .then(res => res.json())
        .then(data => {
          removeTrayIdError(trayIdInput);
          if (data.success) {
            trayIdInput.style.borderColor = '#28a745';
            trayIdInput.style.backgroundColor = '#f5fff5';
            showTrayValidationMessage(trayIdInput, "Available", true);
          } else {
            trayIdInput.style.borderColor = '#dc3545';
            trayIdInput.style.backgroundColor = '#fff5f5';
            showTrayValidationMessage(trayIdInput, data.error || 'Tray ID is invalid', false);
          }
        })
        .catch(() => {
          trayIdInput.style.borderColor = '#dc3545';
          trayIdInput.style.backgroundColor = '#fff5f5';
          showTrayIdValidationError(trayIdInput, 'Network error during validation');
        });
      });
    }
  });
}

function showTrayValidationMessage(input, message, isSuccess) {
  removeTrayIdError(input);
  const msg = document.createElement('div');
  msg.className = 'tray-validation-msg';
  msg.style.cssText = `
    margin-top: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    color: ${isSuccess ? '#28a745' : '#856404'};
    background: ${isSuccess ? '#e8f5e9' : '#fff3cd'};
    border: 1px solid ${isSuccess ? '#c3e6cb' : '#ffeeba'};
    border-radius: 6px;
    padding: 6px 14px;
    min-width: 180px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    position: absolute;
    left: 0;
    top: 38px;
    z-index: 1001;
  `;
  msg.innerHTML = isSuccess
    ? `<span style="font-size:18px;">&#x2714;</span> <span>${message}</span>`
    : `<span style="font-size:18px;">&#9888;</span> <span>${message}</span>`;
  const inputCell = input.closest('td');
  if (inputCell) {
    inputCell.style.position = 'relative';
    inputCell.appendChild(msg);
    setTimeout(() => {
      if (msg.parentNode) msg.remove();
      input.style.borderColor = '#ccc';
      input.style.backgroundColor = '#fff';
    }, 5000);
  }
}
// Helper to show required error
function showTrayIdRequiredError(input) {
  removeTrayIdError(input);
  const errorElement = document.createElement('div');
  errorElement.className = 'tray-validation-error';
  errorElement.style.cssText = `
    color: #dc3545; font-size: 12px; margin-top: 4px; 
    padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
    border-radius: 4px; position: absolute; z-index: 1000; 
    min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  `;
  errorElement.textContent = 'Tray ID is required';
  const inputCell = input.closest('td');
  if (inputCell) {
    inputCell.style.position = 'relative';
    inputCell.appendChild(errorElement);
    setTimeout(() => {
      if (errorElement.parentNode) {
        errorElement.remove();
        input.style.borderColor = '#ccc';
        input.style.backgroundColor = '#fff';
      }
    }, 5000);
  }
}

// Helper to show validation error
function showTrayIdValidationError(input, message) {
  removeTrayIdError(input);
  const errorElement = document.createElement('div');
  errorElement.className = 'tray-validation-error';
  errorElement.style.cssText = `
    color: #dc3545; font-size: 12px; margin-top: 4px; 
    padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
    border-radius: 4px; position: absolute; z-index: 1000; 
    min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  `;
  errorElement.textContent = message;
  const inputCell = input.closest('td');
  if (inputCell) {
    inputCell.style.position = 'relative';
    inputCell.appendChild(errorElement);
    setTimeout(() => {
      if (errorElement.parentNode) {
        errorElement.remove();
        input.style.borderColor = '#ccc';
        input.style.backgroundColor = '#fff';
      }
    }, 5000);
  }
}

// Helper to remove previous error
function removeTrayIdError(input) {
  const inputCell = input.closest('td');
  if (inputCell) {
    const error = inputCell.querySelector('.tray-validation-error');
    if (error) error.remove();
  }
}

// Call this after rendering the tray table
attachTrayQuantityValidationHandlers();
// âœ… UPDATED: populateTrayTable function with optimal quantity distribution
// EXPECTED BEHAVIOR: With total qty 80 and tray capacity 12
// CALCULATION: 80 Ã· 12 = 6 full trays (72) + 1 partial tray (8)
// OUTPUT: 1(Top Tray)-8, 2-12, 3-12, 4-12, 5-12, 6-12, 7-12

window.populateTrayTable = function(quantity, trayCapacity, lotIdList = [], mainLotId = '') {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) return;

  const tableBody = uploadModal.querySelector('.jig-loading-table tbody');
  if (!tableBody) return;

  tableBody.innerHTML = '';

  console.log('ðŸ”§ FIXED OPTIMAL TRAY DISTRIBUTION (REGULAR):');
  console.log('   Total Quantity:', quantity);
  console.log('   Tray Capacity:', trayCapacity);
  console.log('   LotIdList:', lotIdList);
  console.log('   Main Lot ID:', mainLotId);

  // If no lotIdList provided, fill with mainLotId
  if (!lotIdList || lotIdList.length === 0) {
    lotIdList = Array(quantity).fill(mainLotId);
  }

  // Ensure lotIdList has exactly 'quantity' elements
  while (lotIdList.length < quantity) {
    lotIdList.push(mainLotId);
  }
  if (lotIdList.length > quantity) {
    lotIdList = lotIdList.slice(0, quantity);
  }

  // âœ… FIXED DISTRIBUTION: Calculate best tray distribution
  const fullTrays = Math.floor(quantity / trayCapacity);
  const remainingQty = quantity % trayCapacity;
  const totalTrays = remainingQty > 0 ? fullTrays + 1 : fullTrays;

  console.log('   ðŸ“Š FIXED OPTIMAL CALCULATION:');
  console.log(`     Full trays (${trayCapacity} each):`, fullTrays);
  console.log(`     Remaining quantity:`, remainingQty);
  console.log(`     Total trays needed:`, totalTrays);

  // âœ… FIXED: ALWAYS MAKE FIRST TRAY THE TOP TRAY (EDITABLE)
  const optimalTrays = [];
  
  // ALWAYS create first tray as Top Tray (editable)
  if (remainingQty > 0) {
    // Case 1: There's a remainder - put remainder in first tray (Top Tray)
    optimalTrays.push({
      trayNumber: 1,
      quantity: remainingQty,
      isTopTray: true // First tray is always Top Tray
    });
    
    // Add remaining full trays (non-editable)
    for (let i = 0; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: optimalTrays.length + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }
  } else {
    // Case 2: No remainder - first tray is still Top Tray with full capacity
    optimalTrays.push({
      trayNumber: 1,
      quantity: trayCapacity,
      isTopTray: true // First tray is always Top Tray
    });
    
    // Add remaining full trays (non-editable)
    for (let i = 1; i < fullTrays; i++) {
      optimalTrays.push({
        trayNumber: i + 1,
        quantity: trayCapacity,
        isTopTray: false
      });
    }
  }

  // âœ… DISTRIBUTE LOT_IDS ACROSS OPTIMAL TRAYS
  let lotIdIndex = 0;
  optimalTrays.forEach(tray => {
    // Assign lot_id to this tray (cycling through available lot_ids)
    if (lotIdIndex < lotIdList.length) {
      tray.lotId = lotIdList[lotIdIndex];
      // Move index forward by tray quantity to get next lot_id
      lotIdIndex += tray.quantity;
      if (lotIdIndex >= lotIdList.length) {
        // If we exceed the list, use the last lot_id or main lot_id
        tray.lotId = lotIdList[lotIdList.length - 1] || mainLotId;
      }
    } else {
      tray.lotId = mainLotId;
    }
  });

  console.log('   ðŸŽ¯ FIXED OPTIMAL TRAYS CREATED:');
  optimalTrays.forEach(tray => {
    console.log(`     Tray ${tray.trayNumber}: ${tray.quantity} pieces (${tray.lotId})${tray.isTopTray ? ' [TOP TRAY - EDITABLE]' : ''}`);
  });

  // âœ… Render the optimal trays in the table
  optimalTrays.forEach((tray, index) => {
    const row = document.createElement('tr');
    row.setAttribute('data-lot-id', tray.lotId);

    row.innerHTML = `
      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
        ${tray.trayNumber}${tray.isTopTray ? ' (Top Tray)' : ''}
      </td>
      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">
        <input type="text" placeholder="Scan New Tray" 
               data-lot-id="${tray.lotId}"
               style="width:100%; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px;" />
      </td>
            <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">
        ${tray.isTopTray
          ? `<input type="number" value="${tray.quantity}" min="1" max="${tray.quantity}" 
                     data-original-qty="${tray.quantity}"
                     style="width:60px; text-align:center; border:1px solid #ccc; padding:4px; border-radius:4px; font-size:13px; background-color:#f9f9f9;"
                     oninput="validateTrayQtyInputZone2(this, ${tray.quantity})" 
                     onchange="validateTrayQtyInputZone2(this, ${tray.quantity})"
                     onkeydown="if(event.key==='ArrowUp'){event.preventDefault();}"
                     disabled />
             <img src="/static/assets/icons/edit1.png" alt="Edit" title="Edit" 
                  style="width:16px; height:16px; margin-left:6px; vertical-align:middle; cursor:pointer;" 
                  class="tray-edit-btn-zone2" data-action="edit" />`
          : `<span style="font-weight:500; color:#333;">${tray.quantity}</span>`
        }
      </td>
    `;

    tableBody.appendChild(row);
  });
  
  console.log('ðŸ”§ FINAL FIXED OPTIMAL VERIFICATION:');
  const finalQuantities = [];
  let totalVerification = 0;
  document.querySelectorAll('.jig-loading-table tbody tr').forEach((row, idx) => {
    const lotId = row.getAttribute('data-lot-id');
    const qty = parseInt(row.querySelector('input[type="number"], span')?.value || row.querySelector('span')?.textContent || 0);
    finalQuantities.push(qty);
    totalVerification += qty;
    console.log(`   Row ${idx + 1}: lot_id="${lotId}", qty="${qty}"${row.querySelector('input[type="number"]') ? ' [EDITABLE]' : ''}`);
  });
  console.log('   ðŸ“Š Final fixed optimal sequence:', finalQuantities.join(', '));
  console.log('   âœ… Total verification:', totalVerification, '(expected:', quantity, ')');
  console.log('   âœ… Matches expected total?', totalVerification === quantity);
  console.log('   âœ… Has editable top tray?', document.querySelector('.jig-loading-table input[type="number"]') ? 'YES' : 'NO');
}

// âœ… ENHANCED: Also update the validation function to handle the new structure
window.validateTrayQuantity = function(input, trayCapacity) {
  const value = parseInt(input.value);

  if (value > trayCapacity) {
    input.value = trayCapacity;
    Swal.fire({
      icon: 'warning',
      title: 'Quantity Limit Exceeded',
      text: `Maximum quantity per tray is ${trayCapacity}. Value reset to ${trayCapacity}.`,
      timer: 2500,
      showConfirmButton: false
    });
  } else if (value < 1) {
    input.value = 1;
    Swal.fire({
      icon: 'warning',
      title: 'Invalid Quantity',
      text: 'Minimum quantity per tray is 1.',
      timer: 2000,
      showConfirmButton: false
    });
  }

  if (value >= 1 && value <= trayCapacity) {
    input.style.borderColor = '#28a745';
    setTimeout(() => {
      input.style.borderColor = '#ccc';
    }, 1000);
  } else {
    input.style.borderColor = '#dc3545';
  }
  
  // If this input is the editable top tray, recompute the remaining tray quantities
  // so that the total of all trays equals the original total quantity saved on modal.
  try {
    const row = input.closest('tr');
    const tbody = row ? row.closest('tbody') : null;
    const uploadModal = document.getElementById('uploadChildModal');
    if (uploadModal && tbody && row && row.querySelector('input[type="number"]')) {
      const originalTotal = parseInt(uploadModal.getAttribute('data-original-quantity') || '0');
      const trayCap = parseInt(uploadModal.getAttribute('data-tray-capacity') || trayCapacity);
      if (originalTotal > 0 && !isNaN(trayCap)) {
        // Get all rows and compute new distribution
        const rows = Array.from(tbody.querySelectorAll('tr'));
        // First row is top tray (editable)
        const topQty = parseInt(rows[0].querySelector('input[type="number"]').value) || 0;
        const remaining = Math.max(0, originalTotal - topQty);

        // Refill subsequent trays with trayCap each, last tray may be partial
        for (let i = 1; i < rows.length; i++) {
          const spanOrInput = rows[i].querySelector('input[type="number"]') || rows[i].querySelector('span');
          if (!spanOrInput) continue;
          const setQty = Math.min(trayCap, remaining - trayCap * (i - 1) > 0 ? Math.min(trayCap, remaining - trayCap * (i - 1)) : 0);
          if (spanOrInput.tagName.toLowerCase() === 'input') {
            spanOrInput.value = setQty;
          } else {
            spanOrInput.textContent = setQty;
          }
        }
      }
    }
  } catch (e) {
    console.error('Error recomputing tray quantities:', e);
  }
};

// Helper function for CSRF token
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// HELPER FUNCTIONS FOR COUNTERS AND SUMMARIES
  function updateSelectedCount() {
    const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
    const totalCompatible = document.querySelectorAll('.compatible-row').length;
    updateCompatibleRowsCounter(selectedCount, totalCompatible);
  }
  
  function updateCompatibleRowsCounter(selectedCount, totalCompatible) {
    const isAddModelMode = document.body.classList.contains('add-model-mode');
    if (!isAddModelMode) return;
    
    let counter = document.getElementById('compatibleRowsCounter');
    if (!counter) {
      counter = document.createElement('div');
      counter.id = 'compatibleRowsCounter';
      document.body.appendChild(counter);
    }
    
    counter.innerHTML = `
      <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
        <div style="font-size: 14px;">ðŸ“Š Compatible Rows</div>
        <div style="font-size: 12px;">Selected: ${selectedCount} / ${totalCompatible}</div>
      </div>
    `;
    
    counter.style.cssText = `
      position: fixed; top: 130px; right: 20px; z-index: 9999;
      background: ${selectedCount > 0 ? '#28a745' : '#6c757d'};
      color: white; padding: 8px 12px; border-radius: 15px;
      font-size: 12px; font-weight: 600;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    `;
  }
  
  function showCompatibleRowsSummary(modelNumber, compatibleCount) {
    let summary = document.getElementById('compatibleSummary');
    if (!summary) {
      summary = document.createElement('div');
      summary.id = 'compatibleSummary';
      summary.style.cssText = `
        position: fixed; top: 180px; right: 20px; z-index: 9998;
        background: #17a2b8; color: white; padding: 10px 15px;
        border-radius: 10px; font-size: 13px; font-weight: 500;
        box-shadow: 0 2px 8px rgba(23, 162, 184, 0.3);
        max-width: 200px; text-align: center;
      `;
      document.body.appendChild(summary);
    }
    
    summary.innerHTML = `
      <div style="margin-bottom: 5px;">ðŸŽ¯ <strong>Model: ${modelNumber}</strong></div>
      <div style="font-size: 11px; opacity: 0.9;">
        ${compatibleCount > 0 ? `${compatibleCount} compatible rows found` : 'No compatible rows found'}
      </div>
    `;
    
    setTimeout(() => {
      if (summary && summary.parentNode) summary.remove();
    }, 5000);
  }

  // 1. Create the Upload Child Modal if not already present
  if (!document.getElementById('uploadChildModal')) {
    const uploadModal = document.createElement('div');
    uploadModal.id = 'uploadChildModal';
    uploadModal.style = `
      display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 30000;
      background: rgba(0, 0, 0, 0.18); align-items: center; justify-content: center;
    `;
    uploadModal.innerHTML = `
      <div style="
        background: #fff; border-radius: 12px; max-width: 1200px; width: 90vw; height: 94vh; padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.18); position: relative; display: flex; flex-direction: column;
        overflow: hidden;
      ">
        <span id="uploadChildModalClose" style="position: absolute; top: 10px; right: 16px; font-size: 22px; cursor: pointer; color: #888; z-index: 10;">&times;</span>
                
        <h5 style="margin: 0 0 12px 0; text-align: center; font-weight: 700;">JD001/1805SAMG</h5>
        
        <!-- Main Content Container with Image Section -->
        <div style="display: flex; gap: 20px; flex: 1; overflow: hidden;">
          <!-- Left: Form Content -->
          <div style="flex: 1; min-width: 500px; display: flex; flex-direction: column; overflow: hidden;">
        
        <!-- Jig Loading Responsive Form START -->
        <div class="tray-scan-modal-content" style="display:flex; flex-direction:column; height:100%; overflow:hidden;">
          <div class="tray-scan-modal-body" style="flex:1; overflow:hidden; display:flex; flex-direction:column;">
            <div class="jig-loading-form" style="height:100%; display:flex; flex-direction:column;">
              <form style="flex-shrink:0;">
                <!-- Professional Color Verification Section -->
                <div class="color-verification-section" style="background:#f8f9fa; border:1.5px solid #e9ecef; border-radius:8px; padding:12px 16px; margin-bottom:16px;">
                  <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
                    <div id="colorStatusBadge" style="padding:4px 8px; border-radius:4px; font-size:11px; font-weight:600; text-transform:uppercase; background:#6c757d; color:white;">Loading...</div>
                  </div>
                  <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap;">
                    <div style="display:flex; align-items:center; gap:6px;">
                      <span id="platingColorIndicator" style="display:inline-block; width:16px; height:16px; border-radius:50%; background:#6c757d; border:2px solid #fff; box-shadow:0 2px 4px rgba(0,0,0,0.1);"></span>
                      <span id="platingColorText" style="font-size:13px; font-weight:500; color:#495057;">Unknown Color</span>
                    </div>
                    <div style="display:flex; align-items:center; gap:4px; font-size:12px; color:#6c757d;">
                      <span>â†’</span>
                      <span id="trayRouting" style="font-weight:500;">Zone Detection...</span>
                    </div>
                  </div>
                </div>
                <div class="jig-form-row" style="display: flex; flex-wrap: wrap; gap: 18px 18px;">
                  <!-- Lot Qty -->
                  <div class="jig-form-col" style="flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; justify-content:center;">
                    <label for="jigQrId" style="font-size:13px;font-weight:500; margin-bottom:4px;">Lot Qty</label>
                      <input
                        type="text"
                        id="jigQrId"
                        class="form-control jig-input-border"
                        placeholder="Enter Quantity"
                        readonly
                        style="width:100%;margin-top:0; border:1.5px solid #f1f1f1 !important; border-radius:6px; height:36px; font-size:15px; padding-left:12px; background:#f5f5f5;"
                      />
                  </div>
                  <!-- Missing Qty -->
                  <div class="jig-form-col" style="flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; justify-content:center;">
                    <label for="missingQty" style="font-size:13px;font-weight:500; margin-bottom:4px;">Missing Qty</label>
                      <input
                        type="text"
                        id="missingQty"
                        class="form-control jig-input-border"
                        placeholder="0"
                        readonly
                        value="0"
                        style="width:100%;margin-top:0; border:1.5px solid #ff6b6b !important; border-radius:6px; height:36px; font-size:15px; padding-left:12px; background:#fff5f5; color:#dc3545; font-weight:600;"
                      />
                  </div>
                  <!-- Jig ID -->
                  <div class="jig-form-col" style="flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; justify-content:center;">
                    <label for="jigId" style="font-size:13px;font-weight:500; margin-bottom:4px;">Jig ID</label>
                      <input
                        type="text"
                        id="jigId"
                        class="form-control jig-input-border"
                        placeholder="Jig ID"
                        readonly
                        style="width:100%;margin-top:0; border:1.5px solid #f1f1f1 !important; border-radius:6px; height:36px; font-size:15px; padding-left:12px; background:#f5f5f5; color:#333;"
                      />
                  </div>
                  <!-- Tray Cate - Capacity -->
                  <div class="jig-form-col" style="flex:1 1 220px; min-width:180px; display:flex; flex-direction:column; justify-content:center;">
                    <label for="trayTypeCapacity" style="font-size:13px;font-weight:500; margin-bottom:4px;">Tray Cate - Capacity</label>
                    <div style="display:flex;align-items:center;">
                      <span style="display:inline-block;width:18px;height:18px;border-radius:50%;background:#dc3545;vertical-align:middle;margin-right:8px;"></span>
                        <input
                          type="text"
                          id="trayTypeCapacity"
                          class="form-control jig-input-border"
                          placeholder="Normal - 20"
                          readonly
                          style="width:100%;margin-top:0; border:1.5px solid #f1f1f1 !important; border-radius:6px; height:36px; font-size:15px; padding-left:12px; background:#f5f5f5;"
                        />
                    </div>
                  </div>
                </div>
              </form>
              
              <div class="jig-loading-table-wrapper" style="margin-top:18px; overflow-x:auto; overflow-y:auto; max-height:40vh; border:1px solid #ddd; border-radius:6px; flex:1;">
                <table class="jig-loading-table" style="width:100%;border-collapse:collapse;font-size:13px; border:1px solid #bdbdbd;">
                  <thead>
                    <tr style="background:#f7f7f7;">
                      <th style="padding:8px 6px;border-bottom:1px solid #bdbdbd; border-right:1px solid #bdbdbd;">S.No</th>
                      <th style="padding:8px 6px;border-bottom:1px solid #bdbdbd; border-right:1px solid #bdbdbd;">Tray ID</th>
                      <th style="padding:8px 6px;border-bottom:1px solid #bdbdbd;">Tray Qty</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">1</td>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">Tray001</td>
                      <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">
                        10
                        <img
                          src="{% static 'assets/icons/edit1.png' %}"
                          alt="Edit"
                          title="Edit"
                          style="width:16px; height:16px; margin-left:6px; vertical-align:middle; cursor:pointer;"
                          onmouseover="this.style.filter='brightness(0.8)';"
                          onmouseout="this.style.filter='';"
                        />
                      </td>
                    </tr>
                    <tr>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">2</td>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd; border-bottom:1px solid #bdbdbd;">Tray002</td>
                      <td style="padding:6px 4px;text-align:center; border-bottom:1px solid #bdbdbd;">12</td>
                    </tr>
                    <tr>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd;">3</td>
                      <td style="padding:6px 4px;text-align:center; border-right:1px solid #bdbdbd;">Tray003</td>
                      <td style="padding:6px 4px;text-align:center;">8</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              
              <div class="tray-scan-modal-buttons" style="display:flex;justify-content:center;gap:10px;margin:16px 0 8px 0; flex-shrink:0;">
                <button type="button" id="addModelBtn" style="padding:8px 18px;background:#023E4DCC;color:#fff;border:none;border-radius:30px;">Add Model</button>
                <button type="button" id="uploadDraftBtn" style="padding:8px 18px;background:#007bff;color:#fff;border:none;border-radius:30px;">Draft</button>
                <button type="button" id="uploadSubmitBtn" style="padding:8px 18px;background:#28a745;color:#fff;border:none;border-radius:30px;">Submit</button>
                <button type="button" id="uploadCancelBtn" style="padding:8px 18px;background:#dc3545;color:#fff;border:none;border-radius:30px;">Cancel</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Jig Loading Responsive Form END -->
          </div>
          
          <!-- Right: Professional Model Image Section -->
          <div id="modelImageSection" style="
            width: 350px; min-width: 300px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
            border: 1px solid #dee2e6; position: relative; overflow: hidden;
          ">
            <!-- Image Header -->
            <div style="
              display: flex; align-items: center; justify-content: space-between;
              margin-bottom: 16px; padding-bottom: 12px;
              border-bottom: 2px solid #e9ecef;
            ">
              <h6 style="
                margin: 0; font-weight: 600; color: #495057;
                display: flex; align-items: center; gap: 8px;
              ">
                <span style="
                  width: 8px; height: 8px; background: #28a745;
                  border-radius: 50%; display: inline-block;
                  animation: pulse 2s infinite;
                "></span>
                Model Images
              </h6>
              <span id="imageCounter" style="
                font-size: 11px; color: #6c757d; font-weight: 500;
                background: #fff; padding: 4px 8px; border-radius: 12px;
                border: 1px solid #dee2e6;
              ">0 / 0</span>
            </div>
            
            <!-- Image Container with Loading State -->
            <div id="imageContainer" style="
              flex: 1; display: flex; align-items: center; justify-content: center;
              background: #fff; border-radius: 8px; border: 2px dashed #dee2e6;
              position: relative; overflow: hidden; min-height: 250px;
            ">
              <!-- Loading Skeleton -->
              <div id="imageLoading" style="
                display: flex; flex-direction: column; align-items: center;
                gap: 12px; color: #6c757d;
              ">
                <div style="
                  width: 60px; height: 60px; border: 3px solid #f3f3f3;
                  border-top: 3px solid #007bff; border-radius: 50%;
                  animation: spin 1s linear infinite;
                "></div>
                <span style="font-size: 14px; font-weight: 500;">Loading Model Images...</span>
              </div>
              
              <!-- No Image State -->
              <div id="noImageState" style="
                display: none; flex-direction: column; align-items: center;
                gap: 12px; color: #6c757d; text-align: center; padding: 20px;
              ">
                <div style="
                  width: 80px; height: 80px; background: #f8f9fa;
                  border-radius: 50%; display: flex; align-items: center;
                  justify-content: center; font-size: 32px; color: #adb5bd;
                ">ðŸ“·</div>
                <div>
                  <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px;">No Images Available</div>
                  <div style="font-size: 12px; opacity: 0.8;">No model images found for this item</div>
                </div>
              </div>
              
              <!-- Image Display -->
              <img id="modelImage" style="
                display: none; max-width: 100%; max-height: 100%;
                object-fit: contain; border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
              " />
            </div>
            
            <!-- Image Navigation Controls -->
            <div id="imageControls" style="
              display: none; margin-top: 16px;
              justify-content: space-between; align-items: center;
            ">
              <button id="prevImageBtn" style="
                background: #007bff; color: white; border: none;
                border-radius: 6px; padding: 8px 12px; cursor: pointer;
                font-size: 12px; font-weight: 500;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                Previous
              </button>
              
              <div style="
                display: flex; gap: 4px; align-items: center;
              " id="imageDots"></div>
              
              <button id="nextImageBtn" style="
                background: #007bff; color: white; border: none;
                border-radius: 6px; padding: 8px 12px; cursor: pointer;
                font-size: 12px; font-weight: 500;
                transition: all 0.2s ease;
              " onmouseover="this.style.background='#0056b3'" onmouseout="this.style.background='#007bff'">
                Next
              </button>
            </div>
            
            <!-- Model Information Panel -->
            <div id="modelInfoPanel" style="
              margin-top: 16px; padding: 12px; background: #fff;
              border-radius: 6px; border: 1px solid #e9ecef;
            ">
              <div style="
                font-size: 12px; color: #6c757d;
                margin-bottom: 6px; font-weight: 500;
              ">Model Information</div>
              <div id="modelInfoContent" style="
                font-size: 13px; color: #495057;
                line-height: 1.4;
              ">
                <div>Model: <span id="modelNumberDisplay">Loading...</span></div>
                <div>Lot ID: <span id="lotIdDisplay">Loading...</span></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(uploadModal);

    // Store original content for restoration
    const modalContent = uploadModal.querySelector('div');
    if (modalContent) {
        uploadModal.setAttribute('data-original-content', modalContent.innerHTML);
    }

    // Responsive styling
    const style = document.createElement('style');
    style.innerHTML = `
      /* Model Image Section Animations */
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      #modelImage {
        animation: fadeIn 0.5s ease-out;
      }
      
      #imageControls button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,123,255,0.3);
      }
      
      .image-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #dee2e6;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      
      .image-dot.active {
        background: #007bff;
        transform: scale(1.2);
      }
      
      .image-dot:hover {
        background: #0056b3;
        transform: scale(1.1);
      }
      
      @media (max-width: 600px) {
        #uploadChildModal > div {
          max-width: 98vw !important;
          width: 98vw !important;
          max-height: 95vh !important;
          margin: 10px 0 0 0 !important;
          border-radius: 0 !important;
          padding: 15px 10px !important;
          flex-direction: column !important;
        }
        
        #uploadChildModal .jig-loading-table-wrapper {
          max-height: 35vh !important;
        }
        
        #modelImageSection {
          width: 100% !important;
          min-width: auto !important;
          height: 300px !important;
          margin-top: 15px !important;
        }
        
        #imageContainer {
          min-height: 200px !important;
        }
      }
      
      @media (max-width: 1000px) {
        #uploadChildModal > div {
          flex-direction: column !important;
        }
        
        #modelImageSection {
          width: 100% !important;
          min-width: auto !important;
          height: 250px !important;
        }
      }
      
      /* Ensure table stays within bounds */
      .jig-loading-table-wrapper {
        scrollbar-width: thin;
        scrollbar-color: #ccc #f1f1f1;
      }
      
      .jig-loading-table-wrapper::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      
      .jig-loading-table-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 4px;
      }
      
      .jig-loading-table-wrapper::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
      }
      
      .jig-loading-table-wrapper::-webkit-scrollbar-thumb:hover {
        background: #999;
      }
    `;
    document.head.appendChild(style);
  }

// ðŸ–¼ï¸ PROFESSIONAL MODEL IMAGE DISPLAY FUNCTIONALITY
let currentImages = [];
let currentImageIndex = 0;

// Function to fetch and display model images - GLOBAL DECLARATION
window.fetchAndDisplayModelImages = function(lotId, modelNumber) {
  console.log('ðŸ–¼ï¸ [DEBUG] Starting fetchAndDisplayModelImages (Zone 2)');
  console.log('ðŸ“‹ [DEBUG] Input parameters:', { lotId, modelNumber });
  
  // Update model info immediately
  const modelNumberDisplay = document.getElementById('modelNumberDisplay');
  const lotIdDisplay = document.getElementById('lotIdDisplay');
  if (modelNumberDisplay) {
    modelNumberDisplay.textContent = modelNumber || 'N/A';
    console.log('ðŸ“‹ [DEBUG] Updated modelNumberDisplay to:', modelNumber);
  }
  if (lotIdDisplay) {
    lotIdDisplay.textContent = lotId || 'N/A';
    console.log('ðŸ“‹ [DEBUG] Updated lotIdDisplay to:', lotId);
  }
  
  // Show loading state
  console.log('â³ [DEBUG] Showing loading state');
  showImageLoadingState();
  
  if (!lotId) {
    console.warn('âŒ [DEBUG] No lot_id provided for image fetching');
    showNoImageState('No Lot ID provided');
    return;
  }
  
  // Construct API URL (Zone 2 uses different endpoint)
  const apiUrl = `/JigUnloading_Zone2/JU_Zone_get_model_images/?lot_id=${encodeURIComponent(lotId)}&model_number=${encodeURIComponent(modelNumber || '')}`;
  console.log('ðŸŒ [DEBUG] Making API call to:', apiUrl);
  
  // Fetch images from server
  fetch(apiUrl)
    .then(response => {
      console.log('ðŸ“¡ [DEBUG] Received response status:', response.status);
      console.log('ðŸ“¡ [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
      return response.json();
    })
    .then(data => {
      console.log('ðŸ“¸ [DEBUG] Complete API response:', JSON.stringify(data, null, 2));
      console.log('ðŸ“¸ [DEBUG] Response success:', data.success);
      console.log('ðŸ“¸ [DEBUG] Response image:', data.image);
      console.log('ðŸ“¸ [DEBUG] Response error:', data.error);
      
      if (data.success && data.image) {
        console.log('âœ… [DEBUG] Image found, setting up display');
        console.log('ðŸ“¸ [DEBUG] Image URL:', data.image);
        console.log('ðŸ“¸ [DEBUG] Total images available:', data.total_images || 1);
        console.log('ðŸ“¸ [DEBUG] Model number confirmed:', data.model_no);
        
        // Handle multiple images if available
        if (data.all_images && data.all_images.length > 0) {
          currentImages = data.all_images;
        } else {
          currentImages = [data.image];
        }
        currentImageIndex = 0;
        console.log('ðŸ“¸ [DEBUG] Current images array:', currentImages);
        displayImages();
      } else {
        const errorMsg = data.error || 'No images available';
        console.warn('âŒ [DEBUG] No images found. Error message:', errorMsg);
        console.warn('âŒ [DEBUG] Debug info:', data.debug_info);
        console.warn('âŒ [DEBUG] Full response for debugging:', data);
        
        // Show more specific error message if available
        let displayError = errorMsg;
        if (data.debug_info) {
          if (data.debug_info.model_found === false) {
            displayError = `Model ${data.debug_info.model_no_searched || modelNumber} not found in database`;
          } else if (data.debug_info.images_count === 0) {
            displayError = `Model ${data.debug_info.model_no} found but has no images`;
          } else if (!data.debug_info.jig_unload_found && !data.debug_info.model_number_provided) {
            displayError = `No data found for lot ID ${lotId}`;
          }
        }
        
        showNoImageState(displayError);
      }
    })
    .catch(error => {
      console.error('âŒ [DEBUG] Network or parsing error:', error);
      console.error('âŒ [DEBUG] Error details:', error.message);
      console.error('âŒ [DEBUG] Error stack:', error.stack);
      showNoImageState('Error loading images');
    });
};

// Function to show loading state - GLOBAL DECLARATION
window.showImageLoadingState = function() {
  const loading = document.getElementById('imageLoading');
  const noImage = document.getElementById('noImageState');
  const image = document.getElementById('modelImage');
  const controls = document.getElementById('imageControls');
  const counter = document.getElementById('imageCounter');
  
  if (loading) loading.style.display = 'flex';
  if (noImage) noImage.style.display = 'none';
  if (image) image.style.display = 'none';
  if (controls) controls.style.display = 'none';
  if (counter) counter.textContent = '0 / 0';
};

// Function to show no image state - GLOBAL DECLARATION
window.showNoImageState = function(message = 'No images available') {
  const loading = document.getElementById('imageLoading');
  const noImage = document.getElementById('noImageState');
  const image = document.getElementById('modelImage');
  const controls = document.getElementById('imageControls');
  const counter = document.getElementById('imageCounter');
  
  if (loading) loading.style.display = 'none';
  if (noImage) {
    noImage.style.display = 'flex';
    const messageEl = noImage.querySelector('div:last-child div:last-child');
    if (messageEl) messageEl.textContent = message;
  }
  if (image) image.style.display = 'none';
  if (controls) controls.style.display = 'none';
  if (counter) counter.textContent = '0 / 0';
  
  currentImages = [];
  currentImageIndex = 0;
};

// Function to display images - GLOBAL DECLARATION
window.displayImages = function() {
  if (!currentImages || currentImages.length === 0) {
    showNoImageState();
    return;
  }
  
  const loading = document.getElementById('imageLoading');
  const noImage = document.getElementById('noImageState');
  const image = document.getElementById('modelImage');
  const controls = document.getElementById('imageControls');
  const counter = document.getElementById('imageCounter');
  
  // Hide loading and no-image states
  if (loading) loading.style.display = 'none';
  if (noImage) noImage.style.display = 'none';
  
  // Show image
  if (image) {
    image.src = currentImages[currentImageIndex];
    image.style.display = 'block';
    
    // Handle image load error
    image.onerror = function() {
      console.warn('âŒ Failed to load image:', this.src);
      showNoImageState('Failed to load image');
    };
  }
  
  // Update counter
  if (counter) {
    counter.textContent = `${currentImageIndex + 1} / ${currentImages.length}`;
  }
  
  // Show/hide controls based on image count
  if (controls) {
    if (currentImages.length > 1) {
      controls.style.display = 'flex';
      setupImageNavigation();
    } else {
      controls.style.display = 'none';
    }
  }
};

// Function to setup image navigation - GLOBAL DECLARATION
window.setupImageNavigation = function() {
  const prevBtn = document.getElementById('prevImageBtn');
  const nextBtn = document.getElementById('nextImageBtn');
  const dotsContainer = document.getElementById('imageDots');
  
  // Setup prev/next buttons
  if (prevBtn) {
    prevBtn.onclick = () => {
      currentImageIndex = (currentImageIndex - 1 + currentImages.length) % currentImages.length;
      displayImages();
    };
  }
  
  if (nextBtn) {
    nextBtn.onclick = () => {
      currentImageIndex = (currentImageIndex + 1) % currentImages.length;
      displayImages();
    };
  }
  
  // Setup dots
  if (dotsContainer) {
    dotsContainer.innerHTML = '';
    currentImages.forEach((_, index) => {
      const dot = document.createElement('div');
      dot.className = `image-dot ${index === currentImageIndex ? 'active' : ''}`;
      dot.onclick = () => {
        currentImageIndex = index;
        displayImages();
      };
      dotsContainer.appendChild(dot);
    });
  }
};

// âœ… FIXED: restoreOriginalModalContent to reset all attributes
function restoreOriginalModalContent() {
  const uploadModal = document.getElementById('uploadChildModal');
  const modalContent = uploadModal.querySelector('div');
  const originalContent = uploadModal.getAttribute('data-original-content');
  
  if (modalContent && originalContent) {
    modalContent.innerHTML = originalContent;
    
    // âœ… RESET: Clear all custom attributes for fresh start
    uploadModal.removeAttribute('data-combined-lot-ids');
    uploadModal.removeAttribute('data-source-count');
    uploadModal.removeAttribute('data-existing-lot-id-list'); // âœ… NEW: Clear this too
    uploadModal.removeAttribute('data-current-lot-id');
    uploadModal.removeAttribute('data-current-model');
    uploadModal.removeAttribute('data-current-quantity');
    uploadModal.removeAttribute('data-tray-capacity');
    uploadModal.removeAttribute('data-jig-lot-id');  // âœ… NEW: Clear jig_lot_id attribute

    console.log('ðŸ”„ Modal content restored and all attributes reset');
    
    // Re-attach event listeners after restoration
    attachModalEventListeners();
  }
}

// 3. FIXED: Attach proper event listeners to modal buttons
function attachModalEventListeners() {
    console.log('ðŸ”§ ATTACH: Setting up modal event listeners');
    
    // Close button
    const closeBtn = document.getElementById('uploadChildModalClose');
    if (closeBtn) {
        closeBtn.onclick = function () {
            console.log('âŒ Modal closed');
            document.getElementById('uploadChildModal').style.display = 'none';
            window.location.reload(); // Refresh the page after closing modal

        };
    }

    // Cancel button
    const cancelBtn = document.getElementById('uploadCancelBtn');
    if (cancelBtn) {
        cancelBtn.onclick = function () {
            console.log('âŒ Modal cancelled');
            document.getElementById('uploadChildModal').style.display = 'none';
            window.location.reload(); // Refresh the page after closing modal
        };
    }

    // Add Model button
    const addModelBtn = document.getElementById('addModelBtn');
    if (addModelBtn) {
        addModelBtn.onclick = function () {
            console.log('âž• Add Model button clicked');
            const uploadModal = document.getElementById('uploadChildModal');
            
            const modelNumber = uploadModal.getAttribute('data-current-model');
            const lotId = uploadModal.getAttribute('data-current-lot-id');
            
            // Get current quantity from input field
            const qtyInput = uploadModal.querySelector('#jigQrId');
            const currentQuantityFromInput = qtyInput ? parseInt(qtyInput.value) || 0 : 0;
            
            const trayTypeCapacity = uploadModal.querySelector('#trayTypeCapacity').value;
            
            const trayMatch = trayTypeCapacity.match(/^(.+?)\s*-\s*(\d+)$/);
            const trayType = trayMatch ? trayMatch[1].trim() : 'Normal';
            const trayCapacity = trayMatch ? parseInt(trayMatch[2]) : 8;
            
            console.log('ðŸ”§ ADD MODEL: Starting with data:', {
                modelNumber, lotId, currentQuantityFromInput, trayType, trayCapacity
            });
            
            if (!modelNumber || !lotId) {
              Swal.fire({
                icon: 'error',
                title: 'Missing Information',
                text: 'Could not get model information from modal.',
                timer: 2000,
                showConfirmButton: false
              });
              return;
            }
            
            enterAddModelMode(modelNumber, lotId, currentQuantityFromInput, trayType, trayCapacity);
        };
    }

    // Draft button
    const draftBtn = document.getElementById("uploadDraftBtn");
    if (draftBtn) {
        draftBtn.onclick = function (e) {
            console.log('ðŸ“„ Draft button clicked');
            e.preventDefault();
      
            // Collect modal data
            const modal = document.getElementById("uploadChildModal");
            const main_lot_id = modal.getAttribute("data-current-lot-id") || "";
            const model_number = modal.getAttribute("data-current-model") || "";
            // Prefer modal attribute, otherwise read triggering row attributes to avoid hard-coded default
            let tray_type_capacity = modal.getAttribute("data-tray-capacity");
            if (!tray_type_capacity) {
              const triggerRow = document.querySelector('.unload-modal-trigger[data-last-triggered="true"]')?.closest('tr');
              if (triggerRow) {
                const dt = triggerRow.getAttribute('data-tray-type') || 'Normal';
                const dc = triggerRow.getAttribute('data-tray-capacity') || '20';
                tray_type_capacity = `${dt} - ${dc}`;
              } else {
                tray_type_capacity = 'Normal - 20';
              }
            }
            const total_quantity = parseInt(modal.querySelector("#jigQrId")?.value) || 0;
      
            // Collect tray data
            const trayRows = modal.querySelectorAll(".jig-loading-table tbody tr");
            const trays = [];
            trayRows.forEach((row, i) => {
              trays.push({
                tray_id: row.querySelector('input[type="text"]')?.value.trim() || "",
                tray_qty: parseInt(row.querySelector('input[type="number"]')?.value || row.querySelector('span')?.textContent || 0),
                lot_id: row.getAttribute("data-lot-id") || main_lot_id,
                is_top_tray: i === 0
              });
            });
      
            // Get combined_lot_ids if present
            let combined_lot_ids = [];
            if (modal.getAttribute("data-combined-lot-ids")) {
              try {
                combined_lot_ids = JSON.parse(modal.getAttribute("data-combined-lot-ids"));
              } catch {}
            }
      
            console.log('ðŸ“„ DRAFT: Saving draft with data:', {
                main_lot_id, model_number, total_quantity, trays: trays.length
            });
      
            // AJAX call to save draft
            fetch("/JigUnloading_Zone2/JU_Zone_save_jig_unload_draft/", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCookie("csrftoken")
              },
              body: JSON.stringify({
                main_lot_id,
                model_number,
                total_quantity,
                trays,
                tray_type_capacity,
                combined_lot_ids
              })
            })
            .then(res => res.json())
            .then(data => {
              if (data.success) {
                Swal.fire({
                  icon: "success",
                  title: "Draft Saved!",
                  text: `Draft ID: ${data.draft_id}`,
                  timer: 1500,
                  showConfirmButton: false
                });
              } else {
                Swal.fire("Error", data.error || "Failed to save draft.", "error");
              }
            })
            .catch(() => {
              Swal.fire("Error", "Network error.", "error");
            });
        };
    }
    
    // ðŸ”§ FIXED: Submit button with proper error handling
    const submitBtn = document.getElementById('uploadSubmitBtn');
    if (submitBtn) {
        // Remove any existing event listeners
        submitBtn.onclick = null;
        
        submitBtn.onclick = function (e) {
            console.log('âœ… SUBMIT: Submit button clicked');
            e.preventDefault();
            
            try {
                submitTrayDataWithValidation();
            } catch (error) {
                console.error('ðŸš¨ SUBMIT ERROR:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Submit Error',
                    text: 'An error occurred during submission. Please try again.',
                    showConfirmButton: true
                });
            }
        };
        
        console.log('âœ… ATTACH: Submit button event listener attached');
    } else {
        console.error('âŒ ATTACH: Submit button not found');
    }
    
    console.log('âœ… ATTACH: All modal event listeners attached');
}
  // Initial attachment of event listeners
  attachModalEventListeners();
  

// 2. Close Upload Modal handlers
  document.getElementById('uploadChildModal').addEventListener('click', function (e) {
    if (e.target === this) this.style.display = 'none';
  });

// Add change listener for checkboxes in add model mode - AUTO COMBINE VERSION
// ðŸ”§ FIXED: Add change listener for checkboxes in add model mode - JIG-AWARE VERSION
document.addEventListener('change', function(e) {
  if (e.target.classList.contains('row-checkbox') && document.body.classList.contains('add-model-mode')) {
    // ðŸ”§ NEW: Get jig context for this specific row
    const row = e.target.closest('tr');
    const rowJigLotId = row.getAttribute('data-jig-lot-id');
    const rowLotId = row.getAttribute('data-lot-id');
    
    console.log(`ðŸ“‹ Checkbox changed for: ${rowJigLotId}:${rowLotId}, checked: ${e.target.checked}`);
    
    updateSelectedCount();
    
    const selectedCount = document.querySelectorAll('.row-checkbox:checked').length;
    const exitBtn = document.getElementById('exitAddModelBtn');
    
    if (exitBtn) {
      if (selectedCount > 0) {
        exitBtn.innerHTML = `âœ… ${selectedCount} Selected`;
        exitBtn.style.background = '#28a745';
        
        // AUTO-COMBINE: Automatically trigger combine when checkboxes are selected
        setTimeout(() => {
          // Call the enhanced version if available, otherwise fallback to original
          if (typeof handleSelectedRowsEnhanced === 'function') {
            handleSelectedRowsEnhanced();
          } else {
            handleSelectedRowsOriginalDirect();
          }
        }, 300); // Small delay to show the visual feedback
        
      } else {
        exitBtn.innerHTML = 'âŒ Exit Add Model Mode';
        exitBtn.style.background = '#dc3545';
      }
    }
  }
});

  // Add keyboard shortcut
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.body.classList.contains('add-model-mode')) {
      exitAddModelMode();
    }
  });

  // Function to show inline tray validation errors
  function showInlineTrayValidationErrors(invalidTrays, trayRows) {
    invalidTrays.forEach(result => {
        const rowIndex = result.rowIndex - 1;
        const row = trayRows[rowIndex];
        if (row) {
            const trayInput = row.querySelector('input[type="text"]');
            if (trayInput) {
                // Style the input with error
                trayInput.style.borderColor = '#dc3545';
                trayInput.style.backgroundColor = '#fff5f5';
                
                // Create error message element
                const errorElement = document.createElement('div');
                errorElement.className = 'tray-validation-error';
                errorElement.style.cssText = `
                    color: #dc3545; font-size: 12px; margin-top: 4px; 
                    padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
                    border-radius: 4px; position: absolute; z-index: 1000; 
                    min-width: 150px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                `;
                errorElement.textContent = result.error;
                
                // Position the error below the input
                const inputCell = trayInput.closest('td');
                if (inputCell) {
                    inputCell.style.position = 'relative';
                    inputCell.appendChild(errorElement);
                    
                    // Auto-remove error after 8 seconds for tray validation errors
                    setTimeout(() => {
                        if (errorElement.parentNode) {
                            errorElement.remove();
                            trayInput.style.borderColor = '#ccc';
                            trayInput.style.backgroundColor = '#fff';
                        }
                    }, 8000);
                }
            }
        }
    });
  }

  // Function to show inline validation errors below tray ID inputs
  function showInlineValidationErrors(emptyFields) {
    emptyFields.forEach(field => {
        if (field.input && field.type === 'tray_id') {
            // Style the input with error
            field.input.style.borderColor = '#dc3545';
            field.input.style.backgroundColor = '#fff5f5';
            
            // Create error message element
            const errorElement = document.createElement('div');
            errorElement.className = 'tray-validation-error';
            errorElement.style.cssText = `
                color: #dc3545; font-size: 12px; margin-top: 4px; 
                padding: 4px 8px; background: #f8d7da; border: 1px solid #f5c6cb; 
                border-radius: 4px; position: absolute; z-index: 1000; 
                min-width: 120px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            errorElement.textContent = field.message;
            
            // Position the error below the input
            const inputCell = field.input.closest('td');
            if (inputCell) {
                inputCell.style.position = 'relative';
                inputCell.appendChild(errorElement);
                
                // Auto-remove error after 5 seconds
                setTimeout(() => {
                    if (errorElement.parentNode) {
                        errorElement.remove();
                        field.input.style.borderColor = '#ccc';
                        field.input.style.backgroundColor = '#fff';
                    }
                }, 5000);
            }
        }
    });
  }

  // Function to clear all validation errors
  function clearAllValidationErrors() {
    const existingErrors = document.querySelectorAll('.tray-validation-error');
    existingErrors.forEach(error => error.remove());
    
    // Reset input styling
    const allTrayInputs = document.querySelectorAll('.jig-loading-table input[type="text"]');
    allTrayInputs.forEach(input => {
        input.style.borderColor = '#ccc';
        input.style.backgroundColor = '#fff';
    });
  }

// ðŸ”§ FIXED: Complete Submit Button Fix - Replace your existing submit functions

// 1. FIXED: submitTrayDataWithValidation function
function submitTrayDataWithValidation() {
  const uploadModal = document.getElementById('uploadChildModal');
  const lotId = uploadModal ? uploadModal.getAttribute('data-current-lot-id') : '';
  
  if (!lotId) {
      Swal.fire('Error', 'Lot ID not found.', 'error');
      return;
  }

  console.log('ðŸ”§ SUBMIT: Starting validation process');

  // Clear any existing error messages first
  clearAllValidationErrors();

  // Collect all tray data ONCE
  const trays = [];
  const trayRows = document.querySelectorAll('.jig-loading-table tbody tr');
  
  if (trayRows.length === 0) {
      Swal.fire('Error', 'No tray data found.', 'error');
      return;
  }

  // Validate each tray has required data
  let isValid = true;
  let emptyFields = [];

  trayRows.forEach((row, index) => {
      const trayIdInput = row.querySelector('input[type="text"]');
      const trayQtyInput = row.querySelector('input[type="number"]');
      const trayQtySpan = row.querySelector('td:last-child span');
      const sNoCell = row.querySelector('td:first-child');
      const isTopTray = sNoCell && sNoCell.textContent.includes('(Top Tray)');
      
      const tray_id = trayIdInput ? trayIdInput.value.trim() : '';
      const tray_qty = trayQtyInput 
          ? parseInt(trayQtyInput.value) 
          : (trayQtySpan ? parseInt(trayQtySpan.textContent.trim()) : 0);
      const lot_id = row.getAttribute('data-lot-id') || lotId;
      
      // Clear previous error styling
      if (trayIdInput) {
          trayIdInput.style.borderColor = '#ccc';
          trayIdInput.style.backgroundColor = '#fff';
      }
      
      if (!tray_id) {
          emptyFields.push({
              rowIndex: index + 1,
              input: trayIdInput,
              message: 'Tray ID is required',
              type: 'tray_id'
          });
          isValid = false;
      }
      
      if (!tray_qty || tray_qty <= 0) {
          emptyFields.push({
              rowIndex: index + 1,
              input: trayQtyInput || trayQtySpan,
              message: 'Valid quantity is required',
              type: 'tray_qty'
          });
          isValid = false;
      }
      
      if (tray_id && tray_qty > 0) {
          trays.push({ 
              tray_id: tray_id, 
              tray_qty: tray_qty,
              lot_id: lot_id,
              is_top_tray: isTopTray  // Add this line

          });
      }
  });

  
  if (!isValid) {
      console.log('âŒ SUBMIT: Validation failed');
      showInlineValidationErrors(emptyFields);
      return;
  }

  if (trays.length === 0) {
      Swal.fire('Error', 'Please enter at least one valid Tray ID and quantity.', 'error');
      return;
  }

  console.log('ðŸ”§ SUBMIT: Proceeding with trays:', trays);

  // Show loading
  Swal.fire({
      title: 'Validating Tray IDs...',
      text: 'Please wait while we validate the tray IDs',
      allowOutsideClick: false,
      showConfirmButton: false,
      willOpen: () => {
          Swal.showLoading();
      }
  });

  // Validate all tray IDs first
  validateAllTrayIds(trays).then(validationResults => {
      Swal.close();
      
      const invalidTrays = validationResults.filter(result => !result.isValid);
      
      if (invalidTrays.length > 0) {
          console.log('âŒ SUBMIT: Tray validation failed');
          showInlineTrayValidationErrors(invalidTrays, trayRows);
          return;
      }
      
      // âœ… All tray IDs are valid, proceed to save
      console.log('âœ… SUBMIT: All validations passed, proceeding to save');
      saveTrayDataWithJigAwareSources(trays, lotId);
      
  }).catch(error => {
      Swal.close();
      console.error('Validation error:', error);
      Swal.fire({
          icon: 'error',
          title: 'Validation Error',
          text: 'An error occurred during tray ID validation. Please try again.',
          showConfirmButton: true
      });
  });
}


// 2. FIXED: New save function with jig-aware sources (replaces the problematic one)
function saveTrayDataWithJigAwareSources(trays, mainLotId) {
  const uploadModal = document.getElementById('uploadChildModal');
  const jig_lot_id = uploadModal ? (uploadModal.getAttribute('data-jig-lot-id') || '') : '';

  console.log('ðŸ”§ SAVE: Starting save with jig-aware sources');
  console.log('   Trays:', trays);
  console.log('   Main Lot ID:', mainLotId);
  console.log('   Jig Lot ID:', jig_lot_id);

  // Get all modal data including jig-aware sources
  const combinedLotIdsJson = uploadModal ? uploadModal.getAttribute('data-combined-lot-ids') : '[]';
  const jigAwareSourcesJson = uploadModal ? uploadModal.getAttribute('data-jig-aware-sources') : '[]';
  
  let combinedLotIds = [];
  let jigAwareSources = [];
  
  try {
    combinedLotIds = JSON.parse(combinedLotIdsJson || '[]');
    jigAwareSources = JSON.parse(jigAwareSourcesJson || '[]');
  } catch (e) {
    console.warn('Failed to parse modal data:', e);
  }

  console.log('ðŸ”§ SAVE: Extracted data:');
  console.log('   Combined Lot IDs:', combinedLotIds);
  console.log('   Jig-Aware Sources:', jigAwareSources);

  // Verify data integrity
  const lotIdCounts = {};
  trays.forEach(tray => {
    lotIdCounts[tray.lot_id] = (lotIdCounts[tray.lot_id] || 0) + tray.tray_qty;
  });

  console.log('ðŸ”§ SAVE: Final data verification:');
  console.log('   Lot ID Distribution:', lotIdCounts);
  console.log('   Total Pieces:', Object.values(lotIdCounts).reduce((a, b) => a + b, 0));

  if (trays.length === 0) {
    Swal.fire('Error', 'No valid tray data found.', 'error');
    return;
  }

  // Show loading
  Swal.fire({
    title: 'Saving with Preserved Mappings...',
    text: 'Please wait while we save the tray data',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });

  // ðŸ”§ FIXED: Prepare request data with jig-aware sources for accurate backend processing
  const requestData = {
    trays: trays,
    combined_lot_ids: combinedLotIds,
    main_lot_id: mainLotId,
    jig_lot_id: jig_lot_id,
    jig_aware_sources: jigAwareSources  // ðŸ”§ CRITICAL: This preserves original jig-lot mappings
  };

  console.log('ðŸ”§ SAVE: Sending to backend with PRESERVED jig mappings:');
  console.log(JSON.stringify(requestData, null, 2));

  fetch('/JigUnloading_Zone2/JU_Zone_save_jig_unload_tray_ids/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(requestData)
  })
  .then(response => {
    console.log('ðŸ”§ SAVE: Response status:', response.status);
    return response.json();
  })
  .then(data => {
    Swal.close();
    console.log('ðŸ”§ SAVE: Backend response:', data);

    if (data.success) {
      console.log('âœ… SAVE SUCCESS with preserved jig mappings');
      if (data.preserved_mappings) {
        console.log('ðŸŽ¯ Backend Preserved Mappings:', data.preserved_mappings);
      }
      showSuccessInModal();
    } else {
      console.error('âŒ SAVE FAILED:', data.error);
      Swal.fire({
        icon: 'error',
        title: 'Save Failed',
        text: data.error || 'Failed to save tray data. Please try again.',
        showConfirmButton: true
      });
    }
  })
  .catch(error => {
    Swal.close();
    console.error('ðŸš¨ SAVE ERROR:', error);
    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'An error occurred while saving. Please check your connection and try again.',
      showConfirmButton: true
    });
  });
}

// 2. FIXED: saveTrayDataDirect function (rename existing one to avoid conflicts)
function saveTrayDataDirect(trays, mainLotId) {
  const uploadModal = document.getElementById('uploadChildModal');
  const jig_lot_id = uploadModal ? (uploadModal.getAttribute('data-jig-lot-id') || '') : '';

  console.log('ðŸ”§ SAVE: Starting save process');
  console.log('   Trays:', trays);
  console.log('   Main Lot ID:', mainLotId);
  console.log('   Jig Lot ID:', jig_lot_id);

  // Get all modal data including jig-aware sources
  const combinedLotIdsJson = uploadModal ? uploadModal.getAttribute('data-combined-lot-ids') : '[]';
  const jigAwareSourcesJson = uploadModal ? uploadModal.getAttribute('data-jig-aware-sources') : '[]';
  
  let combinedLotIds = [];
  let jigAwareSources = [];
  
  try {
    combinedLotIds = JSON.parse(combinedLotIdsJson || '[]');
    jigAwareSources = JSON.parse(jigAwareSourcesJson || '[]');
  } catch (e) {
    console.warn('Failed to parse modal data:', e);
  }

  console.log('ðŸ”§ SAVE: Extracted data:');
  console.log('   Combined Lot IDs:', combinedLotIds);
  console.log('   Jig-Aware Sources:', jigAwareSources);

  // Verify data integrity
  const lotIdCounts = {};
  trays.forEach(tray => {
    lotIdCounts[tray.lot_id] = (lotIdCounts[tray.lot_id] || 0) + tray.tray_qty;
  });

  console.log('ðŸ”§ SAVE: Final data verification:');
  console.log('   Lot ID Distribution:', lotIdCounts);
  console.log('   Total Pieces:', Object.values(lotIdCounts).reduce((a, b) => a + b, 0));

  if (trays.length === 0) {
    Swal.fire('Error', 'No valid tray data found.', 'error');
    return;
  }

  // Show loading
  Swal.fire({
    title: 'Saving with Preserved Mappings...',
    text: 'Please wait while we save the tray data',
    allowOutsideClick: false,
    showConfirmButton: false,
    willOpen: () => {
      Swal.showLoading();
    }
  });

  // ðŸ”§ FIXED: Prepare request data with jig-aware sources for accurate backend processing
  const requestData = {
    trays: trays,
    combined_lot_ids: combinedLotIds,
    main_lot_id: mainLotId,
    jig_lot_id: jig_lot_id,
    jig_aware_sources: jigAwareSources  // ðŸ”§ CRITICAL: This preserves original jig-lot mappings
  };

  console.log('ðŸ”§ SAVE: Sending to backend with PRESERVED jig mappings:');
  console.log(JSON.stringify(requestData, null, 2));

  fetch('/JigUnloading_Zone2/JU_Zone_save_jig_unload_tray_ids/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    },
    body: JSON.stringify(requestData)
  })
  .then(response => {
    console.log('ðŸ”§ SAVE: Response status:', response.status);
    return response.json();
  })
  .then(data => {
    Swal.close();
    console.log('ðŸ”§ SAVE: Backend response:', data);

    if (data.success) {
      console.log('âœ… SAVE SUCCESS with preserved jig mappings');
      if (data.preserved_mappings) {
        console.log('ðŸŽ¯ Backend Preserved Mappings:', data.preserved_mappings);
      }
      showSuccessInModal();
    } else {
      console.error('âŒ SAVE FAILED:', data.error);
      Swal.fire({
        icon: 'error',
        title: 'Save Failed',
        text: data.error || 'Failed to save tray data. Please try again.',
        showConfirmButton: true
      });
    }
  })
  .catch(error => {
    Swal.close();
    console.error('ðŸš¨ SAVE ERROR:', error);
    Swal.fire({
      icon: 'error',
      title: 'Network Error',
      text: 'An error occurred while saving. Please check your connection and try again.',
      showConfirmButton: true
    });
  });
}
// ðŸ”§ FIXED: validateAllTrayIds function to properly set rowIndex
async function validateAllTrayIds(trays) {
  const validationPromises = trays.map((tray, index) => {
    return validateSingleTrayId({
      ...tray,
      rowIndex: index + 1  // Add rowIndex for error display
    });
  });
  return Promise.all(validationPromises);
}

// ðŸ”§ FIXED: validateSingleTrayId function
function validateSingleTrayId(tray) {
  return fetch('/JigUnloading_Zone2/JU_Zone_validate_tray_id/', {
      method: 'POST',
      headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ 
        tray_id: tray.tray_id,
        lot_id: tray.lot_id  // Include lot_id for proper validation
      })
  })
  .then(response => response.json())
  .then(data => {
      return {
          tray_id: tray.tray_id,
          rowIndex: tray.rowIndex,
          isValid: data.success,
          error: data.success ? null : (data.error || 'Tray ID is invalid')
      };
  })
  .catch(error => {
      return {
          tray_id: tray.tray_id,
          rowIndex: tray.rowIndex,
          isValid: false,
          error: 'Network error during validation'
      };
  });
}

// 7. Updated Submit button event handler
function updateSubmitButtonHandler() {
  const submitBtn = document.getElementById('uploadSubmitBtn');
  if (submitBtn) {
      // Remove old event listener and add new one
      submitBtn.onclick = null;
      submitBtn.onclick = function () {
          console.log('ðŸ”§ FIXED: Submit button clicked with jig-aware preservation');
          submitTrayDataWithValidation(); // This now calls saveTrayDataDirectWithJigAware
      };
  }
}

// Function to show success message - IMMEDIATE CLOSE VERSION
  function showSuccessInModal() {
    // Show quick toast notification
    Swal.fire({
        icon: 'success',
        title: 'Saved!',
        toast: true,
        position: 'top-end',
        timer: 500,
        showConfirmButton: false
    });
    
    // Close upload modal immediately
    document.getElementById('uploadChildModal').style.display = 'none';
    
    // Restore original content for next use
    setTimeout(() => {
        restoreOriginalModalContent();
    }, 100);
    
    // Refresh unload modal immediately
    if (typeof window.refreshUnloadModal === 'function') {
        window.refreshUnloadModal();
    }
    setTimeout(() => {
      window.location.reload();
  }, 600); // 600ms to let the toast appear
  }

  // Make functions globally available
  window.enterAddModelMode = enterAddModelMode;
  window.exitAddModelMode = exitAddModelMode;
  window.handleSelectedRows = handleSelectedRows;
  window.updateSelectedCount = updateSelectedCount;
  window.filterAndHighlightCompatibleRowsWithUnloadCheck = filterAndHighlightCompatibleRowsWithUnloadCheck;
  window.restoreOriginalModalContent = restoreOriginalModalContent;
  window.attachModalEventListeners = attachModalEventListeners;
});
</script>

<!-- Script for Select All functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  // Updated Select All checkbox functionality
  const selectAllCheckbox = document.getElementById('selectAllCheckbox');
  if (selectAllCheckbox) {
    selectAllCheckbox.onchange = function() {
      const isAddModelMode = document.body.classList.contains('add-model-mode');
      
      if (isAddModelMode) {
        // In Add Model Mode - only select visible/compatible rows
        const compatibleCheckboxes = document.querySelectorAll('.compatible-row .row-checkbox:not([disabled])');
        compatibleCheckboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
        
        // Update the count display
        if (window.updateSelectedCount) {
          window.updateSelectedCount();
        }
      } else {
        // Normal mode - select all checkboxes
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(checkbox => {
          checkbox.checked = this.checked;
        });
      }
      
      // Trigger change event
      const event = new Event('change', { bubbles: true });
      const firstCheckbox = document.querySelector('.row-checkbox');
      if (firstCheckbox) {
        firstCheckbox.dispatchEvent(event);
      }
    };
  }
});
</script>

<!-- Script for table sorting functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const table = document.getElementById("order-listing");
  if (!table) {
    console.warn("Table with ID 'order-listing' not found.");
    return;
  }

  const headers = table.querySelectorAll("thead th");
  const tbody = table.querySelector("tbody");
  let sortDirection = {};

  headers.forEach((header, index) => {
    header.style.cursor = "pointer";

    header.addEventListener("click", function () {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const dir = sortDirection[index] === "asc" ? "desc" : "asc";
      sortDirection[index] = dir;

      rows.sort((a, b) => {
        const cellA = a.children[index].textContent.trim();
        const cellB = b.children[index].textContent.trim();
        const valA = isNaN(cellA) ? cellA : parseFloat(cellA);
        const valB = isNaN(cellB) ? cellB : parseFloat(cellB);

        if (valA < valB) return dir === "asc" ? -1 : 1;
        if (valA > valB) return dir === "asc" ? 1 : -1;
        return 0;
      });

      tbody.innerHTML = "";
      rows.forEach((row) => tbody.appendChild(row));
    });
  });
});
</script>


 
<!-- Script for View Icon Tray validate -->

  <script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const redoBtn = document.getElementById("trayScanRedoBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (redoBtn && validateInput && detailsDiv) {
    redoBtn.addEventListener("click", function () {
      // Hide and clear the input
      validateInput.value = "";
      validateInput.blur();
      
      // Hide error message
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Reset Tray Validate button to normal state
      const validateBtn = document.getElementById("trayValidateBtn");
      if (validateBtn) {
        validateBtn.style.background = "#f5faff";
        validateBtn.style.borderColor = "#023E4DCC";
        validateBtn.style.color = "#023E4DCC";
      }

      // Reset all icons in the validation status column (read-only modal)
      // For table layout:
      const rows = detailsDiv.querySelectorAll("tbody tr");
      if (rows.length > 0) {
        rows.forEach(row => {
          const statusCell = row.querySelector("td:last-child");
          if (statusCell) {
            statusCell.innerHTML = `
              <div class="validation-status">
                <div class="status-icon fail">
                  <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                </div>
                <div class="status-icon pass">
                  <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                </div>
              </div>
            `;
          }
        });
      } else {
        // For grid layout (if used)
        detailsDiv.querySelectorAll('.tray-validation-status-header, .tray-validation-status-cell').forEach(cell => {
          cell.innerHTML = `
            Tray Validation Status
            <span style="margin-left: 10px;">
              <img src="{% static 'assets/icons/fail.png' %}" alt="Cross" title="Fail" style="width:18px; height:18px; margin-right:6px; vertical-align:middle;" />
              <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
            </span>
          `;
        });
      }
    });
  }
});
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const validateBtn = document.getElementById("trayValidateBtn");
  const validateInput = document.getElementById("trayValidateInput");
  const redoBtn = document.getElementById("trayScanRedoBtn");
  const errorMessage = document.getElementById("trayErrorMessage");

  if (validateBtn && validateInput) {
    validateBtn.addEventListener("click", function () {
      validateInput.value = "";
      
      // Hide error message when starting new validation
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Change button to active state (green color)
      validateBtn.style.background = "#e8f5e8";
      validateBtn.style.borderColor = "#4caf50";
      validateBtn.style.color = "#2e7d32";
      
      // Add the 4th column to the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table with validation column
        detailsDiv.innerHTML = modal.buildTableHTML(true);
      }
      
      // Focus the hidden input so it can receive keystrokes
      validateInput.focus();
    });
  }
  
  if (redoBtn && validateInput) {
    redoBtn.addEventListener("click", function () {
      validateInput.value = "";
      validateInput.blur();
      
      // Hide error message
      if (errorMessage) {
        errorMessage.style.display = "none";
      }
      
      // Reset button to normal state (original blue color)
      if (validateBtn) {
        validateBtn.style.background = "#f5faff";
        validateBtn.style.borderColor = "#023E4DCC";
        validateBtn.style.color = "#023E4DCC";
      }
      
      // Remove the 4th column from the table
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
      
      if (modal && detailsDiv && modal.buildTableHTML) {
        // Rebuild table without validation column
        detailsDiv.innerHTML = modal.buildTableHTML(false);
      }
      
      redoBtn.focus();
    });
  }
});
</script>


<script nonce="{{ csp_nonce }}">
// Updated Tray Validation Script with Stock Status Support and Enhanced Error Handling
document.addEventListener("DOMContentLoaded", function () {
  const validateInput = document.getElementById("trayValidateInput");
  const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");
  const errorMessage = document.getElementById("trayErrorMessage");
  const errorText = document.getElementById("trayErrorText");

  console.log("ðŸ” Tray validation script loaded");
  console.log("ðŸ“‹ Elements found:", {
    validateInput: !!validateInput,
    detailsDiv: !!detailsDiv,
    errorMessage: !!errorMessage,
    errorText: !!errorText
  });

  function getCurrentBatchId() {
    const modal = document.getElementById("trayScanModal_DayPlanning");
    if (modal && modal.dataset.batchId) return modal.dataset.batchId;
    const lastBtn = document.querySelector('.tray-scan-btn-Jig[data-batch-id]');
    return lastBtn ? lastBtn.getAttribute('data-batch-id') : '';
  }

  function getCurrentStockStatus() {
    // Get stock status from the last clicked button
    const lastBtn = document.querySelector('.tray-scan-btn-Jig[data-batch-id]');
    if (lastBtn) {
      return {
        accepted_ip_stock: lastBtn.getAttribute('data-accepted-ip-stock') === 'true',
        rejected_ip_stock: lastBtn.getAttribute('data-rejected-ip-stock') === 'true',
        few_cases_accepted_ip_stock: lastBtn.getAttribute('data-few-cases-accepted-ip-stock') === 'true'
      };
    }
    return {
      accepted_ip_stock: false,
      rejected_ip_stock: false,
      few_cases_accepted_ip_stock: false
    };
  }

  function showError(message) {
    console.log("ðŸš¨ Showing error:", message);
    if (errorMessage && errorText) {
      errorText.textContent = message;
      
      // Force display with important styles
      errorMessage.style.setProperty('display', 'block', 'important');
      errorMessage.style.setProperty('visibility', 'visible', 'important');
      errorMessage.style.setProperty('opacity', '1', 'important');
      errorMessage.style.setProperty('z-index', '99999', 'important');
      errorMessage.style.setProperty('position', 'relative', 'important');
      errorMessage.style.setProperty('background-color', '#ffebee', 'important');
      errorMessage.style.setProperty('border', '1px solid #f44336', 'important');
      errorMessage.style.setProperty('color', '#c62828', 'important');
      errorMessage.style.setProperty('padding', '8px 12px', 'important');
      errorMessage.style.setProperty('border-radius', '4px', 'important');
      errorMessage.style.setProperty('margin-bottom', '10px', 'important');
      errorMessage.style.setProperty('font-size', '12px', 'important');
      errorMessage.style.setProperty('text-align', 'center', 'important');
      errorMessage.style.setProperty('width', '100%', 'important');
      
      console.log("âœ… Error message styled");
      
      // Scroll to error message if it exists
      errorMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      // Flash the background to make it more noticeable
      let flashCount = 0;
      const flashInterval = setInterval(() => {
        if (flashCount < 6) {
          errorMessage.style.backgroundColor = flashCount % 2 === 0 ? '#ffcdd2' : '#ffebee';
          flashCount++;
        } else {
          clearInterval(flashInterval);
          errorMessage.style.backgroundColor = '#ffebee';
        }
      }, 200);
      
      console.log("âœ… Error message displayed");
      
      // Auto-hide after 8 seconds
      setTimeout(() => {
        errorMessage.style.display = "none";
        console.log("â° Auto-hiding error message after 8 seconds");
      }, 8000);
    } else {
      console.log("âŒ Error message elements not found!");
      // Fallback: show alert if error div not found
      alert(message);
    }
  }

  function hideError() {
    console.log("ðŸ«¥ Hiding error message");
    if (errorMessage) {
      errorMessage.style.display = "none";
    }
  }

  if (validateInput && detailsDiv) {
    console.log("ðŸŽ¯ Setting up tray validation event listener");
    
    // Add input event listener for real-time feedback
    validateInput.addEventListener("input", function(e) {
      console.log("âŒ¨ï¸ User typing:", e.target.value);
    });
    
    validateInput.addEventListener("keydown", function (e) {

            // Get brass QC status from the modal or last clicked tray-scan-btn-Jig
      const modal = document.getElementById("trayScanModal_DayPlanning");
      let brassQcAccptance = false;
      let brassQcRejection = false;
      let brassQcFewCasesAccptance = false;
      
      // Try to get from modal dataset if set
      if (modal) {
        brassQcAccptance = modal.getAttribute('data-brass-qc-accptance') === 'true';
        brassQcRejection = modal.getAttribute('data-brass-qc-rejection') === 'true';
        brassQcFewCasesAccptance = modal.getAttribute('data-brass-qc-few-cases-accptance') === 'true';
      }
      
      // If not set, fallback to last clicked tray-scan-btn-Jig
      if (!brassQcAccptance && !brassQcRejection && !brassQcFewCasesAccptance) {
        const lastBtn = document.querySelector('.tray-scan-btn-Jig[data-batch-id]');
        if (lastBtn) {
          brassQcAccptance = lastBtn.getAttribute('data-brass-qc-accptance') === 'true';
          brassQcRejection = lastBtn.getAttribute('data-brass-qc-rejection') === 'true';
          brassQcFewCasesAccptance = lastBtn.getAttribute('data-brass-qc-few-cases-accptance') === 'true';
        }
      }
      console.log("ðŸ”‘ Key pressed:", e.key, "Value:", validateInput.value.trim());
      
      if (e.key === "Enter") {
        const trayId = validateInput.value.trim();
        console.log("ðŸŽ¯ Enter pressed with tray ID:", trayId);
        
        if (!trayId) {
          console.log("âš ï¸ Empty tray ID, returning");
          return;
        }
        
        const batchId = getCurrentBatchId();
        console.log("ðŸ“¦ Current batch ID:", batchId);
        
        if (!batchId) {
          console.log("âŒ No batch ID found");
          showError("Batch ID not found. Please refresh and try again.");
          return;
        }

        const stockStatus = getCurrentStockStatus();
        console.log("ðŸ“Š Stock status:", stockStatus);

        // Hide any existing error message
        hideError();
        console.log("ðŸ”„ Making API call to validate tray...");

        // Include stock status in the validation request
        const requestData = {
          batch_id: batchId,
          tray_id: trayId,
          ...stockStatus
        };

    fetch("/jig_loading/jig_tray_validate/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie('csrftoken')
      },
      body: JSON.stringify({
        batch_id: batchId,
        tray_id: trayId,
        brass_audit_accptance: brassQcAccptance,
        brass_audit_rejection: brassQcRejection,
        brass_audit_few_cases_accptance: brassQcFewCasesAccptance
      })
    })
        .then(res => {
          console.log("ðŸ“¡ API Response status:", res.status);
          return res.json();
        })
        .then(data => {
          console.log("ðŸ“Š API Response data:", data);
          
          // Find the row in the table with this Tray ID
          const rows = detailsDiv.querySelectorAll("tbody tr");
          console.log("ðŸ“‹ Found", rows.length, "rows in modal table");
          
          let found = false;
          
          rows.forEach((row, index) => {
            const trayIdInput = row.querySelector('input[type="text"]');
            if (trayIdInput) {
              const rowTrayId = trayIdInput.value.trim();
              console.log(`ðŸ”Ž Row ${index + 1}: checking "${rowTrayId}" vs "${trayId}"`);
              
              if (rowTrayId === trayId) {
                found = true;
                console.log(`âœ… Found matching tray in row ${index + 1}`);
                
                const statusCell = row.querySelector("td:last-child");
                if (statusCell) {
                  if (data.success && data.exists) {
                    // Pass validation - show tick as active, cross as inactive
                    statusCell.innerHTML = `
                      <div class="validation-status">
                        <div class="status-icon fail inactive">
                          <img src="/static/assets/icons/fail.png" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                        </div>
                        <div class="status-icon pass active">
                          <img src="/static/assets/icons/pass.png" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                        </div>
                      </div>
                    `;
                    
                    // Add visual feedback for successful validation
                    row.style.backgroundColor = '#e8f5e8';
                    setTimeout(() => {
                      row.style.backgroundColor = '';
                    }, 2000);
                    
                    console.log("âœ… Updated status cell to PASS");
                    
                  } else {
                    // Fail validation - show cross as active, tick as inactive
                    statusCell.innerHTML = `
                      <div class="validation-status">
                        <div class="status-icon fail active">
                          <img src="/static/assets/icons/fail.png" alt="Fail" title="Fail" style="width:18px; height:18px;" />
                        </div>
                        <div class="status-icon pass inactive">
                          <img src="/static/assets/icons/pass.png" alt="Pass" title="Pass" style="width:18px; height:18px;" />
                        </div>
                      </div>
                    `;
                    
                    // Add visual feedback for failed validation
                    row.style.backgroundColor = '#ffebee';
                    setTimeout(() => {
                      row.style.backgroundColor = '';
                    }, 2000);
                    
                    console.log("âŒ Updated status cell to FAIL");
                  }
                }
              }
            }
          });
          
          if (!found) {
            console.log("âŒ Tray not found in table");
            
            // Enhanced error message with stock status context
            let filterContext = '';
            if (stockStatus.accepted_ip_stock && !stockStatus.few_cases_accepted_ip_stock) {
              filterContext = ' (searching in accepted trays only)';
            } else if (stockStatus.rejected_ip_stock && !stockStatus.few_cases_accepted_ip_stock) {
              filterContext = ' (searching in rejected trays only)';
            } else if (stockStatus.few_cases_accepted_ip_stock) {
              filterContext = ' (searching in both accepted and rejected trays)';
            }
            
            showError(`Tray ID "${trayId}" not found in table${filterContext}.`);
          } else {
            console.log("ðŸŽ‰ Validation successful!");
          }
          
          // Always clear and focus input for next scan
          validateInput.value = "";
          validateInput.focus();
        })
        .catch(error => {
          console.error('âŒ Network error:', error);
          showError('Network error occurred while validating the tray ID.');
          validateInput.value = "";
          validateInput.focus();
        });
      }
    });
    
    // Also add focus event to ensure input is ready
    validateInput.addEventListener("focus", function() {
      console.log("ðŸŽ¯ Validate input focused and ready");
    });
    
  } else {
    console.log("âŒ Required elements not found:", {
      validateInput: !!validateInput,
      detailsDiv: !!detailsDiv
    });
  }
  
  // Helper for CSRF
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  
  console.log("ðŸŽ¯ Tray validation script setup complete");
});
</script>


<!--Update the tray list fetching endpoint in the modal script -->
<script nonce="{{ csp_nonce }}">
// Enhanced JavaScript for modal popup with comprehensive debugging
document.addEventListener("DOMContentLoaded", function () {
  console.log("ðŸš€ Modal script loaded");
  
  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link, index) {
    console.log(`ðŸ“Œ Found tray scan button ${index + 1}`);
    
    link.addEventListener('click', async function (e) {
      e.preventDefault();
      console.log("ðŸ”¥ View icon clicked!");

      // Get modal elements
      const modal = document.getElementById("trayScanModal_DayPlanning");
      const detailsDiv = document.getElementById("trayScanDetails_DayPlanning");

      // Get all data attributes with extensive logging
      const lotId = link.getAttribute('data-lot-id');
      const trayCapacity = link.getAttribute('data-tray-capacity');
      const platingStkNo = link.getAttribute('data-plating-stk-no');
      const modelNo = link.getAttribute('data-model-no');
      const modelImage = link.getAttribute('data-model-image');
      const lotIdQuantities = link.getAttribute('data-lot-id-quantities');

      // COMPREHENSIVE DEBUG LOGGING
      console.log("ðŸ” === MODAL DATA DEBUG ===");
      console.log("ðŸ“Š Raw Data Attributes:");
      console.log("  lotId:", lotId);
      console.log("  platingStkNo:", platingStkNo);
      console.log("  modelNo:", modelNo);
      console.log("  modelImage:", modelImage);
      console.log("  trayCapacity:", trayCapacity);
      console.log("  lotIdQuantities:", lotIdQuantities);
      console.log("ðŸ” ========================");

      // Check for missing data
      const missingData = [];
      if (!modelNo || modelNo === 'N/A') missingData.push('modelNo');
      if (!platingStkNo || platingStkNo === 'N/A') missingData.push('platingStkNo');
      if (!modelImage || modelImage.includes('imagePlaceholder.png')) missingData.push('modelImage');
      
      if (missingData.length > 0) {
        console.warn("âš ï¸ Missing data:", missingData.join(', '));
      }

      // Set model number in modal with improved logic
      const modalModelNo = document.getElementById("modalModelNo_DayPlanning");
      if (modalModelNo) {
        let displayText = "Unknown Model";
        
        if (modelNo && modelNo !== 'N/A' && modelNo !== 'null' && modelNo !== 'undefined') {
          displayText = modelNo;
          console.log("âœ… Using modelNo:", modelNo);
        } else if (platingStkNo && platingStkNo !== 'N/A' && platingStkNo !== 'null' && platingStkNo !== 'undefined') {
          displayText = platingStkNo;
          console.log("âœ… Using platingStkNo as fallback:", platingStkNo);
        } else {
          console.log("âŒ No valid model data found");
        }
        
        modalModelNo.textContent = displayText;
        console.log("ðŸ“ Modal header set to:", displayText);
      }

      // Set model image in modal with improved logic
      const modalUserImg = modal.querySelector('.user-profile img');
      if (modalUserImg) {
        let imageUrl = "/static/assets/images/imagePlaceholder.png"; // Default
        
        if (modelImage && 
            modelImage !== 'N/A' && 
            modelImage !== 'null' && 
            modelImage !== 'undefined' && 
            !modelImage.includes('imagePlaceholder.png')) {
          imageUrl = modelImage;
          console.log("âœ… Using model image:", modelImage);
        } else {
          console.log("âŒ Using placeholder image");
        }
        
        modalUserImg.src = imageUrl;
        console.log("ðŸ–¼ï¸ Modal image set to:", imageUrl);
        
        // Add error handling for image loading
        modalUserImg.onerror = function() {
          console.log("âŒ Image failed to load, using placeholder");
          this.src = "/static/assets/images/imagePlaceholder.png";
        };
        
        modalUserImg.onload = function() {
          console.log("âœ… Image loaded successfully");
        };
      }

      // Set Lot Qty with improved error handling
      const modalLotQty = document.getElementById("modalLotQty_DayPlanning");
      if (modalLotQty && lotIdQuantities) {
        try {
          const qtyObj = JSON.parse(lotIdQuantities);
          console.log("ðŸ“Š Parsed lot quantities:", qtyObj);
          
          const totalQty = Object.values(qtyObj).reduce((a, b) => a + parseInt(b || 0), 0);
          modalLotQty.textContent = totalQty;
          console.log("âœ… Total quantity set to:", totalQty);
        } catch (error) {
          console.error('âŒ Error parsing lot quantities:', error);
          console.log('Raw lot quantities string:', lotIdQuantities);
          modalLotQty.textContent = 'Error';
        }
      }

      // Fetch tray data using lot_id
      console.log("ðŸ”„ Fetching tray data for lot_id:", lotId);
      let traysData = [];
      try {
        const params = new URLSearchParams({ lot_id: lotId });
        const resp = await fetch(`/JigUnloading_Zone2/JU_Zone_view_tray_list/?${params}`);
        const result = await resp.json();
        
        console.log("ðŸ“¡ Tray data API response:", result);
        
        if (result.success) {
          traysData = result.trays || [];
          console.log("âœ… Tray data loaded:", traysData.length, "trays");
        } else {
          console.error('âŒ API Error:', result.error || 'Unknown error');
        }
      } catch (e) {
        console.error('âŒ Fetch Error:', e);
      }

      // Build table with better error handling
      let html = `
        <table class="table table-bordered table-sm" style="width:100%; margin-bottom:0;">
          <thead>
            <tr>
              <th style="width:50px;">S.no</th>
              <th>Tray ID</th>
              <th>Tray Qty</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      if (traysData.length > 0) {
        traysData.forEach((tray, idx) => {
          html += `
            <tr>
              <td>${idx + 1}</td>
              <td>${tray.tray_id || 'N/A'}</td>
              <td>${tray.tray_quantity || '0'}</td>
            </tr>
          `;
        });
        console.log("âœ… Table built with", traysData.length, "rows");
      } else {
        html += `
          <tr>
            <td colspan="3" style="text-align: center; color: #888; padding: 20px;">
              No tray data found for lot ID: ${lotId}
            </td>
          </tr>
        `;
        console.log("âš ï¸ No tray data found");
      }
      
      html += '</tbody></table>';
      detailsDiv.innerHTML = html;

      // Show the modal
      modal.style.display = "block";
      modal.classList.add("open");
      console.log("âœ… Modal displayed successfully");
    });
  });

  // Close handler
  const closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");
  if (closeBtn) {
    closeBtn.addEventListener("click", function () {
      const modal = document.getElementById("trayScanModal_DayPlanning");
      if (modal) {
        modal.classList.remove("open");
        modal.style.display = "none";
        console.log("ðŸ”’ Modal closed");
        
      }
          window.location.reload(); 

    });
  }
  
  console.log("âœ… Modal script setup complete");
});
</script>
<!--end of script view icon-->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  function lockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button:not(#closeTrayScanModal_DayPlanning):not(#trayValidateBtn):not(#trayScanRedoBtn), .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.filter = 'grayscale(1)';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    document.querySelectorAll('a:not(.tray-scan-btn-Jig)').forEach(function (el) {
      el.style.pointerEvents = 'none';
      el.style.opacity = '0.4';
      el.style.cursor = 'not-allowed';
      el.classList.add('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = 'none';
      menuPanel.style.cursor = 'not-allowed';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = 'auto';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = 'auto';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  function unlockParentActions() {
    document.querySelectorAll(
      'img[alt="Edit Disabled"], img[alt="Delete Disabled"], .fa-filter, button, .hold-toggle-btn, .hold-remark-icon, label.hold-toggle-switch'
    ).forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.filter = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });
    document.querySelectorAll('a').forEach(function (el) {
      el.style.pointerEvents = '';
      el.style.opacity = '';
      el.style.cursor = '';
      el.classList.remove('locked-action');
    });

    var menuPanel = document.querySelector('.sidebar');
    if (menuPanel) {
      menuPanel.style.pointerEvents = '';
      menuPanel.style.cursor = '';
    }
    var mainPanel = document.querySelector('.main-panel');
    if (mainPanel) {
      mainPanel.style.pointerEvents = '';
    }
    var tableResponsive = document.querySelector('.table-responsive');
    if (tableResponsive) {
      tableResponsive.style.pointerEvents = '';
      tableResponsive.style.overflow = '';
    }
    var table = document.getElementById('order-listing');
    if (table) {
      table.style.pointerEvents = '';
    }
  }

  var modal = document.getElementById("trayScanModal_DayPlanning");
  var closeBtn = document.getElementById("closeTrayScanModal_DayPlanning");

  document.querySelectorAll('.tray-scan-btn-Jig').forEach(function(link) {
    link.addEventListener('click', function() {
      setTimeout(lockParentActions, 100);
    });
  });

  if (closeBtn) {
    closeBtn.addEventListener('click', function() {
      setTimeout(unlockParentActions, 200);
    });
  }
});
</script>
<!-- Active row to be highlighted & Restores the highlighted row to its original position and removes the highlight bg when the tray scan modal is closed. -->
<script nonce="{{ csp_nonce }}">
// Row highlight for Tray Scan (matches highlightWF.html logic) + Move active row to top and restore on close
document.addEventListener("DOMContentLoaded", function() {
  // Add highlight style if not present
  if (!document.getElementById('dp-row-action-highlight-style')) {
    var style = document.createElement('style');
    style.id = 'dp-row-action-highlight-style';
    style.innerHTML = `
      .dp-row-action-highlight {
        transition: box-shadow 1.3s;
        background-color: #fff5bd !important;
        animation: highlightAnimation 2s ease-in-out;
      }
      .dp-row-action-highlight td:nth-child(1),
      .dp-row-action-highlight td:nth-child(2),
      .dp-row-action-highlight td:nth-child(5) {
        background-color: #fff5bd !important;
      }
    `;
    document.head.appendChild(style);
  }

  let originalRowIndex = null;
  let movedRow = null;
  let placeholderRow = null;

  // Highlight and move row for remarks, edit, delete, model presents
  function highlightAndMoveRow(row) {
    document.querySelectorAll('tbody tr').forEach(function(r) {
      r.classList.remove('dp-row-action-highlight');
    });
    if (row && row.parentNode) {
      const tbody = row.parentNode;
      if (tbody.firstElementChild !== row) {
        // If a previous move exists, restore it first
        if (movedRow && placeholderRow && placeholderRow.parentNode) {
          placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
          placeholderRow.parentNode.removeChild(placeholderRow);
          movedRow.classList.remove('dp-row-action-highlight');
          movedRow = null;
          placeholderRow = null;
          originalRowIndex = null;
        }
        // Store original index and row
        originalRowIndex = Array.from(tbody.children).indexOf(row);
        movedRow = row;
        // Insert a placeholder at the original position
        placeholderRow = document.createElement('tr');
        placeholderRow.style.display = 'none';
        for (let i = 0; i < row.children.length; i++) {
          placeholderRow.appendChild(document.createElement('td'));
        }
        tbody.insertBefore(placeholderRow, tbody.children[originalRowIndex]);
        // Move row to top
        tbody.insertBefore(row, tbody.firstElementChild);
      }
      row.classList.add('dp-row-action-highlight');
    }
  }

  // Remarks
  document.querySelectorAll('.remarks-modal-trigger').forEach(function(link) {
    link.addEventListener('click', function(event) {
      var row = event.target.closest('tr');
      highlightAndMoveRow(row);
    });
  });

  // Edit
  document.querySelectorAll('.edit-qty-btn').forEach(function(link) {
    link.addEventListener('click', function(event) {
      var row = event.target.closest('tr');
      highlightAndMoveRow(row);
    });
  });

  // Delete
  document.querySelectorAll('.delete-jig-btn').forEach(function(link) {
    link.addEventListener('click', function(event) {
      var row = event.target.closest('tr');
      highlightAndMoveRow(row);
    });
  });

  // Model Presents (colored circles)
  document.querySelectorAll('.model-stock-no-text, .expand-model-remark').forEach(function(link) {
    link.addEventListener('click', function(event) {
      var row = event.target.closest('tr');
      highlightAndMoveRow(row);
    });
  });

  // Unload button
  document.querySelectorAll('.unload-modal-trigger').forEach(function(link) {
    link.addEventListener('click', function(event) {
      var row = event.target.closest('tr');
      highlightAndMoveRow(row);
    });
  });

  // On modal close, restore row to original position and remove highlight for both modals
  function restoreRowAndClearHighlight() {
    if (movedRow && placeholderRow && placeholderRow.parentNode) {
      placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
      placeholderRow.parentNode.removeChild(placeholderRow);
      movedRow.classList.remove('dp-row-action-highlight');
      movedRow = null;
      placeholderRow = null;
      originalRowIndex = null;
    }
    document.querySelectorAll('tbody tr').forEach(function(row) {
      row.classList.remove('dp-row-action-highlight');
      row.classList.remove('highlighted-tray-scan');
    });
  }

  // Attach to all close buttons for tray scan/modal
  document.querySelectorAll('#closeTrayScanModal, #closeTrayScanModal_DayPlanning, .close, [data-bs-dismiss="modal"]').forEach(function(btn) {
    btn.addEventListener('click', restoreRowAndClearHighlight);
  });
});
</script>

<!-- MODEL COLOR DEBUG SECTION -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
    console.log("ðŸŽ¨ ======= MODEL COLOR DEBUG SECTION =======");
    
    // Collect all model colors from each row
    const rows = document.querySelectorAll('#order-listing tbody tr[data-model-colors]');
    console.log(`ðŸ” Found ${rows.length} rows with model color data`);
    
    rows.forEach((row, index) => {
        try {
            const modelColorsStr = row.getAttribute('data-model-colors');
            const modelListStr = row.getAttribute('data-model-list');
            const lotId = row.getAttribute('data-lot-id');
            
            console.log(`\nðŸ” Row ${index + 1} (Lot: ${lotId}):`);
            console.log(`   ðŸ“Š Raw model-colors data: "${modelColorsStr}"`);
            console.log(`   ðŸ“‹ Raw model-list data: "${modelListStr}"`);
            
            if (modelColorsStr && modelColorsStr !== 'null' && modelColorsStr !== '{}') {
                const modelColors = JSON.parse(modelColorsStr);
                const modelList = modelListStr ? JSON.parse(modelListStr) : [];
                
                console.log(`   ðŸŽ¯ Parsed colors:`, modelColors);
                console.log(`   ðŸ“‹ Parsed model list:`, modelList);
                console.log(`   ðŸŽ¨ Color assignments:`);
                
                modelList.forEach(model => {
                    const color = modelColors[model] || 'NOT_FOUND';
                    console.log(`      ðŸ“Œ Model "${model}" -> Color "${color}"`);
                });
                
                // Check if colors are being applied to circles
                const circles = row.querySelectorAll('.model-circle');
                console.log(`   â­• Found ${circles.length} model circles in this row`);
                
                circles.forEach((circle, circleIndex) => {
                    const model = circle.getAttribute('data-model');
                    const color = circle.getAttribute('data-color');
                    const bgColor = circle.style.backgroundColor;
                    console.log(`      ðŸ”˜ Circle ${circleIndex + 1}: Model="${model}", Color="${color}", Background="${bgColor}"`);
                });
            } else {
                console.log(`   âŒ No model colors data or empty object`);
            }
        } catch (e) {
            console.error(`   âŒ Error parsing row ${index + 1}:`, e);
        }
    });
    
    // Summary
    const totalCircles = document.querySelectorAll('.model-circle').length;
    const coloredCircles = document.querySelectorAll('.model-circle[data-color]:not([data-color="default"])').length;
    
    console.log(`\nðŸŽ¨ ======= COLOR SUMMARY =======`);
    console.log(`ðŸ“Š Total model circles: ${totalCircles}`);
    console.log(`ðŸŽ¯ Colored circles: ${coloredCircles}`);
    console.log(`âŒ Default circles: ${totalCircles - coloredCircles}`);
    console.log(`âœ… Success rate: ${totalCircles > 0 ? ((coloredCircles / totalCircles) * 100).toFixed(1) : 0}%`);
    console.log(`ðŸŽ¨ ======= END DEBUG SECTION =======`);
});
</script>

<!-- Enhanced Script for dynamic model image gallery view with navigation -->
<script nonce="{{ csp_nonce }}">
   // Global color palette and model-to-color mapping (use shared window vars)
   window.GLOBAL_COLOR_PALETTE = window.GLOBAL_COLOR_PALETTE || [
     "#e74c3c", "#f1c40f", "#2ecc71", "#3498db", "#9b59b6",
     "#e67e22", "#1abc9c", "#34495e", "#f39c12", "#d35400",
     "#c0392b", "#8e44ad", "#2980b9", "#27ae60", "#16a085",
     "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7",
     "#dda0dd", "#98d8c8", "#f7dc6f", "#bb8fce", "#85c1e9"
   ];

   // Global mapping to ensure consistent colors across all rows
   window.globalModelColors = window.globalModelColors || {};
   window._globalColorIndex = typeof window._globalColorIndex === 'number' ? window._globalColorIndex : 0;

   // Function to get consistent color for a model
   function getGlobalModelColor(modelNo) {
     if (!window.globalModelColors[modelNo]) {
       const idx = window._globalColorIndex || 0;
       window.globalModelColors[modelNo] = window.GLOBAL_COLOR_PALETTE[idx % window.GLOBAL_COLOR_PALETTE.length];
       window._globalColorIndex = idx + 1;
     }
     return window.globalModelColors[modelNo];
   }
   
   // Initialize global colors on page load by scanning all model data
   function initializeGlobalModelColors() {
     console.log('ðŸŽ¨ Initializing global model colors...');
     
     // Collect all unique models from all rows
     const allModels = new Set();
     
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         modelList.forEach(model => allModels.add(model));
       } catch (e) {
         console.warn('Error parsing model list:', e);
       }
     });
     
     // Assign colors to all models consistently
     const sortedModels = Array.from(allModels).sort(); // Sort for consistency
     sortedModels.forEach(function(modelNo) {
       getGlobalModelColor(modelNo); // This will assign colors in order
     });
     
     console.log('ðŸŽ¨ Global model colors initialized:', window.globalModelColors);
     
     // Update all existing model circles with consistent colors
     updateAllModelCircles();
   }
   
   // Function to update all model circles with consistent colors
   function updateAllModelCircles() {
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         const circles = cell.querySelectorAll('.model-circle');
         
         circles.forEach(function(circle, index) {
           if (modelList[index]) {
             const color = getGlobalModelColor(modelList[index]);
             circle.style.backgroundColor = color;
           }
         });
       } catch (e) {
         console.warn('Error updating model circles:', e);
       }
     });
   }

   document.addEventListener("DOMContentLoaded", function () {
     // Initialize global colors first
     initializeGlobalModelColors();
     
     const modal = document.getElementById('modelRemarkModal');
     const closeBtn = document.getElementById('closeModelRemarkModal');
     const modalContent = document.getElementById('modelRemarkModalContent');
   
     document.querySelectorAll('.expand-model-remark').forEach(function(expandBtn) {
       expandBtn.addEventListener('click', function(e) {
         e.stopPropagation();
         const cell = expandBtn.closest('.model-stock-no-cell');
         if (!cell) return;
   
         try {
           const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
           const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
           const modelColors = JSON.parse(cell.getAttribute('data-model-colors') || '{}');
           
           console.log('ðŸ” Modal Debug Info:');
           console.log('   modelList:', modelList);
           console.log('   modelImages:', modelImages);
           console.log('   modelColors:', modelColors);
           
           // Clear previous content
           modalContent.innerHTML = '';
           
           if (modelList.length === 0) {
             modalContent.innerHTML = '<p style="text-align:center; color:#666;">No models available</p>';
           } else {
             modelList.forEach(function(modelNo, index) {
               const color = getGlobalModelColor(modelNo);
               
               // FIXED: Get images using the correct data structure
               let images = [];
               let firstImage = '/static/assets/images/imagePlaceholder.png';
               
               // Check multiple possible data structures for images
               if (modelImages[modelNo]) {
                 if (Array.isArray(modelImages[modelNo])) {
                   // Direct array of image URLs
                   images = modelImages[modelNo];
                   firstImage = images[0] || firstImage;
                 } else if (modelImages[modelNo].images && Array.isArray(modelImages[modelNo].images)) {
                   // Object with 'images' property
                   images = modelImages[modelNo].images;
                   firstImage = images[0] || firstImage;
                 } else if (modelImages[modelNo].first_image) {
                   // Object with 'first_image' property
                   firstImage = modelImages[modelNo].first_image;
                   images = modelImages[modelNo].images || [firstImage];
                 } else if (typeof modelImages[modelNo] === 'string') {
                   // Single image URL as string
                   images = [modelImages[modelNo]];
                   firstImage = modelImages[modelNo];
                 }
               }
               
               console.log(`ðŸ“¸ Model ${modelNo} images:`, images);
               console.log(`ðŸ“¸ Model ${modelNo} firstImage:`, firstImage);
               
               // Create model row container
               const modelRow = document.createElement('div');
               modelRow.className = 'model-row';
               modelRow.style.cssText = `
                 display: flex;
                 align-items: flex-start;
                 gap: 12px;
                 margin-bottom: 16px;
                 padding: 12px;
                 border: 1px solid #e5e5e5;
                 border-radius: 8px;
                 background: #fafafa;
                 transition: all 0.2s ease;
                 cursor: pointer;
               `;
               
               // Add hover effect
               modelRow.addEventListener('mouseenter', function() {
                 this.style.background = '#f0f8ff';
                 this.style.borderColor = '#007bff';
                 this.style.transform = 'translateY(-1px)';
                 this.style.boxShadow = '0 4px 12px rgba(0,123,255,0.15)';
               });
               
               modelRow.addEventListener('mouseleave', function() {
                 this.style.background = '#fafafa';
                 this.style.borderColor = '#e5e5e5';
                 this.style.transform = 'translateY(0)';
                 this.style.boxShadow = 'none';
               });
               
               // Add navigation on click with correct model_no extraction
               modelRow.addEventListener('click', function() {
                 const cleanModelNo = extractModelNumber(modelNo);
                 const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
                 console.log(`ðŸ”— Navigating to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
                 console.log(`ðŸ”— URL: ${visualAidUrl}`);
                 window.open(visualAidUrl, '_blank');
               });
               
               // Model circle
               const circle = document.createElement('span');
               circle.className = 'model-circle';
               circle.style.cssText = `
                 display: inline-block;
                 width: 20px;
                 height: 20px;
                 border-radius: 50%;
                 background-color: ${color};
                 border: 2px solid #fff;
                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                 flex-shrink: 0;
                 margin-top: 2px;
               `;
               
               // Content container
               const contentContainer = document.createElement('div');
               contentContainer.style.cssText = `
                 flex: 1;
                 min-width: 0;
               `;
               
               // Model number
               const modelNoElement = document.createElement('div');
               modelNoElement.className = 'model-no';
               modelNoElement.textContent = modelNo;
               modelNoElement.style.cssText = `
                 font-weight: 700;
                 color: #023E4DCC;
                 font-size: 16px;
                 margin-bottom: 8px;
                 word-break: break-word;
               `;
               
               // Images container
               const imagesContainer = document.createElement('div');
               imagesContainer.style.cssText = `
                 display: flex;
                 flex-wrap: wrap;
                 gap: 8px;
                 margin-top: 8px;
               `;
               
               if (images.length > 0) {
                 console.log(`ðŸ“¸ Displaying ${images.length} images for model ${modelNo}`);
                 
                 images.slice(0, 3).forEach(function(imageUrl, imgIndex) {
                   const img = document.createElement('img');
                   img.src = imageUrl;
                   img.alt = `${modelNo} - Image ${imgIndex + 1}`;
                   img.style.cssText = `
                     width: 200px;
                     height: 200px;
                     object-fit: cover;
                     border-radius: 6px;
                     border: 1px solid #ddd;
                     background: #fff;
                     transition: transform 0.2s ease;
                     cursor: pointer;
                   `;
                   
                   // Add click handler to show full image viewer
                   img.addEventListener('click', function(e) {
                     e.stopPropagation(); // Prevent row click
                     showModelImages(modelNo, JSON.stringify(images));
                   });
                   
                   img.addEventListener('mouseenter', function() {
                     this.style.transform = 'scale(1.1)';
                   });
                   
                   img.addEventListener('mouseleave', function() {
                     this.style.transform = 'scale(1)';
                   });
                   
                   // Handle image load errors
                   img.addEventListener('error', function() {
                     this.src = '/static/assets/images/imagePlaceholder.png';
                     this.style.opacity = '0.5';
                   });
                   
                   imagesContainer.appendChild(img);
                 });
                 
                 if (images.length > 3) {
                   const moreIndicator = document.createElement('div');
                   moreIndicator.textContent = `+${images.length - 3} more`;
                   moreIndicator.style.cssText = `
                     display: flex;
                     align-items: center;
                     justify-content: center;
                     width: 50px;
                     height: 50px;
                     background: #f8f9fa;
                     border: 1px solid #ddd;
                     border-radius: 6px;
                     font-size: 10px;
                     color: #666;
                     font-weight: 600;
                     cursor: pointer;
                   `;
                   
                   moreIndicator.addEventListener('click', function(e) {
                     e.stopPropagation();
                     showModelImages(modelNo, JSON.stringify(images));
                   });
                   
                   imagesContainer.appendChild(moreIndicator);
                 }
               } else {
                 console.log(`âŒ No images found for model ${modelNo}`);
                 const noImageIndicator = document.createElement('div');
                 noImageIndicator.textContent = 'No Images';
                 noImageIndicator.style.cssText = `
                   width: 50px;
                   height: 50px;
                   background: #f8f9fa;
                   border: 1px solid #ddd;
                   border-radius: 6px;
                   display: flex;
                   align-items: center;
                   justify-content: center;
                   font-size: 10px;
                   color: #999;
                 `;
                 imagesContainer.appendChild(noImageIndicator);
               }
               
               // Click to view indicator
               const clickIndicator = document.createElement('div');
               clickIndicator.innerHTML = 'ðŸ”— Click to view in Visual Aid';
               clickIndicator.style.cssText = `
                 font-size: 11px;
                 color: #007bff;
                 margin-top: 6px;
                 font-style: italic;
               `;
               
               // Assemble the row
               contentContainer.appendChild(modelNoElement);
               contentContainer.appendChild(imagesContainer);
               contentContainer.appendChild(clickIndicator);
               
               modelRow.appendChild(circle);
               modelRow.appendChild(contentContainer);
               
               modalContent.appendChild(modelRow);
             });
           }
           
           modal.style.display = 'block';
         } catch (error) {
           console.error('Error showing model gallery:', error);
           modalContent.innerHTML = '<p style="text-align:center; color:#dc3545;">Error loading model data</p>';
           modal.style.display = 'block';
         }
       });
     });
   
     closeBtn.addEventListener('click', function() {
       modal.style.display = 'none';
     });
     
     window.addEventListener('click', function(e) {
       if (modal.style.display === 'block' && !modal.contains(e.target) && !e.target.classList.contains('expand-model-remark')) {
         modal.style.display = 'none';
       }
     });
   });
   
   // Function to extract clean model number from complex model strings
   function extractModelNumber(modelString) {
     console.log(`ðŸ” Extracting model number from: "${modelString}"`);
     
     if (!modelString || typeof modelString !== 'string') {
       console.log('âŒ Invalid model string, returning as-is');
       return modelString;
     }
     
     // Pattern 1: Extract leading digits (e.g., "1805SSA02" -> "1805")
     const leadingDigitsMatch = modelString.match(/^(\d+)/);
     if (leadingDigitsMatch) {
       const extracted = leadingDigitsMatch[1];
       console.log(`âœ… Extracted using leading digits pattern: "${extracted}"`);
       return extracted;
     }
     
     // Pattern 2: Extract model before first letter (e.g., "2617ABC" -> "2617")
     const beforeLetterMatch = modelString.match(/^(\d+)(?=[A-Za-z])/);
     if (beforeLetterMatch) {
       const extracted = beforeLetterMatch[1];
       console.log(`âœ… Extracted using before-letter pattern: "${extracted}"`);
       return extracted;
     }
     
     // Pattern 3: Extract digits before any special characters
     const beforeSpecialMatch = modelString.match(/^(\d+)(?=\W)/);
     if (beforeSpecialMatch) {
       const extracted = beforeSpecialMatch[1];
       console.log(`âœ… Extracted using before-special pattern: "${extracted}"`);
       return extracted;
     }
     
     // If no pattern matches, return the original string
     console.log(`âš ï¸ No extraction pattern matched, returning original: "${modelString}"`);
     return modelString;
   }
   
   // Enhanced function to show model images in a larger view with navigation
   function showModelImages(modelNo, imagesJson) {
     try {
       const images = JSON.parse(imagesJson);
       if (images.length === 0) {
         // If no images, directly navigate to visual aid with cleaned model number
         const cleanModelNo = extractModelNumber(modelNo);
         const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
         console.log(`ðŸ”— No images found, navigating directly to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
         window.open(visualAidUrl, '_blank');
         return;
       }
       
       // Get the consistent global color for this model
       const modelColor = getGlobalModelColor(modelNo);
       
       // Create image viewer modal
       let imageModal = document.getElementById('modelImageViewer');
       if (!imageModal) {
         imageModal = document.createElement('div');
         imageModal.id = 'modelImageViewer';
         imageModal.style.cssText = `
           position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
           background: rgba(0,0,0,0.9); z-index: 100000; display: none;
           justify-content: center; align-items: center;
         `;
         document.body.appendChild(imageModal);
       }
       
       let currentIndex = 0;
       
       function updateImage() {
         const cleanModelNo = extractModelNumber(modelNo);
         
         imageModal.innerHTML = `
           <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 12px; padding: 20px;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
               <div style="display: flex; align-items: center; gap: 10px;">
                 <span class="model-circle" style="background:${modelColor};width:20px;height:20px;display:inline-block;border-radius:50%;"></span>
                 <h3 style="margin: 0; color: ${modelColor};">Model: ${modelNo} (${currentIndex + 1}/${images.length})</h3>
               </div>
               <div style="display: flex; gap: 10px;">
                 <button onclick="window.open('/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}', '_blank')" 
                         style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                   ðŸ”— Open Visual Aid
                 </button>
                 <button onclick="document.getElementById('modelImageViewer').style.display='none'" 
                         style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 18px;">
                   âœ•
                 </button>
               </div>
             </div>
             <div style="position: relative;">
               <img src="${images[currentIndex]}" alt="Model ${modelNo}" 
                    style="max-width: 100%; max-height: 70vh; object-fit: contain; display: block; margin: 0 auto;"
                    onerror="this.src='/static/assets/images/imagePlaceholder.png'; this.style.opacity='0.5';">
               ${images.length > 1 ? `
                 <button onclick="prevImage()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€¹</button>
                 <button onclick="nextImage()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€º</button>
               ` : ''}
             </div>
             <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
               Click "Open Visual Aid" to view detailed information about this model
             </div>
           </div>
         `;
       }
       
       window.prevImage = function() {
         if (currentIndex > 0) {
           currentIndex--;
           updateImage();
         }
       };
       
       window.nextImage = function() {
         if (currentIndex < images.length - 1) {
           currentIndex++;
           updateImage();
         }
       };
       
       updateImage();
       imageModal.style.display = 'flex';
       
     } catch (error) {
       console.error('Error showing images:', error);
       // Fallback: navigate to visual aid with cleaned model number
       const cleanModelNo = extractModelNumber(modelNo);
       const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
       window.open(visualAidUrl, '_blank');
     }
   }
</script>

<!-- Rest of your existing scripts -->
<script nonce="{{ csp_nonce }}">
   // Helper: Remove image tooltips on hover when modal is open
   function removeModelImageTooltip() {
     document.querySelectorAll('.model-image-tooltip').forEach(function(tip) {
       tip.remove();
     });
   }
   
   document.addEventListener("DOMContentLoaded", function () {
     // Mouse hover for tooltip functionality
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell, i) {
       const textSpan = cell.querySelector('.model-stock-no-text');
       if (!textSpan) return;
       
       let tooltip = null;
       let hideTimeout = null;
       let staticTooltip = null;
       
       try {
         const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         
         textSpan.addEventListener('mouseenter', function(e) {
           if (e.target.closest('.expand-model-remark')) return;
           if (staticTooltip) return;
           if (tooltip) tooltip.remove();
           
           // Create tooltip with first model's first image
           if (modelList.length > 0) {
             const firstModel = modelList[0];
             const firstModelImages = modelImages[firstModel] || {};
             const firstImage = firstModelImages.first_image || '/static/assets/images/imagePlaceholder.png';
             
             tooltip = document.createElement('div');
             tooltip.className = 'model-image-tooltip';
             tooltip.innerHTML = `
               <div style="text-align: center;">
                 <img src="${firstImage}" alt="${firstModel}" style="max-width: 150px; max-height: 150px; object-fit: contain;" />
                 <div style="margin-top: 8px; font-weight: 600; color: #023E4DCC;">${firstModel}</div>
                 ${modelList.length > 1 ? `<div style="font-size: 12px; color: #666;">+${modelList.length - 1} more models</div>` : ''}
               </div>
             `;
             
             document.body.appendChild(tooltip);
             tooltip.style.display = 'block';
             const rect = textSpan.getBoundingClientRect();
             tooltip.style.top = (window.scrollY + rect.bottom + 6) + 'px';
             tooltip.style.left = (window.scrollX + rect.left) + 'px';
           }
         });
         
         textSpan.addEventListener('mouseleave', function() {
           if (staticTooltip) return;
           hideTimeout = setTimeout(() => { if (tooltip) { tooltip.remove(); tooltip = null; } }, 150);
         });
         
       } catch (error) {
         console.error('Error setting up tooltip for cell', i, error);
       }
     });
   });
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  // Get all table rows
  document.querySelectorAll("#order-listing tbody tr").forEach(function (row) {
    // For Jig Unloading Zone 2, plating color is in the 6th column (index 5)
    // Column structure: S.No(0), JIG ID(1), Last Updated(2), Model Presents(3), Polishing Stk No(4), Plating Color(5)
    var cell = row.children[5]; // Plating Color column
    
    if (!cell) return;

    var colorText = (cell.textContent || "")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
    console.log("Normalized colorText:", colorText);

    if (!colorText || colorText === "n/a") return;

    var colorMap = {
      black: {
        bg: "linear-gradient(135deg, #222 60%, #555 100%)",
        border: "#888",
      },
      ips: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #bdbdbd 100%)",
        border: "#757575",
      },
      ipg: {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffe066 100%)",
        border: "#bfa600",
      },
      "ip-gun": {
        bg: "linear-gradient(135deg, #4b4b4b 60%, #a6a6a6 100%)",
        border: "#333",
      },
      "ip-brown": {
        bg: "linear-gradient(135deg, #b97a56 60%, #ffe066 100%)",
        border: "#8d5524",
      },
      rg: {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      ipsipg: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-blue m": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ipsipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "rg-bi": {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      "ipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "ipsipg-hn": {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-corn.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-titanium": {
        bg: "linear-gradient(135deg, #8a8a8a 60%, #bdbdbd 100%)",
        border: "#666",
      },
      "ipg-half.n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      anodising: {
        bg: "linear-gradient(135deg, #ff7f50 60%, #ff4500 100%)",
        border: "#cc3700",
      },
      "ip-blue inh": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-br anti": {
        bg: "linear-gradient(135deg, #b97a56 60%, #8d5524 100%)",
        border: "#8d5524",
      },
      "ip-bronze": {
        bg: "linear-gradient(135deg, #cd7f32 60%, #d2b48c 100%)",
        border: "#8b4513",
      },
      "ip-ch.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-sil anti": {
        bg: "linear-gradient(135deg, #c0c0c0 60%, #f5f5f5 100%)",
        border: "#888",
      },
      "ip-lcr": {
        bg: "linear-gradient(135deg, #ff4500 60%, #ff6347 100%)",
        border: "#cc3700",
      },
      "ip-ogr": {
        bg: "linear-gradient(135deg, #228b22 60%, #32cd32 100%)",
        border: "#006400",
      },
      "ip-ice blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-plum": {
        bg: "linear-gradient(135deg, #dda0dd 60%, #ee82ee 100%)",
        border: "#800080",
      },
      "ip-titanium blue": {
        bg: "linear-gradient(135deg, #4682b4 60%, #5f9ea0 100%)",
        border: "#2c5d72",
      },
    };

    var match = Object.keys(colorMap).find(function (key) {
      return colorText === key || colorText.includes(key);
    });
    console.log("Matched key:", match);

    var oldCircle = cell.querySelector(".plating-color-indicator");
    if (oldCircle) oldCircle.remove();

    if (match) {
      console.log("Creating indicator for:", match);
      var style = colorMap[match];
      var circle = document.createElement("span");
      circle.className = "plating-color-indicator";
      circle.style.display = "inline-block";
      circle.style.width = "16px";
      circle.style.height = "16px";
      circle.style.borderRadius = "50%";
      circle.style.marginRight = "6px";
      circle.style.verticalAlign = "middle";
      if (style.bg.startsWith("linear-gradient")) {
        circle.style.background = "";
        circle.style.backgroundImage = style.bg;
      } else {
        circle.style.background = style.bg;
      }
      circle.style.border = "1px solid " + style.border;
      cell.insertBefore(circle, cell.firstChild);
    }
  });
});
</script>

<!-- Professional Color Verification and Auto-Focus Script -->
<script nonce="{{ csp_nonce }}">
// ðŸŽ¨ Professional Color Verification UI Update Function
function updateColorVerificationUI(platingColor, trayIdColor, trayIdPrefix, modelNumber, platingStkNo, multipleModels) {
  const colorIndicator = document.getElementById('platingColorIndicator');
  const colorText = document.getElementById('platingColorText');
  const statusBadge = document.getElementById('colorStatusBadge');
  const trayRouting = document.getElementById('trayRouting');

  if (!colorIndicator || !colorText || !statusBadge || !trayRouting) {
    console.log('âš ï¸ Color verification UI elements not found');
    return;
  }
  
  // Create status text with plating stock number and model type
  const modelType = multipleModels ? 'Multiple Models' : 'Single Model';
  const displayText = platingStkNo && platingStkNo !== 'No Plating Stock No' ? 
    `${platingStkNo} - ${modelType}` : 
    modelNumber ? `${modelNumber} - ${modelType}` : modelType;
  
  // Default values if no plating color provided
  if (!platingColor || platingColor === 'Unknown') {
    colorIndicator.style.background = '#6c757d';
    colorText.textContent = 'Unknown Color';
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#6c757d';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone Detection...';
    return;
  }
  
  // Set indicator color and text based on plating color
  colorText.textContent = platingColor;
  
  if (platingColor === 'IPS') {
    colorIndicator.style.background = '#dc3545'; // Red
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#dc3545';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone 1 (Red Tray)';
    trayRouting.style.color = '#dc3545';
  } else if (platingColor && (platingColor.includes('Bi') || platingColor.includes('bi'))) {
    colorIndicator.style.background = '#90EE90'; // Light Green
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#90EE90';
    statusBadge.style.color = '#333';
    trayRouting.textContent = 'Light Green Tray';
    trayRouting.style.color = '#90EE90';
  } else {
    colorIndicator.style.background = '#28a745'; // Dark Green
    statusBadge.textContent = displayText;
    statusBadge.style.background = '#28a745';
    statusBadge.style.color = '#fff';
    trayRouting.textContent = 'Zone 2 (Dark Green Tray)';
    trayRouting.style.color = '#28a745';
  }
  
  console.log('ðŸŽ¨ Color verification UI updated:', {
    platingColor,
    trayIdColor,
    trayIdPrefix,
    modelNumber,
    platingStkNo,
    multipleModels,
    displayText
  });
}

// Enhanced auto-focus function for tray ID inputs (Zone 2)
function enableTrayIdAutoFocus() {
  const uploadModal = document.getElementById('uploadChildModal');
  if (!uploadModal) {
    console.log('âš ï¸ Upload modal not found for auto-focus');
    return;
  }

  // Wait for modal to be fully visible and populated
  setTimeout(() => {
    // Look for the first tray ID input (typically the top tray)
    const firstTrayIdInput = uploadModal.querySelector('.jig-loading-table input[type="text"]:not([readonly]):not([disabled])');
    
    if (firstTrayIdInput) {
      // Clear any existing content and focus
      firstTrayIdInput.value = '';
      firstTrayIdInput.focus();
      firstTrayIdInput.select();
      
      // Add visual indicator
      firstTrayIdInput.style.boxShadow = '0 0 8px rgba(0, 123, 255, 0.5)';
      firstTrayIdInput.style.borderColor = '#007bff';
      
      console.log('ðŸŽ¯ Zone 2 - Auto-focused on first tray input:', firstTrayIdInput);
      
      // Remove visual indicator after 2 seconds
      setTimeout(() => {
        if (firstTrayIdInput.style.boxShadow === '0 0 8px rgba(0, 123, 255, 0.5)') {
          firstTrayIdInput.style.boxShadow = '';
          firstTrayIdInput.style.borderColor = '';
        }
      }, 2000);
    } else {
      console.log('âš ï¸ Zone 2 - No tray ID input found for auto-focus');
    }
  }, 400); // Increased delay to ensure modal is fully rendered
}

// Add event listener to call auto-focus when modal is shown
document.addEventListener('DOMContentLoaded', function() {
  const observer = new MutationObserver(function(mutations) {
    mutations.forEach(function(mutation) {
      if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
        const uploadModal = document.getElementById('uploadChildModal');
        if (uploadModal && uploadModal.style.display === 'flex') {
          enableTrayIdAutoFocus();
        }
      }
    });
  });
  
  // Start observing when DOM is ready
  setTimeout(() => {
    const uploadModal = document.getElementById('uploadChildModal');
    if (uploadModal) {
      observer.observe(uploadModal, { attributes: true });
    }
  }, 1000);

  // --- CLIENT HELPERS: tray prefix validation and modal-scoped scanned set (Zone 2) ---
  (function(){
    try {
      const uploadModal = document.getElementById('uploadChildModal');
      if (uploadModal && !uploadModal._scannedTrays) uploadModal._scannedTrays = new Set();

      function allowedPrefixesFor(platingColor, trayType) {
        const color = String(platingColor || '').toUpperCase();
        const type = String(trayType || '').toLowerCase();
        if (color === 'IPS') return type === 'jumbo' ? ['JR'] : ['NR'];
        if (color.includes('BI') || color.includes('BIC') || color.includes('BI-')) return type === 'jumbo' ? ['JL'] : ['NL'];
        return type === 'jumbo' ? ['JD'] : ['ND'];
      }

      window.validateTrayPrefixLocalZone2 = function(trayId, platingColor, trayType) {
        if (!trayId) return { valid: false, reason: 'Empty tray id' };
        const prefix = String(trayId || '').split('-')[0] || '';
        const allowed = allowedPrefixesFor(platingColor, trayType);
        const candidate = prefix.toUpperCase().slice(0,2);
        if (allowed.includes(candidate)) return { valid: true };
        return { valid: false, reason: `Invalid prefix '${candidate}'. Expected: ${allowed.join(', ')}` };
      };

      window.maybeValidateTrayIdZone2 = function(trayInputEl) {
        try {
          const trayId = trayInputEl && trayInputEl.value && trayInputEl.value.trim();
          const uploadModal = document.getElementById('uploadChildModal');
          const platingColor = uploadModal ? uploadModal.getAttribute('data-plating-color') : '';
          const trayType = uploadModal ? uploadModal.getAttribute('data-tray-type') : '';
          const prefRes = window.validateTrayPrefixLocalZone2(trayId, platingColor, trayType);
          if (!prefRes.valid) {
            if (typeof showTrayValidationMessage === 'function') showTrayValidationMessage(trayInputEl, 'error', prefRes.reason);
            return Promise.resolve({ success: false, error: prefRes.reason });
          }
          if (uploadModal && uploadModal._scannedTrays && uploadModal._scannedTrays.has(trayId.toLowerCase())) {
            if (typeof showTrayValidationMessage === 'function') showTrayValidationMessage(trayInputEl, 'info', `${trayId} already validated`);
            return Promise.resolve({ success: true, duplicate: true });
          }
          if (typeof validateTrayIdZone2 === 'function') {
            return validateTrayIdZone2(trayInputEl).then(resp => {
              if (resp && resp.success && uploadModal && uploadModal._scannedTrays) uploadModal._scannedTrays.add(trayId.toLowerCase());
              return resp;
            });
          }
          return Promise.resolve({ success: true });
        } catch (e) {
          console.error('maybeValidateTrayIdZone2 error', e);
          return Promise.resolve({ success: false, error: String(e) });
        }
      };
    } catch (e) {
      console.warn('Zone2 Tray helper init failed', e);
    }
  })();
});
</script>
{% endblock %}
{% endblock content %}