  {% extends "base.html" %} {% load static %} {% block content %}
<style>
  /* Fix for draft table alignment issues */

/* Ensure consistent grid layout for both normal and draft modes */
#trayScanDetails_NI.table-grid,
#trayScanDetails.table-grid {
  display: grid !important;
  grid-template-columns: repeat(3, 1fr) !important;
  gap: 1px !important;
  max-height: 400px !important;
  overflow-y: auto !important;
  padding-right: 10px;
  margin-top: 10px;
  border: 1px solid #ddd;
}

/* Remove conflicting grid column settings */
#trayScanDetails_NI {
  /* Remove the 1fr 1fr setting that conflicts with 3-column layout */
}

/* Ensure all grid items have consistent styling */
#trayScanDetails_NI.table-grid > div,
#trayScanDetails.table-grid > div {
  border: 1px solid #ccc;
  padding: 8px;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  min-height: 40px;
}

/* Header styling for grid items */
#trayScanDetails_NI.table-grid > div:nth-child(-n + 3),
#trayScanDetails.table-grid > div:nth-child(-n + 3) {
  background-color: #f8f9fa;
  font-weight: 600;
  border-bottom: 2px solid #dee2e6;
}

/* Input styling within grid */
#trayScanDetails_NI.table-grid input,
#trayScanDetails.table-grid input {
  width: 90%;
  border: 1px solid #ddd;
  padding: 4px 8px;
  border-radius: 4px;
  text-align: center;
}

/* Draft mode specific styling */
#trayScanDetails_NI.table-grid input[style*="background-color: #f0f8ff"] {
  background-color: #f0f8ff !important;
  border-color: #007bff;
}

/* Button container that spans all columns */
#trayScanDetails_NI.table-grid > div[style*="grid-column: 1 / -1"],
#trayScanDetails.table-grid > div[style*="grid-column: 1 / -1"] {
  grid-column: 1 / -1;
  border: none;
  background: transparent;
  padding: 20px 0;
}

/* Ensure proper grid layout on different screen sizes */
@media (max-width: 768px) {
  #trayScanDetails_NI.table-grid,
  #trayScanDetails.table-grid {
    grid-template-columns: 1fr 2fr 1fr !important;
    font-size: 12px;
  }
  
  #trayScanDetails_NI.table-grid > div,
  #trayScanDetails.table-grid > div {
    padding: 4px;
    min-height: 35px;
  }
}
  .tray-scan-modal-BQ {
  position: fixed;
  top: 0;
  right: -600px; /* Hidden by default */
  width: 600px;
  height: 100%;
  background: white;
  box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
  overflow-y: auto;
  transition: right 0.3s ease;
  z-index: 9999;
  padding: 20px;
  font-family: Arial, sans-serif;
  border-radius: 12px 0 0 12px;
}

.tray-scan-modal-BQ.open {
  right: 0; /* Slide in */
}

.tray-scan-modal-BQ-content {
  position: relative;
  height: 100%;
}
/* Compact table rows for tray scan modal */
#trayScanModal_BQ_ReadOnly table.table-sm > tbody > tr,
#trayScanModal_BQ_ReadOnly table.table-sm > thead > tr {
  height: 26px !important;
  min-height: 22px !important;
  padding: 0 !important;
}

#trayScanModal_BQ_ReadOnly table.table-sm td,
#trayScanModal_BQ_ReadOnly table.table-sm th {
  padding: 2px 6px !important;
  font-size: 13px !important;
  line-height: 1.2 !important;
  vertical-align: middle !important;
}

#trayScanModal_BQ_ReadOnly input.form-control {
  padding: 2px 4px !important;
  font-size: 13px !important;
  height: 22px !important;
  min-height: 20px !important;
}

 .dp-row-action-highlight {
    background-color: #b3e6ff !important; /* Light blue */
    /* Remove box-shadow for no border */
    box-shadow: none !important;
    transition: background 0.3s;
  }
.dp-row-cancel-highlight {
  background-color: #b3e6ff !important; /* Light red */
  
  transition: background 0.3s, box-shadow 0.3s;
}
  /* Base Styles for Popups */
  .avatar-group {
  display: flex;
  align-items: center;
}

.avatar {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  color: white;
  font-weight: bold;
  font-family: Arial, sans-serif;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: -3px;
  z-index: 1;
  box-shadow: 0 0 0 2px white;
}

.avatar:first-child {
  margin-left: 0;
}

.blue   { background-color: #1e88e5; } /* D */
.green  { background-color: #43a047; } /* S */
.purple { background-color: #8e24aa; } /* T */
.orange { background-color: #fb8c00; } /* F */
.teal   { background-color: #4dd0e1; } /* A */
.gray   {
    background-color: #d3d3d3;
    color: #666;
    font-size: 20px;
    margin-left: 5px;
    width: 10px;
    height: 10px;
}

.arrow {
    font-size: 10px;
    line-height: 1;
    align-items: center;
    display: flex;
    justify-content: center;
    margin-top: -3px;
}
 /* Add smooth transition for margin and scaling */
                            .avatar {
                                transition: margin 0.3s ease, transform 0.3s ease;
                            }
                            /* When hovering over the avatar group, adjust the margin to show full circles */
                            .avatar-group:hover .avatar:not(:first-child) {
                                margin-left: 5px;
                            }
                            /* Additionally, scale up individual avatar on hover */
                            .avatar:hover {
                                transform: scale(1.1);
                            }
  /* Rejection Popup Modal Styling */
  .new-popup-modal {
    display: none;
    position: fixed;
    top: 50px;
    right: 20px;
    width: 400px;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    padding: 20px;
    z-index: 10000;
    transition: right 0.3s ease, opacity 0.3s ease;
  }
  .new-popup-modal.open {
    display: block;
  }
  .tray-scan-close {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    color: #666;
  }
  .tray-scan-close:hover {
    color: #333;
  }
  /* Modal Header */
  .modal-title {
    margin-top: 0;
    margin-bottom: 15px;
    padding-bottom: 8px;
    border-bottom: 2px solid #117057;
    color: #117057;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    font-size: 18px;
  }
  /* Rejection Content & Table Styles */
  .rejection-content {
    max-height: 300px;
    overflow-y: auto;
  }
  .rejection-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  .rejection-table th,
  .rejection-table td {
    border: 1px solid #ddd;
    padding: 10px;
    text-align: center;
    font-size: 14px;
  }
  .rejection-table thead {
    background-color: #117057;
    color: #fff;
  }
  .rejection-table tbody tr:nth-child(even) {
    background-color: #f8f8f8;
  }
/* Center and style the tray scan table title */
   
        /* Modal backdrop */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
        }

        /* Show modal when targeted */
        .modal:target {
            display: block;
        }

        /* Modal content box */
        .modal-content {
            position: relative;
            background: white;
            width: 50%;
            margin: 10% auto;
            padding: 20px;
            border-radius: 10px;
        }

        /* Close button */
        .close-btn {
            position: absolute;
            top: 10px;
            right: 15px;
            text-decoration: none;
            font-size: 24px;
            color: #333;
        }

        .close-btn:hover {
            color: red;
        }

        /* Icon link styling */
        .view-icon {
            width: 20px !important;
            height: 20px !important;
            cursor: pointer;
            margin-right: 8px;
        }
 #order-listing thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important; /* existing bg */
  color: #e5fcff !important;      /* existing color */
  vertical-align: middle !important;
  
}
thead th {
  height: 38px !important; /* Increase as needed */
  background: #028084 !important; /* existing bg */
  color: #e5fcff !important;      /* existing color */
  vertical-align: middle !important;
  
}
    /* --- DP_PickTable: Match DP_Completed_Table style --- */
  #order-listing {
    border-collapse: collapse;
  }
  #order-listing th,
  #order-listing td {
    border-right: 1px solid #d1d1d1;
    border-bottom: 1px solid #e0e0e0;
    font-size: 12px;
  }
  #order-listing th:last-child,
  #order-listing td:last-child {
    border-right: none;
  }
  #order-listing tr,
  #order-listing td,
  #order-listing th {
    height: 20px !important;
    padding: 4px 8px !important;
  }
  .content-wrapper {
    transition: opacity 0.3s ease;
    padding-bottom: 20px !important; /* Reduce space above footer */
  }
  .tray-scan-modal,
  .new-popup-modal {
    position: fixed;
    top: 0;
    width: 400px;
    height: 100%;
    background: white;
    box-shadow: -3px 0 10px rgba(0, 0, 0, 0.2);
    overflow-y: auto;
    transition: right 0.3s ease, width 0.3s ease, padding 0.3s ease;
    padding: 20px;
    font-family: Arial, sans-serif;
  }
  .tray-scan-modal {
    right: -400px; /* hidden by default */
    z-index: 9999;
  }
  .tray-scan-modal.open {
    right: 400px; /* When open, sits next to New Popup */
  }
  .new-popup-modal {
    right: -440px; /* hidden by default */
    z-index: 10000;
  }
  .new-popup-modal.open {
    right: 0; /* When open, slides in from the right */
  }
  .tray-scan-close {
    position: absolute;
    right: 10px;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
  }
  .modal-top-header {
    display: flex;
    align-items: center;
    gap: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid #ddd;
    margin-bottom: 12px;
  }
  #trayScanDetails.table-grid {
    display: grid !important; /* override any existing grid or flex */
    grid-template-columns: repeat(3, 1fr) !important;
    gap: 0px !important;
    max-height: 300px !important;
    overflow-y: auto !important;
    padding-right: 10px; /* prevent scrollbar overlay */
    margin-top: 10px;
  }
 
  /* Sticky header row: first 3 divs inside trayScanDetails */
  #trayScanDetails.table-grid > div:nth-child(-n + 3) {
    background-color: #e0e0e0;
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 2;
    align-items: center;
  }
  /* Override only when modal is open */
  .tray-scan-modal.open {
    width: 600px; /* your desired expanded width */
    margin-right: 20px;
  }
  /* Keep it hidden with negative offset matching default width */
  .tray-scan-modal {
    right: -500px; /* must match the new width above to stay hidden properly */
  }
  #trayScanModal {
    border-radius: 12px;
    max-height: 90vh;
    top: 40px; /* Moves the entire modal down from the top of the viewport */
    height: calc(100% - 40px); /* Keeps height correct */
  }
  #trayScanDetails {
    grid-template-columns: 1fr 1fr;
    gap: 12px;
  }

  .ms-2{
        margin-top: 8px;
  }
  /* Make each 
   <p> act like a table cell */
  #trayScanDetails p {
    margin: 0;
    padding: 4px 8px;
    background: #f7f7f7;
    border-radius: 6px;
    font-size: 14px;
  }

  /* Responsive adjustments for screens below 768px */
  @media (max-width: 767px) {
    .tray-scan-modal,
    .new-popup-modal {
      width: 100%;
      padding: 10px;
    }
     .tray-scan-modal.open {
    width: 100% !important; /* your desired expanded width */
    margin-right: 0px !important;
  }
    /* On very small screens, stacking is more appropriate */
    .tray-scan-modal.open {
      right: 0;
      top: 0;
    }
    .new-popup-modal.open {
      right: 0;
      top: 0;
      /* Optionally, you can add margin-top to separate them */
      margin-top: 20px;
    }
  }
  /* Responsive adjustments for tablets (768px to 1024px) */
  @media (min-width: 768px) and (max-width: 1024px) {
    .tray-scan-modal,
    .new-popup-modal {
      width: 300px;
      padding: 15px;
    }
    .tray-scan-modal {
      right: -300px;
    }
    .tray-scan-modal.open {
      right: 300px;
    }
    .new-popup-modal {
      right: -300px;
    }
    .new-popup-modal.open {
      right: 0;
    }
  }
  /* ... remaining styles unchanged ... */
  .pagination-wrapper {
    top: 530px;
    right: 20px;
    background: transparent;
    z-index: 999;
    padding: 5px 10px;
    border-radius: 5px;
  }
  @media (min-width: 768px) and (max-width: 1024px) {
    .table-responsive {
      max-height: 800px;
    }
  }
  @media (min-width: 1025px) {
    .table-responsive {
      max-height: 100%;
    }
  }
  @media (min-width: 768px) and (max-width: 1024px) {
    .table-responsive {
      max-height: 600px;
    }
  }
  .table-responsive {
    max-height: 100%;
    overflow-y: auto;
    scrollbar-width: none;
    -ms-overflow-style: none;
  }
  .table-responsive::-webkit-scrollbar {
    display: none;
  }
  thead th {
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 10;
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
  }
  html,
  body {
    height: 100%;
    margin: 0;
    padding: 0;
    overflow: hidden;
  }
  body {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  .content-wrapper {
    flex: 1;
    overflow-y: auto;
    padding-bottom: 70px;
  }
  /* Make the table header sticky */
  thead th {
    position: sticky;
    top: 0;
    background-color: white; /* or your table header bg color */
    z-index: 10; /* ensure it stays above the table rows */
    box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4); /* optional shadow for better separation */
  }
  .card-body {
    width: 100%;
    overflow-x: auto;
    max-height: 400px;
  }
  footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 40px;
  }
  .btn-twitter.btn-social-icon-text i {
    margin-right: 0.5rem !important;
    padding: 0.3rem !important;
    background: #2e7d32;
  }
  .btn-youtube.btn-social-icon-text i {
    margin-right: 0.5rem !important;
    padding: 0.3rem !important;
  }
  /* Modal styles */
  .image-slider-modal {
    display: none;
    position: fixed;
    top: 40px; /* Leaves room at the top */
    right: 20px;
    width: 600px;
    background: #fff;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 20px;
    z-index: 10000;
    transition: right 0.3s ease;
  }
  .image-slider-modal.open {
    display: block;
  }
.model-image-tooltip {
  position: absolute;
  left: 50%;
  top: 110%;
  transform: translateX(-50%);
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  padding: 12px 18px;
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.2s;
}
.img-gallery {
  display: flex;
  gap: 6px;
  overflow: hidden;
  width: 180px;
}

  .modal-close-NI {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
    color: #666;
  }
  .modal-close-NI:hover {
    color: #333;
  }
  /* Slider styles */
  .slider {
    position: relative;
    overflow: hidden;
    height: 350px;
  }
  .slides {
    display: flex;
    transition: transform 0.5s ease;
  }
  .slide {
    flex: 0 0 100%;
    box-sizing: border-box;
    display: none;
  }
  .slide.active {
    display: block;
  }
  .slide img {
    width: 100%;
    height: 350px;
    object-fit: cover;
    display: block;
  }
  .prev,
  .next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.5);
    border: none;
    color: #fff;
    padding: 8px;
    cursor: pointer;
    border-radius: 50%;
    user-select: none;
  }
  .prev { left: 10px; }
  .next { right: 10px; }
  @media (max-width: 767px) {
    .image-slider-modal {
      width: 100%;
      right: 0;
      top: 0;
      border-radius: 0;
      padding: 10px;
    }
    .slider { height: 250px; }
    .slide img { height: 250px; }
  }

</style>

<div class="content-wrapper">
  <h5 class="text-left mt-0 mb-3">Nickel Inspection / Pick Table</h5>
  <div class="row">
    <div class="col-12 grid-margin stretch-card">
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <!-- Table Section -->
            <div class="table-responsive">
              <table id="order-listing" class="table">
                <thead>
                  <tr>
                    <th>
                      S.No <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Date and Time
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      LOT ID
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Model/Stock No
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Plating Color
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Polish Finish
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Version <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Source
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Tray Type Capacity
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      No of Tray <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      LOT Quantity
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>

                    <th>
                      Accept Qty
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                     <th>
                      Ass. User
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Reject Qty<i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Process Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Action <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Batch Status
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Current Location
                      <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>
                    <th>
                      Remarks <i class="fa fa-filter" aria-hidden="true"></i>
                    </th>

                  </tr>
                </thead>
                <tbody>
                  {% for data in nickle_ip %}
                  <tr data-available-qty="{{ data.display_qty|default:'0' }}" 
                      data-stock-lot-id="{{ data.lot_id }}"
                      data-lot-id="{{ data.lot_id }}"
                      data-batch-id="{{ data.batch_id|default:'' }}"
                      data-model-no="{% if data.model_info %}{{ data.model_info.model_no }}{% else %}N/A{% endif %}"
                      data-nickle-ip-onhold-picking="{{ data.nickle_ip_onhold_picking|yesno:'True,False' }}">         
                    <td>{{forloop.counter}}
                       {% if data.rejected_audit_nickle_ip_stock or data.nickle_audit_few_cases_acceptance %}
                      <i class="fa fa-info-circle" style="color: #028084; font-size:13px;" data-bs-toggle="tooltip" data-placement="right" data-bs-original-title="Nickel Audit"></i>
                      {% endif %}

                    </td>
                    <td>{{ data.created_at|date:"Y-m-d H:i:s" }}</td>
                    <td>{{data.lot_id}}</td>
                    <!-- Model/Stock No Column with Dynamic Image Slider -->
                    <td style="position: relative;" class="model-stock-no-cell"
                        data-model-list='["{% if data.model_info %}{{ data.model_info.model_no }}{% else %}N/A{% endif %}"]'
                        data-images='{}' 
                        data-model-colors='{}'>
                      <span class="model-hover-trigger" style="cursor: pointer;">
                        {% if data.model_info %}
                          {{ data.model_info.model_no }}
                        {% else %}
                          N/A
                        {% endif %}
                        <div class="model-image-tooltip">
                          <button class="img-scroll-left" style="background: none; border: none; font-size: 20px; cursor: pointer;">&#8592;</button>
                          <div class="img-gallery">
                            <!-- Images will be loaded dynamically -->
                          </div>
                          <button class="img-scroll-right" style="background: none; border: none; font-size: 20px; cursor: pointer;">&#8594;</button>
                        </div>
                      </span>
                    </td>
                    <!-- Plating Color -->
                  <td>
                    {% if data.model_info and data.model_info.plating_color %}
                      {{ data.model_info.plating_color }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  
                  <!-- Polish Finish -->
                  <td>
                    {% if data.model_info and data.model_info.polish_finish %}
                      {{ data.model_info.polish_finish }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  
                  <!-- Version -->
                  <td>
                    {% if data.model_info and data.model_info.version_name %}
                      {{ data.model_info.version_name }}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  
                  <td>
                    {% if data.model_info %}
                      {% if data.model_info.vendor_name %}
                        {{ data.model_info.vendor_name }}
                      {% else %}
                        {{ data.model_info.vendor_internal|default:"N/A" }}
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>                    
                  <!-- Tray Type Capacity -->
                  <td>
                    {% if data.model_info %}
                      {% if data.model_info.tray_type and data.model_info.tray_capacity %}
                        {{ data.model_info.tray_type }} {{ data.model_info.tray_capacity }}
                      {% elif data.model_info.tray_capacity %}
                        {{ data.model_info.tray_capacity }}
                      {% else %}
                        N/A
                      {% endif %}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
                  
                  <!-- No of Tray -->
                  <td>
                    {% if data.model_info and data.model_info.tray_capacity and data.display_qty %}
                      {% widthratio data.display_qty data.model_info.tray_capacity 1 %}
                    {% else %}
                      N/A
                    {% endif %}
                  </td>
           
                  <!-- Total Quantity -->
              <td>{{ data.display_qty|default:"0" }}</td>

                    <td>
                      {{data.accepted_qty}}
                    </td>
<!-- Replace the existing Ass. User column in your Nickel_Inspection.html -->
<td>
  {% if data.selected_user %}
    <!-- User already assigned - show as readonly -->
    <div style="display: flex; align-items: center; gap: 8px;">
      <span style="
        background: #e8f5e8; 
        border: 1px solid #4caf50; 
        color: #2e7d32; 
        padding: 4px 12px; 
        border-radius: 4px; 
        font-weight: 500;
        font-size: 12px;
      ">
        {{ data.selected_user.username }}
      </span>
      <span style="color: #4caf50; font-size: 12px;">✓ Assigned</span>
    </div>
  {% else %}
    <!-- User not assigned - show dropdown -->
    <select class="form-control user-assignment-dropdown" 
            data-lot-id="{{ data.lot_id }}" 
            style="font-size: 12px; padding: 4px 8px;">
      <option value="">Select User</option>
      <option value="self">Self ({{ request.user.username }})</option>
      {% for user in all_users %}
        <option value="{{ user.id }}">{{ user.username }}</option>
      {% endfor %}
    </select>
  {% endif %}
</td>


                    <td>
                      {{data.reject_qty }}
                    </td>
                   <td>
  <div class="d-flex">
    <!-- Q Circle - Always gray -->
    <div
      title="Tray Scan"
      class="d-flex align-items-center justify-content-center rounded-circle ms-1"
      style="
        width: 20px;
        height: 20px;
        background-color: #c3c2c2;
        color: white;
        font-weight: bold;
        line-height: 20px;
        text-align: center;
        padding-top: 1px;
        padding-right: 1px;
      "
    >
      Q
    </div>
    
    <!-- QC Circle - Green if accepted, gray if not -->
    <div
  title="Quality Control {% if data.unload_accepted or data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance %}(Accepted){% else %}(Pending){% endif %}"
  class="d-flex align-items-center justify-content-center rounded-circle ms-1"
  style="
    width: 20px;
    height: 20px;
    background-color: {% if data.unload_accepted or data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance %}#28a745{% else %}#c3c2c2{% endif %};
    color: white;
    font-weight: bold;
    line-height: 20px;
    text-align: center;
    padding-top: 1px;
    padding-right: 1px;
    {% if data.unload_accepted or data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance  %}
      box-shadow: 0 0 0 2px #d4f7d4;
      border: 1px solid #1e7e34;
    {% endif %}
  "
>
      QC
    </div>
  </div>
</td>

<td>
  <!-- Edit Button - Disabled if unload_accepted is True -->
  {% if data.unload_accepted %}
    <span title="Edit (Disabled - Already Accepted)" style="opacity: 0.5; cursor: not-allowed;">
      <img
        src="{% static 'assets/icons/edit1.png' %}"
        alt="Edit"
        style="width: 20px; margin-right: 8px; height: auto"
      />
    </span>
  {% else %}
    <a href="#" title="Edit">
      <img
        src="{% static 'assets/icons/edit1.png' %}"
        alt="Edit"
        style="width: 20px; margin-right: 8px; height: auto"
      />
    </a>
  {% endif %}

  <!-- Delete Button - Disabled if unload_accepted is True -->
  {% if data.unload_accepted %}
    <span title="Delete (Disabled - Already Accepted)" style="opacity: 0.5; cursor: not-allowed;">
      <img
        src="{% static 'assets/icons/bin.png' %}"
        alt="Delete"
        style="width: 20px; margin-right: 8px; height: auto"
      />
    </span>
  {% else %}
    <a href="#" title="Delete">
      <img
        src="{% static 'assets/icons/bin.png' %}"
        alt="Delete"
        style="width: 20px; margin-right: 8px; height: auto"
      />
    </a>
  {% endif %}

  <!-- Accept Button -->
  <button
    type="button"
    class="btn btn-social-icon-text btn-twitter accept-unload-btn"
    style="background-color: 
      {% if data.unload_accepted %}#28a745
      {% elif data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance and data.nickle_ip_accepted_tray_scan_status or data.nickle_ip_onhold_picking and data.nickle_ip_few_cases_acceptance %}#bdbdbd
      {% else %}#66bb6a{% endif %};"
    data-lot-id="{{ data.lot_id }}"
    {% if data.unload_accepted %}
    {% elif data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance and data.nickle_ip_accepted_tray_scan_status or data.nickle_ip_onhold_picking and data.nickle_ip_few_cases_acceptance %}
      disabled
    {% endif %}
  >
    <i class="fa fa-check-circle"></i>
    {% if data.unload_accepted %}
      Accepted
    {% else %}
      Accept
    {% endif %}
  </button>
  
  <!-- Reject Button -->
  {% if data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance and data.nickle_ip_accepted_tray_scan_status %}
    <!-- Condition 1 & 4: Show "Rejected" with no redirect -->
    <button
      type="button"
      class="btn btn-social-icon-text btn-youtube"
      disabled
      style="opacity: 0.7; cursor: not-allowed; background: #e53935; color: #fff;"
      title="Already Rejected"
    >
      <i class="fa fa-close"></i>Rejected
    </button>
  {% elif data.nickle_ip_onhold_picking and data.nickle_ip_few_cases_acceptance %}
    <!-- Condition 2: Show "Partial Reject" with redirection -->
    <button
      type="button"
      class="btn btn-social-icon-text btn-youtube tray-scan-btn"
      style="background: #ff9800; color: #fff;"
      data-lot-id="{{ data.lot_id }}"
      title="Partial Reject - Redirection Required"
    >
      <i class="fa fa-exclamation-triangle"></i>Partial Reject
    </button>
  {% elif data.unload_accepted %}
    <!-- Condition 3: unload_accepted is True - Reject disabled -->
    <button
      type="button"
      class="btn btn-social-icon-text btn-youtube"
      disabled
      style="opacity: 0.5; cursor: not-allowed; background: #e53935; color: #fff;"
      title="Reject (Disabled - Already Accepted)"
    >
      <i class="fa fa-close"></i>Reject
    </button>
  {% else %}
    <!-- Default state: Normal reject button -->
    <button
      type="button"
      class="btn btn-social-icon-text btn-youtube tray-scan-btn"
      style="background: #e53935; color: #fff;"
      data-lot-id="{{ data.lot_id }}"
    >
      <i class="fa fa-close"></i>Reject
    </button>
  {% endif %}
  
  <!-- Eye icon to view submitted "Tray Scan Table" - Always enabled -->
  <a
    href="#"
    title="View"
    class="text-primary tray-scan-btn-Jig view-btn-icon"
    style="text-decoration: underline"
    data-batch-id="{{ data.batch_id }}"
    data-model-no="{{ data.model_stock_no__model_no }}"
    data-no-of-trays="{{ data.no_of_trays }}"
    data-tray-capacity="{{ data.tray_capacity|default:'0' }}"
    data-moved-to-d-picker="{{ data.Moved_to_D_Picker }}"
    data-tray-qty-list="{{ data.tray_qty_list|default:'[]'|safe }}"
  >
    <img
      src="{% static 'assets/icons/view.png' %}"
      alt="View"
      style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;"
    />
  </a>
</td>


                    <td>
                      {% if data.nickle_ip_onhold_picking %}
                        <div
                          class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="
                            border: 2px solid #4997ac;
                            background-color: #d1f2f3;
                            color: #03425d;
                            font-size: clamp(0.3rem, 2vw, 0.875rem);
                            white-space: nowrap;
                            padding: 0.3rem;
                          "
                        >
                          Draft
                        </div>
                      {% elif data.unload_accepted or data.rejected_nickle_ip_stock or data.nickle_ip_few_cases_acceptance%}
                        <div
                          class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="
                            border: 2px solid #0d5d17;
                            background-color: #c5f9c2;
                            color: #2f801b;
                            font-size: clamp(0.3rem, 2vw, 0.875rem);
                            white-space: nowrap;
                            padding: 0.3rem;
                          "
                        >
                          Yet To Release
                        </div>
                      
                      {% else %}
                        <div
                          class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                          style="
                            border: 2px solid #ffc107;
                            background-color: #fffbe6;
                            color: #b8860b;
                            font-size: clamp(0.3rem, 2vw, 0.875rem);
                            white-space: nowrap;
                            padding: 0.3rem;
                          "
                        >
                          Yet to start
                        </div>
                      {% endif %}
                    </td>
                    <td>
                      <div
                        class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                        style="
                          border: 2px solid #9adeed;
                          background-color: #d1edf3;
                          color: #033b5d;
                          font-size: clamp(0.3rem, 2vw, 0.875rem);
                          white-space: nowrap;
                          padding: 0.3rem;
                        "
                      >
                        {{data.last_process_module|default:"Jig Unloading"}}
                      </div>
                    </td>
                    <td>
                      <!-- VoiceRec with tooltip (audio remark) -->
                        <a href="#" title="Add Audio Remark" class="remark-tooltip-trigger" style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: pointer;">
                          <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec" style="width: 20px; height: 20px"/>
                          <div class="remark-tooltip" style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 1000;">
                            <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid #fff;"></div>
                            <!-- Audio recording UI placeholder -->
                            <div style="display: flex; align-items: center; gap: 10px;">
                              <button type="button" style="background: #28a745; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center;">
                                <i class="fa fa-microphone"></i>
                              </button>
                              <span style="font-size: 14px; color: #333;">Hold to record audio</span>
                            </div>
                            <div style="text-align: right; margin-top: 10px;">
                              <button type="button" style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                <i class="fa fa-send"></i>
                              </button>
                            </div>
                          </div>
                        </a>

                      <a
                        href="#"
                        title="Add Remark"
                        class="remark-tooltip-trigger"
                        style="
                          display: inline-flex;
                          align-items: center;
                          height: 20px;
                          margin-left: 5px;
                          position: relative;
                          cursor: pointer;
                        "
                      >
                        <img
                          src="{% static 'assets/icons/chat1.png' %}"
                          alt="Chat"
                          style="width: 20px; height: 20px"
                        />
                        <div
                          class="remark-tooltip"
                          style="
                            position: absolute;
                            top: 110%;
                            left: 50%;
                            transform: translateX(-50%);
                            width: 300px;
                            background: #fff;
                            border: 1px solid #ccc;
                            border-radius: 6px;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                            opacity: 0;
                            visibility: hidden;
                            transition: opacity 0.3s ease, visibility 0.3s ease;
                            padding: 15px;
                            z-index: 1000;
                          "
                        >
                          <div
                            style="
                              position: absolute;
                              top: -10px;
                              left: 50%;
                              transform: translateX(-50%);
                              width: 0;
                              height: 0;
                              border-left: 10px solid transparent;
                              border-right: 10px solid transparent;
                              border-bottom: 10px solid #fff;
                            "
                          ></div>
                          <textarea
                            placeholder="Type your remark..."
                            style="
                              width: 85%;
                              height: 40px;
                              resize: vertical;
                              border: 1px solid #ccc;
                              padding: 5px;
                              border-radius: 4px;
                              font-family: Arial, sans-serif;
                              font-size: 14px;
                            "
                          ></textarea>
                          <div style="text-align: right; margin-top: -35px">
                            <button
                              type="button"
                              style="
                                background-color: #007bff;
                                color: #fff;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 14px;
                              "
                            >
                              <i class="fa fa-send"></i>
                            </button>
                          </div>
                        </div>
                      </a>
                    </td>
                  
                  </tr>
                
                  {% endfor %}
                </tbody>
              </table>

               </div>

               <!-- ✅ SINGLE MODAL OUTSIDE OF TABLE -->
<div id="trayScanModal_BQ_ReadOnly" class="tray-scan-modal-BQ" style="display:none;">
  <div class="tray-scan-modal-BQ-content">
    <span id="closeTrayScanModal_BQ_ReadOnly" class="tray-scan-close">&times;</span>

    <div class="modal-top-header">
      <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
        <img src="/static/assets/images/imagePlaceholder.png" alt="User Profile"
             style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
        <span>Model No:</span>
        <h6 id="modalModelNo_BQ_ReadOnly">(Fetch Dynamically)</h6>
      </div>
    </div>
    
    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
      <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
        JIG UnLoading - Tray Scan (Read Only)
      </h5>

      <button id="trayValidateBtn_ReadOnly" type="button" 
              style="display: flex; align-items: center; gap: 6px; background: #f5faff; border: 1px solid #023E4DCC; color: #023E4DCC; border-radius: 20px; padding: 4px 14px; font-size: 13px; font-weight: 500; cursor: pointer;">
        <img src="{% static 'assets/icons/validate.png' %}" alt="Validate" style="width: 20px; height: 20px; margin-right: 4px;" />
        Tray Validate
      </button>

      <!-- Hidden input field -->
      <input id="trayValidateInput_ReadOnly" type="text" placeholder="Scan or enter Tray ID"
             style="position: absolute; left: -9999px; width: 1px; height: 1px; opacity: 0; pointer-events: none;" />
      
      <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="trayScanRedoBtn_ReadOnly"
           style="width: 24px; height: 24px; cursor: pointer; margin-left: 8px;" title="Clear Tray IDs" />
    </div>
    
    <div id="trayErrorMessage_ReadOnly" 
         style="display: none; background-color: #ffebee; border: 1px solid #f44336; color: #c62828; padding: 8px 12px; border-radius: 4px; margin-bottom: 10px; font-size: 14px; text-align: center;">
      <span id="trayErrorText_ReadOnly"></span>
    </div>
    
    <div id="trayScanDetails_BQ_ReadOnly">
      <!-- Dynamic content will be loaded here -->
    </div>
  </div>
</div>
              <!-- Tray Scan Details Modal (Left Popup) -->
              <div id="trayScanModal" class="tray-scan-modal">
                <div class="tray-scan-modal-content">
                  <span id="closeTrayScanModal" class="tray-scan-close"
                    >&times;</span
                  >
                  <h3 id="trayScanModalHeader">Nickle Inspection / <span class="modal-model-no">(Fetch Dynamically)</span> / Rejection Window</h3>                  <div id="trayScanDetails">
                    <!-- Dynamic content will be loaded here -->
                  </div>
                </div>
              </div>
              <!-- New Popup Modal (Right Popup) -->
              <div id="newPopupModal" class="new-popup-modal">
                <div class="tray-scan-modal-content">
                  <span id="closeNewPopupModal" class="tray-scan-close"
                    >&times;</span
                  >
                  <!-- New top header container: title + user profile aligned left -->
                  <div
                    class="modal-top-header"
                    style="
                      display: flex;
                      align-items: center;
                      gap: 20px;
                      padding-bottom: 10px;
                    "
                  >
                    <div
                      class="user-profile"
                      style="display: flex; align-items: center; gap: 8px"
                    >
                      <img
                        src="{% static 'assets/images/userProfile.png' %}"
                        alt="User Profile"
                        style="
                          border-radius: 50%;
                          width: 50px;
                          height: 50px;
                          object-fit: cover;
                        "
                      />
                      <span>Model No:</span>
                      <h6>(Fetch Dynamically) / Accepted Tray Rescan</h6>
                    </div>
                  </div>
                  <!-- Existing centered h3 title -->
                  <!-- Redo icon for clearing "tray ID" -->
                 <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
                    <h5 style="text-align: center; margin: 0; flex: 1; font-weight: 600; color:#595959">
                      Accepted case tray scan table
                    </h5>
                    <img
                      src="{% static 'assets/icons/redo2.png' %}"
                      alt="Redo"
                      
                      id="trayScanRedoBtn"
                      style="width: 24px; height: 24px; cursor: pointer; margin-right: 14px;"
                      title="Clear Tray IDs"
                    />
                  </div>
                  <!-- Accepted Case Tray Scan Table - Grid View with Visible Borders -->
                  <div id="trayScanDetails" class="table-grid">
                    
                    <!-- NEW BUTTONS SECTION -->
                    <div class="tray-scan-modal-buttons" style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                       <button
                    style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">
                    Draft
                  </button>
                  <button
                    style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;">
                    Submit
                  </button>
                  <button
                    style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
                    Cancel
                  </button>
                    </div>
                  </div>
                </div>
              </div>
              
            </div>
            
           
          </div>
          <!-- Pagination Section -->
                     <div class="pagination-wrapper">
            <nav aria-label="Page navigation">
              <ul class="pagination justify-content-end mb-0">
                {% if page_obj.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">Previous</span>
                  </li>
                {% endif %}
          
                {% for num in paginator.page_range %}
                  {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                  {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                  {% endif %}
                {% endfor %}
          
                {% if page_obj.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">Next</span>
                  </li>
                {% endif %}
              </ul>
            </nav>
          </div>
        </div>
      </div>
    </div>
  </div>


            
  {% block script %}

  <script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  console.log('[DEBUG] DOM loaded, setting up view button events');
  
  document.querySelectorAll('.view-btn-icon').forEach(function(icon) {
    icon.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();

      console.log('[DEBUG] View button clicked');

      // Find the parent row and extract lot_id (UNLOT ID) and model_no
      const row = icon.closest('tr[data-lot-id]');
      if (!row) {
        console.error('[DEBUG] No parent row found');
        return;
      }

      const unlotId = row.getAttribute('data-lot-id');
      let modelNo = '';
      const modelCell = row.querySelector('.model-stock-no-cell');
      if (modelCell) {
        const modelList = JSON.parse(modelCell.getAttribute('data-model-list') || '[]');
        modelNo = modelList.length > 0 ? modelList[0] : '';
      }


      const modal = document.getElementById("trayScanModal_BQ_ReadOnly");
      const detailsDiv = document.getElementById("trayScanDetails_BQ_ReadOnly");
      const modalModelNo = document.getElementById("modalModelNo_BQ_ReadOnly");

      if (!modal) {
        console.error('[DEBUG] Modal not found!');
        return;
      }

      if (!detailsDiv) {
        console.error('[DEBUG] Details div not found!');
        return;
      }

      console.log('[DEBUG] Modal and details div found');

      if (modalModelNo && modelNo) {
        modalModelNo.textContent = modelNo;
      }
      if (modal && unlotId) {
        modal.setAttribute('data-lot-id', unlotId);
      }

      // Show loading state
      detailsDiv.innerHTML = `
        <div style="text-align: center; padding: 20px;">
          <p>Loading tray data...</p>
        </div>
      `;

      console.log('[DEBUG] Making API call...');

      fetch(`/jig_unloading/jig_after_view_tray_list/?stock_lot_id=${encodeURIComponent(unlotId)}`)
        .then(resp => {
          console.log('[DEBUG] API response received:', resp.status);
          return resp.json();
        })
        .then(result => {
          console.log('[DEBUG] API Response:', result);
          
          let traysData = [];
          if (result.success && Array.isArray(result.trays)) {
            traysData = result.trays;
          }

          // Build modal content as a table
          let html = `
            <div style="margin-bottom: 10px; font-size: 12px; color: #666;">
            </div>
            <table class="table table-bordered table-sm" style="width:100%; margin-bottom:0;">
              <thead>
                <tr>
                  <th style="width:50px;">S.no</th>
                  <th>Tray ID</th>
                  <th>Tray Qty</th>
                  <th>Tray Validation Status</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          if (traysData.length === 0) {
            html += `
              <tr>
                <td colspan="5" style="text-align: center; padding: 20px; color: #666;">
                  No trays found for this UNLOT ID
                </td>
              </tr>
            `;
          } else {
            for (let i = 0; i < traysData.length; i++) {
              const tray = traysData[i] || {};
              html += `
                <tr data-tray-index="${i}">
                  <td>${tray.is_top_tray ? '1 (Top Tray)' : (i + 1)}</td>
                  <td>
                    <input type="text" class="form-control" value="${tray.tray_id || ''}" readonly style="width: 100%;" />
                  </td>
                  <td>
                    <input type="number" class="form-control" value="${tray.tray_qty || ''}" readonly style="width: 100%;" />
                  </td>

                  <td class="validation-status-cell">
                    <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px; margin-right:6px; vertical-align:middle;" />
                    <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
                  </td>
                </tr>
              `;
            }
          }
          
          html += `
              </tbody>
            </table>
          `;
          detailsDiv.innerHTML = html;

          // Setup modal event listeners with the UNLOT ID
          setupModalEventListeners(modal, detailsDiv, unlotId, traysData);

          console.log('[DEBUG] About to show modal');
          
          // Show the modal
          modal.style.display = "block";
          modal.classList.add("open");
          
          console.log('[DEBUG] Modal should be visible now');
        })
        .catch(error => {
          console.error('[DEBUG] API Error:', error);
          detailsDiv.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #d32f2f;">
              <p>Error loading tray data: ${error.message}</p>
            </div>
          `;
        });
    });
  });
});

function setupModalEventListeners(modal, detailsDiv, unlotId, traysData) {
  console.log('[DEBUG] Setting up modal event listeners');
  
  const validateBtn = modal.querySelector("#trayValidateBtn_ReadOnly");
  const validateInput = modal.querySelector("#trayValidateInput_ReadOnly");
  const redoBtn = modal.querySelector("#trayScanRedoBtn_ReadOnly");
  const errorMessage = modal.querySelector("#trayErrorMessage_ReadOnly");
  const errorText = modal.querySelector("#trayErrorText_ReadOnly");

  // Tray Validate button click
  if (validateBtn && validateInput) {
    validateBtn.onclick = null;
    validateBtn.addEventListener("click", function () {
      validateInput.value = "";
      validateBtn.style.background = "#e8f5e8";
      validateBtn.style.borderColor = "#4caf50";
      validateBtn.style.color = "#2e7d32";
      validateInput.focus();
    });
  }

  // Tray Validate Input keydown
  if (validateInput) {
    validateInput.onkeydown = null;
    validateInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        const trayId = validateInput.value.trim();
        if (!trayId) {
          showError("Please enter a Tray ID");
          return;
        }
        if (!unlotId) {
          showError("UNLOT ID not found");
          return;
        }


        // Make API call to validate tray
        fetch("/jig_unloading/jig_after_tray_validate/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie('csrftoken')
          },
          body: JSON.stringify({
            batch_id: unlotId,
            lot_id: unlotId,
            tray_id: trayId
          })
        })
        .then(response => response.json())
        .then(data => {
          console.log('[DEBUG] Validation Response:', data);
          
          if (data.success && data.exists) {
            updateTrayValidationStatus(trayId, true, data.tray_info);
            hideError();
          } else {
            showError(data.error || `Tray ${trayId} not found in the combine lot IDs`);
          }
          validateInput.value = "";
          validateInput.focus();
        })
        .catch(error => {
          console.error('[DEBUG] Validation Error:', error);
          showError(`Validation error: ${error.message}`);
          validateInput.value = "";
          validateInput.focus();
        });
      }
    });
  }

  // Redo button click
  if (redoBtn) {
    redoBtn.onclick = null;
    redoBtn.addEventListener("click", function () {
      resetValidationUI(validateBtn, validateInput, detailsDiv);
      hideError();
    });
  }

  // Helper functions
  function showError(message) {
    if (errorMessage && errorText) {
      errorText.textContent = message;
      errorMessage.style.display = "block";
      setTimeout(() => {
        errorMessage.style.display = "none";
      }, 5000);
    } else {
      alert(message);
    }
  }

  function hideError() {
    if (errorMessage) {
      errorMessage.style.display = "none";
    }
  }

  function updateTrayValidationStatus(trayId, isValid, trayInfo) {
    const rows = detailsDiv.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const trayInput = row.querySelector("td:nth-child(2) input");
      if (trayInput && trayInput.value === trayId) {
        const statusCell = row.querySelector(".validation-status-cell");
        if (statusCell) {
          if (isValid) {
            statusCell.innerHTML = `
              <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
              <span style="color: green; margin-left: 6px; font-weight: 500;">Validated</span>
            `;
          } else {
            statusCell.innerHTML = `
              <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px; vertical-align:middle;" />
              <span style="color: red; margin-left: 6px; font-weight: 500;">Invalid</span>
            `;
          }
        }
      }
    });
  }

  function resetValidationUI(validateBtn, validateInput, detailsDiv) {
    if (validateInput) {
      validateInput.value = "";
      validateInput.blur();
    }

    if (validateBtn) {
      validateBtn.style.background = "#f5faff";
      validateBtn.style.borderColor = "#023E4DCC";
      validateBtn.style.color = "#023E4DCC";
    }

    const rows = detailsDiv.querySelectorAll("tbody tr");
    rows.forEach(row => {
      const statusCell = row.querySelector(".validation-status-cell");
      if (statusCell) {
        statusCell.innerHTML = `
          <img src="{% static 'assets/icons/fail.png' %}" alt="Fail" title="Fail" style="width:18px; height:18px; margin-right:6px; vertical-align:middle;" />
          <img src="{% static 'assets/icons/pass.png' %}" alt="Pass" title="Pass" style="width:18px; height:18px; vertical-align:middle;" />
        `;
      }
    });
  }
}
</script>

<!-- Modal close functionality -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const closeBtn = document.getElementById("closeTrayScanModal_BQ_ReadOnly");
  const modal = document.getElementById("trayScanModal_BQ_ReadOnly");

  if (closeBtn && modal) {
    closeBtn.addEventListener("click", function () {
      console.log('[DEBUG] Closing modal');
      modal.style.display = "none";
      modal.classList.remove("open");
    });
  }

  // Close modal on outside click
  window.addEventListener("click", function (event) {
    if (event.target === modal) {
      console.log('[DEBUG] Closing modal (outside click)');
      modal.style.display = "none";
      modal.classList.remove("open");
    }
  });
});
</script>

<!-- Simple Test Version - Accept Button -->
<!-- SweetAlert2 Accept Button Script -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('.accept-unload-btn').forEach(function(button) {
    button.addEventListener('click', function(e) {
      e.preventDefault();

      const lotId = this.getAttribute('data-lot-id');
      if (!lotId) {
        Swal.fire({
          icon: 'error',
          title: 'LOT ID not found!',
          text: 'Please refresh and try again.',
        });
        return;
      }

      Swal.fire({
        title: 'Accept this LOT?',
        text: `Are you sure you want to accept LOT: ${lotId}?`,
        icon: 'question',
        showCancelButton: true,
        confirmButtonText: 'Accept',
        cancelButtonText: 'Cancel',
        reverseButtons: true,
        allowOutsideClick: false,
        allowEscapeKey: false
      }).then((result) => {
        if (result.isConfirmed) {
          button.disabled = true;
          button.innerHTML = 'Processing...';

          fetch('/nickle_inspection/accept_unload/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ lot_id: lotId })
          })
          .then(response => response.text())
          .then(text => {
            try {
              const data = JSON.parse(text);
              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Accepted!',
                  text: data.message || 'Lot accepted successfully.',
                  timer: 1800,
                  showConfirmButton: false
                });
                button.innerHTML = 'Accepted';
                button.style.backgroundColor = '#28a745';
                setTimeout(() => window.location.reload(), 1800);
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: data.error || 'Failed to accept lot.'
                });
                button.disabled = false;
                button.innerHTML = 'Accept';
              }
            } catch (parseError) {
              Swal.fire({
                icon: 'error',
                title: 'Response Error',
                text: 'Could not parse server response.'
              });
              button.disabled = false;
              button.innerHTML = 'Accept';
            }
          })
          .catch(error => {
            Swal.fire({
              icon: 'error',
              title: 'Network Error',
              text: error.message || 'Could not connect to server.'
            });
            button.disabled = false;
            button.innerHTML = 'Accept';
          });
        } else {
          Swal.fire({
            icon: 'info',
            title: 'Cancelled',
            text: 'Lot acceptance cancelled.',
            timer: 1200,
            showConfirmButton: false
          });
        }
      });
    });
  });
});
</script>

<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", () => {
  const trayScanLinks = document.querySelectorAll(".tray-scan-btn");
  const trayModal = document.getElementById("trayScanModal");
  const closeTrayBtn = document.getElementById("closeTrayScanModal");
  const detailsDiv = document.getElementById("trayScanDetails");
  const newPopupModal = document.getElementById("newPopupModal");
  const closeNewPopupBtn = document.getElementById("closeNewPopupModal");

  // GLOBAL LOT ID STORAGE FUNCTIONS
  function storeLotIdGlobally(row) {
    if (row) {
      // Store multiple references to lot_id
      window.currentLotId = row.getAttribute('data-lot-id') || 
                           row.getAttribute('data-stock-lot-id') || 
                           row.cells[2]?.textContent?.trim();
      window.currentStockLotId = window.currentLotId;
      window.currentActiveRow = row;
      
      console.log('[DEBUG] Stored lot_id globally:', window.currentLotId);
      
      // Also store in modal dataset if modal exists
      if (trayModal) {
        trayModal.dataset.stockLotId = window.currentLotId;
        trayModal.dataset.lotId = window.currentLotId;
      }
    }
  }

  // COMPREHENSIVE LOT ID EXTRACTION FUNCTION
  function extractLotId() {
    let lotId = null;
    
    console.log('[DEBUG] Starting lot_id extraction...');
    
    // Strategy 1: From window global variables (set when modal opens)
    if (window.currentLotId) {
      lotId = window.currentLotId;
      console.log('[DEBUG] Strategy 1 - Window currentLotId:', lotId);
      return cleanLotId(lotId);
    }
    
    if (window.currentStockLotId) {
      lotId = window.currentStockLotId;
      console.log('[DEBUG] Strategy 1b - Window currentStockLotId:', lotId);
      return cleanLotId(lotId);
    }
    
    // Strategy 2: From currently highlighted row
    const highlightedRow = document.querySelector('tr.dp-row-action-highlight');
    if (highlightedRow) {
      lotId = highlightedRow.getAttribute('data-stock-lot-id') || 
             highlightedRow.getAttribute('data-lot-id') ||
             highlightedRow.cells[2]?.textContent?.trim();
      console.log('[DEBUG] Strategy 2 - Highlighted row:', lotId);
      if (lotId) return cleanLotId(lotId);
    }
    
    // Strategy 3: From active row stored in window
    if (window.currentActiveRow) {
      lotId = window.currentActiveRow.getAttribute('data-stock-lot-id') || 
             window.currentActiveRow.getAttribute('data-lot-id') ||
             window.currentActiveRow.cells[2]?.textContent?.trim();
      console.log('[DEBUG] Strategy 3 - Active row:', lotId);
      if (lotId) return cleanLotId(lotId);
    }
    
    // Strategy 4: From modal datasets
    if (trayModal) {
      lotId = trayModal.dataset.stockLotId || trayModal.dataset.lotId;
      console.log('[DEBUG] Strategy 4 - Modal dataset:', lotId);
      if (lotId) return cleanLotId(lotId);
    }
    
    // Strategy 5: From rejection table rows with data attributes
    const rejectionRows = document.querySelectorAll('#rejection-table-body tr[data-stock-lot-id]');
    if (rejectionRows.length > 0) {
      lotId = rejectionRows[0].getAttribute('data-stock-lot-id');
      console.log('[DEBUG] Strategy 5 - Rejection table:', lotId);
      if (lotId) return cleanLotId(lotId);
    }
    
    // Strategy 6: From any table row that has tray-scan-btn-NI
    const allTableRows = document.querySelectorAll('#order-listing tbody tr');
    for (let row of allTableRows) {
      const trayScanBtn = row.querySelector('.tray-scan-btn-NI');
      if (trayScanBtn) {
        lotId = row.getAttribute('data-stock-lot-id') || 
               row.getAttribute('data-lot-id') ||
               row.cells[2]?.textContent?.trim();
        console.log('[DEBUG] Strategy 6 - Table row:', lotId);
        if (lotId) return cleanLotId(lotId);
      }
    }
    
    // Strategy 7: From first visible row in table (last resort)
    const firstRow = document.querySelector('#order-listing tbody tr:first-child');
    if (firstRow) {
      lotId = firstRow.getAttribute('data-stock-lot-id') || 
             firstRow.getAttribute('data-lot-id') ||
             firstRow.cells[2]?.textContent?.trim();
      console.log('[DEBUG] Strategy 7 - First row fallback:', lotId);
      if (lotId) return cleanLotId(lotId);
    }
    
    console.log('[DEBUG] All strategies failed to find lot_id');
    return null;
  }
  
  // FUNCTION TO CLEAN AND VALIDATE LOT ID
  function cleanLotId(lotId) {
    if (!lotId) return null;
    
    // Convert to string and trim
    lotId = String(lotId).trim();
    
    // Remove any non-alphanumeric characters except hyphens, underscores, and dots
    lotId = lotId.replace(/[^\w\-\.]/g, '');
    
    // Validate it's not empty and not 'null'/'undefined'
    if (!lotId || lotId === 'null' || lotId === 'undefined' || lotId.length === 0) {
      return null;
    }
    
    console.log('[DEBUG] Cleaned lot_id:', lotId);
    return lotId;
  }

  trayScanLinks.forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();

      const row = event.target.closest("tr");
      
      // IMPROVED LOT ID EXTRACTION - Try multiple strategies
      let lotId = null;
      
      // Strategy 1: From button data attributes
      lotId = link.getAttribute('data-lot-id') || link.getAttribute('data-stock-lot-id');
      
      // Strategy 2: From row data attributes
      if (!lotId && row) {
        lotId = row.getAttribute('data-lot-id') || 
               row.getAttribute('data-stock-lot-id') ||
               row.cells[2]?.textContent?.trim(); // LOT ID column
      }
      
      // Strategy 3: From other elements in the row
      if (!lotId && row) {
        const lotIdCell = row.querySelector('td:nth-child(3)'); // LOT ID is usually 3rd column
        if (lotIdCell) {
          lotId = lotIdCell.textContent.trim();
        }
      }
      
      console.log('[DEBUG] Extracted lot_id:', lotId);
      
      if (!lotId || lotId === 'null' || lotId === 'undefined') {
        console.error('[DEBUG] Could not extract valid lot_id');
        alert('Error: Could not find LOT ID. Please refresh the page and try again.');
        return;
      }

      const batchId = link.getAttribute('data-batch-id') || lotId;
      const isOnHold = row.getAttribute('data-nickle-ip-onhold-picking') === 'True';
   
      // STORE LOT ID GLOBALLY WHEN MODAL OPENS
      storeLotIdGlobally(row);

      trayModal.dataset.batchId = batchId;
      trayModal.dataset.stockLotId = lotId;

      const dateTime = row.cells[1].textContent.trim();
      const totalQuantity = row.cells[10].textContent.trim();
      const modelNo = row.getAttribute('data-model-no') || '';
      const modalHeader = document.getElementById("trayScanModalHeader");
      if (modalHeader) {
        modalHeader.innerHTML = `Nickle Inspection / <span class="modal-model-no">${modelNo}</span> / Rejection Window`;
      }

      // If ip_onhold_picking is True, show read-only saved data
      if (isOnHold) {
        console.log('[DEBUG] Showing read-only data for lot_id:', lotId);
        showReadOnlyRejectionData(lotId, detailsDiv);
      } else {
        // Show editable rejection form (existing code)
        console.log('[DEBUG] Showing editable form for lot_id:', lotId);
        showEditableRejectionForm(lotId, batchId, detailsDiv, row);
      }

      trayModal.classList.add("open");
    });
  });

  // Function to show read-only saved rejection data
  function showReadOnlyRejectionData(lotId, detailsDiv) {
    console.log("[FRONTEND] Fetching rejected tray scan data for lotId:", lotId);
    
    // Validate lotId before making API call
    if (!lotId || lotId === 'null' || lotId === 'undefined' || lotId.trim() === '') {
      console.error('[FRONTEND] Invalid lot_id provided:', lotId);
      detailsDiv.innerHTML = `<div style="color:red;">Error: Invalid LOT ID. Please refresh the page and try again.</div>`;
      return;
    }
    
    fetch(`/nickle_inspection/nickle_ip_get_rejected_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
      .then(res => res.json())
      .then(data => {
        console.log("[FRONTEND] API response for lotId", lotId, ":", data);
        if (!data.success) {
          detailsDiv.innerHTML = `<div style="color:red;">${data.error || "No data found"}</div>`;
          return;
        }
        
        // Check if this is batch rejection or tray-wise rejection
        let isBatchRejection = data.is_batch_rejection || false;
        let totalRejectionQty = data.total_rejection_qty || 0;
        
        let html = `
          <div style="font-weight:bold; margin-bottom:8px;">
            Saved Rejection Details - ${isBatchRejection ? 'BATCH REJECTION' : 'TRAY-WISE REJECTION'}
            <br><span style="font-size:12px; color:#117057;">(Read Only)</span>
          </div>
          <div class="alert alert-info" style="font-size:13px; margin-bottom:10px;">
            <i class="fa fa-info-circle"></i> This data is already saved and cannot be modified
          </div>
        `;
        
        if (isBatchRejection) {
          // Special handling for batch rejection
          html += `
            <div class="alert alert-warning" style="font-size:13px; margin-bottom:10px;">
              <i class="fa fa-exclamation-triangle"></i> This LOT was rejected as a complete batch
            </div>
            <table class="table table-bordered text-center" style="font-size:13px;">
              <thead>
                <tr>
                  <th>Rejection Type</th>
                  <th>Total Quantity Rejected</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:bold; color:#d32f2f;">BATCH REJECTION</td>
                  <td style="font-weight:bold; color:#d32f2f;">${totalRejectionQty}</td>
                  <td>${new Date().toLocaleDateString()}</td>
                </tr>
              </tbody>
            </table>
          `;
        } else {
          // Standard table for tray-wise rejection
          html += `
            <table class="table table-bordered text-center" style="font-size:13px;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>Reason ID</th>
                  <th>Rejection Reason</th>
                  <th>Quantity</th>
                  <th>Tray</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let totalQty = 0;
          if (data.rows && data.rows.length > 0) {
            data.rows.forEach((row, idx) => {
              html += `
                <tr>
                  <td>${row.sno || (idx + 1)}</td>
                  <td>${row.reason_id || ''}</td>
                  <td>${row.reason || ''}</td>
                  <td>${row.qty || 0}</td>
                  <td>${row.tray_id || ''}</td>
                </tr>
              `;
              totalQty += parseInt(row.qty) || 0;
            });
          } else {
            html += `
              <tr>
                <td colspan="5" style="color:#666; font-style:italic;">No rejection data found</td>
              </tr>
            `;
          }
          
          html += `
              <tr style="font-weight:bold; background-color:#f8f9fa;">
                <td colspan="3" style="text-align:right;">Total Saved Qty</td>
                <td style="color:${totalQty === 0 ? 'red' : '#117057'};">${totalQty}</td>
                <td></td>
              </tr>
            </tbody>
            </table>
          `;
        }
        
        html += `
          <div style="text-align:center; margin-top:16px;">
            <button class="btn btn-success" id="readonlyProceedBtn">Proceed</button>
            <button class="btn btn-secondary" id="readonlyCloseBtn">Close</button>
          </div>
        `;
        
        detailsDiv.innerHTML = html;

        // Button handlers
        document.getElementById('readonlyProceedBtn').onclick = function() {
          document.getElementById('trayScanModal').classList.remove('open');
        };
        document.getElementById('readonlyCloseBtn').onclick = function() {
          document.getElementById('trayScanModal').classList.remove('open');
        };
      })
      .catch(error => {
        console.error("[FRONTEND] Error fetching rejected tray scan data:", error);
        detailsDiv.innerHTML = `<div style="color:red;">Error loading rejection data: ${error.message}</div>`;
      });
  }

  // Function to show editable rejection form (COMPLETE FUNCTION FROM FIRST FILE)
  function showEditableRejectionForm(stockLotId, batchId, detailsDiv, row) {
    // STORE LOT ID GLOBALLY WHEN EDITABLE FORM IS SHOWN
    storeLotIdGlobally(row);
    
    // Set the inner HTML with Proceed and Cancel buttons tagged with IDs
    detailsDiv.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2" style="padding: 10px 0;">
        <h4 class="mb-0">Rejection Reason List</h4>
        <div class="form-check d-flex align-items-center">
            <input class="form-check-input" type="checkbox" id="batchRejection" />
            <label class="form-check-label ms-2" for="batchRejection">Lot Rejection</label>
        </div>
      </div>
     
      <div class="table-responsive" style="border: solid 1px black;">
        <table class="table table-bordered text-center" style="border: solid 2px black; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
          <thead style="border: solid 2px black; background-color: #007bff; color: #fff;">
          <tr style="border: solid 1px black; background-color: #007bff; color: #fff;">
              <th style="padding: 12px;">S.No</th>
              <th style="padding: 12px;">Reason ID</th>
              <th style="padding: 12px;">Rejection Reason</th>
              <th style="padding: 12px;">Quantity</th>
              <th style="padding: 12px;">Tray</th>
          </tr>
          </thead>
           <tbody id="rejection-table-body">
              {% for reason in nickle_rejection_reasons %}
               <tr data-batch-id="${batchId}" data-stock-lot-id="${stockLotId}">
                 <td>{{ forloop.counter }}</td>
                 <td style="color: {{ reason.row_color }};">{{ reason.rejection_reason_id }}</td>
                 <td style="color: {{ reason.row_color }};">{{ reason.rejection_reason }}</td>
                 <td>
                   <input type="number" min="0" class="form-control rejection-qty-input" name="quantity_{{ forloop.counter }}" style="width: 80px;" />
                 </td>
                 <td>
                   <input type="text" class="form-control tray-id-input" name="tray_{{ forloop.counter }}" placeholder="Scan Tray ID" style="width: 120px;" data-group="{{ reason.group.group_name|default:'' }}" />
                   <span class="tray-id-error" style="color: #d32f2f; font-size: 12px; display: none; margin-left: 4px;"></span>
                 </td>
               </tr>
             {% endfor %}
             <tr>
               <td colspan="3" style="text-align: right; font-weight: bold;">Total Qty</td>
               <td id="rejection-total-qty" style="font-weight: bold;">0</td>
               <td></td>
             </tr>
           </tbody>
        </table>
      </div>
       <br>
       <div id="batchRejectionMsg" style="margin-bottom:10px; color: #d32f2f; font-weight: bold;"></div>
     
        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                 <button id="proceedButton" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;">
                   Proceed
                 </button>
                 <button id="cancelRejection" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
                   Cancel
                 </button>
               </div>
        
      `;

    // Add all the existing event listeners for the editable form
    addEditableFormEventListeners(row, batchId, stockLotId);
  }

  // Function to add event listeners for editable form (COMPLETE FUNCTION FROM FIRST FILE)
  function addEditableFormEventListeners(row, batchId, stockLotId) {
    // Place the tray ID validation code here:
    document.querySelectorAll('.tray-id-input').forEach(function(input, idx, allInputs) {
      input.addEventListener('blur', function() {
        const trayId = input.value.trim();
        const group = input.getAttribute('data-group');
        const errorSpan = input.parentElement.querySelector('.tray-id-error') || (() => {
          const span = document.createElement('span');
          span.className = 'tray-id-error';
          span.style.color = 'red';
          span.style.fontSize = '12px';
          input.parentElement.appendChild(span);
          return span;
        })();
        errorSpan.textContent = '';
        errorSpan.style.display = 'none';
    
        if (!trayId) return;
    
        // Check for duplicate tray ID in other rows
        let found = false;
        allInputs.forEach(function(otherInput, otherIdx) {
          if (otherIdx !== idx && otherInput.value.trim() === trayId) {
            const otherGroup = otherInput.getAttribute('data-group');
            if (otherGroup !== group) {
              errorSpan.textContent = `Tray ID "${trayId}" is not same group match.`;
              errorSpan.style.display = 'inline';
              found = true;
            }
          }
        });
        if (found) return;
    
        // Server check for existence (optional, if you want to keep it)
        fetch(`/nickle_inspection/nickle_reject_check_tray_id/?tray_id=${encodeURIComponent(trayId)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.exists) {
              errorSpan.textContent = `Tray ID "${trayId}" is not existing.`;
              errorSpan.style.display = 'inline';
            }
          });
      });
    });
    
    // Set availableQty from Django context (set this variable in your view and template)
    const availableQty = parseInt(row.getAttribute('data-available-qty'), 10) || 0;        
    document.querySelectorAll('.rejection-qty-input').forEach(function(input, idx, allInputs) {
      input.addEventListener('input', function() {
        // Remove all previous qty errors
        document.querySelectorAll('.qty-error').forEach(function(span) { span.remove(); });
    
        let total = 0;
        let errorRow = null;
        let errorInput = null;
    
        // Calculate running total and find the first row that exceeds
        allInputs.forEach(function(qtyInput, i) {
          const val = parseInt(qtyInput.value) || 0;
          total += val;
          if (!errorRow && total > availableQty) {
            errorRow = i + 1;
            errorInput = qtyInput;
          }
        });
    
        document.getElementById('rejection-total-qty').textContent = total;
    
        // Show error below the input if exceeded
        if (errorInput) {
          let errorSpan = document.createElement('span');
          errorSpan.className = 'qty-error';
          errorSpan.style.color = '#d32f2f';
          errorSpan.style.fontSize = '12px';
          errorSpan.style.display = 'block';
          errorSpan.style.marginTop = '2px';
          errorSpan.textContent = `Row ${errorRow}: Quantity exceeds available (${availableQty}).`;
          errorInput.parentElement.appendChild(errorSpan);
        }
      });
    });

    // Batch rejection checkbox event listener
    const batchRejectionCheckbox = document.getElementById("batchRejection");
    const rejectionTableBody = document.getElementById("rejection-table-body");
    
    if (batchRejectionCheckbox && rejectionTableBody) {
      batchRejectionCheckbox.addEventListener("change", function () {
        const inputs = rejectionTableBody.querySelectorAll("input");
        if (this.checked) {
          inputs.forEach(input => {
            input.disabled = true;
            input.value = ""; // Optionally clear values
          });
          document.getElementById('rejection-total-qty').textContent = "0";
        } else {
          inputs.forEach(input => {
            input.disabled = false;
          });
        }
      });
    }

    // UPDATED PROCEED BUTTON HANDLER WITH ENHANCED LOT ID EXTRACTION
    const proceedButton = document.getElementById("proceedButton");
    const cancelButton = document.getElementById("cancelRejection");

    if (proceedButton) {
      proceedButton.addEventListener("click", () => {
        // If already saved, just open the modal if closed
        if (window.trayRejectionSaved) {
          if (!newPopupModal.classList.contains("open")) {
            newPopupModal.classList.add("open");
          }
          return;
        }
        
        // Prevent multiple clicks during save
        if (proceedButton.disabled) return;
        proceedButton.disabled = true;
        
        const batchRejectionCheckbox = document.getElementById("batchRejection");
        const msgDiv = document.getElementById("batchRejectionMsg");
        if (msgDiv) msgDiv.textContent = ""; // Clear previous messages

        if (batchRejectionCheckbox && batchRejectionCheckbox.checked) {
          // USE THE COMPREHENSIVE LOT ID EXTRACTION FUNCTION
          const lotId = extractLotId();
          
          console.log('[DEBUG] Final extracted lot_id:', lotId);
          console.log('[DEBUG] lot_id type:', typeof lotId);
          console.log('[DEBUG] lot_id length:', lotId ? lotId.length : 'null');
          
          const totalQty = document.getElementById('rejection-total-qty').textContent || "0";
          
          // Enhanced validation
          if (!lotId) {
            console.error('[DEBUG] Lot ID extraction completely failed');
            
            if (msgDiv) {
              msgDiv.style.color = "#d32f2f";
              msgDiv.textContent = "Lot ID not found. Please refresh the page and try again.";
            }
            proceedButton.disabled = false;
            return;
          }
          
          console.log('[DEBUG] Sending batch rejection request with:', {
            lot_id: lotId,
            total_qty: totalQty
          });
          
          fetch('/nickle_inspection/nickle_batch_rejection/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              lot_id: lotId,
              total_qty: totalQty
            })
          })
          .then(res => {
            console.log('[DEBUG] Response status:', res.status);
            return res.json();
          })
          .then(data => {
            console.log('[DEBUG] Response data:', data);
            
            if (data.success) {
              if (msgDiv) {
                msgDiv.style.color = "#388e3c";
                msgDiv.textContent = "Lot rejection saved!";
              }
              
              setTimeout(() => {
                trayModal.classList.remove("open");
                if (msgDiv) msgDiv.textContent = "";
                window.location.reload();
              }, 1200);
            } else {
              if (msgDiv) {
                msgDiv.style.color = "#d32f2f";
                msgDiv.textContent = data.error || "Failed to save batch rejection";
                
                // Show debug info if available
                if (data.debug_info) {
                  console.error('[DEBUG] Server debug info:', data.debug_info);
                  msgDiv.textContent += ` (Debug: Check console for details)`;
                }
              }
              proceedButton.disabled = false;
            }
          })
          .catch(error => {
            console.error('[DEBUG] Network error:', error);
            if (msgDiv) {
              msgDiv.style.color = "#d32f2f";
              msgDiv.textContent = "Network error occurred";
            }
            proceedButton.disabled = false;
          });
        } else {
          // Tray-wise rejection - use same lot_id extraction
          const lotId = extractLotId();
          
          if (!lotId) {
            if (msgDiv) {
              msgDiv.style.color = "#d32f2f";
              msgDiv.textContent = "Lot ID not found for tray rejection.";
            }
            proceedButton.disabled = false;
            return;
          }
          
          const rows = document.querySelectorAll("#rejection-table-body tr");
          let tray_rejections = [];
          
          rows.forEach(row => {
            // Only process rows that have the input fields (skip summary row)
            const qtyInput = row.querySelector('input.rejection-qty-input');
            const trayInput = row.querySelector('input.tray-id-input');
            if (qtyInput && trayInput) {
              const reason_id = row.querySelectorAll("td")[1].textContent.trim();
              const qty = qtyInput.value.trim();
              const tray_id = trayInput.value.trim();
              if (qty && parseInt(qty) > 0 && tray_id) {
                tray_rejections.push({
                  reason_id: reason_id,
                  qty: qty,
                  tray_id: tray_id
                });
              }
            }
          });
          
          if (!tray_rejections.length) {
            if (msgDiv) {
              msgDiv.style.color = "#d32f2f";
              msgDiv.textContent = "Enter at least one tray qty and tray id.";
            }
            proceedButton.disabled = false;
            return;
          }
          
          fetch('/nickle_inspection/nickle_tray_rejection/', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
              lot_id: lotId,
              tray_rejections: tray_rejections
            })
          })
          .then(res => res.json())
          .then(data => {
            if (data.success) {
              // Rest of your existing success logic...
              rows.forEach(row => {
                const qtyInput = row.querySelector('input.rejection-qty-input');
                const trayInput = row.querySelector('input.tray-id-input');
                if (qtyInput) qtyInput.disabled = true;
                if (trayInput) trayInput.disabled = true;
              });
              window.trayRejectionSaved = true;
              
              if (msgDiv) {
                msgDiv.style.color = "#388e3c";
                msgDiv.textContent = "Tray rejection saved!";
              }
              
              // Fetch and render Accepted Tray Rescan modal
              fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
                .then(res => res.json())
                .then(rescanData => {
                  if (rescanData.success) {
                    showAcceptedTrayModal(rescanData, lotId, rescanData.has_draft || false);
                  }
                })
                .catch(error => {
                  console.error('Error fetching accepted tray data:', error);
                  alert('Error loading accepted tray data. Please try again.');
                });
                
            } else {
              if (msgDiv) {
                msgDiv.style.color = "#d32f2f";
                msgDiv.textContent = data.error || "Failed to save tray rejection";
              }
              proceedButton.disabled = false;
            }
          })
          .catch(() => {
            if (msgDiv) {
              msgDiv.style.color = "#d32f2f";
              msgDiv.textContent = "Network error";
            }
            proceedButton.disabled = false;
          });
        }
      });
    }
    
    if (cancelButton) {
      cancelButton.addEventListener("click", () => {
        trayModal.classList.remove("open");
      });
    }
  }

  // Helper function to get CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // Function to fetch and show normal accepted tray data
  function fetchAndShowAcceptedTrayData(lotId) {
    fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
      .then(res => res.json())
      .then(rescanData => {
        if (rescanData.success) {
          showAcceptedTrayModal(rescanData, lotId, false);
        }
      })
      .catch(error => {
        console.error('Error fetching accepted tray data:', error);
        alert('Error loading accepted tray data. Please try again.');
      });
  }

  // Function to show read-only accepted tray data (for draft mode)
  function showReadOnlyAcceptedTrayData(lotId, detailsDiv) {
    fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
      .then(res => res.json())
      .then(data => {
        if (data.success && data.has_draft) {
          showAcceptedTrayModal(data, lotId, true);
        } else {
          // No draft exists, proceed with normal flow
          fetchAndShowAcceptedTrayData(lotId);
        }
      })
      .catch(error => {
        console.error('Error checking draft data:', error);
        // Fallback to normal flow
        fetchAndShowAcceptedTrayData(lotId);
      });
  }

  // ENHANCED showAcceptedTrayModal function with better error handling and modal opening
  function showAcceptedTrayModal(rescanData, lotId, isDraft) {
    console.log('[DEBUG] showAcceptedTrayModal called with:', {
      rescanData: rescanData,
      lotId: lotId,
      isDraft: isDraft
    });

    // Validate inputs
    if (!rescanData || !lotId) {
      console.error('[DEBUG] Invalid parameters passed to showAcceptedTrayModal');
      alert('Error: Invalid data for accepted tray modal');
      return;
    }

    let rows = rescanData.rows || [];   
    let modelNo = rescanData.model_no || 'Unknown Model';
    let topTrayVerified = rescanData.top_tray_verified || false;
    let verifiedTrayQty = rescanData.verified_tray_qty || 0;
    
    console.log('[DEBUG] Processing rows:', rows.length, 'Model:', modelNo);
    
    // Sort rows by tray quantity
    rows.sort((a, b) => parseInt(a.tray_qty) - parseInt(b.tray_qty));
    
    // Reassign S.no after sorting
    rows.forEach((row, idx) => {
      row.sno = idx + 1;
    });

    // Calculate total capacity for tray scan counter
    let totalCapacity = 0;
    rows.forEach(row => {
      totalCapacity += parseInt(row.tray_qty) || 0;
    });

    console.log('[DEBUG] Total capacity calculated:', totalCapacity);

    let draftIndicator = isDraft ? ' (Draft)' : '';
    let draftAlert = isDraft ? `
      <div class="alert alert-info" style="margin: 10px 0; padding: 8px 12px; font-size: 14px;">
        <i class="fa fa-info-circle"></i> This is draft data. You can edit and save changes.
      </div>
    ` : '';

    let html = `
      <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
        <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
          <img src="/static/assets/images/userProfile.png" alt="User Profile" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
          <span>Model No:</span>
          <h6>${modelNo} / Accepted Tray Rescan${draftIndicator}</h6>
        </div>
      </div>
      ${draftAlert}
      
      <!-- Header with Tray Scan Counter and Redo Button -->
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
        <h5 style="margin: 0; font-weight: 600; color:#595959">
          Accepted case tray scan table${isDraft ? ' (Draft Mode)' : ''}
        </h5>
        <div style="display: flex; align-items: center; gap: 15px;">
          <!-- Tray Scan Counter -->
          <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #dee2e6;">
            <span style="font-size: 14px; font-weight: 600; color: #028084;">Scan Qty:</span>
            <span id="trayScanCounter" style="font-size: 14px; font-weight: bold; color: #dc3545;" data-total="${totalCapacity}">${totalCapacity}/${totalCapacity}</span>
          </div>
          <!-- Redo Button -->
          <img src="/static/assets/icons/redo2.png" alt="Redo" id="acceptedTrayRedoBtn" 
               style="width: 24px; height: 24px; cursor: pointer;" title="Clear Tray IDs" />
        </div>
      </div>
      
      <div id="trayScanDetails" class="table-grid">
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">S.no</div>
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray ID</div>
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray Qty</div>
    `;

    // Handle case where no rows exist - create default rows
    if (rows.length === 0) {
      console.log('[DEBUG] No rows found, creating default row');
      rows = [{ tray_id: '', tray_qty: 10, sno: 1 }]; // Default row
    }

    rows.forEach((row, index) => {
      let inputStyle = isDraft ? 'width:90px; background-color: #f0f8ff;' : 'width:90px;';
      let isTopTray = index === 0;
      let topTrayQty = isTopTray && verifiedTrayQty > 0 ? verifiedTrayQty : row.tray_qty;
      
      html += `
        <div style="border: 1px solid #ccc; padding: 8px;">${isTopTray ? '1 (Top Tray)' : row.sno}</div>
        <div style="border: 1px solid #ccc; padding: 8px;">
          <input type="text" value="${row.tray_id || ''}" style="${inputStyle}" class="accepted-tray-id-input" data-row="${row.sno}" data-tray-qty="${row.tray_qty}" />
          <span class="tray-id-error" style="display:none; color:#d32f2f; font-size:12px; margin-left:4px;"></span>
        </div>
        <div style="border: 1px solid #ccc; padding: 8px;">
          <input type="number" value="${topTrayQty || row.tray_qty}" style="width:60px; background-color: #f5f5f5;" readonly />
        </div>
      `;
    });

    // Add buttons based on draft mode
    if (isDraft) {
      html += `
        <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <button id="acceptedTrayUpdateDraftBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Update Draft</button>
          <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTrayFinalSubmitBtn">Final Submit</button>
          <button id="acceptedTrayCancelDraftBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">Cancel</button>
        </div>
      `;
    } else {
      html += `
        <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <button id="acceptedTrayDraftBtn" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Draft</button>
          <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTraySubmitBtn">Submit</button>
          <button id="acceptedTrayCancelBtn" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">Cancel</button>
        </div>
      `;
    }

    html += `
      <div id="acceptedTrayMsg" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
    </div>`;
    
    // CRITICAL: Get the modal and verify it exists
    const newPopupModal = document.getElementById("newPopupModal");
    if (!newPopupModal) {
      console.error('[DEBUG] newPopupModal element not found in DOM!');
      alert('Error: Modal element not found. Please refresh the page.');
      return;
    }

    console.log('[DEBUG] newPopupModal found:', newPopupModal);
    
    // Get the modal content container
    const modalContent = newPopupModal.querySelector(".tray-scan-modal-content");
    if (!modalContent) {
      console.error('[DEBUG] Modal content container not found!');
      alert('Error: Modal content container not found. Please refresh the page.');
      return;
    }

    console.log('[DEBUG] Setting modal content...');
    
    // Set the content
    modalContent.innerHTML = html;
    
    console.log('[DEBUG] Content set, opening modal...');
    
    // CRITICAL: Force modal to open with multiple strategies
    // Strategy 1: Add the open class
    newPopupModal.classList.add("open");
    
    // Strategy 2: Force display style (in case CSS is not working)
    newPopupModal.style.display = 'block';
    newPopupModal.style.right = '0px';
    
    // Add event listeners
    try {
      console.log('[DEBUG] Adding event listeners...');
      
      if (isDraft) {
        addDraftModeEventListeners(lotId);
      } else {
        addNormalModeEventListeners(lotId);
      }

      addTrayIdValidation(lotId);
      addAcceptedTrayRedoFunctionality();
      
      console.log('[DEBUG] Event listeners added successfully');
      
      // Focus on first input for better UX
      setTimeout(() => {
        const firstInput = document.querySelector('.accepted-tray-id-input');
        if (firstInput) {
          firstInput.focus();
        }
      }, 200);
      
    } catch (error) {
      console.error('[DEBUG] Error adding event listeners:', error);
    }
    
    console.log('[DEBUG] showAcceptedTrayModal completed successfully');
  }

  // Add event listeners for normal mode
  function addNormalModeEventListeners(lotId) {
    // Draft button
    const draftBtn = document.getElementById("acceptedTrayDraftBtn");
    if (draftBtn) {
      draftBtn.addEventListener("click", function () {
        saveTrayData(lotId, true, "Draft saved successfully!");
      });
    }

    // Submit button
    const submitBtn = document.getElementById("acceptedTraySubmitBtn");
    if (submitBtn) {
      submitBtn.addEventListener("click", function () {
        saveTrayData(lotId, false, "Accepted tray scan saved!");
      });
    }

    // Cancel button
    const cancelBtn = document.getElementById("acceptedTrayCancelBtn");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function () {
        document.getElementById("newPopupModal").classList.remove("open");
        document.getElementById("trayScanModal").classList.remove("open");
        window.location.reload(); // Reload to reset state
      });
    }
  }

  // Add event listeners for draft mode
  function addDraftModeEventListeners(lotId) {
    // Update Draft button
    const updateDraftBtn = document.getElementById("acceptedTrayUpdateDraftBtn");
    if (updateDraftBtn) {
      updateDraftBtn.addEventListener("click", function () {
        saveTrayData(lotId, true, "Draft updated successfully!");
      });
    }
    
    // Final Submit button
    const finalSubmitBtn = document.getElementById("acceptedTrayFinalSubmitBtn");
    if (finalSubmitBtn) {
      finalSubmitBtn.addEventListener("click", function () {
        saveTrayData(lotId, false, "Final submission successful!");
      });
    }
    
    // Cancel button
    const cancelBtn = document.getElementById("acceptedTrayCancelDraftBtn");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function () {
        document.getElementById("newPopupModal").classList.remove("open");
        document.getElementById("trayScanModal").classList.remove("open");
      });
    }
  }

  // Updated addTrayIdValidation function to include counter updates
  function addTrayIdValidation(lotId) {
    document.querySelectorAll('.accepted-tray-id-input').forEach(function(input, idx, allInputs) {
      // Add input event listener to update counter in real-time
      input.addEventListener('input', function() {
        updateTrayScanCounter();
      });
      
      input.addEventListener('blur', function() {
        const trayId = input.value.trim();
        const errorSpan = input.parentElement.querySelector('.tray-id-error');
        errorSpan.textContent = '';
        errorSpan.style.display = 'none';
        
        // Update counter when input loses focus
        updateTrayScanCounter();
        
        if (!trayId) return;

        // Check for duplicate tray ID in other rows
        let duplicateRow = null;
        allInputs.forEach(function(otherInput, otherIdx) {
          if (otherIdx !== idx && otherInput.value.trim() === trayId) {
            duplicateRow = otherInput.dataset.row;
          }
        });
        if (duplicateRow) {
          errorSpan.textContent = `Duplicate Tray ID: "${trayId}" already in row ${duplicateRow}.`;
          errorSpan.style.display = 'inline';
          return;
        }

        // Server check for existence and lot match
        fetch(`/nickle_inspection/nickle_check_tray_id/?tray_id=${encodeURIComponent(trayId)}&lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.exists) {
              if (data.not_in_same_lot) {
                errorSpan.textContent = `Tray ID "${trayId}" is not in the same lot (Row ${input.dataset.row}).`;
              } else if (data.already_rejected) {
                errorSpan.textContent = `Tray ID "${trayId}" is already rejected in IP screen (Row ${input.dataset.row}).`;
              } else {
                errorSpan.textContent = `Tray ID "${trayId}" is not existing (Row ${input.dataset.row}).`;
              }
              errorSpan.style.display = 'inline';
            }
          });
      });
      
      // Add Enter key navigation
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const nextInput = allInputs[idx + 1];
          if (nextInput) {
            nextInput.focus();
          }
        }
      });
    });
  }

  // Function to update tray scan counter
  function updateTrayScanCounter() {
    const counter = document.getElementById('trayScanCounter');
    if (!counter) return;
    
    const totalCapacity = parseInt(counter.getAttribute('data-total')) || 0;
    let remainingCapacity = totalCapacity;
    
    // Calculate remaining capacity based on filled tray IDs
    document.querySelectorAll('.accepted-tray-id-input').forEach(function(input) {
      const trayQty = parseInt(input.getAttribute('data-tray-qty')) || 0;
      const trayId = input.value.trim();
      
      if (trayId) {
        remainingCapacity -= trayQty;
      }
    });
    
    // Ensure remaining capacity doesn't go below 0
    remainingCapacity = Math.max(0, remainingCapacity);
    
    // Update counter display
    counter.textContent = `${remainingCapacity}/${totalCapacity}`;
    
    // Change color based on progress
    if (remainingCapacity === 0) {
      counter.style.color = '#28a745'; // Green when complete
    } else if (remainingCapacity < totalCapacity) {
      counter.style.color = '#ffc107'; // Yellow when in progress
    } else {
      counter.style.color = '#dc3545'; // Red when not started
    }
  }

  // Function to add redo functionality
  function addAcceptedTrayRedoFunctionality() {
    const redoBtn = document.getElementById('acceptedTrayRedoBtn');
    if (!redoBtn) return;
    
    redoBtn.addEventListener('click', function() {
      // Clear all tray ID inputs
      document.querySelectorAll('.accepted-tray-id-input').forEach(function(input) {
        input.value = '';
      });
      
      // Clear all error messages
      document.querySelectorAll('.tray-id-error').forEach(function(error) {
        error.style.display = 'none';
        error.textContent = '';
      });
      
      // Update tray scan counter
      updateTrayScanCounter();
      
      // Focus on first input
      const firstInput = document.querySelector('.accepted-tray-id-input');
      if (firstInput) {
        firstInput.focus();
      }
    });
  }

  // Helper function to save tray data - UPDATED to handle draft saving without visible reload
  function saveTrayData(lotId, isDraft, successMessage) {
    const rows = [];
    document.querySelectorAll('#newPopupModal .table-grid input[type="text"]').forEach((input, idx) => {
      const tray_id = input.value;
      const qtyInput = input.parentElement.nextElementSibling.querySelector('input[type="number"]');
      const tray_qty = qtyInput ? qtyInput.value : '';
      rows.push({ tray_id, tray_qty });
    });

    fetch('/nickle_inspection/nickle_save_accepted_tray_scan/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ lot_id: lotId, rows: rows, draft_save: isDraft })
    })
    .then(res => res.json())
    .then(data => {
      const msgP = document.getElementById("acceptedTrayMsg");
      if (data.success) {
        if (msgP) {
          msgP.style.color = "#388e3c";
          msgP.textContent = successMessage;
        }
        // Reload the page after a short delay for user feedback
        setTimeout(function() {
          window.location.reload();
        }, 800);
      } else {
        if (msgP) {
          msgP.style.color = "#d32f2f";
          msgP.textContent = data.error || "Failed to save";
        }
      }
    })
    .catch(error => {
      console.error('Error saving data:', error);
      const msgP = document.getElementById("acceptedTrayMsg");
      if (msgP) {
        msgP.style.color = "#d32f2f";
        msgP.textContent = "Error saving data. Please try again.";
      }
    });
  }

  // Existing modal close event listeners
  closeTrayBtn.addEventListener("click", () => {
    trayModal.classList.remove("open");
  });
  
  trayModal.addEventListener("click", (event) => {
    if (event.target === trayModal) {
      trayModal.classList.remove("open");
    }
  });
  
  // New Popup Modal close events
  closeNewPopupBtn.addEventListener("click", () => {
    newPopupModal.classList.remove("open");
  });

  // STORE LOT ID GLOBALLY WHEN ANY BUTTON IS CLICKED
  document.addEventListener('click', function(e) {
    if (e.target.matches('.tray-scan-btn, .tray-scan-btn-NI')) {
      const row = e.target.closest('tr');
      if (row) {
        storeLotIdGlobally(row);
      }
    }
  });
 
});
</script>


<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function() {
  
  // Function to show accepted tray modal (adapted from IS_PickTable.html)
  function showAcceptedTrayModal(rescanData, lotId, isDraft) {
    let rows = rescanData.rows || [];   
    let modelNo = rescanData.model_no;
    let topTrayVerified = rescanData.top_tray_verified || false;
    let verifiedTrayQty = rescanData.verified_tray_qty || 0;
    
    rows.sort((a, b) => parseInt(a.tray_qty) - parseInt(b.tray_qty));
    
    // Reassign S.no after sorting
    rows.forEach((row, idx) => {
      row.sno = idx + 1;
    });

    // Calculate total capacity for tray scan counter
    let totalCapacity = 0;
    rows.forEach(row => {
      totalCapacity += parseInt(row.tray_qty) || 0;
    });

    let draftIndicator = isDraft ? ' (Draft)' : '';
    let draftAlert = isDraft ? `
      <div class="alert alert-info" style="margin: 10px 0; padding: 8px 12px; font-size: 14px;">
        <i class="fa fa-info-circle"></i> This is draft data. You can edit and save changes.
      </div>
    ` : '';

    let html = `
      <div class="modal-top-header" style="display: flex; align-items: center; gap: 20px; padding-bottom: 10px;">
        <div class="user-profile" style="display: flex; align-items: center; gap: 8px">
          <img src="/static/assets/images/imagePlaceholder.png" alt="User Profile" style="border-radius: 50%; width: 50px; height: 50px; object-fit: cover;" />
          <span>Model No:</span>
          <h6>${modelNo} / Accepted Tray Rescan${draftIndicator}</h6>
        </div>
      </div>
      ${draftAlert}
      
      <!-- Header with Tray Scan Counter and Redo Button -->
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
        <h5 style="margin: 0; font-weight: 600; color:#595959">
          Nickle Inspection - Accepted Tray Scan${isDraft ? ' (Draft Mode)' : ''}
        </h5>
        
        <div style="display: flex; align-items: center; gap: 15px;">
          <!-- Tray Scan Counter -->
          <div style="display: flex; align-items: center; gap: 8px; background: #f8f9fa; padding: 6px 12px; border-radius: 20px; border: 1px solid #dee2e6;">
            <span style="font-size: 14px; font-weight: 600; color: #028084;">Scan Qty:</span>
            <span id="trayScanCounter_NI" style="font-size: 14px; font-weight: bold; color: #dc3545;" data-total="${totalCapacity}">${totalCapacity}/${totalCapacity}</span>
          </div>
          <!-- Redo Button -->
          <img src="{% static 'assets/icons/redo2.png' %}" alt="Redo" id="acceptedTrayRedoBtn_NI" 
               style="width: 24px; height: 24px; cursor: pointer;" title="Clear Tray IDs" />
        </div>
      </div>
      
      <div id="trayScanDetails_NI" class="table-grid">
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">S.no</div>
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray ID</div>
        <div style="border: 1px solid #ccc; padding: 8px; font-weight: bold;">Tray Qty</div>
    `;

    rows.forEach((row, index) => {
      let inputStyle = isDraft ? 'width:90px; background-color: #f0f8ff;' : 'width:90px;';
      let isTopTray = index === 0;
      let topTrayQty = isTopTray && verifiedTrayQty > 0 ? verifiedTrayQty : row.tray_qty;
      
      html += `
        <div style="border: 1px solid #ccc; padding: 8px;">${isTopTray ? '1 (Top Tray)' : row.sno}</div>
        <div style="border: 1px solid #ccc; padding: 8px;">
          <input type="text" value="${row.tray_id}" style="${inputStyle}" class="accepted-tray-id-input-ni" data-row="${row.sno}" data-tray-qty="${row.tray_qty}" />
          <span class="tray-id-error-ni" style="display:none; color:#d32f2f; font-size:12px; margin-left:4px;"></span>
        </div>
        <div style="border: 1px solid #ccc; padding: 8px;">
          ${isTopTray ? `
            <!-- Top Tray Quantity with Icons -->
            <div style="display: flex; align-items: center; gap: 8px;">
              <input type="number" 
                     value="${topTrayQty}" 
                     style="width:60px; background-color: ${topTrayVerified ? '#f5f5f5' : '#fff'};" 
                     class="top-tray-qty-input-ni"
                     ${topTrayVerified ? 'readonly' : 'readonly'}
                     data-original-qty="${row.tray_qty}" />
              
              <!-- Edit Icon -->
              <img src="{% static 'assets/icons/edit1.png' %}" 
                   alt="Edit" 
                   class="edit-top-tray-btn-ni" 
                   style="width: 18px; height: 18px; cursor: pointer; ${topTrayVerified ? 'opacity: 0.5; pointer-events: none;' : ''}" 
                   title="Edit Top Tray Quantity" />
              
              <!-- Check Icon -->
              <input type="checkbox" 
                     class="verify-top-tray-checkbox-ni" 
                     style="width: 18px; height: 18px; cursor: pointer;" 
                     ${topTrayVerified ? 'checked disabled' : ''}
                     title="Verify Top Tray Quantity" />
            </div>
          ` : `
            <input type="number" value="${row.tray_qty}" style="width:60px; background-color: #f5f5f5;" readonly />
          `}
        </div>
      `;
    });

    // Different buttons based on draft mode
    if (isDraft) {
      html += `
        <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <button id="acceptedTrayUpdateDraftBtn_NI" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Update Draft</button>
          <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTrayFinalSubmitBtn_NI">Final Submit</button>
          <button id="acceptedTrayCancelDraftBtn_NI" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
            Cancel
          </button>
        </div>
      `;
    } else {
      html += `
        <div style="grid-column: 1 / -1; display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
          <button id="acceptedTrayDraftBtn_NI" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 30px;">Draft</button>
          <button style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 30px;" id="acceptedTraySubmitBtn_NI">Submit</button>
          <button id="acceptedTrayCancelBtn_NI" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 30px;">
            Cancel
          </button>
        </div>
      `;
    }

    html += `
      <div id="acceptedTrayMsg_NI" style="margin-top: 10px; text-align: center; font-weight: bold;"></div>
    </div>`;
    
    document.querySelector("#newPopupModal .tray-scan-modal-content").innerHTML = html;
    document.getElementById("newPopupModal").classList.add("open");
    
    // Initialize tray scan counter
    updateTrayScanCounter_NI();
    
    // Add event listeners based on mode
    if (isDraft) {
      addDraftModeEventListeners_NI(lotId);
    } else {
      addNormalModeEventListeners_NI(lotId);
    }

    // Add tray ID validation for all modes
    addTrayIdValidation_NI(lotId);
    
    // Add redo functionality
    addAcceptedTrayRedoFunctionality_NI();
    
    // Add top tray verification functionality
    addTopTrayVerificationFunctionality_NI(lotId);
  }

  // Function to update tray scan counter
  function updateTrayScanCounter_NI() {
    const counter = document.getElementById('trayScanCounter_NI');
    if (!counter) return;
    
    const totalCapacity = parseInt(counter.getAttribute('data-total')) || 0;
    let remainingCapacity = totalCapacity;
    
    // Calculate remaining capacity based on filled tray IDs
    document.querySelectorAll('.accepted-tray-id-input-ni').forEach(function(input) {
      const trayQty = parseInt(input.getAttribute('data-tray-qty')) || 0;
      const trayId = input.value.trim();
      
      if (trayId) {
        remainingCapacity -= trayQty;
      }
    });
    
    // Ensure remaining capacity doesn't go below 0
    remainingCapacity = Math.max(0, remainingCapacity);
    
    // Update counter display
    counter.textContent = `${remainingCapacity}/${totalCapacity}`;
    
    // Change color based on progress
    if (remainingCapacity === 0) {
      counter.style.color = '#28a745'; // Green when complete
    } else if (remainingCapacity < totalCapacity) {
      counter.style.color = '#ffc107'; // Yellow when in progress
    } else {
      counter.style.color = '#dc3545'; // Red when not started
    }
  }

  // Function to add redo functionality
  function addAcceptedTrayRedoFunctionality_NI() {
    const redoBtn = document.getElementById('acceptedTrayRedoBtn_NI');
    if (!redoBtn) return;
    
    redoBtn.addEventListener('click', function() {
      // Clear all tray ID inputs
      document.querySelectorAll('.accepted-tray-id-input-ni').forEach(function(input) {
        input.value = '';
      });
      
      // Clear all error messages
      document.querySelectorAll('.tray-id-error-ni').forEach(function(error) {
        error.style.display = 'none';
        error.textContent = '';
      });
      
      // Update tray scan counter
      updateTrayScanCounter_NI();
      
      // Focus on first input
      const firstInput = document.querySelector('.accepted-tray-id-input-ni');
      if (firstInput) {
        firstInput.focus();
      }
    });
  }

  // Function to add tray ID validation
  function addTrayIdValidation_NI(lotId) {
    document.querySelectorAll('.accepted-tray-id-input-ni').forEach(function(input, idx, allInputs) {
      // Add input event listener to update counter in real-time
      input.addEventListener('input', function() {
        updateTrayScanCounter_NI();
      });
      
      input.addEventListener('blur', function() {
        const trayId = input.value.trim();
        const errorSpan = input.parentElement.querySelector('.tray-id-error-ni');
        errorSpan.textContent = '';
        errorSpan.style.display = 'none';
        
        // Update counter when input loses focus
        updateTrayScanCounter_NI();
        
        if (!trayId) return;

        // Check for duplicate tray ID in other rows
        let duplicateRow = null;
        allInputs.forEach(function(otherInput, otherIdx) {
          if (otherIdx !== idx && otherInput.value.trim() === trayId) {
            duplicateRow = otherInput.dataset.row;
          }
        });
        if (duplicateRow) {
          errorSpan.textContent = `Duplicate Tray ID: "${trayId}" already in row ${duplicateRow}.`;
          errorSpan.style.display = 'inline';
          return;
        }

        // Server check for existence and lot match
        fetch(`/nickle_inspection/nickle_check_tray_id/?tray_id=${encodeURIComponent(trayId)}&lot_id=${encodeURIComponent(lotId)}`)
          .then(res => res.json())
          .then(data => {
            if (!data.exists) {
              if (data.not_in_same_lot) {
                errorSpan.textContent = `Tray ID "${trayId}" is not in the same lot (Row ${input.dataset.row}).`;
              } else if (data.already_rejected) {
                errorSpan.textContent = `Tray ID "${trayId}" is already rejected in Nickle IP (Row ${input.dataset.row}).`;
              } else {
                errorSpan.textContent = `Tray ID "${trayId}" is not existing (Row ${input.dataset.row}).`;
              }
              errorSpan.style.display = 'inline';
            }
          });
      });
      
      // Add Enter key navigation
      input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const nextInput = allInputs[idx + 1];
          if (nextInput) {
            nextInput.focus();
          }
        }
      });
    });
  }

  // Add event listeners for normal mode
  function addNormalModeEventListeners_NI(lotId) {
    // Draft button
    const draftBtn = document.getElementById("acceptedTrayDraftBtn_NI");
    if (draftBtn) {
      draftBtn.addEventListener("click", function () {
        saveTrayData_NI(lotId, true, "Draft saved successfully!");
      });
    }

    // Submit button
    const submitBtn = document.getElementById("acceptedTraySubmitBtn_NI");
    if (submitBtn) {
      submitBtn.addEventListener("click", function () {
        saveTrayData_NI(lotId, false, "Accepted tray scan saved!");
      });
    }

    // Cancel button
    const cancelBtn = document.getElementById("acceptedTrayCancelBtn_NI");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function () {
        document.getElementById("newPopupModal").classList.remove("open");
        document.getElementById("trayScanModal").classList.remove("open");
        window.location.reload();
      });
    }
  }

  // Add event listeners for draft mode
  function addDraftModeEventListeners_NI(lotId) {
    // Update Draft button
    const updateDraftBtn = document.getElementById("acceptedTrayUpdateDraftBtn_NI");
    if (updateDraftBtn) {
      updateDraftBtn.addEventListener("click", function () {
        saveTrayData_NI(lotId, true, "Draft updated successfully!");
      });
    }
    
    // Final Submit button
    const finalSubmitBtn = document.getElementById("acceptedTrayFinalSubmitBtn_NI");
    if (finalSubmitBtn) {
      finalSubmitBtn.addEventListener("click", function () {
        saveTrayData_NI(lotId, false, "Final submission successful!");
      });
    }
    
    // Cancel button
    const cancelBtn = document.getElementById("acceptedTrayCancelDraftBtn_NI");
    if (cancelBtn) {
      cancelBtn.addEventListener("click", function () {
        document.getElementById("newPopupModal").classList.remove("open");
        document.getElementById("trayScanModal").classList.remove("open");
      });
    }
  }

  // Helper function to save tray data
  function saveTrayData_NI(lotId, isDraft, successMessage) {
    const rows = [];
    document.querySelectorAll('#newPopupModal .table-grid input[type="text"]').forEach((input, idx) => {
      const tray_id = input.value;
      const qtyInput = input.parentElement.nextElementSibling.querySelector('input[type="number"]');
      const tray_qty = qtyInput ? qtyInput.value : '';
      rows.push({ tray_id, tray_qty });
    });

    fetch('/nickle_inspection/nickle_save_accepted_tray_scan/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ lot_id: lotId, rows: rows, draft_save: isDraft })
    })
    .then(res => res.json())
    .then(data => {
      const msgP = document.getElementById("acceptedTrayMsg_NI");
      if (data.success) {
        if (msgP) {
          msgP.style.color = "#388e3c";
          msgP.textContent = successMessage;
        }
        // Reload the page after a short delay for user feedback
        setTimeout(function() {
          window.location.reload();
        }, 800);
      } else {
        if (msgP) {
          msgP.style.color = "#d32f2f";
          msgP.textContent = data.error || "Failed to save";
        }
      }
    })
    .catch(error => {
      console.error('Error saving data:', error);
      const msgP = document.getElementById("acceptedTrayMsg_NI");
      if (msgP) {
        msgP.style.color = "#d32f2f";
        msgP.textContent = "Error saving data. Please try again.";
      }
    });
  }

  // Add top tray verification functionality
  function addTopTrayVerificationFunctionality_NI(lotId) {
    const editBtn = document.querySelector('.edit-top-tray-btn-ni');
    const checkbox = document.querySelector('.verify-top-tray-checkbox-ni');
    let qtyInput = document.querySelector('.top-tray-qty-input-ni');
    
    // Edit button click handler
    if (editBtn && editBtn.style.pointerEvents !== 'none') {
      editBtn.addEventListener('click', function() {
        if (checkbox.checked || checkbox.disabled) return;
        
        // Enable editing
        qtyInput.removeAttribute('readonly');
        qtyInput.style.backgroundColor = '#fff3cd';
        qtyInput.style.borderColor = '#ffc107';
        qtyInput.style.cursor = 'text';
        qtyInput.focus();
        qtyInput.select();
        
        const originalQty = parseInt(qtyInput.getAttribute('data-original-qty')) || 0;
        
        // Remove any existing event listeners to avoid duplicates
        const newInput = qtyInput.cloneNode(true);
        qtyInput.parentNode.replaceChild(newInput, qtyInput);
        qtyInput = newInput;
        
        newInput.focus();
        newInput.select();
        
        // Add real-time validation
        newInput.addEventListener('input', function(e) {
          let val = parseInt(this.value) || 0;
          
          if (val < 0) {
            this.value = 0;
            val = 0;
          }
          
          if (val > originalQty) {
            this.value = originalQty;
            val = originalQty;
          }
          
          updateTrayScanCounter_NI();
        });
        
        // Handle keydown events
        newInput.addEventListener('keydown', function(e) {
          if ([46, 8, 9, 27, 13, 35, 36, 37, 39, 38, 40].indexOf(e.keyCode) !== -1 ||
              (e.keyCode === 65 && e.ctrlKey === true) ||
              (e.keyCode === 67 && e.ctrlKey === true) ||
              (e.keyCode === 86 && e.ctrlKey === true) ||
              (e.keyCode === 88 && e.ctrlKey === true)) {
            
            if (e.key === 'Enter') {
              e.preventDefault();
              this.blur();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              this.value = originalQty;
              this.blur();
            }
            return;
          }
          
          if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
          }
        });
        
        // Handle blur
        newInput.addEventListener('blur', function() {
          let finalVal = parseInt(this.value) || 0;
          if (finalVal < 0) finalVal = 0;
          if (finalVal > originalQty) finalVal = originalQty;
          this.value = finalVal;
          
          this.setAttribute('readonly', true);
          this.style.backgroundColor = '#f5f5f5';
          this.style.borderColor = '#ccc';
          this.style.cursor = 'not-allowed';
          
          updateTrayScanCounter_NI();
        }, { once: true });
      });
    }
    
    // Checkbox click handler
    if (checkbox && !checkbox.disabled) {
      checkbox.addEventListener('change', function() {
        if (this.checked) {
          const currentQtyInput = document.querySelector('.top-tray-qty-input-ni');
          const verifiedQty = parseInt(currentQtyInput.value) || 0;
          const originalQty = parseInt(currentQtyInput.getAttribute('data-original-qty')) || 0;
          
          if (verifiedQty <= 0) {
            showTopTrayError_NI('Please enter a valid quantity before verifying.');
            this.checked = false;
            return;
          }
          
          if (!originalQty || originalQty <= 0) {
            showTopTrayError_NI('Original quantity not found. Please refresh and try again.');
            this.checked = false;
            return;
          }
          
          // Save verification to backend
          saveTopTrayVerification_NI(lotId, verifiedQty, originalQty);
        }
      });
    }
  }

  // Function to save top tray verification
  function saveTopTrayVerification_NI(lotId, verifiedQty, originalQty) {
    if (!lotId) {
      showTopTrayError_NI('Lot ID not found');
      return;
    }
    
    if (!verifiedQty || verifiedQty <= 0) {
      showTopTrayError_NI('Please enter a valid verified quantity');
      return;
    }
    
    if (!originalQty || originalQty <= 0) {
      showTopTrayError_NI('Original quantity not found');
      return;
    }
    
    const requestBody = {
      lot_id: lotId,
      verified_tray_qty: verifiedQty,
      original_tray_qty: originalQty
    };
    
    fetch('/nickle_inspection/nickle_verify_top_tray_qty/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(requestBody)
    })
    .then(res => {
      if (!res.ok) {
        throw new Error(`HTTP error! status: ${res.status}`);
      }
      return res.json();
    })
    .then(data => {
      if (data.success) {
        // Update UI to show verified state
        const qtyInput = document.querySelector('.top-tray-qty-input-ni');
        const editBtn = document.querySelector('.edit-top-tray-btn-ni');
        const checkbox = document.querySelector('.verify-top-tray-checkbox-ni');
        
        if (qtyInput) {
          qtyInput.setAttribute('readonly', true);
          qtyInput.style.backgroundColor = '#f5f5f5';
          qtyInput.style.borderColor = '#28a745';
        }
        
        if (editBtn) {
          editBtn.style.opacity = '0.5';
          editBtn.style.pointerEvents = 'none';
        }
        
        if (checkbox) {
          checkbox.disabled = true;
        }
        
        showTopTraySuccess_NI(`Top tray quantity verified successfully! Saved: ${data.verified_qty}`);
        updateTrayScanCounter_NI();
        
      } else {
        const checkbox = document.querySelector('.verify-top-tray-checkbox-ni');
        if (checkbox) checkbox.checked = false;
        
        showTopTrayError_NI(data.error || 'Failed to verify top tray quantity');
      }
    })
    .catch(error => {
      console.error('Error verifying top tray:', error);
      const checkbox = document.querySelector('.verify-top-tray-checkbox-ni');
      if (checkbox) checkbox.checked = false;
      
      showTopTrayError_NI('Network error occurred while verifying');
    });
  }

  // Function to show top tray success message
  function showTopTraySuccess_NI(message) {
    const msgDiv = document.getElementById("acceptedTrayMsg_NI");
    if (msgDiv) {
      msgDiv.style.color = "#388e3c";
      msgDiv.textContent = message;
      setTimeout(() => {
        msgDiv.textContent = "";
      }, 3000);
    }
  }

  // Function to show top tray error message
  function showTopTrayError_NI(message) {
    const msgDiv = document.getElementById("acceptedTrayMsg_NI");
    if (msgDiv) {
      msgDiv.style.color = "#d32f2f";
      msgDiv.textContent = message;
      setTimeout(() => {
        msgDiv.textContent = "";
      }, 5000);
    }
  }

  // MAIN INTEGRATION: Update the existing proceed button handler
  // Add this to your existing proceed button event listener in the editable rejection form
  
  // Find and update the existing proceed button handler
  document.addEventListener('click', function(e) {
    if (e.target && e.target.id === 'readonlyProceedBtn') {
      const lotId = window.currentLotId || window.currentStockLotId;
      
      if (!lotId) {
        alert('LOT ID not found. Please refresh and try again.');
        return;
      }
      
      console.log('[DEBUG] Proceed button clicked, fetching accepted tray data for:', lotId);
      
      // First check if draft exists
      fetch(`/nickle_inspection/nickle_Ip_check_accepted_tray_draft/?lot_id=${encodeURIComponent(lotId)}`)
        .then(res => res.json())
        .then(draftData => {
          if (draftData.has_draft) {
            // Fetch and show draft data
            fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
              .then(res => res.json())
              .then(rescanData => {
                if (rescanData.success) {
                  // Close the rejection modal
                  document.getElementById("trayScanModal").classList.remove("open");
                  // Show accepted tray modal with draft data
                  showAcceptedTrayModal(rescanData, lotId, true);
                } else {
                  alert('Error loading draft data: ' + (rescanData.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('Error fetching draft data:', error);
                alert('Error loading draft data. Please try again.');
              });
          } else {
            // Proceed with normal flow - fetch fresh accepted tray data
            fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
              .then(res => res.json())
              .then(rescanData => {
                if (rescanData.success) {
                  // Close the rejection modal
                  document.getElementById("trayScanModal").classList.remove("open");
                  // Show accepted tray modal
                  showAcceptedTrayModal(rescanData, lotId, false);
                } else {
                  alert('Error loading accepted tray data: ' + (rescanData.error || 'Unknown error'));
                }
              })
              .catch(error => {
                console.error('Error fetching accepted tray data:', error);
                alert('Error loading accepted tray data. Please try again.');
              });
          }
        })
        .catch(error => {
          console.error('Error checking draft:', error);
          // Fallback to normal flow
          fetch(`/nickle_inspection/nickle_get_accepted_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
            .then(res => res.json())
            .then(rescanData => {
              if (rescanData.success) {
                document.getElementById("trayScanModal").classList.remove("open");
                showAcceptedTrayModal(rescanData, lotId, false);
              }
            });
        });
    }
  });

  // Helper function for CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
  
<!-- Recjection List Scripts -->
                        <script nonce="{{ csp_nonce }}">
                          document.addEventListener("DOMContentLoaded", function() {
                            var rejectionTrigger = document.querySelector('.rejection-popup-trigger');
                            var rejectionModal = document.getElementById('rejectionPopupModal');
                            var closeRejection = document.getElementById('closeRejectionPopup');

                            if (rejectionTrigger) {
                              rejectionTrigger.addEventListener('click', function() {
                                rejectionModal.classList.add("open");
                              });
                            }

                            if (closeRejection) {
                              closeRejection.addEventListener('click', function() {
                                rejectionModal.classList.remove("open");
                              });
                            }
                          });
                        </script>



   <!-- Script for Tray Validate Status column -- enable/disable of table column -->
   <script nonce="{{ csp_nonce }}">
      document.addEventListener("DOMContentLoaded", function () {
        const validateBtn = document.getElementById("trayValidateBtn");
        const detailsDiv = document.getElementById("trayScanDetails_NI");
        let validationEnabled = false;
      
        if (validateBtn && detailsDiv) {
          validateBtn.addEventListener("click", function () {
            validationEnabled = !validationEnabled;
      
            // Toggle header
            const header = detailsDiv.querySelector('.tray-validation-status-header');
            if (header) {
              header.style.opacity = validationEnabled ? "1" : "0.3";
              header.style.pointerEvents = validationEnabled ? "auto" : "none";
            }
      
            // Toggle all cells in the column
            detailsDiv.querySelectorAll('.tray-validation-status-cell').forEach(function(cell) {
              cell.style.opacity = validationEnabled ? "1" : "0.3";
              cell.style.pointerEvents = validationEnabled ? "auto" : "none";
            });
          });
        }
      });
   </script>

  <!-- Table Sorting Script -->
  <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      const table = document.getElementById("order-listing");
      if (!table) return;
      const headers = table.querySelectorAll("thead th");
      const tbody = table.querySelector("tbody");
      let sortDirection = {};
      headers.forEach((header, index) => {
        header.style.cursor = "pointer";
        header.addEventListener("click", function () {
          const rows = Array.from(tbody.querySelectorAll("tr"));
          const dir = sortDirection[index] === "asc" ? "desc" : "asc";
          sortDirection[index] = dir;
          rows.sort((a, b) => {
            const cellA = a.children[index].textContent.trim();
            const cellB = b.children[index].textContent.trim();
            const valA = isNaN(cellA) ? cellA : parseFloat(cellA);
            const valB = isNaN(cellB) ? cellB : parseFloat(cellB);
            if (valA < valB) return dir === "asc" ? -1 : 1;
            if (valA > valB) return dir === "asc" ? 1 : -1;
            return 0;
          });
          tbody.innerHTML = "";
          rows.forEach((row) => tbody.appendChild(row));
        });
      });
    });
  </script>


<!-- Complete Tray Scan Modal & New Popup Script with Lot ID Fix -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", () => {
  const trayScanLinks = document.querySelectorAll(".tray-scan-btn");
  const trayModal = document.getElementById("trayScanModal");
  const closeTrayBtn = document.getElementById("closeTrayScanModal");
  const detailsDiv = document.getElementById("trayScanDetails");
  const newPopupModal = document.getElementById("newPopupModal");
  const closeNewPopupBtn = document.getElementById("closeNewPopupModal");

  // GLOBAL LOT ID STORAGE FUNCTIONS
  function storeLotIdGlobally(row) {
    if (row) {
      // Store multiple references to lot_id
      window.currentLotId = row.getAttribute('data-lot-id') || 
                           row.getAttribute('data-stock-lot-id') || 
                           row.cells[2]?.textContent?.trim();
      window.currentStockLotId = window.currentLotId;
      window.currentActiveRow = row;
      
      console.log('[DEBUG] Stored lot_id globally:', window.currentLotId);
      
      // Also store in modal dataset if modal exists
      if (trayModal) {
        trayModal.dataset.stockLotId = window.currentLotId;
        trayModal.dataset.lotId = window.currentLotId;
      }
    }
  }

  trayScanLinks.forEach((link) => {
    link.addEventListener("click", (event) => {
      event.preventDefault();

      const row = event.target.closest("tr");
      
      // IMPROVED LOT ID EXTRACTION - Try multiple strategies
      let lotId = null;
      
      // Strategy 1: From button data attributes
      lotId = link.getAttribute('data-lot-id') || link.getAttribute('data-stock-lot-id');
      
      // Strategy 2: From row data attributes
      if (!lotId && row) {
        lotId = row.getAttribute('data-lot-id') || 
               row.getAttribute('data-stock-lot-id') ||
               row.cells[2]?.textContent?.trim(); // LOT ID column
      }
      
      // Strategy 3: From other elements in the row
      if (!lotId && row) {
        const lotIdCell = row.querySelector('td:nth-child(3)'); // LOT ID is usually 3rd column
        if (lotIdCell) {
          lotId = lotIdCell.textContent.trim();
        }
      }
      
      console.log('[DEBUG] Extracted lot_id:', lotId);
      
      if (!lotId || lotId === 'null' || lotId === 'undefined') {
        console.error('[DEBUG] Could not extract valid lot_id');
        alert('Error: Could not find LOT ID. Please refresh the page and try again.');
        return;
      }

      const batchId = link.getAttribute('data-batch-id') || lotId;
      const isOnHold = row.getAttribute('data-nickle-ip-onhold-picking') === 'True';
   
      // STORE LOT ID GLOBALLY WHEN MODAL OPENS
      storeLotIdGlobally(row);

      trayModal.dataset.batchId = batchId;
      trayModal.dataset.stockLotId = lotId;

      const dateTime = row.cells[1].textContent.trim();
      const totalQuantity = row.cells[10].textContent.trim();
      const modelNo = row.getAttribute('data-model-no') || '';
      const modalHeader = document.getElementById("trayScanModalHeader");
      if (modalHeader) {
        modalHeader.innerHTML = `Nickle Inspection / <span class="modal-model-no">${modelNo}</span> / Rejection Window`;
      }

      // If ip_onhold_picking is True, show read-only saved data
      if (isOnHold) {
        console.log('[DEBUG] Showing read-only data for lot_id:', lotId);
        showReadOnlyRejectionData(lotId, detailsDiv);
      } else {
        // Show editable rejection form (existing code)
        console.log('[DEBUG] Showing editable form for lot_id:', lotId);
        showEditableRejectionForm(lotId, batchId, detailsDiv, row);
      }

      trayModal.classList.add("open");
    });
  });

  // Function to show read-only saved rejection data
  function showReadOnlyRejectionData(lotId, detailsDiv) {
    console.log("[FRONTEND] Fetching rejected tray scan data for lotId:", lotId);
    
    // Validate lotId before making API call
    if (!lotId || lotId === 'null' || lotId === 'undefined' || lotId.trim() === '') {
      console.error('[FRONTEND] Invalid lot_id provided:', lotId);
      detailsDiv.innerHTML = `<div style="color:red;">Error: Invalid LOT ID. Please refresh the page and try again.</div>`;
      return;
    }
    
    fetch(`/nickle_inspection/nickle_ip_get_rejected_tray_scan_data/?lot_id=${encodeURIComponent(lotId)}`)
      .then(res => res.json())
      .then(data => {
        console.log("[FRONTEND] API response for lotId", lotId, ":", data);
        if (!data.success) {
          detailsDiv.innerHTML = `<div style="color:red;">${data.error || "No data found"}</div>`;
          return;
        }
        
        // Check if this is batch rejection or tray-wise rejection
        let isBatchRejection = data.is_batch_rejection || false;
        let totalRejectionQty = data.total_rejection_qty || 0;
        
        let html = `
          <div style="font-weight:bold; margin-bottom:8px;">
            Saved Rejection Details - ${isBatchRejection ? 'BATCH REJECTION' : 'TRAY-WISE REJECTION'}
            <br><span style="font-size:12px; color:#117057;">(Read Only)</span>
          </div>
          <div class="alert alert-info" style="font-size:13px; margin-bottom:10px;">
            <i class="fa fa-info-circle"></i> This data is already saved and cannot be modified
          </div>
        `;
        
        if (isBatchRejection) {
          // Special handling for batch rejection
          html += `
            <div class="alert alert-warning" style="font-size:13px; margin-bottom:10px;">
              <i class="fa fa-exclamation-triangle"></i> This LOT was rejected as a complete batch
            </div>
            <table class="table table-bordered text-center" style="font-size:13px;">
              <thead>
                <tr>
                  <th>Rejection Type</th>
                  <th>Total Quantity Rejected</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td style="font-weight:bold; color:#d32f2f;">BATCH REJECTION</td>
                  <td style="font-weight:bold; color:#d32f2f;">${totalRejectionQty}</td>
                  <td>${new Date().toLocaleDateString()}</td>
                </tr>
              </tbody>
            </table>
          `;
        } else {
          // Standard table for tray-wise rejection
          html += `
            <table class="table table-bordered text-center" style="font-size:13px;">
              <thead>
                <tr>
                  <th>S.No</th>
                  <th>Reason ID</th>
                  <th>Rejection Reason</th>
                  <th>Quantity</th>
                  <th>Tray</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let totalQty = 0;
          if (data.rows && data.rows.length > 0) {
            data.rows.forEach((row, idx) => {
              html += `
                <tr>
                  <td>${row.sno || (idx + 1)}</td>
                  <td>${row.reason_id || ''}</td>
                  <td>${row.reason || ''}</td>
                  <td>${row.qty || 0}</td>
                  <td>${row.tray_id || ''}</td>
                </tr>
              `;
              totalQty += parseInt(row.qty) || 0;
            });
          } else {
            html += `
              <tr>
                <td colspan="5" style="color:#666; font-style:italic;">No rejection data found</td>
              </tr>
            `;
          }
          
          html += `
              <tr style="font-weight:bold; background-color:#f8f9fa;">
                <td colspan="3" style="text-align:right;">Total Saved Qty</td>
                <td style="color:${totalQty === 0 ? 'red' : '#117057'};">${totalQty}</td>
                <td></td>
              </tr>
            </tbody>
            </table>
          `;
        }
        
        html += `
          <div style="text-align:center; margin-top:16px;">
            <button class="btn btn-success" id="readonlyProceedBtn">Proceed</button>
            <button class="btn btn-secondary" id="readonlyCloseBtn">Close</button>
          </div>
        `;
        
        detailsDiv.innerHTML = html;

        // Button handlers
        document.getElementById('readonlyProceedBtn').onclick = function() {
          document.getElementById('trayScanModal').classList.remove('open');
        };
        document.getElementById('readonlyCloseBtn').onclick = function() {
          document.getElementById('trayScanModal').classList.remove('open');
        };
      })
      .catch(error => {
        console.error("[FRONTEND] Error fetching rejected tray scan data:", error);
        detailsDiv.innerHTML = `<div style="color:red;">Error loading rejection data: ${error.message}</div>`;
      });
  }

  // Rest of your existing functions...
  // (showEditableRejectionForm, addEditableFormEventListeners, etc.)
});
  </script>
  <!-- Script for Text Remarks (unchanged) -->
  <script nonce="{{ csp_nonce }}">
    document.addEventListener("DOMContentLoaded", function () {
      var triggers = document.querySelectorAll(".remark-tooltip-trigger");
      triggers.forEach(function (trigger) {
        var tooltip = trigger.querySelector(".remark-tooltip");
        var sendButton = tooltip ? tooltip.querySelector("button") : null;
        function showTooltip() {
          tooltip.style.opacity = "1";
          tooltip.style.visibility = "visible";
          var rect = tooltip.getBoundingClientRect();
          if (rect.right > window.innerWidth) {
            tooltip.style.left = "auto";
            tooltip.style.right = "0";
            tooltip.style.transform = "none";
          }
          if (rect.left < 0) {
            tooltip.style.left = "0";
            tooltip.style.transform = "none";
          }
          var textarea = tooltip.querySelector("textarea");
          if (textarea) {
            textarea.focus();
          }
        }
        function hideTooltip() {
          tooltip.style.opacity = "0";
          tooltip.style.visibility = "hidden";
        }
        trigger.addEventListener("mouseenter", showTooltip);
        trigger.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        tooltip.addEventListener("mouseleave", function () {
          setTimeout(function () {
            if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
              hideTooltip();
            }
          }, 100);
        });
        trigger.addEventListener("click", function (e) {
          e.preventDefault();
        });
        if (sendButton) {
          sendButton.addEventListener("click", hideTooltip);
        }
      });
    });
  </script>

  <!-- Image Slider Script -->
  <script nonce="{{ csp_nonce }}">
// Replace the existing Image Slider Script in Nickel_Inspection.html with this enhanced version

document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.model-hover-trigger').forEach(function(trigger) {
    const tooltip = trigger.querySelector('.model-image-tooltip');
    const imgGallery = tooltip.querySelector('.img-gallery');
    let images = [];
    let currentIndex = 0;
    let imagesLoaded = false;

    function renderImages() {
      imgGallery.innerHTML = '';
      for (let i = currentIndex; i < Math.min(currentIndex + 3, images.length); i++) {
        const img = document.createElement('img');
        img.src = images[i];
        img.style = "width: 55px; height: 55px; object-fit: cover; border-radius: 6px;";
        imgGallery.appendChild(img);
      }
    }

    function showTooltip() {
      tooltip.style.opacity = '1';
      tooltip.style.pointerEvents = 'auto';
      tooltip.style.display = 'flex';
    }

    function hideTooltip() {
      tooltip.style.opacity = '0';
      tooltip.style.pointerEvents = 'none';
      setTimeout(() => {
        if (tooltip.style.opacity === '0') {
          tooltip.style.display = 'none';
        }
      }, 200);
    }

    trigger.addEventListener('mouseenter', function(e) {
      // Extract model number from the text content
      const modelNoElement = trigger.childNodes[0];
      const modelNo = modelNoElement ? modelNoElement.nodeValue.trim() : '';
      
      if (!modelNo || modelNo === 'N/A') {
        console.log('[DEBUG] No valid model number found');
        return;
      }

      console.log('[DEBUG] Fetching images for model:', modelNo);
      
      if (!imagesLoaded) {
        // Show loading state
        imgGallery.innerHTML = '<div style="padding: 20px; color: #666; font-size: 12px;">Loading...</div>';
        showTooltip();
        
        // Fetch images from backend
        fetch(`/nickle_inspection/get_model_images/?model_no=${encodeURIComponent(modelNo)}`)
          .then(resp => {
            console.log('[DEBUG] API response status:', resp.status);
            return resp.json();
          })
          .then(data => {
            console.log('[DEBUG] API response data:', data);
            if (data.success && data.images && data.images.length > 0) {
              images = data.images;
            } else {
              // Use placeholder if no images found
              images = ["/static/assets/images/imagePlaceholder.png"];
            }
            currentIndex = 0;
            renderImages();
            imagesLoaded = true;
            showTooltip();
          })
          .catch(error => {
            console.error('[DEBUG] Error fetching images:', error);
            // Use placeholder on error
            images = ["/static/assets/images/imagePlaceholder.png"];
            currentIndex = 0;
            renderImages();
            imagesLoaded = true;
            showTooltip();
          });
      } else {
        renderImages();
        showTooltip();
      }
    });

    trigger.addEventListener('mouseleave', function(e) {
      // Add a small delay to allow moving to tooltip
      setTimeout(() => {
        if (!trigger.matches(':hover') && !tooltip.matches(':hover')) {
          hideTooltip();
        }
      }, 100);
    });

    // Keep tooltip visible when hovering over it
    tooltip.addEventListener('mouseenter', function() {
      showTooltip();
    });

    tooltip.addEventListener('mouseleave', function() {
      setTimeout(() => {
        if (!trigger.matches(':hover') && !tooltip.matches(':hover')) {
          hideTooltip();
        }
      }, 100);
    });

    // Handle left scroll button
    tooltip.querySelector('.img-scroll-left').addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      if (currentIndex > 0) {
        currentIndex--;
        renderImages();
      }
    });

    // Handle right scroll button
    tooltip.querySelector('.img-scroll-right').addEventListener('click', function(e) {
      e.stopPropagation();
      e.preventDefault();
      if (currentIndex + 3 < images.length) {
        currentIndex++;
        renderImages();
      }
    });
  });
});
  </script>


<!-- Show alert and highlight row -->
<script nonce="{{ csp_nonce }}">
  document.addEventListener("DOMContentLoaded", function() {
    const table = document.getElementById('order-listing');
    const modal = document.getElementById('trayScanModal');
    const msgBarId = 'dp-table-msg-bar';
    let msgBar = document.getElementById(msgBarId);

    // Create message bar if not present
    if (!msgBar && table) {
      msgBar = document.createElement('div');
      msgBar.id = msgBarId;
      msgBar.style.display = 'none';
      msgBar.style.width = '100%';
      msgBar.style.margin = '0 0 8px 0';
      msgBar.style.padding = '10px 24px';
      msgBar.style.background = '#d1eaff';
      msgBar.style.color = '#0056b3';
      msgBar.style.fontWeight = 'bold';
      msgBar.style.borderRadius = '8px';
      msgBar.style.fontSize = '1.1rem';
      msgBar.style.textAlign = 'center';
      msgBar.style.transition = 'opacity 0.3s, background 0.3s, color 0.3s';
      table.parentNode.insertBefore(msgBar, table);
    }

    // Highlight style (if not present)
    if (!document.getElementById('dp-row-action-highlight-style')) {
      var style = document.createElement('style');
      style.id = 'dp-row-action-highlight-style';
      style.innerHTML = `
        .dp-row-action-highlight {
          box-shadow: 0 0 0 3px #007bff, 0 0 10px #007bff55 !important;
          transition: box-shadow 9.3s;
          background-color: #f0f8ff !important;
          animation: highlightAnimation 2s ease-in-out;
        }
      `;
      document.head.appendChild(style);
    }

    const btnMsg = {
      "Draft": "Drafted successfully",
      "Submit": "Submitted successfully",
      "Cancel": "Cancelled successfully"
    };
    const btnBg = {
      "Draft": "#d1eaff",    // blue
      "Submit": "#d4f7d4",   // green
      "Cancel": "#ffd6d6"    // red
    };
    const btnColor = {
      "Draft": "#0056b3",
      "Submit": "#218838",
      "Cancel": "#b30000"
    };

    document.querySelectorAll('.tray-scan-modal-buttons button').forEach(function(btn) {
      btn.addEventListener('click', function(e) {
        e.preventDefault();

        // 1. Close the modal immediately
        if (modal) modal.classList.remove('open');

        // 2. Show alert and highlight row
        let btnText = btn.textContent.trim();
        let msg = btnMsg[btnText] || "Action successful";
        let bg = btnBg[btnText] || "#d1eaff";
        let color = btnColor[btnText] || "#0056b3";
        if (msgBar) {
          msgBar.textContent = msg;
          msgBar.style.display = 'block';
          msgBar.style.opacity = '1';
          msgBar.style.background = bg;
          msgBar.style.color = color;
        }
        document.querySelectorAll('tr.highlighted-tray-scan').forEach(function(row) {
          row.classList.add('dp-row-action-highlight');
          setTimeout(function() {
            row.classList.remove('dp-row-action-highlight');
          }, 2000);
        });

        // 3. Hide alert after 2s (and redirect if needed)
        setTimeout(function() {
          if (msgBar) {
            msgBar.style.opacity = '0';
            setTimeout(function() { msgBar.style.display = 'none'; }, 300);
          }
          // Uncomment below if you want to redirect after alert
          // window.location.href = "{% url 'dp_pick_table' %}";
        }, 3000);
      });
    });
  });
</script>

<!-- script for buttons in form & highlight -->
<script nonce="{{ csp_nonce }}">
      document.addEventListener("DOMContentLoaded", function () {
        // 1. Save the active row when clicking a tray scan trigger.
        document.querySelectorAll(".tray-scan-btn").forEach(function(btn) {
          btn.addEventListener("click", function(e) {
            const row = e.target.closest("tr");
            if (row) {
              window.activeRow = row;
            }
            // Open the left modal (trayScanModal) as needed.
            const trayModal = document.getElementById("trayScanModal");
            if (trayModal) {
              trayModal.classList.add("open");
            }
          });
        });

        // 2. Attach click event handlers to popup action buttons (Draft, Submit, Cancel)
        document.querySelectorAll('.tray-scan-modal-buttons button').forEach(function(btn) {
          btn.addEventListener("click", function(e) {
            e.preventDefault();
            
            // Close both modals
            const newPopupModal = document.getElementById("newPopupModal");
            const trayScanModal = document.getElementById("trayScanModal");
            if (newPopupModal) newPopupModal.classList.remove("open");
            if (trayScanModal) trayScanModal.classList.remove("open");

            // Highlight the active row for a few seconds.
            document.querySelectorAll('#order-listing tbody tr').forEach(function(row) {
        row.classList.remove("dp-row-action-highlight");
      });

      if (window.activeRow) {
        window.activeRow.classList.add("dp-row-action-highlight");
        setTimeout(() => {
          window.activeRow.classList.remove("dp-row-action-highlight");
        }, 2000);
      }
      });
    });
  });
</script>

<!-- script for active tablr row highlight -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
    // Highlight row when clicking any .tray-scan-btn or .view-icon
  function highlightActiveRow(e) {
    const row = e.target.closest("tr");
    if (row) {
      // Remove highlight from all rows
      document.querySelectorAll('#order-listing tbody tr').forEach(function(r) {
        r.classList.remove("dp-row-action-highlight");
      });
      // Add highlight to the clicked row
      row.classList.add("dp-row-action-highlight");
      // Remove highlight after 2 seconds
      setTimeout(() => {
        row.classList.remove("dp-row-action-highlight");
      }, 2000);
    }
  }

  // For left modal tray scan triggers
  document.querySelectorAll(".tray-scan-btn").forEach(function(btn) {
    btn.addEventListener("click", highlightActiveRow);
  });

  // For all view.png icons (with class .view-icon)
  document.querySelectorAll(".view-icon").forEach(function(icon) {
    icon.addEventListener("click", function(e) {
      highlightActiveRow(e);
      // If you want to open a modal, add your modal logic here
    });
  });
});
</script>




{% endblock %} {% endblock content %}
