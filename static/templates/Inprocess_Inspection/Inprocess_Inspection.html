{% extends "base.html" %} 
{% load static %} 
{% load stock_filters %}
{% load custom_tags %}
{% block content %}
<style>
  /* Enhanced Model Gallery Modal Styles */
  #modelRemarkModal {
      display: none;
      position: fixed;
      top: 6vh;
      right: 2vw;
      transform: none;
      z-index: 20000;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      min-width: 420px;
      max-width: 520px;
      min-height: 400px;
      max-height: 80vh;
      padding: 20px 24px;
      overflow-y: auto;
      font-size: 13px;
      border: 1px solid #e0e0e0;
  }
  
  @media (max-width: 900px) {
      #modelRemarkModal {
          right: 0;
          max-width: 98vw;
          min-width: 0;
          width: 98vw;
          padding: 12px 16px;
          font-size: 12px;
          top: 2vh;
          max-height: 90vh;
      }
  }
  
  #modelRemarkModalContent {
      display: flex;
      flex-direction: column;
      gap: 0;
  }
  
  #modelRemarkModal .close-btn,
  #closeModelRemarkModal {
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 20px;
      color: #999;
      cursor: pointer;
      transition: color 0.2s ease;
  }
  
  #modelRemarkModal .close-btn:hover,
  #closeModelRemarkModal:hover {
      color: #dc3545;
  }
  
  /* Model row hover animations */
  .model-row:hover {
      background: #f0f8ff !important;
      border-color: #007bff !important;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,123,255,0.15);
  }
  
  /* Enhanced image hover effects */
  .model-row img:hover {
      transform: scale(1.1) !important;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  
  /* Visual Aid navigation button styling */
  .visual-aid-btn {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
  }
  
  .visual-aid-btn:hover {
      background: linear-gradient(135deg, #0056b3, #003d82);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
  }
  
  /* Enhanced model circle with animation */
  .model-circle {
      transition: all 0.2s ease;
  }
  
  .model-row:hover .model-circle {
      transform: scale(1.1);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  }
  /* Enhanced bath number dropdown styling */
  .bath-number-select {
      transition: all 0.3s ease;
      border: 1.5px solid #ced4da;
  }
  
  .bath-number-select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  }
  
  .bath-number-select[disabled] {
      background-color: #e8f5e8 !important;
      border-color: #28a745 !important;
      color: #155724 !important;
      cursor: not-allowed;
  }
  
  /* Bath type indicator styling */
  .bath-number-select + small {
      font-style: italic;
      margin-top: 2px !important;
  }
  
  /* Floating alert animation */
  .dp-float-alert {
      animation: slideInRight 0.3s ease-out;
  }
  
  @keyframes slideInRight {
      from {
          opacity: 0;
          transform: translateX(100%);
      }
      to {
          opacity: 1;
          transform: translateX(0);
      }
  }
  
  /* Enhanced option styling */
  .bath-number-select option[disabled] {
      color: #ccc !important;
      background-color: #f8f9fa !important;
  }
  
  .bath-number-select option:not([disabled]) {
      color: #495057;
      background-color: #fff;
  }
   /* ========== Tablet override â€” paste at file end (after other table styles) ========== */
   /* --- Tablet: freeze first 3 columns consistently with desktop --- */
   @media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {
   *{
   font-size: 20px !important; /* Increase font size for better readability */
   }
   :root { --app-font-size: 20px; }
   .rounded-circle{
   padding: 17px !important;
   }
   .model-image-tooltip{
   transform: translateX(-25%) !important;
   top: 45% !important;
   z-index: 500000 !important; /* high so it sits above table & scrollbar */
   }
   /* Core layout blocks */
   .content-wrapper,
   .card, .card-body,
   .table-responsive,
   #order-listing,
   #trayScanModal_DayPlanning,
   .tray-scan-modal-DayPlanning,
   .pagination-wrapper {
   font-size: var(--app-font-size) !important;
   line-height: 1.35 !important;
   }
   /* Table headings / cells / icons */
   #order-listing th,
   #order-listing td,
   #order-listing thead th {
   font-size: var(--app-font-size) !important;
   vertical-align: middle !important;
   white-space: nowrap;
   text-overflow: ellipsis;
   overflow: hidden;
   }
   /* Ensure heading/title and date controls match */
   h4.text-left.mt-0.mb-3,
   .calendar-bar .date-input-group label,
   .calendar-bar .date-input-group input,
   #search-date-range-simple,
   #clear-date-filter-simple,
   .calendar-btn,
   #trayScanModal_DayPlanning input.form-control,#trayValidateBtn,
   #trayScanModal_DayPlanning table th, #trayScanModal_DayPlanning table td,
   #modalModelNo_DayPlanning
   {
   font-size: var(--app-font-size) !important;
   }  
   /* Reserve space for filter icons in header cells */
   #order-listing th {
   position: relative;
   overflow: visible !important;
   white-space: normal !important; /* allow wrapping */
   }
   /* Ensure filter icons always stay to the right */
   #order-listing th .fa-filter {
   position: absolute;
   right: 10px;
   top: 50%;
   transform: translateY(-50%);
   font-size: 10px !important;
   opacity: 0.8;
   cursor: pointer;
   }
   /* Column 1 */
   #order-listing th:nth-child(1),
   #order-listing td:nth-child(1) {
   position: sticky;
   left: 0 !important;
   min-width: 90px !important;
   max-width: 90px !important;
   background: #f7fafd;
   z-index: 30;
   }
   /* Column 2 */
   #order-listing th:nth-child(2),
   #order-listing td:nth-child(2) {
   position: sticky;
   left: 90px !important;   /* = width of col1 */
   min-width: 125px !important;
   max-width: 125px !important;
   background: #f7fafd;
   z-index: 25;
   }
   /* Column 3 */
   #order-listing th:nth-child(3),
   #order-listing td:nth-child(3) {
   position: sticky;
   left: 215px !important;  /* 75 (col1) + 100 (col2 min) */
   min-width: 140px !important;
   max-width: 140px !important;
   background: #f7fafd;
   z-index: 20;
   }
   /* Sticky header */
   #order-listing thead th {
   position: sticky;
   top: 0;
   z-index: 40;
   background: #028084 !important;
   color: #e5fcff !important;
   }
   }
   @media (pointer: coarse) and (min-width: 680px) and (max-width: 1400px) {
   .table-container {
   overflow-x: auto;
   }
   /* Other columns (fit remaining space) */
   #order-listing th:nth-child(4)  { min-width: 140px !important; max-width: 140px !important; }
   #order-listing th:nth-child(5)  { min-width: 120px !important; max-width: 120px !important; }
   #order-listing th:nth-child(6)  { min-width: 135px !important; max-width: 135px !important; }
   #order-listing th:nth-child(7)  { min-width: 120px !important; max-width: 120px !important; }
   #order-listing th:nth-child(8)  { min-width: 140px !important; max-width: 140px !important; }
   #order-listing th:nth-child(9)  { min-width: 140px !important; max-width: 145px !important; }
   #order-listing th:nth-child(10) { min-width: 130px !important; max-width: 130px !important; }
   #order-listing th:nth-child(11) { min-width: 150px !important; max-width: 150px !important; }
   #order-listing th:nth-child(12) { min-width: 140px !important; max-width: 140px !important; }
   #order-listing th:nth-child(13) { min-width: 140px !important; max-width: 140px !important; }
   #order-listing th:nth-child(14) { min-width: 120px !important; max-width: 120px !important; }
   #order-listing th:nth-child(15) { min-width: 125px !important; max-width: 125px !important; }
   #order-listing th:nth-child(16) { min-width: 130px !important; max-width: 150px !important; }
   #order-listing th:nth-child(17) { min-width: 130px !important; max-width: 130px !important; }
   #order-listing th:nth-child(18) { min-width: 130px !important; max-width: 130px !important; }
   #order-listing th:nth-child(19) { min-width: 140px !important; max-width: 140px !important; }
   #order-listing th:nth-child(20) { min-width: 130px !important; max-width: 130px !important; }
   #order-listing th:nth-child(21) { min-width: 130px !important; max-width: 130px !important; }
   /* Prevent overlap */
   #order-listing th:nth-child(-n+3),
   #order-listing td:nth-child(-n+3) {
   z-index: 45 !important;
   }
   /* Hide hidden columns */
   #order-listing th[hidden],
   #order-listing td[hidden] {
   display: none !important;
   }
   }
   .remark-tooltip textarea[readonly] {
   min-height: 40px;
   height: auto;
   background: #f7f7f7;
   color: #888;
   cursor: not-allowed;
   }
   .remark-tooltip .fa-info-circle {
   vertical-align: middle;
   }
   .remark-tooltip {
   max-height: 300px;
   }
   /* Add to your CSS file for Excel-like grid lines */
   .table-bordered th, .table-bordered td {
   border: 1px solid #d9dedf !important;
   }
   /* Add to your CSS file for Excel-like grid lines */
   .table-bordered th, .table-bordered td {
   border: 1px solid #d9dedf !important;
   }
   /* Add to your CSS file for Excel-like grid lines */
   .table-bordered th, .table-bordered td {
   border: 1px solid #d9dedf !important;
   }
   /* Make the table header sticky */
   thead th {
   position: sticky;
   top: 0;
   background-color: white; /* or your table header bg color */
   z-index: 5; /* ensure it stays above the table rows */
   }
   #order-listing thead th {
   height: 38px !important; /* Increase as needed */
   background: #028084 !important;
   color: #e5fcff !important;
   vertical-align: middle !important;
   border-bottom: 2.5px solid #bdbdbd !important; /* Thicker grey line below heading */
   }
   /* style for hol/unhold row - blurred bg */
   #order-listing tr:last-child td {
   margin-bottom: 0 !important;
   padding-bottom: 0 !important;
   /* background: #f4f3f3 !important; */
   }
   /* Gird line color combination */
   #order-listing th,
   #order-listing td {
   border-right: 1.5px solid #bababa !important; /* Vertical lines: blue */
   border-bottom: 1.5px solid #121413 !important; /* Horizontal lines: green */
   }
   /* Default: Desktop/Laptop (wider columns for larger font) - server */
   /* #order-listing th:nth-child(1) {
   min-width: 90px;
   max-width: 90px;
   } */ /* S.No */
   /* #order-listing th:nth-child(2) {
   min-width: 90px;
   max-width: 100px;
   } */ /* Last Updated */
   /* #order-listing th:nth-child(3) {
   min-width: 90px;
   max-width: 120px;
   } */ /* Plating */
   #order-listing th:nth-child(4) {
   min-width: 110px;
   max-width: 120px;
   } /* Polishing Stk No */
   #order-listing th:nth-child(5) {
   min-width: 90px;
   max-width: 100px;
   } /* Plating Color */
   #order-listing th:nth-child(6) {
   min-width: 105px;
   max-width: 110px;
   } /* Category */
   #order-listing th:nth-child(7) {
   min-width: 85px;
   max-width: 95px;
   } /* Polish Finish */
   #order-listing th:nth-child(8) {
   min-width: 110px;
   max-width: 110px;
   } /* Version */
   #order-listing th:nth-child(9) {
   min-width: 105px;
   max-width: 105px;
   } /* Tray Cate-Capacity */
   #order-listing th:nth-child(10) {
   min-width: 115px;
   max-width: 120px;
   } /* Source */
   #order-listing th:nth-child(11) {
   min-width: 115px;
   max-width: 115px;
   } /* No of Trays */
   #order-listing th:nth-child(12) {
   min-width: 105px;
   max-width: 105px;
   } /* Input Qty */
   #order-listing th:nth-child(13) {
   min-width: 95px;
   max-width: 100px;
   } /* Process Status */
   #order-listing th:nth-child(14) {
   min-width: 95px;
   max-width: 100px;
   } /*  Action */
   #order-listing th:nth-child(15) {
   min-width: 95px;
   max-width: 100px;
   } /* Lot Status */
   #order-listing th:nth-child(16) {
   min-width: 100px;
   max-width: 100px;
   } /* Current Stage */
   #order-listing th:nth-child(17) {
   min-width: 110px;
   max-width: 100px;
   } /* Remarks */
   #order-listing th:nth-child(18) {
   min-width: 100px;
   max-width: 110px;
   }
   @media (min-width: 600px) and (max-width: 900px) {
   #order-listing {
   table-layout: auto !important; /* Let columns auto-fit content */
   width: 100% !important;
   min-width: unset !important;
   max-width: 100vw !important;
   }
   /* Adjust width for all headings (th) and cells (td) */
   #order-listing th,
   #order-listing td {
   min-width: 160px !important;
   max-width: 260px !important;
   width: 180px !important;
   }
   #order-listing th {
   position: relative;
   padding-right: 48px !important; /* More space for filter icon */
   white-space: normal !important;
   overflow: visible !important;
   text-overflow: ellipsis;
   }
   #order-listing th .fa-filter {
   position: absolute;
   right: 18px !important;
   top: 50%;
   transform: translateY(-50%);
   z-index: 2;
   background: transparent;
   pointer-events: auto;
   }
   }
   /* Right-align filter icons */
   #order-listing th .fa-filter {
   position: absolute;
   right: 8px;
   top: 50%;
   transform: translateY(-50%);
   font-size: 11px;
   opacity: 0.7;
   cursor: pointer;
   transition: opacity 0.2s;
   }
   #order-listing th .fa-filter:hover {
   opacity: 1;
   }
   #order-listing th:last-child,
   #order-listing td:last-child {
   border-right: none;
   max-width: 95px;
   min-width: 100px;
   }
   /* Overall Table Shrink */
   #order-listing tr,
   #order-listing td,
   #order-listing th {
   height: 20px !important;
   padding-top: 2px !important;
   padding-bottom: 2px !important;
   padding-left: 6px !important;
   padding-right: 6px !important;
   }
   /* Table heading font size */
   /* Add this at the end of your 
<style>
   block in DP_PickTable.html */
   /* Professional table header styling with proper text wrapping */
   #order-listing th {
   position: relative;
   padding: 8px 12px 8px 16px !important;
   text-align: left !important;
   vertical-align: middle !important;
   white-space: normal !important;
   line-height: 1.3 !important;
   word-break: keep-all !important;
   hyphens: none !important;
   /* font-size: 13px; */
   /* font-weight: 600 !important; */
   background: #028084 !important;
   color: #e5fcff !important;
   border-bottom: 2.5px solid #bdbdbd !important;
   /* min-width: 80px;
   max-width: 140px; */
   overflow-wrap: break-word;
   word-wrap: break-word;
   z-index: 20 !important;
   }
   /* Make sure header cells for sticky columns are always above body cells */
   /* Fix: Prevent shadow/rows from showing behind sticky columns while scrolling */
   #order-listing th:nth-child(-n+3),
   #order-listing td:nth-child(-n+3) {
   z-index: 30 !important; 
   box-shadow: 2px 0 8px rgba(0,0,0,0.04);
   }
   /* Prevent sticky columns from overlapping sticky header */
   #order-listing td:nth-child(-n+3) {
   z-index: 11 !important;
   }
   /* Make the first column sticky and opaque */
   #order-listing td:first-child,
   #order-listing th:first-child {
   position: sticky;
   left: 0;
   background: #fff;      /* Or match your table background */
   z-index: 2;            /* Above blurred rows */
   box-shadow: 2px 0 4px rgba(0,0,0,0.03); /* Optional: subtle shadow */
   }
   /* Force specific table headers to wrap onto two lines */
   #order-listing th:nth-child(4),   /* Polishing Stk No */
   #order-listing th:nth-child(5),   /* Plating Color */
   #order-listing th:nth-child(7),   /* Polish Finish */
   #order-listing th:nth-child(9),   /* Tray Cate-Capacity */
   #order-listing th:nth-child(11),  /* No of Tray */
   #order-listing th:nth-child(12),  /* Input Qty */
   #order-listing th:nth-child(13)   /* Process Status */ {
   white-space: normal !important;
   line-height: 1.2 !important;
   word-break: break-word !important;
   text-align: center;
   vertical-align: middle;
   padding-top: 5px !important;
   padding-bottom: 5px !important;
   }
   /* Freeze style for 1st - 3 columns */
   /* --- Freeze first 3 columns and table header for #order-listing --- */
   #order-listing {
   position: relative;
   border-collapse: separate !important;
   border-spacing: 0;
   background: #fff;
   /* Ensure enough left padding for sticky columns */
   }
   #order-listing th,
   #order-listing td {
   background-clip: padding-box;
   /* Prevent overlap artifacts */
   z-index: 1;
   }
   /* Sticky header */
   #order-listing thead th {
   position: sticky;
   top: 0;
   z-index: 10;
   background: #028084 !important;
   color: #e5fcff !important;
   }
   /* Freeze 1st column */
   #order-listing th:nth-child(1),
   #order-listing td:nth-child(1) {
   position: sticky;
   left: 0 !important;
   z-index: 12; /* Above header */
   background: #f7fafd;
   min-width: 75px;
   max-width: 75px;
   }
   /* Freeze 2nd column - Last Updated*/
   #order-listing th:nth-child(2),
   #order-listing td:nth-child(2) {
   position: sticky;
   left: 75px; /* Match min-width of 1st col */
   z-index: 12;
   background: #f7fafd;
   min-width: 85px; /* Increased width */
   max-width: 85px; /* Increased width */
   }
   /* Freeze 3rd column */
   #order-listing th:nth-child(3),
   #order-listing td:nth-child(3) {
   position: sticky;
   left: 160px; /* 100px (1st) + 90px (2nd) */
   z-index: 12;
   background: #f7fafd;
   min-width: 100px; /* Increased width 100 - old value*/
   max-width: 110px; /* Increased width  110 - old value*/
   }
   /* Prevent sticky columns from overlapping sticky header */
   #order-listing th:nth-child(-n + 3) {
   z-index: 12;
   }
   #order-listing td:nth-child(-n + 3) {
   z-index: 11;
   }
   /* Ensure sticky columns and header work together */
   #order-listing th,
   #order-listing td {
   box-sizing: border-box;
   /* Prevent content shake */
   /* overflow: hidden; */
   text-overflow: ellipsis;
   white-space: nowrap;
   }
   .blurred-heading, .blurred-cell {
   filter: blur(2px) grayscale(0.7) opacity(0.6);
   pointer-events: none !important;
   user-select: none;
   cursor: not-allowed;
   background: #f5f5f5 !important;
   }
   /* Show remark tooltip above the trigger instead of below */
   .remark-tooltip {
   top: auto !important;
   bottom: 110% !important;
   }
   #trayScanDetails.table-grid {
   display: grid !important;
   grid-template-columns: 94px 175px 150px !important;
   gap: 0px !important;
   max-height: 300px !important;
   overflow-y: auto !important;
   overflow-x: hidden !important;
   padding-right: 10px;
   margin-top: 10px;
   border: 1px solid #ddd;
   }
   #trayScanModal{
   overflow: scroll !important;
   width: 435px !important;
   }
   #trayScanDetails.table-grid::-webkit-scrollbar {
   width: 8px;
   }
   #trayScanDetails.table-grid::-webkit-scrollbar-track {
   background: #f1f1f1;
   border-radius: 4px;
   }
   #trayScanDetails.table-grid::-webkit-scrollbar-thumb {
   background: #888;
   border-radius: 4px;
   }
   #trayScanDetails.table-grid::-webkit-scrollbar-thumb:hover {
   background: #555;
   }
   .tray-scan-modal.open {
   width:500px !important;
   }
   /* For the 4-column layout (with validation status) */
   #trayScanDetails.table-grid.four-column {
   grid-template-columns: 50px 1fr 100px 140px !important;
   overflow-y: auto !important;
   overflow-x: hidden !important;
   }
   /* Styling individual grid cells, only inside trayScanDetails */
   #trayScanDetails.table-grid > div {
   background: #f7f7f7;
   padding: 8px 12px;
   font-size: 12px;
   border: 1px solid #ddd;
   margin: 0; /* reset any margin from 
   <p>
      or others */
      }
      /* S.no column specific styling */
      #trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
      text-align: center;
      font-weight: 600;
      padding: 8px 4px; /* Reduced horizontal padding for S.no */
      }
      /* For mobile responsiveness */
      @media (max-width: 768px) {
      #trayScanDetails.table-grid {
      grid-template-columns: 45px 1fr 1fr !important; /* Even smaller S.no column on mobile */
      }
      #trayScanDetails.table-grid.four-column {
      grid-template-columns: 40px 1fr 80px 100px !important;
      }
      #trayScanDetails.table-grid > div:nth-child(3n+1):not(:nth-child(-n+4)) {
      padding: 6px 2px; /* Further reduced padding on mobile */
      font-size: 11px;
      }
      }
      /* For very small screens */
      @media (max-width: 480px) {
      #trayScanDetails.table-grid {
      grid-template-columns: 35px 1fr 80px !important; /* Minimal S.no column */
      }
      #trayScanDetails.table-grid.four-column {
      grid-template-columns: 30px 1fr 70px 90px !important;
      }
      }
      .row-checkbox, #selectAllCheckbox {
      display: none;
      }
      body.add-model-mode .row-checkbox,
      body.add-model-mode #selectAllCheckbox {
      display: inline-block;
      }
      /* General model circle styling */
      .model-circle {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: -7px; /* Adjust this value for more/less space */
      }
      /* Compact and responsive modal for model/stock no */
      #modelRemarkModal {
      display: none;
      position: fixed;
      top: 6vh;
      right: 2vw;
      transform: none;
      z-index: 20000;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.18);
      min-width: 320px;
      max-width: 420px;
      min-height: 400px;
      max-height: 500px;
      padding: 18px 32px 12px 32px;
      overflow-y: auto;
      font-size: 12px;
      }
      @media (max-width: 900px) {
      #modelRemarkModal {
      right: 0;
      max-width: 98vw;
      min-width: 0;
      width: 98vw;
      padding: 10px 4vw 10px 4vw;
      font-size: 11px;
      }
      }
      #modelRemarkModalContent {
      display: flex;
      flex-direction: column;
      gap: 10px;
      }
      #modelRemarkModal .close-btn,
      #closeModelRemarkModal {
      position: absolute;
      top: 6px;
      right: 12px;
      font-size: 18px;
      color: #888;
      cursor: pointer;
      }
      #modelRemarkModal img {
      max-width: 54px;
      max-height: 54px;
      border-radius: 6px;
      border: 1px solid #eee;
      background: #fafafa;
      }
      #modelRemarkModal .model-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 2px;
      }
      #modelRemarkModal .model-circle {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 2px;
      vertical-align: middle;
      flex-shrink: 0;
      }
      #modelRemarkModal .model-no {
      font-weight: 600;
      color: #023E4DCC;
      font-size: 0.98rem;
      margin-bottom: 2px;
      }
      #modelRemarkModal .remark-label {
      font-size: 11px;
      color: #222;
      margin-bottom: 1px;
      }
      #modelRemarkModal .remark-text {
      font-size: 11px;
      color: #444;
      background: #f7f7f7;
      border-radius: 5px;
      padding: 5px 8px;
      min-width: 80px;
      min-height: 18px;
      margin-bottom: 0;
      }
      @media (max-width: 600px) {
      #modelRemarkModal {
      left: 0;
      top: 0;
      width: 98vw;
      max-width: 98vw;
      min-width: 0;
      padding: 8px 4px 8px 4px;
      font-size: 11px;
      max-height: 60vh;
      }
      #modelRemarkModal img {
      max-width: 38px;
      max-height: 38px;
      }
      #modelRemarkModal .model-no {
      font-size: 0.92rem;
      }
      #modelRemarkModal .remark-label,
      #modelRemarkModal .remark-text {
      font-size: 10px;
      }
      }
      /* Tooltip for model images */
      .model-image-tooltip {
      position: absolute;
      z-index: 99999;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.18);
      padding: 10px;
      min-width: 220px;
      max-width: 350px;
      max-height: 220px;
      display: none;
      overflow: hidden;
      }
      .model-image-tooltip .image-slider {
      display: flex;
      align-items: center;
      gap: 8px;
      }
      .model-image-tooltip img {
      max-width: 180px;
      max-height: 180px;
      object-fit: contain;
      border-radius: 4px;
      }
      .model-image-tooltip .slider-btn {
      background: #eee;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      cursor: pointer;
      }
      .model-image-tooltip.static {
      display: block !important;
      position: fixed !important;
      top: 80px !important;
      left: 50% !important;
      transform: translateX(-50%) !important;
      z-index: 100000;
      }
      .model-image-tooltip .close-btn {
      position: absolute;
      top: 4px;
      right: 8px;
      font-size: 18px;
      color: #888;
      cursor: pointer;
      }
      /* Image slider modal */
      .image-slider-modal {
      display: none;
      position: fixed;
      top: 40px;
      right: 20px;
      width: 600px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      padding: 20px;
      z-index: 10000;
      transition: right 0.3s ease;
      }
      .image-slider-modal.open {
      display: block;
      }
      .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      }
      .slider {
      position: relative;
      overflow: hidden;
      height: 350px;
      }
      .slides {
      display: flex;
      transition: transform 0.5s ease;
      width: 100%;
      }
      .slide {
      flex: 0 0 100%;
      box-sizing: border-box;
      display: none;
      }
      .slide.active {
      display: block;
      }
      .slide img {
      width: 100%;
      height: 350px;
      object-fit: cover;
      display: block;
      }
      .prev,
      .next {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      border: none;
      color: #fff;
      padding: 8px;
      cursor: pointer;
      border-radius: 50%;
      user-select: none;
      }
      .prev {
      left: 10px;
      }
      .next {
      right: 10px;
      }
      @media (max-width: 767px) {
      .image-slider-modal {
      width: 100%;
      right: 0;
      top: 0;
      border-radius: 0;
      padding: 10px;
      }
      .slider {
      height: 250px;
      }
      .slide img {
      height: 250px;
      }
      }
      /* Add Jig Remark Modal Styles */
      /* Modal backdrop styles */
      .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1040;
      width: 100vw;
      height: 100vh;
      background-color: #000;
      }
      .modal-backdrop.fade {
      opacity: 0;
      }
      .modal-backdrop.show {
      opacity: 0.5;
      }
      /* Modal base styles */
      .modal.fade .modal-dialog {
      transition: transform 0.3s ease-out;
      transform: translate(0, -50px);
      }
      .modal.show .modal-dialog {
      transform: none;
      }
      .modal {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 1050;
      display: none;
      width: 100%;
      height: 100%;
      overflow-x: hidden;
      overflow-y: auto;
      outline: 0;
      }
      .modal.show {
      display: block !important;
      }
      body.modal-open {
      overflow: hidden;
      }
      /* Remarks modal specific styles */
      #remarksModal .modal-dialog {
      max-width: 500px;
      margin: 1.75rem auto;
      }
      #remarksModal .modal-content {
      border: none;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      #remarksModal .modal-header {
      border-bottom: none;
      padding: 0;
      }
      #remarksModal .modal-body {
      padding: 1rem 2rem 2rem 2rem;
      }
      #remarksModal .modal-title {
      color: #023E4DCC;
      font-weight: 700;
      font-size: 1.25rem;
      text-align: center;
      margin-bottom: 1rem;
      }
      /* Loading spinner styles */
      #remarksLoadingSpinner {
      display: none;
      text-align: center;
      padding: 20px;
      }
      #remarksLoadingSpinner .spinner-border {
      width: 3rem;
      height: 3rem;
      border-width: 0.25em;
      }
      .spinner-border {
      display: inline-block;
      width: 2rem;
      height: 2rem;
      vertical-align: text-bottom;
      border: 0.25em solid currentColor;
      border-right-color: transparent;
      border-radius: 50%;
      animation: spinner-border 0.75s linear infinite;
      }
      @keyframes spinner-border {
      to {
      transform: rotate(360deg);
      }
      }
      .text-primary {
      color: #007bff !important;
      }
      /* Form styles for remarks modal */
      #remarksModalForm .form-control {
      border: 1px solid #ced4da;
      border-radius: 0.375rem;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      line-height: 1.5;
      color: #495057;
      background-color: #fff;
      background-clip: padding-box;
      transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      #remarksModalForm .form-control:focus {
      color: #495057;
      background-color: #fff;
      border-color: #80bdff;
      outline: 0;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }
      #remarksModalForm .form-check-input {
      width: 1em;
      height: 1em;
      margin-top: 0.25em;
      vertical-align: top;
      background-color: #fff;
      background-repeat: no-repeat;
      background-position: center;
      background-size: contain;
      border: 1px solid rgba(0, 0, 0, 0.25);
      appearance: none;
      color-adjust: exact;
      }
      #remarksModalForm .form-check-input:checked {
      background-color: #007bff;
      border-color: #007bff;
      }
      #remarksModalForm .form-check-input[type="radio"] {
      border-radius: 50%;
      }
      #remarksModalForm .form-check-input[type="radio"]:checked {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='-4 -4 8 8'%3e%3ccircle r='2' fill='%23fff'/%3e%3c/svg%3e");
      }
      #remarksModalForm .btn {
      display: inline-block;
      font-weight: 400;
      line-height: 1.5;
      color: #212529;
      text-align: center;
      text-decoration: none;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      background-color: transparent;
      border: 1px solid transparent;
      padding: 0.375rem 0.75rem;
      font-size: 1rem;
      border-radius: 0.375rem;
      transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
      }
      #remarksModalForm .btn-primary {
      color: #fff;
      background-color: #007bff;
      border-color: #007bff;
      }
      #remarksModalForm .btn-primary:hover {
      color: #fff;
      background-color: #0056b3;
      border-color: #004085;
      }
      #remarksModalForm .btn-secondary {
      color: #fff;
      background-color: #6c757d;
      border-color: #6c757d;
      }
      #remarksModalForm .btn-secondary:hover {
      color: #fff;
      background-color: #545b62;
      border-color: #4e555b;
      }
      /* Character count styling */
      #remarksCharCount {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      color: #6c757d;
      font-size: 0.75rem;
      pointer-events: none;
      }
      /* Position relative for character count container */
      .position-relative {
      position: relative !important;
      }
      /* Bootstrap utility classes used in the modal */
      .mb-3 {
      margin-bottom: 1rem !important;
      }
      .row {
      display: flex;
      flex-wrap: wrap;
      margin-top: calc(-0.5 * 0);
      margin-right: calc(-0.5 * 1.5rem);
      margin-left: calc(-0.5 * 1.5rem);
      }
      .col-5 {
      flex: 0 0 auto;
      width: 41.66666667%;
      }
      .col-7 {
      flex: 0 0 auto;
      width: 58.33333333%;
      }
      .col-12 {
      flex: 0 0 auto;
      width: 100%;
      }
      .d-flex {
      display: flex !important;
      }
      .align-items-center {
      align-items: center !important;
      }
      .justify-content-center {
      justify-content: center !important;
      }
      .gap-3 {
      gap: 1rem !important;
      }
      .text-end {
      text-align: right !important;
      }
      .fw-bold {
      font-weight: 700 !important;
      }
      .px-4 {
      padding-left: 1.5rem !important;
      padding-right: 1.5rem !important;
      }
      .me-2 {
      margin-right: 0.5rem !important;
      }
      .close {
      float: right;
      font-size: 1.5rem;
      font-weight: 700;
      line-height: 1;
      color: #000;
      text-shadow: 0 1px 0 #fff;
      opacity: 0.5;
      background: transparent;
      border: 0;
      cursor: pointer;
      }
      .close:hover {
      opacity: 0.75;
      }
      .position-absolute {
      position: absolute !important;
      }
      .end-0 {
      right: 0 !important;
      }
      .top-0 {
      top: 0 !important;
      }
      .m-2 {
      margin: 0.5rem !important;
      }
</style>
<!-- Model/Stock No Modal Popup -->
<div id="modelRemarkModal" style="margin-top: 70px">
   <span id="closeModelRemarkModal">&times;</span>
   <div style="font-weight:700; font-size:18px; color:#616161; margin-bottom:20px; margin-top:4px; text-align:center;">
      Model Image Gallery
   </div>
   <div id="modelRemarkModalContent"></div>
</div>
<div class="content-wrapper">
   <!-- <h5 class="text-left mt-0 mb-3">Day Planning Pick Table</h5> -->
   <div class="col-12 grid-margin stretch-card">
      <div class="card">
         <div class="card-body">
            <h5 class="text-left mt-0 mb-4" style="font-weight:700;">Inprocess Inspection Main Table</h5>
            <!-- Table Section -->
            <div class="table-responsive" style="overflow: scroll !important">
               <table id="order-listing" class="table">
                  <thead>
                     <tr>
                        <th>S.No <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>JIG ID <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Date &amp; <br> Time <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Model Presents <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <!--<th>Plating Stk No <i class="fa fa-filter" aria-hidden="true"></i></th>
                         <th>Polishing Stk No <i class="fa fa-filter" aria-hidden="true"></i></th> -->
                        <th>Plating Color <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Polish Finish <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th style="display: none;">Version <i class="fa fa-filter" aria-hidden="true" ></i></th>
                        <!--<th>Source-<br> Location <i class="fa fa-filter" aria-hidden="true"></i></th>-->
                        <th>Tray Cate -<br> Capacity <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Jig Cate- <br>Capacity <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Jig Lot <br> Qty <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Bath Type <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Nickel Bath No <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>In.P Info <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Process Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Action <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th style = "min-width: 140px; max-width: 140px">Lot Status <i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th style = "min-width: 100px; max-width: 100px">Current Stage<i class="fa fa-filter" aria-hidden="true"></i></th>
                        <th>Remarks <i class="fa fa-filter" aria-hidden="true"></i></th>
                     </tr>
                  </thead>
                  <tbody>
                     {% for jig_detail in jig_details %}
                     <tr class="highlighted-tray-scan" data-lot-id="{{ jig_detail.lot_id }}">
                        <td>
                           <span style="display:flex; align-items:center; gap:3px;">
                              {% if is_admin %}
                              <!-- Admin users: Show toggle switch -->
                              <label class="hold-toggle-switch" style="margin-bottom:0;">
                              {% if not jig_detail.inprocess_hold_lot %}
                              <input type="checkbox" class="hold-toggle-btn" checked />
                              <span class="hold-slider"></span>
                              {% else %}
                              <input type="checkbox" class="hold-toggle-btn" />
                              <span class="hold-slider"></span>
                              {% endif %}
                              </label>
                              <!-- Hold remark icon -->
                              <span class="hold-remark-icon" 
                                 style="display:{% if jig_detail.inprocess_hold_lot or data.inprocess_release_lot or data.inprocess_holding_reason or data.inprocess_release_reason %}inline-block{% else %}none{% endif %}; cursor:pointer;" 
                                 title="{% if jig_detail.inprocess_holding_reason %}Holding Reason: {{ jig_detail.inprocess_holding_reason }}{% endif %}{% if jig_detail.inprocess_holding_reason and jig_detail.inprocess_release_reason %}&#10;{% endif %}{% if jig_detail.inprocess_release_reason %}Release Reason: {{ jig_detail.inprocess_release_reason }}{% endif %}">
                              {% if jig_detail.inprocess_hold_lot or jig_detail.inprocess_release_lot or jig_detail.inprocess_holding_reason or jig_detail.inprocess_release_reason %}
                              <img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:12px; height:12px;" />
                              {% endif %}
                              </span>
                              {% else %}
                              <!-- Non-admin: Only show view icon if there's a holding/release reason -->
                              {% if jig_detail.inprocess_hold_lot or jig_detail.inprocess_release_lot or jig_detail.inprocess_holding_reason or jig_detail.inprocess_release_reason %}
                              <span class="hold-remark-icon" 
                                 style="display:inline-block; cursor:pointer;" 
                                 title="{% if jig_detail.inprocess_holding_reason %}Holding Reason: {{ jig_detail.inprocess_holding_reason }}{% endif %}{% if jig_detail.inprocess_holding_reason and jig_detail.inprocess_release_reason %}&#10;{% endif %}{% if jig_detail.inprocess_release_reason %}Release Reason: {{ jig_detail.inprocess_release_reason }}{% endif %}">
                              <img src="{% static 'assets/icons/view2.png' %}" alt="View Reason" style="width:18px; height:18px;" />
                              </span>
                              {% endif %}
                              {% endif %}
                              <span class="sno-value">{{ jig_details.start_index|add:forloop.counter0 }}</span>
                           </span>
                        </td>
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.jig_qr_id }}</td>
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {{ jig_detail.jig_loaded_date_time|date:"d-M-y" }}<br>
                        <span style="display:inline-block; margin-top:4px;word-break: break-all;">{{ jig_detail.jig_loaded_date_time|date:"h:i A" }}</span>
                        </td>
                        <!-- Model Presents - Keep existing functionality with colored circles -->
                        <td  {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %} class="model-stock-no-cell" 
                        data-images='{{ jig_detail.model_images|json_encode }}'
                        data-model-colors='{{ jig_detail.model_colors|json_encode }}'
                        data-model-list='{{ jig_detail.no_of_model_cases|json_encode }}'>
                        <span class="model-stock-no-text" style="cursor:pointer;" {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% for model_no in jig_detail.no_of_model_cases %}
                        {% if jig_detail.model_colors %}
                        <span class="model-circle" style="background:{{ jig_detail.model_colors|get_item:model_no }};{% if forloop.last %}margin-right:0;{% endif %}"></span>
                        {% else %}
                        <span class="model-circle" style="background:#ccc;{% if forloop.last %}margin-right:0;{% endif %}"></span>
                        {% endif %}
                        {% endfor %}
                        <!-- Expand menu icon -->
                        <span class="expand-model-remark" style="display:inline-block;width:18px;height:18px;vertical-align:middle;cursor:pointer;" title="Expand">
                           <svg width="18" height="18" viewBox="0 0 18 18">
                              <circle cx="9" cy="9" r="8" fill="#bbb"/>
                              <polygon points="6,7 12,7 9,12" fill="#fff"/>
                           </svg>
                        </span>
                        </span>
                        </td>
                        <!-- Plating Stock No from ModelMasterCreation -->
                                           <!--<td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}> 
                           {% if jig_detail.final_plating_stk_nos %}
                               {{ jig_detail.final_plating_stk_nos }}
                           
                           {% else %}
                               N/A
                           {% endif %} 
                           </td>            -->     
                        <!-- Polishing Stock No from ModelMasterCreation -->
                        <!--                       <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                           {% if jig_detail.final_polishing_stk_nos %}
                               {{ jig_detail.final_polishing_stk_nos }}
                           
                           {% else %}
                               N/A
                           {% endif %}
                           </td>  -->                     
                        <!-- Plating Color from ModelMasterCreation -->
                                                <!-- In your Inprocess_Inspection.html template, find the plating color cell and update it: -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                            {{ jig_detail.plating_color|highlight_plating_color|safe|default:"N/A" }}
                        </td>                        <!-- Polish Finish from ModelMasterCreation -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.polish_finish|default:"N/A" }}</td>
                        <!-- Version from ModelMasterCreation -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %} style="display: none;">
                        {% if jig_detail.final_version_names %}
                        {{ jig_detail.final_version_names }}
                        {% else %}
                        N/A
                        {% endif %}
                        </td>
                        <!-- Source-Location from ModelMasterCreation
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}> {{ jig_detail.location_name|default:"N/A" }}</td> -->
                        <!-- Enhanced Tray Category - Capacity with Color Coding -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% if jig_detail.tray_type and jig_detail.tray_capacity %}
                            {% if jig_detail.tray_capacity == 20 %}
                                <!-- Normal - 20 with RGB gradient (Updated for Inprocess Inspection) -->
                                <div class="tray-capacity-badge normal-tray" 
                                     style="background: #dc3545; 
                                            color: white; 
                                            padding: 4px 12px; 
                                            border-radius: 15px; 
                                            font-size: 12px; 
                                            font-weight: 700; 
                                            text-align: center; 
                                            border: 1px solid rgba(255,255,255,0.3);
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                     title="Normal Tray - 20 Capacity (Custom for Inprocess Inspection)">
                                    Normal - 20
                                </div>
                            {% elif jig_detail.tray_capacity == 12 %}
                                <!-- Jumbo - 12 with RGB gradient -->
                                <div class="tray-capacity-badge jumbo-tray" 
                                     style="background: #28a745; 
                                            color: white; 
                                            padding: 4px 12px; 
                                            border-radius: 15px; 
                                            font-size: 12px; 
                                            font-weight: 700; 
                                            text-align: center; 
                                            border: 1px solid rgba(255,255,255,0.3);
                                            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
                                            text-shadow: 0 1px 2px rgba(0,0,0,0.3);"
                                     title="Jumbo Tray - 12 Capacity (Red, Dark Green, Light Green)">
                                    Jumbo - 12
                                </div>
                            {% else %}
                                <!-- Other tray types -->
                                <div class="tray-capacity-badge other-tray" 
                                     style="background: #6c757d; 
                                            color: white; 
                                            padding: 4px 12px; 
                                            border-radius: 15px; 
                                            font-size: 12px; 
                                            font-weight: 600; 
                                            text-align: center;"
                                     title="{{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }} Capacity">
                                    {{ jig_detail.tray_type }} - {{ jig_detail.tray_capacity }}
                                </div>
                            {% endif %}
                        {% else %}
                            <span style="color: #6c757d; font-style: italic; font-size: 12px;">No Tray Info</span>
                        {% endif %}
                        </td>
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.jig_capacity }} - Jig</td>
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.total_cases_loaded|default:"0" }}</td>
                      <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>{{ jig_detail.ep_bath_type }}</td>
                        <!-- Nickel Bath No - Dropdown -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <div style="position:relative; display:flex; align-items:center;">
                           {% if jig_detail.bath_numbers %}
                           <!-- Show saved bath number (disabled state) -->
                           <select style="max-height:110px; overflow-y:auto; width:80px; background-color:#f5f5f5;" 
                              size="1" disabled>
                              <option value="{{ jig_detail.bath_numbers.bath_number }}" selected>
                                 {{ jig_detail.bath_numbers.bath_number }}
                              </option>
                           </select>
                           <img src="{% static 'assets/icons/scan.png' %}" alt="Scan"
                              style="opacity:0.2; margin-left:4px; height:14px; width:14px; object-fit:contain;" />
                           {% else %}
                            <!-- Updated Bath Number Dropdown with Type Filtering -->
                          <select class="bath-number-select" 
                                  data-jig-id="{{ jig_detail.id }}" 
                                  data-bath-type="{{ jig_detail.ep_bath_type|default:'Bright' }}"
                                  style="font-size: 12px; padding: 2px 4px;">
                              <option value="">Select Bath No</option>
                              {% for bath in all_bath_numbers %}
                              <option value="{{ bath.bath_number }}" 
                                      data-bath-type="{{ bath.bath_type }}">
                                  {{ bath.bath_number }}
                              </option>
                              {% endfor %}
                          </select>
                           <img src="{% static 'assets/icons/scan.png' %}" alt="Scan"
                              style="opacity:0.4; margin-left:4px; height:14px; width:14px; object-fit:contain;" />
                           {% endif %}
                        </div>
                        </td>
                        <!-- In.P Info -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <div style="display: flex; align-items: center; justify-content: center; position: relative;">
                           <img
                              src="{% static 'assets/icons/viewRemarks.png' %}"
                              alt="View Remarks"
                              style="width:22px; height:22px; object-fit:contain; cursor:pointer;"
                              title="View Remarks"
                              class="view-remarks-icon"
                              data-remark="{{ jig_detail.remarks|default:'No remarks' }}"
                              data-tooltip-id="remarks-tooltip-{{ forloop.counter }}"
                              />
                           <div class="remarks-tooltip"
                              data-tooltip-id="remarks-tooltip-{{ forloop.counter }}"
                              style="display:none; position:absolute; top:-170%; left:50%; transform:translateX(-50%); min-width:180px; max-width:320px; background:#fff; border:1px solid #ccc; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,0.18); padding:10px 14px; font-size:13px; color:#222; z-index:9999; white-space:pre-line;">
                           </div>
                        </div>
                        </td>
                        <!-- Process Status column -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <div style="display: flex; gap: 6px; align-items: center; justify-content: center;">
                           <!-- Tray Scan (B) - Green when bath number is saved, disabled otherwise -->
                           <div title="Tray Scan"
                              class="d-flex align-items-center justify-content-center rounded-circle ms-1 tray-scan-status"
                              data-jig-id="{{ jig_detail.id }}"
                              style="width: 20px; height: 20px; 
                              {% if jig_detail.bath_numbers %}
                              background-color: #0c8249; color: white;
                              {% else %}
                              background-color: #ccc; color: #888;
                              {% endif %}
                              font-weight: 500; line-height: 20px; text-align: center; padding-top: 1px; padding-right: 1px;">
                              B
                           </div>
                           <!-- Rework (R) - Always disabled for now -->
                           <div title="Inspection"
                              class="d-flex align-items-center justify-content-center rounded-circle ms-1 rework-status"
                              data-jig-id="{{ jig_detail.id }}"
                              style="width: 20px; height: 20px;
                              {% if jig_detail.jig_position and jig_detail.remarks %}
                              background-color: #0c8249; color: white;
                              {% else %}
                              background-color: #ccc; color: #888;
                              {% endif %}
                              font-weight: 500; line-height: 20px; text-align: center;">
                              I
                           </div>
                        </div>
                        </td>
                        <!-- Action -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <a href="#" title="Delete"
                        class="delete-jig-btn"
                        data-lot-id="{{ jig_detail.lot_id }}"
                        {% if jig_detail.jig_position and jig_detail.remarks and jig_detail.bath_numbers %} style="pointer-events: none; opacity: 0.5;" tabindex="-1" aria-disabled="true"{% endif %}>
                        <img src="{% static 'assets/icons/bin.png' %}" alt="Delete" style="width: 20px; margin-right: 8px; height: auto; cursor:pointer;"/>
                        </a>
                        <!-- FIXED: Properly connected Remarks link -->
                        {% if not jig_detail.jig_position or not jig_detail.remarks %}
                          {% if jig_detail.bath_numbers %}
                            <!-- Enabled Inspection link -->
                            <a href="#" class="text-primary tray-scan-btn remarks-modal-trigger"
                              data-jig-id="{{ jig_detail.id }}"
                              data-lot-id="{{ jig_detail.lot_id }}"
                              data-no-of-trays="{{ jig_detail.calculated_no_of_trays }}"
                              data-tray-capacity="{{ jig_detail.primary_tray_capacity }}"
                              data-current-position="{{ jig_detail.jig_position|default:'Top' }}"
                              data-current-remarks="{{ jig_detail.remarks|default:'' }}"
                              data-moved-to-d-picker="False">Inspection</a>
                          {% else %}
                            <!-- Disabled Inspection link -->
                            <a href="javascript:void(0);" class="text-secondary tray-scan-btn remarks-modal-trigger disabled"
                              style="pointer-events: none; opacity: 0.5; cursor: not-allowed;"
                              title="Select Bath Number first">Inspection</a>
                          {% endif %}
                        {% endif %}
                        </td>
                        <!-- Lot Status -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        {% if jig_detail.inprocess_hold_lot %}
                        <div
                           class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #dc3545; background-color: #f8d7da; color: #721c24; font-size: 13px; white-space: nowrap; padding: 5px;">
                           On Hold
                        </div>
                        {% elif jig_detail.remarks and jig_detail.bath_numbers %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #0d5d17; background-color: #c5f9c2; color: #2f801b; font-size: 13px; white-space: nowrap; padding: 6px;">
                           Yet To Release
                        </div>
                        {% elif not jig_detail.remarks and not jig_detail.bath_numbers %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #f9a825; background-color: #fff8e1; color: #b26a00; font-size: 13px; white-space: nowrap; padding: 6px;">
                           Yet To Start
                        </div>
                        {% else %}
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #4997ac; background-color: #d1f2f3; color: #03425d; font-size: 13px; white-space: nowrap; padding: 6px;">
                           Draft
                        </div>
                        {% endif %}
                        </td>
                        <!-- Current Stage -->
                        <td {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <div class="d-inline-block px-3 fw-semibold text-center rounded-pill"
                           style="border: 1px solid #9adeed; background-color: #d1edf3; color: #033b5d; font-size: 12px; white-space: nowrap; padding: 6px;">
                           {{ jig_detail.last_process_module|default:"Jig Loading" }}
                        </div>
                        </td>
                        <!-- VoiceRec with tooltip (audio remark) -->
                        <td style="z-index: 1050; position: relative;" {% if jig_detail.inprocess_hold_lot %} class="row-inactive-blur" {% endif %}>
                        <a href="#" title="Add Audio Remark" class="remark-tooltip-trigger"
                           style="display: inline-flex; align-items: center; height: 28px; margin-left: 0; position: relative; cursor: pointer;">
                           <img src="{% static 'assets/icons/rec.png' %}" alt="VoiceRec" style="width: 20px; height: 20px"/>
                           <div class="remark-tooltip"
                              style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 265px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 10px; z-index: 20000;">
                              <div style="display: flex; align-items: center; gap: 10px;">
                                 <button type="button"
                                    style="background: #28a745; color: #fff; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; display: flex; align-items: center; justify-content: center;">
                                 <i class="fa fa-microphone"></i>
                                 </button>
                                 <span style="font-size: 14px; color: #333;">Hold to record audio</span>
                                 <div style="text-align: right; margin-top: 10px;">
                                    <button type="button"
                                       style="background-color: #007bff; color: #fff; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    <i class="fa fa-send"></i>
                                    </button>
                                 </div>
                              </div>
                           </div>
                        </a>
                        <a
                           href="#"
                           title="Add Remark"
                           class="remark-tooltip-trigger"
                           data-lot-id="{{ jig_detail.lot_id }}"
                           style="display: inline-flex; align-items: center; height: 20px; margin-left: 5px; position: relative; cursor: pointer;">
                           <img
                              src="{% static 'assets/icons/chat_icon.png' %}"
                              alt="Chat"
                              style="width: 20px; height: 20px; {% if jig_detail.pick_remarks %}filter: grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2); opacity: 1;{% else %}opacity: 0.7;{% endif %}">
                           <div
                              class="remark-tooltip"
                              style="position: absolute; top: 110%; left: 50%; transform: translateX(-50%); width: 300px; background: #fff; border: 1px solid #ccc; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; padding: 15px; z-index: 20000;">
                              <textarea
                              placeholder="Type your remark..."
                              style="width: 85%; height: 40px; resize: vertical; border: 1px solid #ccc; padding: 5px; border-radius: 4px; font-family: Arial, sans-serif; font-size: 14px; z-index: 20001; position: relative;"
                              {% if jig_detail.pick_remarks %}readonly{% endif %}
                              >{{ jig_detail.pick_remarks|default_if_none:"" }}</textarea>
                              <div style="text-align: right; margin-top: -35px">
                                 {% if not jig_detail.pick_remarks %}
                                 <button
                                    type="button"
                                    style="background-color: #007bff; color: #fff; border: none; padding: 5px; border-radius: 4px; cursor: pointer; font-size: 14px;">
                                 <i class="fa fa-send"></i>
                                 </button>
                                 {% else %}
                                 <div style="margin-top: 18px; color: #31708f; background: #d9edf7; border: 1px solid #bce8f1; border-radius: 4px; padding: 8px 12px; font-size: 10px; text-align: left; position: relative; z-index: 20002;">
                                    <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                                    Remark already saved and cannot be edited.
                                 </div>
                                 {% endif %}
                              </div>
                           </div>
                        </a>
                        </td>
                     </tr>
                     {% empty %}
                     <tr>
                        <td colspan="21" style="text-align: center; padding: 20px; color: #888;">
                           No jig details found.
                        </td>
                     </tr>
                     {% endfor %}
                  </tbody>
               </table>
               <!-- Tray Scan Modal -->
               <div id="trayScanModal" class="tray-scan-modal active">
                  <!-- Modal content here -->
               </div>
            </div>
            
            
      </div>
   </div>
</div>
</div>
<!-- Modal for Remarks - UPDATED WITH AJAX FUNCTIONALITY -->
<div class="modal fade" id="remarksModal" tabindex="-1" role="dialog" aria-labelledby="remarksModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header p-0" style="border-bottom:none;">
                <img src="{% static 'assets/images/loginBG3.jpg' %}" alt="Banner" style="width:100%;height:90px;object-fit:cover;border-radius:8px 8px 0 0;">
                <button type="button" class="close position-absolute end-0 top-0 m-2" data-bs-dismiss="modal" aria-label="Close" style="z-index:2;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <!-- Add Jig Remark - Modal Popup Window -->
            <div class="modal-body pt-2">
                <h5 class="modal-title text-center mb-3" id="remarksModalLabel" style="color:#023E4DCC;font-weight:700;">Add Jig Remark</h5>
                <!-- Loading spinner -->
                <div id="remarksLoadingSpinner" style="display:none; text-align:center; padding:20px;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Saving...</span>
                    </div>
                    <div style="margin-top:10px; color:#666;">Saving details...</div>
                </div>
                <form id="remarksModalForm" autocomplete="off">
                    <input type="hidden" id="remarksJigId" name="jig_id" />
                    <div class="mb-3 row align-items-center ms-30">
                        <label class="col-5 col-form-label text-end" style="margin-left:-35px; font-weight:bold;">
                            Jig Position: <span style="color: red;">*</span>
                        </label>
                        <div class="col-7 d-flex gap-3">
                            <label class="form-check-label me-2">
                                <input type="radio" class="form-check-input" name="jig_position" value="Top" required> Top
                            </label>
                            <label class="form-check-label me-2">
                                <input type="radio" class="form-check-input" name="jig_position" value="Middle"> Middle
                            </label>
                            <label class="form-check-label">
                                <input type="radio" class="form-check-input" name="jig_position" value="Bottom"> Bottom
                            </label>
                        </div>
                    </div>
                    <div class="mb-3 row align-items-center">
                        <label class="col-5 col-form-label text-end fw-bold" style="margin-left:-1px;">
                            Enter Remarks: <span style="color: #6c757d; font-size: 12px;">(Optional)</span>
                        </label>
                        <div class="col-7 position-relative">
                            <input type="text" name="remarks" maxlength="50" class="form-control pe-5" 
                                placeholder="Enter remarks (optional, max 50 chars)" style="padding-right: 70px;" />
                            <span id="remarksCharCount" class="position-absolute end-0 top-50 translate-middle-y text-muted small me-2" 
                                style="pointer-events:none; font-size:12px;">0/50</span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12 d-flex justify-content-center gap-3">
                            <button type="submit" id="saveRemarksBtn" class="btn btn-primary px-4">Submit</button>
                            <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Hold Remark Modal -->
<div id="holdRemarkModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.18); z-index:20000; align-items:center; justify-content:center;">
   <div style="background:#fff; border-radius:10px; padding:28px 32px 18px 32px; min-width:320px; max-width:90vw; box-shadow:0 4px 24px rgba(0,0,0,0.18); position:relative;">
      <span id="closeHoldRemarkModal" style="position:absolute; top:8px; right:16px; font-size:22px; font-weight:bold; color:#d9534f; cursor:pointer;">&times;</span>
      <h5 style="margin-bottom:16px; color:#028084;">Row Hold Remark</h5>
      <textarea id="holdRemarkInput" maxlength="50" style="width:100%; height:60px; border:1px solid #ccc; border-radius:6px; padding:8px; font-size:15px; resize:none;" placeholder="Enter remark (max 50 chars)"></textarea>
      <div style="text-align:right; margin-top:10px;">
         <button id="saveHoldRemarkBtn" style="background:#007bff; color:#fff; border:none; border-radius:20px; padding:6px 18px; font-size:15px; cursor:pointer;">Save</button>
      </div>
      <div id="holdRemarkError" style="color:red; font-size:13px; min-height:18px; margin-top:6px;"></div>
   </div>
</div>
<!-- 2. REPLACE the "JavaScript for Remarks Modal" script section -->
<script nonce="{{ csp_nonce }}">
   document.addEventListener("DOMContentLoaded", function () {
     // Character counter for remarks input
     const remarksInput = document.querySelector('input[name="remarks"]');
     const charCount = document.getElementById('remarksCharCount');
     
     if (remarksInput && charCount) {
       remarksInput.addEventListener('input', function() {
         const currentLength = this.value.length;
         charCount.textContent = `${currentLength}/50`;
         
         // Change color if approaching limit
         if (currentLength > 40) {
           charCount.style.color = '#dc3545'; // Red color
         } else {
           charCount.style.color = '#6c757d'; // Gray color
         }
       });
     }
   
     // Handle remarks modal trigger
     document.querySelectorAll('.remarks-modal-trigger').forEach(function(link) {
       link.addEventListener('click', function(e) {
         e.preventDefault();
         
         // Get data from the clicked link
         const jigId = this.getAttribute('data-jig-id');
         const lotId = this.getAttribute('data-lot-id');
         const noOfTrays = this.getAttribute('data-no-of-trays');
         const trayCapacity = this.getAttribute('data-tray-capacity');
         const currentPosition = this.getAttribute('data-current-position');
         const currentRemarks = this.getAttribute('data-current-remarks');
         
         console.log('Opening remarks modal for:', { jigId, lotId, noOfTrays, trayCapacity, currentPosition, currentRemarks });
         
         // Set the jig_id in the hidden input
         document.getElementById('remarksJigId').value = jigId;
         
         // Reset form first
         const form = document.getElementById('remarksModalForm');
         if (form) {
           form.reset();
           document.getElementById('remarksJigId').value = jigId; // Reset after form reset
           
           // Set existing values if they exist
           if (currentPosition) {
             const positionRadio = form.querySelector(`input[name="jig_position"][value="${currentPosition}"]`);
             if (positionRadio) {
               positionRadio.checked = true;
             }
           }
           
           if (currentRemarks) {
             const remarksInput = form.querySelector('input[name="remarks"]');
             if (remarksInput) {
               remarksInput.value = currentRemarks;
               // Update character count
               if (charCount) {
                 charCount.textContent = `${currentRemarks.length}/50`;
                 if (currentRemarks.length > 40) {
                   charCount.style.color = '#dc3545';
                 } else {
                   charCount.style.color = '#6c757d';
                 }
               }
             }
           } else {
             if (charCount) charCount.textContent = '0/50';
           }
         }
         
         // Open modal using Bootstrap 5
         const modal = document.getElementById('remarksModal');
         if (modal) {
           if (typeof bootstrap !== "undefined" && bootstrap.Modal) {
             const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
             bsModal.show();
           } else {
             // Fallback for non-Bootstrap: show modal manually
             modal.style.display = 'block';
             modal.classList.add('show');
             modal.classList.add('fade');
             document.body.classList.add('modal-open');
             
             // Create backdrop
             const backdrop = document.createElement('div');
             backdrop.className = 'modal-backdrop fade show';
             backdrop.style.zIndex = '1040';
             document.body.appendChild(backdrop);
             
             // Close modal on backdrop click
             backdrop.addEventListener('click', function() {
               modal.style.display = 'none';
               modal.classList.remove('show');
               document.body.classList.remove('modal-open');
               backdrop.remove();
             });
           }
         }
       });
     });
   
     // Handle form submission
     document.getElementById('remarksModalForm')?.addEventListener('submit', function(e) {
       e.preventDefault();
       
       const formData = new FormData(this);
       const jigId = formData.get('jig_id');
       const jigPosition = formData.get('jig_position');
       const remarks = formData.get('remarks');
       
       if (!jigId) {
         showFloatingAlert('Error: Missing jig ID', 'error');
         return;
       }
       
       if (!jigPosition) {
         showFloatingAlert('Please select a jig position', 'error');
         return;
       }
       
       if (remarks.trim().length > 50) {
         showFloatingAlert('Remarks cannot exceed 50 characters', 'error');
         return;
       }
       
       // Show loading state
       const loadingSpinner = document.getElementById('remarksLoadingSpinner');
       const saveBtn = document.getElementById('saveRemarksBtn');
       const form = document.getElementById('remarksModalForm');
       
       if (loadingSpinner) loadingSpinner.style.display = 'block';
       if (saveBtn) saveBtn.disabled = true;
       if (form) form.style.display = 'none';
       
       // Prepare data for AJAX request
       const data = {
         jig_id: jigId,
         jig_position: jigPosition,
         remarks: remarks.trim()
       };
       
       // Send AJAX request
       fetch('/inprocess_inspection/save_jig_remarks/', {
         method: 'POST',
         headers: {
           'Content-Type': 'application/json',
         },
         body: JSON.stringify(data)
       })
       .then(response => response.json())
       .then(data => {
         if (data.success) {
           // Show success message
           showFloatingAlert('Jig remarks saved successfully!', 'success');
           
           // Update the data attributes of the remarks link to reflect saved values
           const remarksLink = document.querySelector(`.remarks-modal-trigger[data-jig-id="${jigId}"]`);
           if (remarksLink) {
             remarksLink.setAttribute('data-current-position', data.jig_position);
             remarksLink.setAttribute('data-current-remarks', data.remarks);
           }
   
           const reworkStatus = document.querySelector(`.rework-status[data-jig-id="${jigId}"]`);
           if (reworkStatus) {
             reworkStatus.style.backgroundColor = '#0c8249';
             reworkStatus.style.color = 'white';
           }
           
           // Close modal
           const modal = document.getElementById('remarksModal');
           if (modal && typeof bootstrap !== "undefined") {
             const bsModal = bootstrap.Modal.getInstance(modal);
             if (bsModal) {
               bsModal.hide();
             }
           } else if (modal) {
             modal.style.display = 'none';
             modal.classList.remove('show');
             document.body.classList.remove('modal-open');
             const backdrop = document.querySelector('.modal-backdrop');
             if (backdrop) backdrop.remove();
           }
   
           setTimeout(() => {
         window.location.reload();
       }, 100); // 1-second delay
           
         } else {
           // Show error message
           showFloatingAlert(data.message || 'Error saving jig remarks', 'error');
         }
       })
       .catch(error => {
         console.error('Error:', error);
         showFloatingAlert('Network error occurred while saving remarks', 'error');
       })
       .finally(() => {
         // Hide loading state
         if (loadingSpinner) loadingSpinner.style.display = 'none';
         if (saveBtn) saveBtn.disabled = false;
         if (form) form.style.display = 'block';
       });
     });
   });
</script>
{% block script %}
<!--HOld save-->
<script nonce="{{ csp_nonce }}">
   // âœ… FIXED: Store state globally so it persists across table refreshes
   window.holdToggleState = {
     currentHoldCell: null,
     intendedState: null,
     currentBatchId: null,
     currentLotId: null
   };
   
   function attachHoldToggleListeners() {
     console.log('Attaching hold toggle listeners...');
   
     // Attach batch_id to each row for easy access
     document.querySelectorAll("tbody tr").forEach(function (row) {
       const trayScanBtn = row.querySelector('.tray-scan-btn, .tray-scan-btn-Jig');
       if (trayScanBtn) {
         row.setAttribute('data-batch-id', trayScanBtn.getAttribute('data-batch-id'));
       }
     });
   
     // Remove existing listeners and attach new ones
     document.querySelectorAll('.hold-toggle-btn').forEach(function (btn) {
       // Remove any existing click listeners
       const newBtn = btn.cloneNode(true);
       btn.parentNode.replaceChild(newBtn, btn);
       
       // Add new event listener
       newBtn.addEventListener('click', function (e) {
         e.preventDefault();
         
         const holdCell = newBtn.closest('td');
        const row = holdCell.closest('tr');
        let lotId = row.getAttribute('data-lot-id');
        if (!lotId) {
          // Try to get from checkbox in the row
          const checkbox = row.querySelector('.model-select-checkbox');
          if (checkbox) {
            lotId = checkbox.getAttribute('data-lot-id');
          }
        }
        window.holdToggleState = {
          currentHoldCell: holdCell,
          intendedState: newBtn.checked,
          currentLotId: lotId,
          rowIdentifier: lotId
        };
         console.log('Hold toggle clicked, state:', window.holdToggleState);
         
         document.getElementById('holdRemarkModal').querySelector('h5').textContent = 
           window.holdToggleState.intendedState ? 'Unholding Reason' : 'Holding Reason';
         document.getElementById('holdRemarkInput').value = '';
         document.getElementById('holdRemarkError').textContent = '';
         document.getElementById('holdRemarkModal').style.display = 'flex';
         document.getElementById('holdRemarkInput').focus();
       });
     });
   
     // âœ… Attach save button handler (only once globally)
     const saveBtn = document.getElementById('saveHoldRemarkBtn');
     if (saveBtn && !window.holdSaveHandlerAttached) {
       window.holdSaveHandlerAttached = true;
       
       saveBtn.onclick = function () {
         console.log('Save button clicked, current state:', window.holdToggleState);
         
         const remark = document.getElementById('holdRemarkInput').value.trim();
         if (!remark) {
           document.getElementById('holdRemarkError').textContent = 'Remark required!';
           return;
         }
         
         // âœ… Use stored state instead of current variables
         if (!window.holdToggleState.currentLotId) {
           document.getElementById('holdRemarkError').textContent = 'Lot ID not found!';
           return;
         }
       
         const action = window.holdToggleState.intendedState ? 'unhold' : 'hold';
         
         console.log('Sending request:', {
           lot_id: window.holdToggleState.currentLotId,
           remark: remark,
           action: action
         });
       
         fetch('/inprocess_inspection/inprocess_save_hold_unhold_reason/', {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
             'X-CSRFToken': getCookie('csrftoken')
           },
           body: JSON.stringify({
             lot_id: window.holdToggleState.currentLotId,
             remark: remark,
             action: action
           })
         })
         .then(res => res.json())
         .then(data => {
           console.log('Server response:', data);
           
           if (data.success) {
             // âœ… Close modal first
             document.getElementById('holdRemarkModal').style.display = 'none';
             
             // âœ… Update UI immediately before refresh
             const currentRow = document.querySelector(`tr[data-lot-id="${window.holdToggleState.currentLotId}"]`);
             if (currentRow) {
               const toggle = currentRow.querySelector('.hold-toggle-btn');
               const icon = currentRow.querySelector('.hold-remark-icon');
               
               if (action === 'hold') {
                 if (toggle) toggle.checked = false;
                 currentRow.classList.add('row-inactive');
                 currentRow.querySelectorAll('td').forEach((td, idx) => {
                   if (idx > 0) {
                     td.classList.add('row-inactive-blur');
                   } else {
                     td.classList.remove('row-inactive-blur');
                   }
                 });
                 if (icon) {
                   icon.style.display = 'inline-block';
                   icon.innerHTML = `<img src="{% static 'assets/icons/view2.png' %}" alt="Remark" style="width:18px; height:18px;" />`;
                   icon.setAttribute('title', 'Holding Reason: ' + remark);
                 }
               } else {
                 if (toggle) toggle.checked = true;
                 currentRow.classList.remove('row-inactive');
                 currentRow.querySelectorAll('td').forEach(td => {
                   td.classList.remove('row-inactive-blur');
                 });
                 if (icon) {
                   icon.style.display = 'none';
                 }
               }
             }
             
             // âœ… Then refresh the table data
             setTimeout(() => {
               if (typeof refreshTableData === 'function') {
                 location.reload();
               } else {
                 location.reload();
               }
             }, 500);
             
           } else {
             document.getElementById('holdRemarkError').textContent = data.error || 'Failed to save reason!';
           }
         })
         .catch((error) => {
           console.error('Request failed:', error);
           document.getElementById('holdRemarkError').textContent = 'Network error!';
         });
       };
     }
   
     // âœ… Attach close button handler (only once globally)
     const closeBtn = document.getElementById('closeHoldRemarkModal');
     if (closeBtn && !window.holdCloseHandlerAttached) {
       window.holdCloseHandlerAttached = true;
       closeBtn.onclick = function () {
         document.getElementById('holdRemarkModal').style.display = 'none';
         // Clear the state when modal is closed
         window.holdToggleState = {
           currentHoldCell: null,
           intendedState: null,
           currentBatchId: null,
           currentLotId: null
         };
       };
     }
   
     // Helper for CSRF
     function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
         const cookies = document.cookie.split(';');
         for (let i = 0; i < cookies.length; i++) {
           const cookie = cookies[i].trim();
           if (cookie.substring(0, name.length + 1) === (name + '=')) {
             cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
             break;
           }
         }
       }
       return cookieValue;
     }
   }
   
   // âœ… Call on page load
   document.addEventListener("DOMContentLoaded", function () {
     attachHoldToggleListeners();
   });
</script>
<script nonce="{{ csp_nonce }}">
   // Make sure SweetAlert2 is loaded in your template
   document.addEventListener("DOMContentLoaded", function () {
     document.querySelectorAll('.delete-jig-btn').forEach(function(btn) {
       btn.addEventListener('click', function(e) {
         e.preventDefault();
         const lotId = this.getAttribute('data-lot-id');
         if (!lotId) {
           Swal.fire('Error', 'Lot ID not found.', 'error');
           return;
         }
         Swal.fire({
           title: 'Are you sure?',
           text: "Do you really want to delete this record?",
           icon: 'warning',
           showCancelButton: true,
           confirmButtonColor: '#d33',
           cancelButtonColor: '#3085d6',
           confirmButtonText: 'Delete',
           cancelButtonText: 'Cancel'
         }).then((result) => {
           if (result.isConfirmed) {
             fetch('/inprocess_inspection/delete_jig_details/', {
               method: 'POST',
               headers: {
                 'Content-Type': 'application/json',
                 'X-CSRFToken': getCookie('csrftoken')
               },
               body: JSON.stringify({ lot_id: lotId })
             })
             .then(res => res.json())
             .then(data => {
                 if (data.success) {
                   Swal.fire({
                     icon: 'success',
                     title: 'Record deleted successfully.',
                     showConfirmButton: false,
                     timer: 1200
                   }).then(() => window.location.reload());
                 } else {
                   Swal.fire('Error', data.message || 'Failed to delete record.', 'error');
                 }
             })
             .catch(() => {
               Swal.fire('Error', 'Network error.', 'error');
             });
           }
         });
       });
     });
   });
     
</script>
<script nonce="{{ csp_nonce }}">
   // Helper to get CSRF token from cookies
   function getCookie(name) {
       let cookieValue = null;
       if (document.cookie && document.cookie !== '') {
           const cookies = document.cookie.split(';');
           for (let i = 0; i < cookies.length; i++) {
               const cookie = cookies[i].trim();
               // Does this cookie string begin with the name we want?
               if (cookie.substring(0, name.length + 1) === (name + '=')) {
                   cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                   break;
               }
           }
       }
       return cookieValue;
   }
</script>
<!-- Script for Text Remarks (unchanged) -->
<script nonce="{{ csp_nonce }}">
   document.addEventListener("DOMContentLoaded", function () {
     var triggers = document.querySelectorAll(".remark-tooltip-trigger");
     triggers.forEach(function (trigger) {
       var tooltip = trigger.querySelector(".remark-tooltip");
       var sendButton = tooltip ? tooltip.querySelector("button") : null;
       function showTooltip() {
         tooltip.style.opacity = "1";
         tooltip.style.visibility = "visible";
         var rect = tooltip.getBoundingClientRect();
         if (rect.right > window.innerWidth) {
           tooltip.style.left = "auto";
           tooltip.style.right = "0";
           tooltip.style.transform = "none";
         }
         if (rect.left < 0) {
           tooltip.style.left = "0";
           tooltip.style.transform = "none";
         }
         var textarea = tooltip.querySelector("textarea");
         if (textarea) {
           textarea.focus();
         }
       }
       function hideTooltip() {
         tooltip.style.opacity = "0";
         tooltip.style.visibility = "hidden";
       }
       trigger.addEventListener("mouseenter", showTooltip);
       trigger.addEventListener("mouseleave", function () {
         setTimeout(function () {
           if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
             hideTooltip();
           }
         }, 100);
       });
       tooltip.addEventListener("mouseleave", function () {
         setTimeout(function () {
           if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
             hideTooltip();
           }
         }, 100);
       });
       trigger.addEventListener("click", function (e) {
         e.preventDefault();
       });
       if (sendButton) {
         sendButton.addEventListener("click", hideTooltip);
       }
     });
   });
</script>
<script nonce="{{ csp_nonce }}">
   // Use pick_remarks instead of remarks for tooltip remark functionality
   document.addEventListener("DOMContentLoaded", function () {
     var triggers = document.querySelectorAll(".remark-tooltip-trigger");
     triggers.forEach(function (trigger) {
       var tooltip = trigger.querySelector(".remark-tooltip");
       var sendButton = tooltip ? tooltip.querySelector("button") : null;
       function showTooltip() {
         tooltip.style.opacity = "1";
         tooltip.style.visibility = "visible";
         var rect = tooltip.getBoundingClientRect();
         if (rect.right > window.innerWidth) {
           tooltip.style.left = "auto";
           tooltip.style.right = "0";
           tooltip.style.transform = "none";
         }
         if (rect.left < 0) {
           tooltip.style.left = "0";
           tooltip.style.transform = "none";
         }
         var textarea = tooltip.querySelector("textarea");
         if (textarea) {
           textarea.focus();
         }
       }
       function hideTooltip() {
         tooltip.style.opacity = "0";
         tooltip.style.visibility = "hidden";
       }
       trigger.addEventListener("mouseenter", showTooltip);
       trigger.addEventListener("mouseleave", function () {
         setTimeout(function () {
           if (!trigger.matches(":hover") && !tooltip.matches(":hover")) {
             hideTooltip();
           }
         }, 100);
       });
       tooltip.addEventListener("mouseleave", function () {
         setTimeout(function () {
           if (!tooltip.matches(":hover") && !trigger.matches(":hover")) {
             hideTooltip();
           }
         }, 100);
       });
       trigger.addEventListener("click", function (e) {
         e.preventDefault();
       });
               // ...existing code...
       if (sendButton) {
         sendButton.addEventListener("click", function (e) {
           e.preventDefault();
           var textarea = tooltip.querySelector("textarea");
           var pickRemark = textarea ? textarea.value.trim() : "";
           if (!pickRemark) {
             Swal.fire('Error', 'Please enter a remark before sending.', 'error');
             return;
           }
           var lotId = trigger.getAttribute('data-lot-id');
           if (!lotId) {
             Swal.fire('Error', 'Lot ID not found.', 'error');
             return;
           }
           fetch('/inprocess_inspection/ii_save_ip_pick_remark/', {
             method: 'POST',
             headers: {
               'Content-Type': 'application/json',
               'X-CSRFToken': getCookie('csrftoken')
             },
             body: JSON.stringify({
               lot_id: lotId,
               pick_remarks: pickRemark
             })
           })
           .then(res => res.json())
           .then(data => {
             if (data.success) {
               Swal.fire({
                 icon: 'success',
                 title: 'Remark saved!',
                 timer: 1200,
                 showConfirmButton: false
               }).then(() => {
                 // Make the textarea readonly
                 if (textarea) {
                   textarea.setAttribute("readonly", true);
                 }
                 // Replace send button with info message
                 if (sendButton && tooltip) {
                   const infoDiv = document.createElement("div");
                   infoDiv.style.marginTop = "40px";
                   infoDiv.style.color = "#31708f";
                   infoDiv.style.background = "#d9edf7";
                   infoDiv.style.border = "1px solid #bce8f1";
                   infoDiv.style.borderRadius = "4px";
                   infoDiv.style.padding = "8px 12px";
                   infoDiv.style.fontSize = "10px";
                   infoDiv.style.textAlign = "left";
                   infoDiv.innerHTML = `
                     <i class="fa fa-info-circle" style="margin-right: 6px;"></i>
                     Remark already saved and cannot be edited.
                   `;
                   sendButton.parentNode.replaceChild(infoDiv, sendButton);
                 }
                 // Change chat icon color without refresh
                 var chatIcon = trigger.querySelector('img[alt="Chat"]');
                 if (chatIcon) {
                   chatIcon.style.filter = "grayscale(0) brightness(1.1) sepia(1) hue-rotate(80deg) saturate(3) contrast(1.2)";
                   chatIcon.style.opacity = "1";
                 }
                 hideTooltip();
               });
      } else {
       Swal.fire('Error', data.error || 'Failed to save remark', 'error');
     }
   })
   .catch(() => {
     Swal.fire('Error', 'Network error', 'error');
   });
   });
   }
     
     });
   });
</script>
<script nonce="{{ csp_nonce }}">
   // Add this to your JS file or inside a <script> tag at the bottom of your template
   
   document.querySelectorAll('.view-remarks-icon').forEach(function(icon) {
     const tooltipId = icon.getAttribute('data-tooltip-id');
     const tooltip = document.querySelector('.remarks-tooltip[data-tooltip-id="' + tooltipId + '"]');
     const remark = icon.getAttribute('data-remark');
   
     // Show tooltip on hover
     icon.addEventListener('mouseenter', function() {
       tooltip.textContent = remark;
       tooltip.style.display = 'block';
     });
     // Hide tooltip when mouse leaves icon or tooltip
     icon.addEventListener('mouseleave', function() {
       tooltip.style.display = 'none';
     });
     tooltip.addEventListener('mouseleave', function() {
       tooltip.style.display = 'none';
     });
   
     // Optional: Show tooltip on click (for mobile)
     icon.addEventListener('click', function(e) {
       e.preventDefault();
       tooltip.textContent = remark;
       tooltip.style.display = 'block';
     });
   });
</script>

<!-- Script for Bath Number Selection and AJAX Save -->
<script nonce="{{ csp_nonce }}">
   document.addEventListener("DOMContentLoaded", function () {
     // Handle bath number selection
     document.querySelectorAll('.bath-number-select').forEach(function(select) {
       select.addEventListener('change', function() {
         const jigId = this.getAttribute('data-jig-id');
         const bathNumber = this.value;
         
         if (!bathNumber) {
           return; // Don't process empty selections
         }
         
         // Show loading state
         this.disabled = true;
         this.style.backgroundColor = '#f5f5f5';
         
         // Prepare data for AJAX request
         const data = {
           jig_id: jigId,
           bath_number: bathNumber
         };
         
         // Send AJAX request
         fetch('/inprocess_inspection/save_bath_number/', {
           method: 'POST',
           headers: {
             'Content-Type': 'application/json',
           },
           body: JSON.stringify(data)
         })
         .then(response => response.json())
         .then(data => {
           if (data.success) {
             // Show success message
             showFloatingAlert('Bath number saved successfully!', 'success');
             
             // Keep the dropdown disabled and show the saved value
             this.disabled = true;
             this.style.backgroundColor = '#f5f5f5';
             
             // Update the scan icon opacity
             const scanIcon = this.parentElement.querySelector('img[alt="Scan"]');
             if (scanIcon) {
               scanIcon.style.opacity = '0.2';
             }
             
             // Update the Tray Scan (B) status to green
             const trayScanStatus = document.querySelector(`.tray-scan-status[data-jig-id="${jigId}"]`);
             if (trayScanStatus) {
               trayScanStatus.style.backgroundColor = '#0c8249';
               trayScanStatus.style.color = 'white';
             }

             // Enable the "Inspection" hyperlink in this row if present
             const row = this.closest('tr');
             if (row) {
               // Find the Inspection link in this row
               const inspectionLink = row.querySelector('.remarks-modal-trigger.text-secondary.disabled');
               if (inspectionLink) {
                 inspectionLink.classList.remove('text-secondary', 'disabled');
                 inspectionLink.classList.add('text-primary');
                 inspectionLink.style.pointerEvents = '';
                 inspectionLink.style.opacity = '';
                 inspectionLink.style.cursor = '';
                 inspectionLink.title = '';
                inspectionLink.setAttribute('data-jig-id', jigId);

               }
             }
             
           } else {
             // Show error message
             showFloatingAlert(data.message || 'Error saving bath number', 'error');
             
             // Re-enable the dropdown
             this.disabled = false;
             this.style.backgroundColor = '';
             this.value = ''; // Reset selection
           }
         })
         .catch(error => {
           console.error('Error:', error);
           showFloatingAlert('Network error occurred', 'error');
           
           // Re-enable the dropdown
           this.disabled = false;
           this.style.backgroundColor = '';
           this.value = ''; // Reset selection
         });
       });
     });
   });
   
   // Function to show floating alerts
   function showFloatingAlert(message, type = 'info') {
     // Remove existing alerts
     const existingAlert = document.querySelector('.dp-float-alert');
     if (existingAlert) {
       existingAlert.remove();
     }
     
     // Create new alert
     const alert = document.createElement('div');
     alert.className = 'dp-float-alert show';
     alert.textContent = message;
     
     // Set color based on type
     if (type === 'success') {
       alert.style.background = '#28a745';
     } else if (type === 'error') {
       alert.style.background = '#dc3545';
     } else {
       alert.style.background = '#222';
     }
     
     document.body.appendChild(alert);
     
     // Auto-hide after 3 seconds
     setTimeout(() => {
       alert.classList.remove('show');
       setTimeout(() => {
         if (alert.parentElement) {
           alert.remove();
         }
       }, 300);
     }, 3000);
   }
</script>

<!-- Script for dynamic model image gallery view -->
<script nonce="{{ csp_nonce }}">
   document.addEventListener("DOMContentLoaded", function () {
     const modal = document.getElementById('modelRemarkModal');
     const closeBtn = document.getElementById('closeModelRemarkModal');
     const modalContent = document.getElementById('modelRemarkModalContent');
   
     document.querySelectorAll('.expand-model-remark').forEach(function(expandBtn) {
       expandBtn.addEventListener('click', function(e) {
         e.stopPropagation();
         const cell = expandBtn.closest('.model-stock-no-cell');
         if (!cell) return;
   
         try {
           // Get dynamic data from data attributes
           const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
           const modelColors = JSON.parse(cell.getAttribute('data-model-colors') || '{}');
           const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
   
           // Build grid of images (3 columns max, responsive)
           let html = `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:18px 12px;justify-items:center;">`;
           
           modelList.forEach(function(modelNo, index) {
             const color = modelColors[modelNo] || '#ccc';
             const modelImageData = modelImages[modelNo] || {};
             const firstImage = modelImageData.first_image || '/static/assets/images/imagePlaceholder.png';
             
             html += `
               <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                 <span class="model-circle" style="background:${color};width:22px;height:22px;display:inline-block;margin-bottom:2px;"></span>
                 <img src="${firstImage}" alt="${modelNo}" style="max-width:80px;max-height:80px;border-radius:8px;border:1px solid #eee;background:#fafafa;cursor:pointer;" onclick="showModelImages('${modelNo}', '${JSON.stringify(modelImageData.images || []).replace(/'/g, "\\'")}')"/>
                 <div style="font-weight:600;color:#023E4DCC;font-size:0.98rem;text-align:center;word-break:break-all;">${modelNo}</div>
               </div>
             `;
           });
           html += `</div>`;
   
           modalContent.innerHTML = html;
           modal.style.display = 'block';
         } catch (error) {
           console.error('Error parsing model data:', error);
           modalContent.innerHTML = '<div style="padding:20px;text-align:center;color:#888;">Error loading model data</div>';
           modal.style.display = 'block';
         }
       });
     });
   
    closeBtn.addEventListener('click', function() {
      window.location.reload(); 
      modal.style.display = 'none';
    });
     
     window.addEventListener('click', function(e) {
       if (modal.style.display === 'block' && !modal.contains(e.target) && !e.target.classList.contains('expand-model-remark')) {
         modal.style.display = 'none';
       }
     });
   });
   
   // Function to show model images in a larger view
   function showModelImages(modelNo, imagesJson) {
     try {
       const images = JSON.parse(imagesJson);
       if (images.length === 0) {
         alert('No images available for ' + modelNo);
         return;
       }
       
       // Create image viewer modal
       let imageModal = document.getElementById('modelImageViewer');
       if (!imageModal) {
         imageModal = document.createElement('div');
         imageModal.id = 'modelImageViewer';
         imageModal.style.cssText = `
           position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
           background: rgba(0,0,0,0.8); z-index: 100000; display: none;
           justify-content: center; align-items: center;
         `;
         document.body.appendChild(imageModal);
       }
       
       let currentIndex = 0;
       
       function updateImage() {
         imageModal.innerHTML = `
           <div style="position: relative; max-width: 90%; max-height: 90%; background: white; border-radius: 8px; overflow: hidden;">
             <div style="position: absolute; top: 10px; right: 10px; font-size: 24px; cursor: pointer; color: #000; z-index: 2;" onclick="document.getElementById('modelImageViewer').style.display='none'">&times;</div>
             <div style="padding: 20px; text-align: center;">
               <h3 style="margin: 0 0 15px 0; color: #023E4DCC;">${modelNo}</h3>
               <img src="${images[currentIndex]}" style="max-width: 100%; max-height: 70vh; object-fit: contain;" />
               <div style="margin-top: 15px;">
                 <button onclick="prevImage()" ${currentIndex === 0 ? 'disabled' : ''} style="margin: 0 10px; padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">Previous</button>
                 <span style="margin: 0 15px; color: #666;">${currentIndex + 1} / ${images.length}</span>
                 <button onclick="nextImage()" ${currentIndex === images.length - 1 ? 'disabled' : ''} style="margin: 0 10px; padding: 8px 16px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer;">Next</button>
               </div>
             </div>
           </div>
         `;
       }
       
       window.prevImage = function() {
         if (currentIndex > 0) {
           currentIndex--;
           updateImage();
         }
       };
       
       window.nextImage = function() {
         if (currentIndex < images.length - 1) {
           currentIndex++;
           updateImage();
         }
       };
       
       updateImage();
       imageModal.style.display = 'flex';
       
     } catch (error) {
       console.error('Error showing images:', error);
       alert('Error loading images');
     }
   }
</script>
<!-- Rest of your existing scripts -->
<script nonce="{{ csp_nonce }}">
   // Helper: Remove image tooltips on hover when modal is open
   function removeModelImageTooltip() {
     document.querySelectorAll('.model-image-tooltip').forEach(function(tip) {
       tip.remove();
     });
   }
   
   document.addEventListener("DOMContentLoaded", function () {
     // Mouse hover for tooltip functionality
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell, i) {
       const textSpan = cell.querySelector('.model-stock-no-text');
       if (!textSpan) return;
       
       let tooltip = null;
       let hideTimeout = null;
       let staticTooltip = null;
       
       try {
         const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         
         textSpan.addEventListener('mouseenter', function(e) {
           if (e.target.closest('.expand-model-remark')) return;
           if (staticTooltip) return;
           if (tooltip) tooltip.remove();
           
           // Create tooltip with first model's first image
           if (modelList.length > 0) {
             const firstModel = modelList[0];
             const firstModelImages = modelImages[firstModel] || {};
             const firstImage = firstModelImages.first_image || '/static/assets/images/imagePlaceholder.png';
             
             tooltip = document.createElement('div');
             tooltip.className = 'model-image-tooltip';
             tooltip.innerHTML = `
               <div style="text-align: center;">
                 <img src="${firstImage}" alt="${firstModel}" style="max-width: 150px; max-height: 150px; object-fit: contain;" />
                 <div style="margin-top: 8px; font-weight: 600; color: #023E4DCC;">${firstModel}</div>
                 ${modelList.length > 1 ? `<div style="font-size: 12px; color: #666;">+${modelList.length - 1} more models</div>` : ''}
               </div>
             `;
             
             document.body.appendChild(tooltip);
             tooltip.style.display = 'block';
             const rect = textSpan.getBoundingClientRect();
             tooltip.style.top = (window.scrollY + rect.bottom + 6) + 'px';
             tooltip.style.left = (window.scrollX + rect.left) + 'px';
           }
         });
         
         textSpan.addEventListener('mouseleave', function() {
           if (staticTooltip) return;
           hideTimeout = setTimeout(() => { if (tooltip) { tooltip.remove(); tooltip = null; } }, 150);
         });
         
       } catch (error) {
         console.error('Error setting up tooltip for cell', i, error);
       }
     });
   });
</script>
<!-- FIXED: JavaScript for Remarks Modal -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
    // Character counter for remarks input
    const remarksInput = document.querySelector('input[name="remarks"]');
    const charCount = document.getElementById('remarksCharCount');
    
    if (remarksInput && charCount) {
        remarksInput.addEventListener('input', function() {
            const currentLength = this.value.length;
            charCount.textContent = `${currentLength}/50`;
            
            // Change color if approaching limit
            if (currentLength > 40) {
                charCount.style.color = '#dc3545'; // Red color
            } else {
                charCount.style.color = '#6c757d'; // Gray color
            }
        });
    }

    // Handle remarks modal trigger
    document.querySelectorAll('.remarks-modal-trigger').forEach(function(link) {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Get data from the clicked link
            const jigId = this.getAttribute('data-jig-id');
            const lotId = this.getAttribute('data-lot-id');
            const noOfTrays = this.getAttribute('data-no-of-trays');
            const trayCapacity = this.getAttribute('data-tray-capacity');
            const currentPosition = this.getAttribute('data-current-position');
            const currentRemarks = this.getAttribute('data-current-remarks');
            
            console.log('Opening remarks modal for:', { jigId, lotId, noOfTrays, trayCapacity, currentPosition, currentRemarks });
            
            // Set the jig_id in the hidden input
            document.getElementById('remarksJigId').value = jigId;
            
            // Reset form first
            const form = document.getElementById('remarksModalForm');
            if (form) {
                form.reset();
                document.getElementById('remarksJigId').value = jigId; // Reset after form reset
                
                // Set existing values if they exist
                if (currentPosition) {
                    const positionRadio = form.querySelector(`input[name="jig_position"][value="${currentPosition}"]`);
                    if (positionRadio) {
                        positionRadio.checked = true;
                    }
                }
                
                if (currentRemarks) {
                    const remarksInput = form.querySelector('input[name="remarks"]');
                    if (remarksInput) {
                        remarksInput.value = currentRemarks;
                        // Update character count
                        if (charCount) {
                            charCount.textContent = `${currentRemarks.length}/50`;
                            if (currentRemarks.length > 40) {
                                charCount.style.color = '#dc3545';
                            } else {
                                charCount.style.color = '#6c757d';
                            }
                        }
                    }
                } else {
                    if (charCount) charCount.textContent = '0/50';
                }
            }
            
            // Open modal using Bootstrap 5
            const modal = document.getElementById('remarksModal');
            if (modal) {
                if (typeof bootstrap !== "undefined" && bootstrap.Modal) {
                    const bsModal = bootstrap.Modal.getOrCreateInstance(modal);
                    bsModal.show();
                } else {
                    // Fallback for non-Bootstrap: show modal manually
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    modal.classList.add('fade');
                    document.body.classList.add('modal-open');
                    
                    // Create backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.style.zIndex = '1040';
                    document.body.appendChild(backdrop);
                    
                    // Close modal on backdrop click
                    backdrop.addEventListener('click', function() {
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        document.body.classList.remove('modal-open');
                        backdrop.remove();
                    });
                }
            }
        });
    });

    // Handle form submission - UPDATED TO MAKE REMARKS OPTIONAL
    document.getElementById('remarksModalForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const jigId = formData.get('jig_id');
        const jigPosition = formData.get('jig_position');
        const remarks = formData.get('remarks') || ''; // Default to empty string if null/undefined
        
        if (!jigId) {
            showFloatingAlert('Error: Missing jig ID', 'error');
            return;
        }
        
        // UPDATED: Only check for jig_position, remarks is optional
        if (!jigPosition) {
            showFloatingAlert('Please select a jig position', 'error');
            return;
        }
        
        // Only validate remarks length if remarks is provided
        if (remarks.trim().length > 50) {
            showFloatingAlert('Remarks cannot exceed 50 characters', 'error');
            return;
        }
        
        // Show loading state
        const loadingSpinner = document.getElementById('remarksLoadingSpinner');
        const saveBtn = document.getElementById('saveRemarksBtn');
        const form = document.getElementById('remarksModalForm');
        
        if (loadingSpinner) loadingSpinner.style.display = 'block';
        if (saveBtn) saveBtn.disabled = true;
        if (form) form.style.display = 'none';
        
        // Prepare data for AJAX request
        const data = {
            jig_id: jigId,
            jig_position: jigPosition,
            remarks: remarks.trim() // Can be empty string
        };
        
        // Send AJAX request
        fetch('/inprocess_inspection/save_jig_remarks/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const message = remarks.trim() 
                    ? 'Jig position and remarks saved successfully!' 
                    : 'Jig position saved successfully!';
                showFloatingAlert(message, 'success');
                
                // Update the data attributes of the remarks link to reflect saved values
                const remarksLink = document.querySelector(`.remarks-modal-trigger[data-jig-id="${jigId}"]`);
                if (remarksLink) {
                    remarksLink.setAttribute('data-current-position', data.jig_position);
                    remarksLink.setAttribute('data-current-remarks', data.remarks || '');
                }

                const reworkStatus = document.querySelector(`.rework-status[data-jig-id="${jigId}"]`);
                if (reworkStatus) {
                    reworkStatus.style.backgroundColor = '#0c8249';
                    reworkStatus.style.color = 'white';
                }
                
                // Close modal
                const modal = document.getElementById('remarksModal');
                if (modal && typeof bootstrap !== "undefined") {
                    const bsModal = bootstrap.Modal.getInstance(modal);
                    if (bsModal) {
                        bsModal.hide();
                    }
                } else if (modal) {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    document.body.classList.remove('modal-open');
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) backdrop.remove();
                }

                setTimeout(() => {
                    window.location.reload();
                }, 100); // Short delay for better UX
                
            } else {
                // Show error message
                showFloatingAlert(data.message || 'Error saving jig details', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showFloatingAlert('Network error occurred while saving details', 'error');
        })
        .finally(() => {
            // Hide loading state
            if (loadingSpinner) loadingSpinner.style.display = 'none';
            if (saveBtn) saveBtn.disabled = false;
            if (form) form.style.display = 'block';
        });
    });
});
</script>

<!-- Enhanced Script for dynamic model image gallery view with navigation -->
<script nonce="{{ csp_nonce }}">
   // Global color palette and model-to-color mapping
   const GLOBAL_COLOR_PALETTE = [
     "#e74c3c", "#f1c40f", "#2ecc71", "#3498db", "#9b59b6",
     "#e67e22", "#1abc9c", "#34495e", "#f39c12", "#d35400",
     "#c0392b", "#8e44ad", "#2980b9", "#27ae60", "#16a085",
     "#ff6b6b", "#4ecdc4", "#45b7d1", "#96ceb4", "#ffeaa7",
     "#dda0dd", "#98d8c8", "#f7dc6f", "#bb8fce", "#85c1e9"
   ];
   
   // Global mapping to ensure consistent colors across all rows
   window.globalModelColors = window.globalModelColors || {};
   window._globalColorIndex = typeof window._globalColorIndex === 'number' ? window._globalColorIndex : 0;

   // Function to get consistent color for a model
   function getGlobalModelColor(modelNo) {
     if (!window.globalModelColors[modelNo]) {
       const idx = window._globalColorIndex || 0;
       window.globalModelColors[modelNo] = GLOBAL_COLOR_PALETTE[idx % GLOBAL_COLOR_PALETTE.length];
       window._globalColorIndex = idx + 1;
     }
     return window.globalModelColors[modelNo];
   }
   
   // Initialize global colors on page load by scanning all model data
   function initializeGlobalModelColors() {
     console.log('ðŸŽ¨ Initializing global model colors...');
     
     // Collect all unique models from all rows
     const allModels = new Set();
     
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         modelList.forEach(model => allModels.add(model));
       } catch (e) {
         console.warn('Error parsing model list:', e);
       }
     });
     
     // Assign colors to all models consistently
     const sortedModels = Array.from(allModels).sort(); // Sort for consistency
     sortedModels.forEach(function(modelNo) {
       getGlobalModelColor(modelNo); // This will assign colors in order
     });
     
     console.log('ðŸŽ¨ Global model colors initialized:', window.globalModelColors);
     
     // Update all existing model circles with consistent colors
     updateAllModelCircles();
   }
   
   // Function to update all model circles with consistent colors
   function updateAllModelCircles() {
     document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
       try {
         const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
         const circles = cell.querySelectorAll('.model-circle');
         
         circles.forEach(function(circle, index) {
           if (modelList[index]) {
             const color = getGlobalModelColor(modelList[index]);
             circle.style.backgroundColor = color;
           }
         });
       } catch (e) {
         console.warn('Error updating model circles:', e);
       }
     });
   }

   document.addEventListener("DOMContentLoaded", function () {
     // Initialize global colors first
     initializeGlobalModelColors();
     
     const modal = document.getElementById('modelRemarkModal');
     const closeBtn = document.getElementById('closeModelRemarkModal');
     const modalContent = document.getElementById('modelRemarkModalContent');
   
     document.querySelectorAll('.expand-model-remark').forEach(function(expandBtn) {
       expandBtn.addEventListener('click', function(e) {
         e.stopPropagation();
         const cell = expandBtn.closest('.model-stock-no-cell');
         if (!cell) return;
   
         try {
           const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
           const modelImages = JSON.parse(cell.getAttribute('data-images') || '{}');
           const modelColors = JSON.parse(cell.getAttribute('data-model-colors') || '{}');
           
           console.log('ðŸ” Modal Debug Info:');
           console.log('   modelList:', modelList);
           console.log('   modelImages:', modelImages);
           console.log('   modelColors:', modelColors);
           
           // Clear previous content
           modalContent.innerHTML = '';
           
           if (modelList.length === 0) {
             modalContent.innerHTML = '<p style="text-align:center; color:#666;">No models available</p>';
           } else {
             modelList.forEach(function(modelNo, index) {
               const color = getGlobalModelColor(modelNo);
               
               // FIXED: Get images using the correct data structure
               let images = [];
               let firstImage = '/static/assets/images/imagePlaceholder.png';
               
               // Check multiple possible data structures for images
               if (modelImages[modelNo]) {
                 if (Array.isArray(modelImages[modelNo])) {
                   // Direct array of image URLs
                   images = modelImages[modelNo];
                   firstImage = images[0] || firstImage;
                 } else if (modelImages[modelNo].images && Array.isArray(modelImages[modelNo].images)) {
                   // Object with 'images' property
                   images = modelImages[modelNo].images;
                   firstImage = images[0] || firstImage;
                 } else if (modelImages[modelNo].first_image) {
                   // Object with 'first_image' property
                   firstImage = modelImages[modelNo].first_image;
                   images = modelImages[modelNo].images || [firstImage];
                 } else if (typeof modelImages[modelNo] === 'string') {
                   // Single image URL as string
                   images = [modelImages[modelNo]];
                   firstImage = modelImages[modelNo];
                 }
               }
               
               console.log(`ðŸ“¸ Model ${modelNo} images:`, images);
               console.log(`ðŸ“¸ Model ${modelNo} firstImage:`, firstImage);
               
               // Create model row container
               const modelRow = document.createElement('div');
               modelRow.className = 'model-row';
               modelRow.style.cssText = `
                 display: flex;
                 align-items: flex-start;
                 gap: 12px;
                 margin-bottom: 16px;
                 padding: 12px;
                 border: 1px solid #e5e5e5;
                 border-radius: 8px;
                 background: #fafafa;
                 transition: all 0.2s ease;
                 cursor: pointer;
               `;
               
               // Add hover effect
               modelRow.addEventListener('mouseenter', function() {
                 this.style.background = '#f0f8ff';
                 this.style.borderColor = '#007bff';
                 this.style.transform = 'translateY(-1px)';
                 this.style.boxShadow = '0 4px 12px rgba(0,123,255,0.15)';
               });
               
               modelRow.addEventListener('mouseleave', function() {
                 this.style.background = '#fafafa';
                 this.style.borderColor = '#e5e5e5';
                 this.style.transform = 'translateY(0)';
                 this.style.boxShadow = 'none';
               });
               
               // Add navigation on click with correct model_no extraction
               modelRow.addEventListener('click', function() {
                 const cleanModelNo = extractModelNumber(modelNo);
                 const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
                 console.log(`ðŸ”— Navigating to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
                 console.log(`ðŸ”— URL: ${visualAidUrl}`);
                 window.open(visualAidUrl, '_blank');
               });
               
               // Model circle
               const circle = document.createElement('span');
               circle.className = 'model-circle';
               circle.style.cssText = `
                 display: inline-block;
                 width: 20px;
                 height: 20px;
                 border-radius: 50%;
                 background-color: ${color};
                 border: 2px solid #fff;
                 box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                 flex-shrink: 0;
                 margin-top: 2px;
               `;
               
               // Content container
               const contentContainer = document.createElement('div');
               contentContainer.style.cssText = `
                 flex: 1;
                 min-width: 0;
               `;
               
               // Model number
               const modelNoElement = document.createElement('div');
               modelNoElement.className = 'model-no';
               modelNoElement.textContent = modelNo;
               modelNoElement.style.cssText = `
                 font-weight: 700;
                 color: #023E4DCC;
                 font-size: 16px;
                 margin-bottom: 8px;
                 word-break: break-word;
               `;
               
               // Images container
               const imagesContainer = document.createElement('div');
               imagesContainer.style.cssText = `
                 display: flex;
                 flex-wrap: wrap;
                 gap: 8px;
                 margin-top: 8px;
               `;
               
               if (images.length > 0) {
                 console.log(`ðŸ“¸ Displaying ${images.length} images for model ${modelNo}`);
                 
                 images.slice(0, 3).forEach(function(imageUrl, imgIndex) {
                   const img = document.createElement('img');
                   img.src = imageUrl;
                   img.alt = `${modelNo} - Image ${imgIndex + 1}`;
                   img.style.cssText = `
                     width: 200px;
                     height: 200px;
                     object-fit: cover;
                     border-radius: 6px;
                     border: 1px solid #ddd;
                     background: #fff;
                     transition: transform 0.2s ease;
                     cursor: pointer;
                   `;
                   
                   // Add click handler to show full image viewer
                   img.addEventListener('click', function(e) {
                     e.stopPropagation(); // Prevent row click
                     showModelImages(modelNo, JSON.stringify(images));
                   });
                   
                   img.addEventListener('mouseenter', function() {
                     this.style.transform = 'scale(1.1)';
                   });
                   
                   img.addEventListener('mouseleave', function() {
                     this.style.transform = 'scale(1)';
                   });
                   
                   // Handle image load errors
                   img.addEventListener('error', function() {
                     this.src = '/static/assets/images/imagePlaceholder.png';
                     this.style.opacity = '0.5';
                   });
                   
                   imagesContainer.appendChild(img);
                 });
                 
                 if (images.length > 3) {
                   const moreIndicator = document.createElement('div');
                   moreIndicator.textContent = `+${images.length - 3} more`;
                   moreIndicator.style.cssText = `
                     display: flex;
                     align-items: center;
                     justify-content: center;
                     width: 50px;
                     height: 50px;
                     background: #f8f9fa;
                     border: 1px solid #ddd;
                     border-radius: 6px;
                     font-size: 10px;
                     color: #666;
                     font-weight: 600;
                     cursor: pointer;
                   `;
                   
                   moreIndicator.addEventListener('click', function(e) {
                     e.stopPropagation();
                     showModelImages(modelNo, JSON.stringify(images));
                   });
                   
                   imagesContainer.appendChild(moreIndicator);
                 }
               } else {
                 console.log(`âŒ No images found for model ${modelNo}`);
                 const noImageIndicator = document.createElement('div');
                 noImageIndicator.textContent = 'No Images';
                 noImageIndicator.style.cssText = `
                   width: 50px;
                   height: 50px;
                   background: #f8f9fa;
                   border: 1px solid #ddd;
                   border-radius: 6px;
                   display: flex;
                   align-items: center;
                   justify-content: center;
                   font-size: 10px;
                   color: #999;
                 `;
                 imagesContainer.appendChild(noImageIndicator);
               }
               
               // Click to view indicator
               const clickIndicator = document.createElement('div');
               clickIndicator.innerHTML = 'ðŸ”— Click to view in Visual Aid';
               clickIndicator.style.cssText = `
                 font-size: 11px;
                 color: #007bff;
                 margin-top: 6px;
                 font-style: italic;
               `;
               
               // Assemble the row
               contentContainer.appendChild(modelNoElement);
               contentContainer.appendChild(imagesContainer);
               contentContainer.appendChild(clickIndicator);
               
               modelRow.appendChild(circle);
               modelRow.appendChild(contentContainer);
               
               modalContent.appendChild(modelRow);
             });
           }
           
           modal.style.display = 'block';
         } catch (error) {
           console.error('Error showing model gallery:', error);
           modalContent.innerHTML = '<p style="text-align:center; color:#dc3545;">Error loading model data</p>';
           modal.style.display = 'block';
         }
       });
     });
   
     closeBtn.addEventListener('click', function() {
       modal.style.display = 'none';
     });
     
     window.addEventListener('click', function(e) {
       if (modal.style.display === 'block' && !modal.contains(e.target) && !e.target.classList.contains('expand-model-remark')) {
         modal.style.display = 'none';
       }
     });
   });
   
   // Function to extract clean model number from complex model strings
   function extractModelNumber(modelString) {
     console.log(`ðŸ” Extracting model number from: "${modelString}"`);
     
     if (!modelString || typeof modelString !== 'string') {
       console.log('âŒ Invalid model string, returning as-is');
       return modelString;
     }
     
     // Pattern 1: Extract leading digits (e.g., "1805SSA02" -> "1805")
     const leadingDigitsMatch = modelString.match(/^(\d+)/);
     if (leadingDigitsMatch) {
       const extracted = leadingDigitsMatch[1];
       console.log(`âœ… Extracted using leading digits pattern: "${extracted}"`);
       return extracted;
     }
     
     // Pattern 2: Extract model before first letter (e.g., "2617ABC" -> "2617")
     const beforeLetterMatch = modelString.match(/^(\d+)(?=[A-Za-z])/);
     if (beforeLetterMatch) {
       const extracted = beforeLetterMatch[1];
       console.log(`âœ… Extracted using before-letter pattern: "${extracted}"`);
       return extracted;
     }
     
     // Pattern 3: Extract digits before any special characters
     const beforeSpecialMatch = modelString.match(/^(\d+)(?=\W)/);
     if (beforeSpecialMatch) {
       const extracted = beforeSpecialMatch[1];
       console.log(`âœ… Extracted using before-special pattern: "${extracted}"`);
       return extracted;
     }
     
     // If no pattern matches, return the original string
     console.log(`âš ï¸ No extraction pattern matched, returning original: "${modelString}"`);
     return modelString;
   }
   
   // Enhanced function to show model images in a larger view with navigation
   function showModelImages(modelNo, imagesJson) {
     try {
       const images = JSON.parse(imagesJson);
       if (images.length === 0) {
         // If no images, directly navigate to visual aid with cleaned model number
         const cleanModelNo = extractModelNumber(modelNo);
         const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
         console.log(`ðŸ”— No images found, navigating directly to Visual Aid for model: ${modelNo} -> ${cleanModelNo}`);
         window.open(visualAidUrl, '_blank');
         return;
       }
       
       // Get the consistent global color for this model
       const modelColor = getGlobalModelColor(modelNo);
       
       // Create image viewer modal
       let imageModal = document.getElementById('modelImageViewer');
       if (!imageModal) {
         imageModal = document.createElement('div');
         imageModal.id = 'modelImageViewer';
         imageModal.style.cssText = `
           position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
           background: rgba(0,0,0,0.9); z-index: 100000; display: none;
           justify-content: center; align-items: center;
         `;
         document.body.appendChild(imageModal);
       }
       
       let currentIndex = 0;
       
       function updateImage() {
         const cleanModelNo = extractModelNumber(modelNo);
         
         imageModal.innerHTML = `
           <div style="position: relative; max-width: 90vw; max-height: 90vh; background: white; border-radius: 12px; padding: 20px;">
             <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
               <div style="display: flex; align-items: center; gap: 10px;">
                 <span class="model-circle" style="background:${modelColor};width:20px;height:20px;display:inline-block;border-radius:50%;"></span>
                 <h3 style="margin: 0; color: ${modelColor};">Model: ${modelNo} (${currentIndex + 1}/${images.length})</h3>
               </div>
               <div style="display: flex; gap: 10px;">
                 <button onclick="window.open('/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}', '_blank')" 
                         style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                   ðŸ”— Open Visual Aid
                 </button>
                 <button onclick="document.getElementById('modelImageViewer').style.display='none'" 
                         style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 18px;">
                   âœ•
                 </button>
               </div>
             </div>
             <div style="position: relative;">
               <img src="${images[currentIndex]}" alt="Model ${modelNo}" 
                    style="max-width: 100%; max-height: 70vh; object-fit: contain; display: block; margin: 0 auto;"
                    onerror="this.src='/static/assets/images/imagePlaceholder.png'; this.style.opacity='0.5';">
               ${images.length > 1 ? `
                 <button onclick="prevImage()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€¹</button>
                 <button onclick="nextImage()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer;">â€º</button>
               ` : ''}
             </div>
             <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
               Click "Open Visual Aid" to view detailed information about this model
             </div>
           </div>
         `;
       }
       
       window.prevImage = function() {
         if (currentIndex > 0) {
           currentIndex--;
           updateImage();
         }
       };
       
       window.nextImage = function() {
         if (currentIndex < images.length - 1) {
           currentIndex++;
           updateImage();
         }
       };
       
       updateImage();
       imageModal.style.display = 'flex';
       
     } catch (error) {
       console.error('Error showing images:', error);
       // Fallback: navigate to visual aid with cleaned model number
       const cleanModelNo = extractModelNumber(modelNo);
       const visualAidUrl = `/adminportal/other_visualaid/?model_no=${encodeURIComponent(cleanModelNo)}`;
       window.open(visualAidUrl, '_blank');
     }
   }
</script>
<!-- Updated row highlighting script that preserves model colors -->
<script nonce="{{ csp_nonce }}">
   // Row highlight for Tray Scan (matches highlightWF.html logic) + Move active row to top and restore on close
   document.addEventListener("DOMContentLoaded", function() {
     // Add highlight style if not present
     if (!document.getElementById('dp-row-action-highlight-style')) {
       var style = document.createElement('style');
       style.id = 'dp-row-action-highlight-style';
       style.innerHTML = `
         .dp-row-action-highlight {
           transition: box-shadow 1.3s;
           background-color: #fff5bd !important;
           animation: highlightAnimation 2s ease-in-out;
         }
         .dp-row-action-highlight td:nth-child(1),
         .dp-row-action-highlight td:nth-child(2),
         .dp-row-action-highlight td:nth-child(5) {
           background-color: #fff5bd !important;
         }
         /* Preserve model circle colors even when row is highlighted */
         .dp-row-action-highlight .model-circle {
           /* Model circles keep their original colors */
         }
       `;
       document.head.appendChild(style);
     }
   
     let originalRowIndex = null;
     let movedRow = null;
     let placeholderRow = null;
   
     // Highlight and move row for remarks, edit, delete, model presents
     function highlightAndMoveRow(row) {
       document.querySelectorAll('tbody tr').forEach(function(r) {
         r.classList.remove('dp-row-action-highlight');
       });
       if (row && row.parentNode) {
         const tbody = row.parentNode;
         if (tbody.firstElementChild !== row) {
           // If a previous move exists, restore it first
           if (movedRow && placeholderRow && placeholderRow.parentNode) {
             placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
             placeholderRow.parentNode.removeChild(placeholderRow);
             movedRow.classList.remove('dp-row-action-highlight');
             movedRow = null;
             placeholderRow = null;
             originalRowIndex = null;
           }
           // Store original index and row
           originalRowIndex = Array.from(tbody.children).indexOf(row);
           movedRow = row;
           // Insert a placeholder at the original position
           placeholderRow = document.createElement('tr');
           placeholderRow.style.display = 'none';
           for (let i = 0; i < row.children.length; i++) {
             placeholderRow.appendChild(document.createElement('td'));
           }
           tbody.insertBefore(placeholderRow, tbody.children[originalRowIndex]);
           // Move row to top
           tbody.insertBefore(row, tbody.firstElementChild);
         }
         row.classList.add('dp-row-action-highlight');
         
         // Preserve model circle colors after highlighting
         preserveModelCircleColors(row);
       }
     }
     
     // Function to preserve model circle colors when row is highlighted
     function preserveModelCircleColors(row) {
       const modelCell = row.querySelector('.model-stock-no-cell');
       if (modelCell) {
         try {
           const modelList = JSON.parse(modelCell.getAttribute('data-model-list') || '[]');
           const circles = modelCell.querySelectorAll('.model-circle');
           
           circles.forEach(function(circle, index) {
             if (modelList[index] && window.globalModelColors) {
               const globalColor = window.globalModelColors[modelList[index]];
               if (globalColor) {
                 circle.style.background = globalColor;
               }
             }
           });
         } catch (e) {
           console.warn('Error preserving model circle colors:', e);
         }
       }
     }
   
     // Remarks
     document.querySelectorAll('.remarks-modal-trigger').forEach(function(link) {
       link.addEventListener('click', function(event) {
         var row = event.target.closest('tr');
         highlightAndMoveRow(row);
       });
     });
   
     // Edit
     document.querySelectorAll('.edit-qty-btn').forEach(function(link) {
       link.addEventListener('click', function(event) {
         var row = event.target.closest('tr');
         highlightAndMoveRow(row);
       });
     });
   
     // Delete
     document.querySelectorAll('.delete-jig-btn').forEach(function(link) {
       link.addEventListener('click', function(event) {
         var row = event.target.closest('tr');
         highlightAndMoveRow(row);
       });
     });
   
     // Model Presents (colored circles)
     document.querySelectorAll('.model-stock-no-text, .expand-model-remark').forEach(function(link) {
       link.addEventListener('click', function(event) {
         var row = event.target.closest('tr');
         highlightAndMoveRow(row);
       });
     });
   
     // On modal close, restore row to original position and remove highlight for both modals
     function restoreRowAndClearHighlight() {
       if (movedRow && placeholderRow && placeholderRow.parentNode) {
         placeholderRow.parentNode.insertBefore(movedRow, placeholderRow);
         placeholderRow.parentNode.removeChild(placeholderRow);
         movedRow.classList.remove('dp-row-action-highlight');
         movedRow = null;
         placeholderRow = null;
         originalRowIndex = null;
       }
       document.querySelectorAll('tbody tr').forEach(function(row) {
         row.classList.remove('dp-row-action-highlight');
         row.classList.remove('highlighted-tray-scan');
       });
       
       // Restore all model circle colors after clearing highlights
       if (window.globalModelColors) {
         document.querySelectorAll('.model-stock-no-cell').forEach(function(cell) {
           try {
             const modelList = JSON.parse(cell.getAttribute('data-model-list') || '[]');
             const circles = cell.querySelectorAll('.model-circle');
             
             circles.forEach(function(circle, index) {
               if (modelList[index]) {
                 const globalColor = window.globalModelColors[modelList[index]];
                 if (globalColor) {
                   circle.style.background = globalColor;
                 }
               }
             });
           } catch (e) {
             console.warn('Error restoring model circle colors:', e);
           }
         });
       }
     }
   
     // Attach to all close buttons for tray scan/modal
     document.querySelectorAll('#closeTrayScanModal, #closeTrayScanModal_DayPlanning, .close, [data-bs-dismiss="modal"]').forEach(function(btn) {
       btn.addEventListener('click', restoreRowAndClearHighlight);
     });
   });
</script>
<!-- Enhanced Script for Bath Number Selection with Type Filtering -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
    console.log('ðŸ”§ Initializing enhanced bath number selection with type filtering...');
    
    // Function to filter bath options based on type
    function filterBathOptions(selectElement, bathType) {
        const options = selectElement.querySelectorAll('option[data-bath-type]');
        let visibleCount = 0;
        
        console.log(`ðŸ” Filtering bath options for type: ${bathType}`);
        
        options.forEach(option => {
            const optionBathType = option.getAttribute('data-bath-type');
            
            if (optionBathType === bathType) {
                option.style.display = '';
                option.disabled = false;
                visibleCount++;
                console.log(`âœ… Showing option: ${option.value} (${optionBathType})`);
            } else {
                option.style.display = 'none';
                option.disabled = true;
                console.log(`âŒ Hiding option: ${option.value} (${optionBathType})`);
            }
        });
        
        console.log(`ðŸ“Š Total visible options for ${bathType}: ${visibleCount}`);
        return visibleCount;
    }
    
    // Initialize all bath number dropdowns
    document.querySelectorAll('.bath-number-select').forEach(function(select) {
        const bathType = select.getAttribute('data-bath-type') || 'Bright'; // Default to Bright
        
        console.log(`ðŸ”§ Initializing dropdown for bath type: ${bathType}`);
        
        // Filter options on page load
        const visibleCount = filterBathOptions(select, bathType);
        
        // Add a data attribute to track the count
        select.setAttribute('data-visible-count', visibleCount);
        
        // Enhanced change event handler
        select.addEventListener('change', function() {
            const jigId = this.getAttribute('data-jig-id');
            const bathNumber = this.value;
            const selectedBathType = this.querySelector(`option[value="${bathNumber}"]`)?.getAttribute('data-bath-type');
            
            console.log(`ðŸ”„ Bath number changed: ${bathNumber} (Type: ${selectedBathType})`);
            
            if (!bathNumber) {
                return;
            }
            
            // Validate bath type matches
            if (selectedBathType !== bathType) {
                showFloatingAlert(`Invalid selection: This bath number is for ${selectedBathType}, but ${bathType} is required.`, 'error');
                this.value = '';
                return;
            }
            
            // Show loading state
            this.disabled = true;
            this.style.backgroundColor = '#f5f5f5';
            
            // Prepare data for AJAX request
            const data = {
                jig_id: jigId,
                bath_number: bathNumber
            };
            
            console.log('ðŸ“¤ Sending AJAX request:', data);
            
            // Send AJAX request
            fetch('/inprocess_inspection/save_bath_number/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                console.log('ðŸ“¥ Server response:', data);
                
                if (data.success) {
                    // Show success message with bath type info
                    showFloatingAlert(`${selectedBathType} bath number saved successfully! You can now proceed with inspection.`, 'success');
                    
                    // Keep the dropdown disabled and show the saved value
                    this.disabled = true;
                    this.style.backgroundColor = '#e8f5e8'; // Light green to indicate saved
                    this.style.borderColor = '#28a745';
                    
                    // Update the scan icon opacity
                    const scanIcon = this.parentElement.querySelector('img[alt="Scan"]');
                    if (scanIcon) {
                        scanIcon.style.opacity = '0.2';
                    }
                    
                    // Update the Tray Scan (B) status to green
                    const trayScanStatus = document.querySelector(`.tray-scan-status[data-jig-id="${jigId}"]`);
                    if (trayScanStatus) {
                        trayScanStatus.style.backgroundColor = '#0c8249';
                        trayScanStatus.style.color = 'white';
                        trayScanStatus.textContent = `${selectedBathType}`;
                    }
                    
                    // Update the Action column to show active Inspection link
                    const actionCell = this.closest('tr').querySelector('td:last-child');
                    if (actionCell) {
                        const inspectionArea = actionCell.querySelector('.inspection-link-disabled');
                        if (inspectionArea) {
                            inspectionArea.outerHTML = `
                                <a href="#" class="remarks-modal-trigger text-primary" 
                                   data-jig-id="${jigId}" 
                                   data-lot-id="${this.closest('tr').getAttribute('data-lot-id')}"
                                   data-current-position="" 
                                   data-current-remarks=""
                                   style="font-weight: 600; text-decoration: none;">
                                    ðŸ” Inspection
                                </a>
                            `;
                            
                            // Re-attach event listeners
                            if (typeof attachInspectionLinkListeners === 'function') {
                                attachInspectionLinkListeners();
                            }
                        }
                    }
                    
                } else {
                    showFloatingAlert(data.message || 'Error saving bath number', 'error');
                    this.disabled = false;
                    this.style.backgroundColor = '';
                    this.style.borderColor = '';
                    this.value = '';
                }
            })
            .catch(error => {
                console.error('âŒ Network error:', error);
                showFloatingAlert('Network error occurred', 'error');
                this.disabled = false;
                this.style.backgroundColor = '';
                this.style.borderColor = '';
                this.value = '';
            });
        });
    });
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    console.log('âœ… Enhanced bath number selection initialized');
});

// Enhanced floating alert function
function showFloatingAlert(message, type = 'info') {
    // Remove existing alerts
    const existingAlert = document.querySelector('.dp-float-alert');
    if (existingAlert) {
        existingAlert.remove();
    }
    
    // Create new alert
    const alert = document.createElement('div');
    alert.className = 'dp-float-alert show';
    alert.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        word-wrap: break-word;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    `;
    alert.textContent = message;
    
    // Set color based on type
    if (type === 'success') {
        alert.style.background = '#28a745';
    } else if (type === 'error') {
        alert.style.background = '#dc3545';
    } else if (type === 'warning') {
        alert.style.background = '#ffc107';
        alert.style.color = '#000';
    } else {
        alert.style.background = '#17a2b8';
    }
    
    document.body.appendChild(alert);
    
    // Trigger animation
    setTimeout(() => {
        alert.style.opacity = '1';
        alert.style.transform = 'translateX(0)';
    }, 10);
    
    // Auto-hide after 4 seconds
    setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (alert.parentElement) {
                alert.remove();
            }
        }, 300);
    }, 4000);
}
</script>
<!-- Table Sorting Script -->
<script nonce="{{ csp_nonce }}">
document.addEventListener("DOMContentLoaded", function () {
  const table = document.getElementById("order-listing");
  if (!table) {
    console.warn("Table with ID 'order-listing' not found.");
    return;
  }

  const headers = table.querySelectorAll("thead th");
  const tbody = table.querySelector("tbody");
  let sortDirection = {};

  headers.forEach((header, index) => {
    header.style.cursor = "pointer";

    header.addEventListener("click", function () {
      const rows = Array.from(tbody.querySelectorAll("tr"));
      const dir = sortDirection[index] === "asc" ? "desc" : "asc";
      sortDirection[index] = dir;

      rows.sort((a, b) => {
        const cellA = a.children[index]?.textContent.trim() || "";
        const cellB = b.children[index]?.textContent.trim() || "";
        
        // Try numeric sort first
        const numA = parseFloat(cellA.replace(/,/g, ""));
        const numB = parseFloat(cellB.replace(/,/g, ""));
        
        if (!isNaN(numA) && !isNaN(numB)) {
          return dir === "asc" ? numA - numB : numB - numA;
        }
        
        // Fallback to string comparison
        return dir === "asc"
          ? cellA.localeCompare(cellB)
          : cellB.localeCompare(cellA);
      });

      // Clear tbody and append sorted rows
      tbody.innerHTML = "";
      rows.forEach((row) => tbody.appendChild(row));
      
      // Update visual indicators (optional)
      headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      header.classList.add(dir === "asc" ? 'sort-asc' : 'sort-desc');
    });
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  // Get all table rows
  document.querySelectorAll("#order-listing tbody tr").forEach(function (row) {
    // For Inprocess Inspection, plating color is in the 6th column (index 5)
    // Adjust this index based on your actual table structure
    var cell = row.children[5]; // Change this index if needed
    
    if (!cell) return;

    var colorText = (cell.textContent || "")
      .replace(/\s+/g, " ")
      .trim()
      .toLowerCase();
    console.log("Normalized colorText:", colorText);

    if (!colorText || colorText === "n/a") return;

    var colorMap = {
      black: {
        bg: "linear-gradient(135deg, #222 60%, #555 100%)",
        border: "#888",
      },
      ips: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #bdbdbd 100%)",
        border: "#757575",
      },
      ipg: {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffe066 100%)",
        border: "#bfa600",
      },
      "ip-gun": {
        bg: "linear-gradient(135deg, #4b4b4b 60%, #a6a6a6 100%)",
        border: "#333",
      },
      "ip-brown": {
        bg: "linear-gradient(135deg, #b97a56 60%, #ffe066 100%)",
        border: "#8d5524",
      },
      rg: {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      ipsipg: {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-blue m": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ipsipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "rg-bi": {
        bg: "linear-gradient(135deg, #e3a6a1 60%, #f7cac9 100%)",
        border: "#b76e79",
      },
      "ipg-2n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      "ipsipg-hn": {
        bg: "linear-gradient(135deg, #e0e0e0 60%, #ffd700 100%)",
        border: "#757575",
      },
      "ip-corn.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-titanium": {
        bg: "linear-gradient(135deg, #8a8a8a 60%, #bdbdbd 100%)",
        border: "#666",
      },
      "ipg-half.n": {
        bg: "linear-gradient(135deg, #ffe066 60%, #ffd700 100%)",
        border: "#bfa600",
      },
      anodising: {
        bg: "linear-gradient(135deg, #ff7f50 60%, #ff4500 100%)",
        border: "#cc3700",
      },
      "ip-blue inh": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-br anti": {
        bg: "linear-gradient(135deg, #b97a56 60%, #8d5524 100%)",
        border: "#8d5524",
      },
      "ip-bronze": {
        bg: "linear-gradient(135deg, #cd7f32 60%, #d2b48c 100%)",
        border: "#8b4513",
      },
      "ip-ch.gold": {
        bg: "linear-gradient(135deg, #ffd700 60%, #ffcc00 100%)",
        border: "#bfa600",
      },
      "ip-sil anti": {
        bg: "linear-gradient(135deg, #c0c0c0 60%, #f5f5f5 100%)",
        border: "#888",
      },
      "ip-lcr": {
        bg: "linear-gradient(135deg, #ff4500 60%, #ff6347 100%)",
        border: "#cc3700",
      },
      "ip-ogr": {
        bg: "linear-gradient(135deg, #228b22 60%, #32cd32 100%)",
        border: "#006400",
      },
      "ip-ice blue": {
        bg: "linear-gradient(135deg, #0074d9 60%, #7fdbff 100%)",
        border: "#00509e",
      },
      "ip-plum": {
        bg: "linear-gradient(135deg, #dda0dd 60%, #ee82ee 100%)",
        border: "#800080",
      },
      "ip-titanium blue": {
        bg: "linear-gradient(135deg, #4682b4 60%, #5f9ea0 100%)",
        border: "#2c5d72",
      },
    };

    var match = Object.keys(colorMap).find(function (key) {
      return colorText === key || colorText.includes(key);
    });
    console.log("Matched key:", match);

    var oldCircle = cell.querySelector(".plating-color-indicator");
    if (oldCircle) oldCircle.remove();

    if (match) {
      console.log("Creating indicator for:", match);
      var style = colorMap[match];
      var circle = document.createElement("span");
      circle.className = "plating-color-indicator";
      circle.style.display = "inline-block";
      circle.style.width = "16px";
      circle.style.height = "16px";
      circle.style.borderRadius = "50%";
      circle.style.marginRight = "6px";
      circle.style.verticalAlign = "middle";
      if (style.bg.startsWith("linear-gradient")) {
        circle.style.background = "";
        circle.style.backgroundImage = style.bg;
      } else {
        circle.style.background = style.bg;
      }
      circle.style.border = "1px solid " + style.border;
      cell.insertBefore(circle, cell.firstChild);
    }
  });
});
</script>

{% endblock %}
{% endblock content %}